# syntax=dhi.io/build:2-debian12

image: dhi.io/pkg-node
variant: runtime
tags:
  - 24.12.0-debian12
platforms:
  - linux/amd64
  - linux/arm64
vars:
  ARCH: '#{ target.arch == "amd64" ? "x64" : "arm64" }'
  COREPACK_VERSION: 0.34.5
  NPM_VERSION: 11.7.0
  VERSION: 24.12.0
  YARN_VERSION: 1.22.22
contents:
  packages:
    - '!cdebconf'
    - '!debconf'
    - '!dpkg'
    - '!gcc-12'
    - '!gcc-12-base'
    - '!gcc-base'
    - '!install-info'
    - '!libdebian-installer'
    - '!libdebian-installer4'
    - '!libnewt0.52'
    - '!libreadline8'
    - '!libslang2'
    - '!libtextwrap'
    - '!libtextwrap1'
    - '!openssl'
    - '!readline-common'
    - '!tar'
    - base-files
    - bash
    - ca-certificates
    - coreutils
    - libc6
    - libstdc++6
    - sed
  builds:
    - name: nodejs
      contents:
        packages:
          - base-files
          - bash
          - coreutils
          - findutils
          - gzip
          - libatomic1
          - libc6
          - libstdc++6
          - gpg
          - gpg-agent
          - grep
          - tar
        files:
          - url: https://keys.openpgp.org/vks/v1/by-fingerprint/5BE8A3F6C8A5C01D106C0AD820B1A390B168D356
            path: ${source.dir}/keys/5BE8A3F6C8A5C01D106C0AD820B1A390B168D356
            uid: 0
            gid: 0
          - url: https://keys.openpgp.org/vks/v1/by-fingerprint/DD792F5973C6DE52C432CBDAC77ABFA00DDBF2B7
            path: ${source.dir}/keys/DD792F5973C6DE52C432CBDAC77ABFA00DDBF2B7
            uid: 0
            gid: 0
          - url: https://keys.openpgp.org/vks/v1/by-fingerprint/CC68F5A3106FF448322E48ED27F5E38D5B0A215F
            path: ${source.dir}/keys/CC68F5A3106FF448322E48ED27F5E38D5B0A215F
            uid: 0
            gid: 0
          - url: https://keys.openpgp.org/vks/v1/by-fingerprint/8FCCA13FEF1D0C2E91008E09770F7A9A5AE15600
            path: ${source.dir}/keys/8FCCA13FEF1D0C2E91008E09770F7A9A5AE15600
            uid: 0
            gid: 0
          - url: https://keys.openpgp.org/vks/v1/by-fingerprint/890C08DB8579162FEE0DF9DB8BEAB4DFCF555EF4
            path: ${source.dir}/keys/890C08DB8579162FEE0DF9DB8BEAB4DFCF555EF4
            uid: 0
            gid: 0
          - url: https://keys.openpgp.org/vks/v1/by-fingerprint/C82FA3AE1CBEDC6BE46B9360C43CEC45C17AB93C
            path: ${source.dir}/keys/C82FA3AE1CBEDC6BE46B9360C43CEC45C17AB93C
            uid: 0
            gid: 0
          - url: https://keys.openpgp.org/vks/v1/by-fingerprint/108F52B48DB57BB0CC439B2997B01419BD92F80A
            path: ${source.dir}/keys/108F52B48DB57BB0CC439B2997B01419BD92F80A
            uid: 0
            gid: 0
          - url: https://keys.openpgp.org/vks/v1/by-fingerprint/A363A499291CBBC940DD62E41F10027AF002F8B0
            path: ${source.dir}/keys/A363A499291CBBC940DD62E41F10027AF002F8B0
            uid: 0
            gid: 0
          - url: https://nodejs.org/download/release/v24.12.0/SHASUMS256.txt
            path: ${source.dir}/SHASUMS256.txt
            uid: 0
            gid: 0
          - url: https://nodejs.org/download/release/v24.12.0/SHASUMS256.txt.sig
            path: ${source.dir}/SHASUMS256.txt.sig
            uid: 0
            gid: 0
          - url: https://nodejs.org/download/release/v24.12.0/node-v24.12.0-linux-${ARCH}.tar.gz
            checksum: https://nodejs.org/download/release/v24.12.0/SHASUMS256.txt
            path: ${source.dir}/node-v24.12.0-linux-${ARCH}.tar.gz
            spdx:
              name: nodejs
              version: 24.12.0
              packages:
                - name: nodejs
                  purl: pkg:dhi/nodejs@24.12.0
                  license: MIT
            uid: 0
            gid: 0
          - url: https://registry.npmjs.org/npm/-/npm-11.7.0.tgz
            path: ${source.dir}/npm-v11.7.0.tgz
            uid: 0
            gid: 0
          - url: https://registry.npmjs.org/corepack/-/corepack-0.34.5.tgz
            path: ${source.dir}/corepack-v0.34.5.tgz
            uid: 0
            gid: 0
      pipeline:
        - name: verify
          runs: |
            set -eux -o pipefail

            GNUPGHOME="$(mktemp -d)"
            export GNUPGHOME

            gpg --batch --import keys/5BE8A3F6C8A5C01D106C0AD820B1A390B168D356
            gpg --batch --import keys/DD792F5973C6DE52C432CBDAC77ABFA00DDBF2B7
            gpg --batch --import keys/CC68F5A3106FF448322E48ED27F5E38D5B0A215F
            gpg --batch --import keys/8FCCA13FEF1D0C2E91008E09770F7A9A5AE15600
            gpg --batch --import keys/890C08DB8579162FEE0DF9DB8BEAB4DFCF555EF4
            gpg --batch --import keys/C82FA3AE1CBEDC6BE46B9360C43CEC45C17AB93C
            gpg --batch --import keys/108F52B48DB57BB0CC439B2997B01419BD92F80A
            gpg --batch --import keys/A363A499291CBBC940DD62E41F10027AF002F8B0
            gpg --batch --verify "SHASUMS256.txt.sig" "SHASUMS256.txt"

            grep "node-v24.12.0-linux-${ARCH}.tar.gz" "SHASUMS256.txt" | sha256sum -c -
        - name: install
          runs: |
            set -eux -o pipefail

            mkdir -p "${target.dir}/opt/nodejs"
            tar -xf "node-v24.12.0-linux-${ARCH}.tar.gz"
            mv "node-v24.12.0-linux-${ARCH}" "${target.dir}/opt/nodejs/node-v24.12.0"

            if [ -f "npm-v11.7.0.tgz" ]; then
              echo "(re)installing npm"
              tar -xzf "npm-v11.7.0.tgz"

              pushd package
              "${target.dir}/opt/nodejs/node-v24.12.0/bin/node" bin/npm-cli.js rm npm -gf --loglevel=silent
              "${target.dir}/opt/nodejs/node-v24.12.0/bin/node" bin/npm-cli.js install -gf "../npm-v11.7.0.tgz"
              popd
            fi

            if [ -f "corepack-v0.34.5.tgz" ]; then
              echo "(re)installing corepack"
              "${target.dir}/opt/nodejs/node-v24.12.0/bin/node" \
                "${target.dir}/opt/nodejs/node-v24.12.0/bin/npm" rm corepack -gf --loglevel=silent
              "${target.dir}/opt/nodejs/node-v24.12.0/bin/node" \
                "${target.dir}/opt/nodejs/node-v24.12.0/bin/npm" install -gf "corepack-v0.34.5.tgz"
            fi

            mkdir -p "${target.dir}/usr/local/bin"
            find "${target.dir}/opt/nodejs/node-v24.12.0/bin" -type f -executable -o -type l | while read -r file; do
              filename=$(basename "${file}")
              ln -s "/opt/nodejs/node-v24.12.0/bin/${filename}" "${target.dir}/usr/local/bin/${filename}"
            done

            chown -R 0:0 "${target.dir}/opt/nodejs/node-v24.12.0"
      outputs:
        - source: ${target.dir}/opt/nodejs
          target: /opt/nodejs
          uid: 0
          gid: 0
        - source: ${target.dir}/usr/local/bin
          target: /usr/local/bin
          uid: 0
          gid: 0
        - source: /opt/docker/sbom
          target: /opt/docker/sbom
          uid: 0
          gid: 0
    - name: yarn
      contents:
        packages:
          - base-files
          - bash
          - coreutils
          - gpg
          - gpg-agent
          - gzip
          - tar
        files:
          - url: https://keys.openpgp.org/vks/v1/by-fingerprint/6A010C5166006599AA17F08146C2130DFD2497F5
            path: ${source.dir}/keys/6A010C5166006599AA17F08146C2130DFD2497F5
            uid: 0
            gid: 0
          - url: https://yarnpkg.com/downloads/1.22.22/yarn-v1.22.22.tar.gz.asc
            path: ${source.dir}/yarn-v1.22.22.tar.gz.asc
            uid: 0
            gid: 0
          - url: https://yarnpkg.com/downloads/1.22.22/yarn-v1.22.22.tar.gz
            path: ${source.dir}/yarn-v1.22.22.tar.gz
            spdx:
              name: yarn
              version: 1.22.22
              packages:
                - name: yarn
                  purl: pkg:dhi/yarn@1.22.22
                  license: MIT
            uid: 0
            gid: 0
      pipeline:
        - name: install
          runs: |
            set -eux -o pipefail

            GNUPGHOME="$(mktemp -d)"
            export GNUPGHOME

            gpg --import keys/6A010C5166006599AA17F08146C2130DFD2497F5
            gpg --batch --verify "yarn-v1.22.22.tar.gz.asc" "yarn-v1.22.22.tar.gz"

            tar -xf "yarn-v1.22.22.tar.gz"
            mkdir -p "${target.dir}/opt/yarn"
            mv "yarn-v1.22.22" "${target.dir}/opt/yarn/yarn-v1.22.22"

            mkdir -p "${target.dir}/usr/local/bin"
            ln -s "/opt/yarn/yarn-v1.22.22/bin/yarn" "${target.dir}/usr/local/bin/yarn"
            ln -s "/opt/yarn/yarn-v1.22.22/bin/yarnpkg" "${target.dir}/usr/local/bin/yarnpkg"

            chown -R 0:0 "${target.dir}/opt/yarn/yarn-v1.22.22"
      outputs:
        - source: ${target.dir}/opt/yarn
          target: /opt/yarn
          uid: 0
          gid: 0
        - source: ${target.dir}/usr/local/bin
          target: /usr/local/bin
          uid: 0
          gid: 0
        - source: /opt/docker/sbom
          target: /opt/docker/sbom
          uid: 0
          gid: 0
accounts:
  root: true
  run-as: root
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "12"
  version-codename: bookworm
  pretty-name: Docker Hardened Images/Debian GNU/Linux 12 (bookworm)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
environment:
  NODE_VERSION: 24.12.0
