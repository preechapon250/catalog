# syntax=dhi.io/build:1-debian12

image: dhi.io/pkg-binutils
variant: runtime
tags:
  - 2-debian12
  - 2.45-debian12
platforms:
  - linux/amd64
  - linux/arm64
vars:
  ARCH: '#{ target.arch == "amd64" ? "x86-64" : "aarch64" }'
  ARCH_ALIAS: '#{ target.arch == "amd64" ? "x86_64" : "aarch64" }'
  SEMVER_MAJOR_MINOR_VERSION: "2.45"
  SEMVER_MAJOR_VERSION: "2"
  VERSION: "2.45"
contents:
  packages:
    - libc6
    - libjansson4
    - zlib1g
  builds:
    - name: binutils deb
      pipeline:
        - name: binutils deb
          uses: deb/build@v1
          with:
            control: |
              Section: text
              Priority: optional
              Homepage: https://docker.com/dhi
              Standards-Version: 3.9.2

              Package: binutils
              Priority: optional
              Section: devel
              Maintainer: Docker Hardened Images <dhi@docker.com>
              Architecture: all
              Version: 2.45
              Provides: binutils-gold, elf-binutils
              Depends: binutils-common (= 2.45), libbinutils (= 2.45)
              Description: GNU assembler, linker and binary utilities
                The programs in this package are used to assemble, link and manipulate
                binary and object files.  They may be used in conjunction with a compiler
                and various libraries to build programs.
              Homepage: https://www.gnu.org/software/binutils/
            dir: ${source.dir}/deb
        - name: binutils-common deb
          uses: deb/build@v1
          with:
            control: |
              Section: text
              Priority: optional
              Homepage: https://docker.com/dhi
              Standards-Version: 3.9.2

              Package: binutils-common
              Priority: optional
              Section: devel
              Maintainer: Docker Hardened Images <dhi@docker.com>
              Architecture: all
              Source: binutils
              Version: 2.45
              Description: Common files for the GNU assembler, linker and binary utilities
                This package contains the localization files used by binutils packages for
                various target architectures and parts of the binutils documentation. It is
                not useful on its own.
              Homepage: https://www.gnu.org/software/binutils/
            dir: ${source.dir}/deb
        - name: libbinutils deb
          uses: deb/build@v1
          with:
            control: |
              Section: text
              Priority: optional
              Homepage: https://docker.com/dhi
              Standards-Version: 3.9.2

              Package: libbinutils
              Priority: optional
              Section: devel
              Maintainer: Docker Hardened Images <dhi@docker.com>
              Architecture: all
              Source: binutils
              Version: 2.45
              Depends: libc6 (>= 2.36), libzstd1 (>= 1.5.2), zlib1g (>= 1:1.1.4), binutils-common (= 2.45)
              Description: GNU binary utilities (private shared library)
                This package includes the private shared libraries libbfd and libopcodes.
              Homepage: https://www.gnu.org/software/binutils/
            dir: ${source.dir}/deb
        - name: libctf-nobfd0 deb
          uses: deb/build@v1
          with:
            control: |
              Section: text
              Priority: optional
              Homepage: https://docker.com/dhi
              Standards-Version: 3.9.2

              Package: libctf-nobfd0
              Priority: optional
              Section: devel
              Maintainer: Docker Hardened Images <dhi@docker.com>
              Architecture: all
              Source: binutils
              Version: 2.45
              Depends: libc6 (>= 2.36), zlib1g (>= 1:1.1.4)
              Description: Compact C Type Format library (runtime, no BFD dependency)
                This package includes the libctf-nobfd shared library.  The Compact C Type
                Format (CTF) is a way of representing information about a binary program
              Homepage: https://www.gnu.org/software/binutils/
            dir: ${source.dir}/deb
        - name: libctf0 deb
          uses: deb/build@v1
          with:
            control: |
              Section: text
              Priority: optional
              Homepage: https://docker.com/dhi
              Standards-Version: 3.9.2

              Package: libctf0
              Priority: optional
              Section: devel
              Maintainer: Docker Hardened Images <dhi@docker.com>
              Architecture: all
              Source: binutils
              Version: 2.45
              Depends: libbinutils (= 2.45), libc6 (>= 2.36), zlib1g (>= 1:1.1.4)
              Description: Compact C Type Format library (runtime, BFD dependency)
                This package includes the libctf shared library.  The Compact C Type
                Format (CTF) is a way of representing information about a binary program
              Homepage: https://www.gnu.org/software/binutils/
            dir: ${source.dir}/deb
        - name: binutils-${ARCH}-linux-gnu deb
          uses: deb/build@v1
          with:
            control: |
              Section: text
              Priority: optional
              Homepage: https://docker.com/dhi
              Standards-Version: 3.9.2

              Package: binutils-${ARCH}-linux-gnu
              Priority: optional
              Section: devel
              Maintainer: Docker Hardened Images <dhi@docker.com>
              Architecture: all
              Source: binutils
              Version: 2.45
              Depends: binutils-common (= 2.45), libc6 (>= 2.36), libzstd1 (>= 1.5.2), zlib1g (>= 1:1.1.4)
              Description: GNU binary utilities, for ${ARCH}-linux-gnu target
                This package provides GNU assembler, linker and binary utilities
                for the ${ARCH}-linux-gnu target.
                .
                You don't need this package unless you plan to cross-compile programs
                for ${ARCH}-linux-gnu and ${ARCH}-linux-gnu is not your native
                platform.
              Homepage: https://www.gnu.org/software/binutils/
            dir: ${source.dir}/deb
        - name: deb install
          uses: deb/install@v1
          with:
            files:
              - ${source.dir}/deb/binutils_2.45_all.deb
              - ${source.dir}/deb/binutils-common_2.45_all.deb
              - ${source.dir}/deb/libbinutils_2.45_all.deb
              - ${source.dir}/deb/libctf-nobfd0_2.45_all.deb
              - ${source.dir}/deb/libctf0_2.45_all.deb
              - ${source.dir}/deb/binutils-${ARCH}-linux-gnu_2.45_all.deb
    - name: binutils
      contents:
        packages:
          - base-files
          - bash
          - coreutils
          - findutils
          - make
          - build-essential
          - gpg
          - gpg-agent
          - automake
          - autotools-dev
          - gzip
          - sed
          - grep
          - diffutils
          - bison
          - flex
          - texinfo
          - zlib1g-dev
          - pkg-config
          - libjansson-dev
        files:
          - url: https://ftpmirror.gnu.org/gnu-keyring.gpg
            path: ${source.dir}/keys/gnu-keyring.gpg
            uid: 0
            gid: 0
          - url: https://ftpmirror.gnu.org/binutils/binutils-2.45.tar.gz.sig
            path: ${source.dir}/sig/binutils-2.45.tar.gz.sig
            uid: 0
            gid: 0
          - url: https://ftpmirror.gnu.org/binutils/binutils-2.45.tar.gz
            path: ${source.dir}/binutils-2.45.tar.gz
            uid: 0
            gid: 0
          - url: https://sourceware.org/git?p=binutils-gdb.git;a=patch;h=f87a66db645caf8cc0e6fc87b0c28c78a38af59b
            path: ${source.dir}/patches/CVE-2025-11081.patch
            uid: 0
            gid: 0
          - url: https://sourceware.org/git?p=binutils-gdb.git;a=patch;h=ea1a0737c7692737a644af0486b71e4a392cbca8
            path: ${source.dir}/patches/CVE-2025-11082.patch
            uid: 0
            gid: 0
          - url: https://sourceware.org/git?p=binutils-gdb.git;a=patch;h=9ca499644a21ceb3f946d1c179c38a83be084490
            path: ${source.dir}/patches/CVE-2025-11083.patch
            uid: 0
            gid: 0
          - url: https://sourceware.org/git?p=binutils-gdb.git;a=patch;h=047435dd988a3975d40c6626a8f739a0b2e154bc
            path: ${source.dir}/patches/CVE-2025-11412.patch
            uid: 0
            gid: 0
          - url: https://sourceware.org/git?p=binutils-gdb.git;a=patch;h=1108620d7a521f1c85d2f629031ce0fbae14e331
            path: ${source.dir}/patches/CVE-2025-11413-1.patch
            uid: 0
            gid: 0
          - url: https://sourceware.org/git?p=binutils-gdb.git;a=patch;h=72efdf166aa0ed72ecc69fc2349af6591a7a19c0
            path: ${source.dir}/patches/CVE-2025-11413-2.patch
            uid: 0
            gid: 0
          - url: https://sourceware.org/git?p=binutils-gdb.git;a=patch;h=aeaaa9af6359c8e394ce9cf24911fec4f4d23703
            path: ${source.dir}/patches/CVE-2025-11414.patch
            uid: 0
            gid: 0
          - url: https://sourceware.org/git?p=binutils-gdb.git;a=patch;h=b6ac5a8a5b82f0ae6a4642c8d7149b325f4cc60a
            path: ${source.dir}/patches/CVE-2025-11494.patch
            uid: 0
            gid: 0
          - url: https://sourceware.org/git?p=binutils-gdb.git;a=patch;h=6b21c8b2ecfef5c95142cbc2c32f185cb1c26ab0
            path: ${source.dir}/patches/CVE-2025-11495.patch
            uid: 0
            gid: 0
      pipeline:
        - name: verify
          uses: gpg/verify@v1
          with:
            file: ${source.dir}/binutils-2.45.tar.gz
            keys: ${source.dir}/keys/gnu-keyring.gpg
            signature: ${source.dir}/sig/binutils-2.45.tar.gz.sig
        - name: extract
          runs: |
            set -eux -o pipefail

            tar -xaf "binutils-2.45.tar.gz" --strip-components=1
        - name: install
          runs: |
            set -eux -o pipefail

            patch -p1 < "${source.dir}/patches/CVE-2025-11081.patch"
            patch -p1 < "${source.dir}/patches/CVE-2025-11082.patch"
            patch -p1 < "${source.dir}/patches/CVE-2025-11083.patch"
            patch -p1 < "${source.dir}/patches/CVE-2025-11412.patch"
            patch -p1 < "${source.dir}/patches/CVE-2025-11413-1.patch"
            patch -p1 < "${source.dir}/patches/CVE-2025-11413-2.patch"
            patch -p1 < "${source.dir}/patches/CVE-2025-11414.patch"
            patch -p1 < "${source.dir}/patches/CVE-2025-11494.patch"
            patch -p1 < "${source.dir}/patches/CVE-2025-11495.patch"

            gnuArch="$(dpkg-architecture --query DEB_BUILD_GNU_TYPE)"

            CC="$gnuArch-gcc" CXX="$gnuArch-g++" \
              CFLAGS="-fPIC -g -O2 -ffunction-sections -fdata-sections" CXXFLAGS="-fPIC -g -O2 -ffunction-sections -fdata-sections" LDFLAGS="-Wl,--gc-sections" \
              ./configure --prefix="${target.dir}/opt/binutils" \
              --build="$gnuArch" \
              --target="$gnuArch" \
              --host="$gnuArch" \
              --disable-silent-rules \
              --disable-nls \
              --disable-werror \
              --disable-multilib \
              --disable-gprofng \
              --disable-gdb \
              --disable-gdbserver \
              --disable-compressed-debug-sections \
              --disable-x86-used-note \
              --disable-default-execstack \
              --disable-static \
              --enable-deterministic-archives \
              --enable-plugins \
              --enable-threads \
              --enable-jansson \
              --enable-new-dtags \
              --enable-ld=default \
              --enable-gold \
              --enable-plugins \
              --enable-shared \
              --enable-default-hash-style=gnu \
              --enable-textrel-check=error \
              --with-gold-ldflags=-static-libstdc++ \
              --with-system-zlib

            make
            make install

            find "${target.dir}/opt/binutils" -type f -executable -exec strip {} \;
            rm -rf "${target.dir}/opt/binutils/share"
            rm -rf "${target.dir}/opt/binutils/include"
        - name: tests
          runs: |
            set -eux -o pipefail

            "${target.dir}/opt/binutils/bin/addr2line" --version
            "${target.dir}/opt/binutils/bin/ar" --version
            "${target.dir}/opt/binutils/bin/as" --version
            "${target.dir}/opt/binutils/bin/c++filt" --version
            "${target.dir}/opt/binutils/bin/elfedit" --version
            "${target.dir}/opt/binutils/bin/gprof" --version
            "${target.dir}/opt/binutils/bin/ld" --version
            "${target.dir}/opt/binutils/bin/ld.bfd" --version
            "${target.dir}/opt/binutils/bin/nm" --version
            "${target.dir}/opt/binutils/bin/objcopy" --version
            "${target.dir}/opt/binutils/bin/objdump" --version
            "${target.dir}/opt/binutils/bin/ranlib" --version
            "${target.dir}/opt/binutils/bin/readelf" --version
            "${target.dir}/opt/binutils/bin/size" --version
            "${target.dir}/opt/binutils/bin/strings" --version
            "${target.dir}/opt/binutils/bin/strip" --version
            "${target.dir}/opt/binutils/bin/addr2line" --help
            "${target.dir}/opt/binutils/bin/ar" --help
            "${target.dir}/opt/binutils/bin/as" --help
            "${target.dir}/opt/binutils/bin/c++filt" --help
            "${target.dir}/opt/binutils/bin/elfedit" --help
            "${target.dir}/opt/binutils/bin/gprof" --help
            "${target.dir}/opt/binutils/bin/ld" --help
            "${target.dir}/opt/binutils/bin/ld.bfd" --help
            "${target.dir}/opt/binutils/bin/nm" --help
            "${target.dir}/opt/binutils/bin/objcopy" --help
            "${target.dir}/opt/binutils/bin/objdump" --help
            "${target.dir}/opt/binutils/bin/ranlib" --help
            "${target.dir}/opt/binutils/bin/readelf" --help
            "${target.dir}/opt/binutils/bin/size" --help
            "${target.dir}/opt/binutils/bin/strings" --help
            "${target.dir}/opt/binutils/bin/strip" --help
      outputs:
        - source: ${target.dir}/opt/binutils/
          target: /usr
          uid: 0
          gid: 0
        - source: /opt/docker/sbom
          target: /opt/docker/sbom
          uid: 0
          gid: 0
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "12"
  version-codename: bookworm
  pretty-name: Docker Hardened Images/Debian GNU/Linux 12 (bookworm)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
tests:
  - name: Run testcontainers tests
    directory: package/binutils/tests
    commands:
      - go test . -count=1 -v
    exit-code: 0
