# syntax=dhi.io/build:2-alpine3.23

image: dhi.io/pkg-python
variant: runtime
tags:
  - 3.14-alpine3.23
  - 3.14.2-alpine3.23
platforms:
  - linux/amd64
  - linux/arm64
vars:
  COSIGN_DIGEST: sha256:9dfbfe297449aa1f23f4ea8dc1872c91ce40c810b851ae075e0a703461426dc1
  COSIGN_VERSION: 2.5.0
  OIDC_IDENTITY: hugo@python.org
  OIDC_ISSUER: https://github.com/login/oauth
  PATCH_CVE-2025-12084: ""
  PATCH_CVE-2025-13836: ""
  PATCH_CVE-2025-13837: ""
  PIP_CHECKSUM: sha256:9655943313a94722b7774661c21049070f6bbb0a1516bf02f7c8d5d9201514cd
  PIP_URL: https://files.pythonhosted.org/packages/44/3c/d717024885424591d5376220b5e836c2d5293ce2011523c9de23ff7bf068/pip-25.3-py3-none-any.whl
  PIP_VERSION: "25.3"
  PYTHON_MAJOR_MINOR_VERSION: "3.14"
  PYTHON_MAJOR_VERSION: "3"
  PYTHON_VERSION: 3.14.2
  SETUPTOOLS_CHECKSUM: sha256:062d34222ad13e0cc312a4c02d73f059e86a4acbfbdea8f8f76b28c99f306922
  SETUPTOOLS_URL: https://files.pythonhosted.org/packages/a3/dc/17031897dae0efacfea57dfd3a82fdd2a2aeb58e0ff71b77b87e44edc772/setuptools-80.9.0-py3-none-any.whl
  SETUPTOOLS_VERSION: ""
  VERSION: 3.14.2
contents:
  repositories:
    - https://dl-cdn.alpinelinux.org/alpine/v3.23/main
    - https://dl-cdn.alpinelinux.org/alpine/v3.23/community
  packages:
    - alpine-baselayout-data
    - bzip2
    - ca-certificates-bundle
    - expat
    - gdbm
    - libffi
    - mpdecimal
    - musl
    - ncurses
    - openssl
    - readline
    - sqlite-libs
    - tzdata
    - zlib
  builds:
    - name: python
      contents:
        repositories:
          - https://dl-cdn.alpinelinux.org/alpine/v3.23/main
          - https://dl-cdn.alpinelinux.org/alpine/v3.23/community
        packages:
          - ca-certificates-bundle
          - busybox
          - musl
          - dpkg-dev
          - dpkg
          - bluez-dev
          - bzip2-dev
          - expat-dev
          - gcc
          - gdbm-dev
          - libc-dev
          - libffi-dev
          - libnsl-dev
          - libtirpc-dev
          - linux-headers
          - make
          - mpdecimal-dev
          - ncurses-dev
          - openssl-dev
          - pax-utils
          - readline-dev
          - sqlite-dev
          - tcl-dev
          - tk
          - tk-dev
          - xz-dev
          - zlib-dev
          - git
        files:
          - url: https://files.pythonhosted.org/packages/44/3c/d717024885424591d5376220b5e836c2d5293ce2011523c9de23ff7bf068/pip-25.3-py3-none-any.whl
            checksum: sha256:9655943313a94722b7774661c21049070f6bbb0a1516bf02f7c8d5d9201514cd
            path: ${source.dir}/pip-25.3-py3-none-any.whl
            uid: 0
            gid: 0
          - url: https://www.python.org/ftp/python/3.14.2/Python-3.14.2.tar.xz.sigstore
            path: ${source.dir}/python.tar.xz.sigstore
            uid: 0
            gid: 0
          - url: https://www.python.org/ftp/python/3.14.2/Python-3.14.2.tar.xz
            path: ${source.dir}/python.tar.xz
            spdx:
              name: python
              version: 3.14.2
              packages:
                - name: python
                  purl: pkg:dhi/python@3.14.2
                  license: PSF-2.0
            uid: 0
            gid: 0
        artifacts:
          - name: dhi.io/cosign:2.5.0@sha256:9dfbfe297449aa1f23f4ea8dc1872c91ce40c810b851ae075e0a703461426dc1
            includes:
              - usr/local/bin/cosign
            uid: 0
            gid: 0
      pipeline:
        - name: verify
          uses: cosign/verify-blob@v1
          with:
            blob: ${source.dir}/python.tar.xz
            certificate-identity: hugo@python.org
            certificate-oidc-issuer: https://github.com/login/oauth
            offline: true
            signature: ${source.dir}/python.tar.xz.sigstore
        - name: install
          runs: |
            set -eux -o pipefail

            tar -xaf python.tar.xz --strip-components=1

            if [ -f "${source.dir}/patch/CVE-2025-13836.patch" ]; then
              git apply "${source.dir}/patch/CVE-2025-13836.patch"
            fi
            if [ -f "${source.dir}/patch/CVE-2025-13837.patch" ]; then
              git apply "${source.dir}/patch/CVE-2025-13837.patch"
            fi
            if [ -f "${source.dir}/patch/CVE-2025-12084.patch" ]; then
              git apply "${source.dir}/patch/CVE-2025-12084.patch"
            fi

            gnuArch="$(dpkg-architecture --query DEB_BUILD_GNU_TYPE)"

            if [ -f "pip-25.3-py3-none-any.whl" ]; then
              rm -rf Lib/ensurepip/_bundled/pip*
              cp "pip-25.3-py3-none-any.whl" Lib/ensurepip/_bundled/
              sed -i "s/_PIP_VERSION = \".*\"/_PIP_VERSION = \"25.3\"/g" Lib/ensurepip/__init__.py
            fi

            if [ -f "setuptools--py3-none-any.whl" ]; then
              rm -rf Lib/ensurepip/_bundled/setuptools*
              cp "setuptools--py3-none-any.whl" Lib/ensurepip/_bundled/
              sed -i "s/_SETUPTOOLS_VERSION = \".*\"/_SETUPTOOLS_VERSION = \"\"/g" Lib/ensurepip/__init__.py
            fi

            ./configure --prefix="${target.dir}/opt/python-3.14.2" \
              --build="$gnuArch" \
              --enable-loadable-sqlite-extensions \
              --enable-option-checking=fatal \
              --enable-shared \
              --with-lto \
              --with-ensurepip

            nproc="$(nproc)"
            EXTRA_CFLAGS="-DTHREAD_STACK_SIZE=0x100000"
            LDFLAGS="${LDFLAGS:--Wl},--strip-all"
            EXTRA_CFLAGS="${EXTRA_CFLAGS:-} -fno-omit-frame-pointer -mno-omit-leaf-frame-pointer"
            make -j "$nproc" "EXTRA_CFLAGS=${EXTRA_CFLAGS:-}" "LDFLAGS=${LDFLAGS:-}"
            rm python
            make -j "$nproc" "EXTRA_CFLAGS=${EXTRA_CFLAGS:-}" "LDFLAGS=${LDFLAGS:--Wl},-rpath='\$\$ORIGIN/../lib'" python

            make install

            # replace invalid reference to /out directory
            find "${target.dir}/opt/python-3.14.2/bin" -type f -exec sed -i "s|/out/|/|g" {} +

            ln -s idle3 "${target.dir}/opt/python-3.14.2/bin/idle"
            ln -s pip3 "${target.dir}/opt/python-3.14.2/bin/pip"
            ln -s pydoc3 "${target.dir}/opt/python-3.14.2/bin/pydoc"
            ln -s python3 "${target.dir}/opt/python-3.14.2/bin/python"
            ln -s python3-config "${target.dir}/opt/python-3.14.2/bin/python-config"

            ln -s "/opt/python-3.14.2" "${target.dir}/opt/python"

            # shellcheck disable=SC2061,SC2035
            find "${target.dir}/opt/python-3.14.2" -depth \
              \( \
              \( -type d -a \( -name test -o -name tests -o -name idle_test \) \) \
              -o \( -type f -a \( -name '*.pyc' -o -name '*.pyo' -o -name 'libpython*.a' \) \) \
              \) -exec rm -rf '{}' +
        - name: strip
          uses: strip@v1
          with:
            dir: ${target.dir}/opt
      outputs:
        - source: ${target.dir}/opt
          target: /opt
          uid: 0
          gid: 0
        - source: /opt/docker/sbom
          target: /opt/docker/sbom
          uid: 0
          gid: 0
accounts:
  root: true
  run-as: root
os-release:
  name: Docker Hardened Images (Alpine)
  id: alpine
  version-id: "3.23"
  pretty-name: Docker Hardened Images/Alpine Linux v3.23
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
environment:
  LD_LIBRARY_PATH: /opt/python/lib
  PATH: /opt/python/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
  PYTHON_VERSION: 3.14.2
  SSL_CERT_FILE: /etc/ssl/certs/ca-certificates.crt
