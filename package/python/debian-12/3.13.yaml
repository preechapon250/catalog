# syntax=dhi.io/build:2-debian12

image: dhi.io/pkg-python
variant: runtime
tags:
  - 3.13-debian12
  - 3.13.11-debian12
platforms:
  - linux/amd64
  - linux/arm64
vars:
  COSIGN_DIGEST: sha256:9dfbfe297449aa1f23f4ea8dc1872c91ce40c810b851ae075e0a703461426dc1
  COSIGN_VERSION: 2.5.0
  EXPAT_DIGEST: sha256:3fdbe5af6f4e7951e227db3bd931072fec23771bafa560f7d178b71abe53ef90
  EXPAT_VERSION: 2.7.3
  OIDC_IDENTITY: thomas@python.org
  OIDC_ISSUER: https://accounts.google.com
  PATCH_CVE-2025-12084: ""
  PATCH_CVE-2025-13836: ""
  PATCH_CVE-2025-13837: ""
  PIP_CHECKSUM: sha256:98436feffb9e31bc9339cf369fd55d3331b1580b6a6f1173bacacddcf9c34754
  PIP_URL: https://files.pythonhosted.org/packages/69/00/5ac7aa77688ec4d34148b423d34dc0c9bc4febe0d872a9a1ad9860b2f6f1/pip-26.0-py3-none-any.whl
  PIP_VERSION: "26.0"
  PYTHON_MAJOR_MINOR_VERSION: "3.13"
  PYTHON_MAJOR_VERSION: "3"
  PYTHON_VERSION: 3.13.11
  SETUPTOOLS_CHECKSUM: sha256:95b30ddfb717250edb492926c92b5221f7ef3fbcc2b07579bcd4a27da21d0173
  SETUPTOOLS_URL: https://files.pythonhosted.org/packages/94/b8/f1f62a5e3c0ad2ff1d189590bfa4c46b4f3b6e49cef6f26c6ee4e575394d/setuptools-80.10.2-py3-none-any.whl
  SETUPTOOLS_VERSION: ""
  VERSION: 3.13.11
  WHEEL_CHECKSUM: sha256:4b399d56c9d9338230118d705d9737a2a468ccca63d5e813e2a4fc7815d8bc4d
  WHEEL_URL: https://files.pythonhosted.org/packages/87/22/b76d483683216dde3d67cba61fb2444be8d5be289bf628c13fc0fd90e5f9/wheel-0.46.3-py3-none-any.whl
  WHEEL_VERSION: 0.46.3
contents:
  packages:
    - base-files
    - ca-certificates
    - libbz2-1.0
    - libcom-err2
    - libcrypt1
    - libdb5.3
    - libffi8
    - libgcc-s1
    - liblzma5
    - libncursesw6
    - libreadline8
    - libsqlite3-0
    - libstdc++6
    - libtinfo6
    - libuuid1
    - ncurses-base
    - ncurses-bin
    - netbase
    - tzdata
    - zlib1g
  builds:
    - name: python
      contents:
        packages:
          - bash
          - coreutils
          - dpkg-dev
          - libc6
          - gawk
          - sed
          - grep
          - findutils
          - g++
          - gcc
          - make
          - pkg-config
          - git
          - zip
          - base-files
          - ca-certificates
          - netbase
          - tzdata
          - ncurses-base
          - ncurses-bin
          - build-essential
          - dpkg-dev
          - gcc
          - libbluetooth-dev
          - libbz2-dev
          - libc6-dev
          - libdb-dev
          - libffi-dev
          - libgdbm-dev
          - liblzma-dev
          - libncurses-dev
          - libreadline-dev
          - libsqlite3-dev
          - libssl-dev
          - tk-dev
          - uuid-dev
          - zlib1g-dev
        files:
          - url: https://files.pythonhosted.org/packages/69/00/5ac7aa77688ec4d34148b423d34dc0c9bc4febe0d872a9a1ad9860b2f6f1/pip-26.0-py3-none-any.whl
            checksum: sha256:98436feffb9e31bc9339cf369fd55d3331b1580b6a6f1173bacacddcf9c34754
            path: ${source.dir}/pip-26.0-py3-none-any.whl
            uid: 0
            gid: 0
          - url: https://files.pythonhosted.org/packages/87/22/b76d483683216dde3d67cba61fb2444be8d5be289bf628c13fc0fd90e5f9/wheel-0.46.3-py3-none-any.whl
            checksum: sha256:4b399d56c9d9338230118d705d9737a2a468ccca63d5e813e2a4fc7815d8bc4d
            path: ${source.dir}/wheel-0.46.3-py3-none-any.whl
            uid: 0
            gid: 0
          - url: https://www.python.org/ftp/python/3.13.11/Python-3.13.11.tar.xz.sigstore
            path: ${source.dir}/python.tar.xz.sigstore
            uid: 0
            gid: 0
          - url: https://www.python.org/ftp/python/3.13.11/Python-3.13.11.tar.xz
            path: ${source.dir}/python.tar.xz
            spdx:
              name: python
              version: 3.13.11
              packages:
                - name: python
                  purl: pkg:dhi/python@3.13.11
                  license: PSF-2.0
            uid: 0
            gid: 0
        artifacts:
          - name: dhi.io/cosign:2.5.0@sha256:9dfbfe297449aa1f23f4ea8dc1872c91ce40c810b851ae075e0a703461426dc1
            includes:
              - usr/local/bin/cosign
            uid: 0
            gid: 0
      pipeline:
        - name: verify
          uses: cosign/verify-blob@v1
          with:
            blob: ${source.dir}/python.tar.xz
            certificate-identity: thomas@python.org
            certificate-oidc-issuer: https://accounts.google.com
            offline: true
            signature: ${source.dir}/python.tar.xz.sigstore
        - name: install
          runs: |
            set -eux -o pipefail

            tar -xaf python.tar.xz --strip-components=1

            if [ -f "${source.dir}/patch/CVE-2025-13836.patch" ]; then
              git apply "${source.dir}/patch/CVE-2025-13836.patch"
            fi
            if [ -f "${source.dir}/patch/CVE-2025-13837.patch" ]; then
              git apply "${source.dir}/patch/CVE-2025-13837.patch"
            fi
            if [ -f "${source.dir}/patch/CVE-2025-12084.patch" ]; then
              git apply "${source.dir}/patch/CVE-2025-12084.patch"
            fi

            gnuArch="$(dpkg-architecture --query DEB_BUILD_GNU_TYPE)"

            if [ -f "${source.dir}/pip-26.0-py3-none-any.whl" ]; then
              rm -rf Lib/ensurepip/_bundled/pip*
              cp "${source.dir}/pip-26.0-py3-none-any.whl" Lib/ensurepip/_bundled/
              sed -i "s/_PIP_VERSION = \".*\"/_PIP_VERSION = \"26.0\"/g" Lib/ensurepip/__init__.py
            fi

            if [ -f "${source.dir}/setuptools--py3-none-any.whl" ]; then
              rm -rf Lib/ensurepip/_bundled/setuptools*
              cp "${source.dir}/setuptools--py3-none-any.whl" Lib/ensurepip/_bundled/
              sed -i "s/_SETUPTOOLS_VERSION = \".*\"/_SETUPTOOLS_VERSION = \"\"/g" Lib/ensurepip/__init__.py
            fi

            if [ -f "${source.dir}/wheel-0.46.3-py3-none-any.whl" ]; then
              rm -rf Lib/ensurepip/_bundled/wheel*
              cp "${source.dir}/wheel-0.46.3-py3-none-any.whl" Lib/ensurepip/_bundled/
              sed -i "s/_WHEEL_VERSION = \".*\"/_WHEEL_VERSION = \"0.46.3\"/g" Lib/ensurepip/__init__.py
            fi

            # Replace vendored wheel in setuptools if present
            if [ -f "${source.dir}/setuptools--py3-none-any.whl" ] && [ -f "${source.dir}/wheel-0.46.3-py3-none-any.whl" ]; then
              # Verify wheel files are valid zip archives before extracting
              if ! python3 -m zipfile -t "${source.dir}/setuptools--py3-none-any.whl" > /dev/null 2>&1; then
                echo "Error: setuptools wheel file is not a valid zip archive"
                exit 1
              fi
              if ! python3 -m zipfile -t "${source.dir}/wheel-0.46.3-py3-none-any.whl" > /dev/null 2>&1; then
                echo "Error: wheel file is not a valid zip archive"
                exit 1
              fi

              # Extract both wheels
              python3 -m zipfile -e "${source.dir}/setuptools--py3-none-any.whl" setuptools_temp/
              python3 -m zipfile -e "${source.dir}/wheel-0.46.3-py3-none-any.whl" wheel_temp/

              # Remove old vendored wheel from setuptools
              rm -rf setuptools_temp/setuptools/_vendor/wheel*

              # Copy new wheel into setuptools vendor directory
              cp -r wheel_temp/wheel/ setuptools_temp/setuptools/_vendor/
              cp -r wheel_temp/wheel-0.46.3.dist-info/ setuptools_temp/setuptools/_vendor/

              # Repackage setuptools with all its contents (including _distutils_hack, etc.)
              (cd setuptools_temp && zip -r "../setuptools--patched.whl" .)

              # Verify _distutils_hack is still present in the repacked wheel if it was in the original
              if python3 -m zipfile -l "${source.dir}/setuptools--py3-none-any.whl" | grep -q "_distutils_hack"; then
                if ! python3 -m zipfile -l "setuptools--patched.whl" | grep -q "_distutils_hack"; then
                  echo "ERROR: _distutils_hack was present in original setuptools but missing from repacked wheel!"
                  python3 -m zipfile -l "setuptools--patched.whl" | head -30
                  exit 1
                fi
              fi

              mv "setuptools--patched.whl" "Lib/ensurepip/_bundled/setuptools--py3-none-any.whl"
              rm -rf setuptools_temp wheel_temp
            fi

            # Verify the bundled setuptools wheel still has _distutils_hack if it should
            if python3 -m zipfile -l "${source.dir}/setuptools--py3-none-any.whl" | grep -q "_distutils_hack"; then
              python3 -m zipfile -l Lib/ensurepip/_bundled/setuptools--py3-none-any.whl | grep "_distutils_hack" || (
                echo "ERROR: _distutils_hack not in bundled setuptools wheel!"
                python3 -m zipfile -l Lib/ensurepip/_bundled/setuptools--py3-none-any.whl | head -30
                exit 1
              )
            fi

            ./configure --prefix="/opt/python-3.13.11" \
              --build="$gnuArch" \
              --enable-loadable-sqlite-extensions \
              --enable-option-checking=fatal \
              --enable-shared \
              --with-lto \
              --with-ensurepip

            nproc="$(nproc)"
            EXTRA_CFLAGS="-DTHREAD_STACK_SIZE=0x100000"
            LDFLAGS="${LDFLAGS:--Wl},--strip-all"
            EXTRA_CFLAGS="${EXTRA_CFLAGS:-} -fno-omit-frame-pointer -mno-omit-leaf-frame-pointer"
            make -j "$nproc" "EXTRA_CFLAGS=${EXTRA_CFLAGS:-}" "LDFLAGS=${LDFLAGS:-}"
            rm python
            make -j "$nproc" "EXTRA_CFLAGS=${EXTRA_CFLAGS:-}" "LDFLAGS=${LDFLAGS:--Wl},-rpath='\$\$ORIGIN/../lib'" python

            make DESTDIR="${target.dir}" install

            # Verify _distutils_hack was installed if it was present in the wheel
            if python3 -m zipfile -l Lib/ensurepip/_bundled/setuptools--py3-none-any.whl | grep -q "_distutils_hack"; then
              if [ ! -d "${target.dir}/opt/python-3.13.11/lib/python3.13/site-packages/_distutils_hack" ]; then
                echo "ERROR: _distutils_hack directory not found in installed site-packages!"
                ls -la "${target.dir}/opt/python-3.13.11/lib/python3.13/site-packages/" | head -20
                exit 1
              fi
              if [ ! -f "${target.dir}/opt/python-3.13.11/lib/python3.13/site-packages/_distutils_hack/override.py" ]; then
                echo "ERROR: _distutils_hack/override.py file not found!"
                ls -la "${target.dir}/opt/python-3.13.11/lib/python3.13/site-packages/_distutils_hack/"
                exit 1
              fi
            fi

            ln -s idle3 "${target.dir}/opt/python-3.13.11/bin/idle"
            ln -s pip3 "${target.dir}/opt/python-3.13.11/bin/pip"
            ln -s pydoc3 "${target.dir}/opt/python-3.13.11/bin/pydoc"
            ln -s python3 "${target.dir}/opt/python-3.13.11/bin/python"
            ln -s python3-config "${target.dir}/opt/python-3.13.11/bin/python-config"

            ln -s "/opt/python-3.13.11" "${target.dir}/opt/python"

            # shellcheck disable=SC2061,SC2035
            find "${target.dir}/opt/python-3.13.11" -depth \
              \( \
              \( -type d -a \( -name test -o -name tests -o -name idle_test \) \) \
              -o \( -type f -a \( -name '*.pyc' -o -name '*.pyo' -o -name 'libpython*.a' \) \) \
              \) -exec rm -rf '{}' +
        - name: strip
          uses: strip@v1
          with:
            dir: ${target.dir}/opt
      paths:
        - type: directory
          path: /tmp
          uid: 0
          gid: 0
      outputs:
        - source: ${target.dir}/opt
          target: /opt
          uid: 0
          gid: 0
        - source: /opt/docker/sbom
          target: /opt/docker/sbom
          uid: 0
          gid: 0
accounts:
  root: true
  run-as: root
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "12"
  version-codename: bookworm
  pretty-name: Docker Hardened Images/Debian GNU/Linux 12 (bookworm)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
environment:
  LD_LIBRARY_PATH: /opt/python/lib
  PATH: /opt/python/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
  PYTHON_VERSION: 3.13.11
  SSL_CERT_FILE: /etc/ssl/certs/ca-certificates.crt
