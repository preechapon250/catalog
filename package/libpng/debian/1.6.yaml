# syntax=dhi.io/build:1-debian13

image: dhi.io/pkg-libpng
variant: runtime
tags:
  - "1"
  - "1.6"
  - 1.6.53
  - 1-debian13
  - 1.6-debian13
  - 1.6.53-debian13
platforms:
  - linux/amd64
  - linux/arm64
vars:
  COMMIT_SHA: 4e3f57d50f552841550a36eabbb3fbcecacb7750
  DEBIAN_EPOCH_MAJOR_MINOR_VERSION: "1.6"
  DEBIAN_EPOCH_MAJOR_VERSION: "1"
  DEBIAN_EPOCH_VERSION: 1.6.53
  VERSION: 1.6.53
contents:
  packages:
    - base-files
  builds:
    - name: libpng deb
      pipeline:
        - name: libpng16-16t64 deb
          uses: deb/build@v1
          with:
            control: |
              Section: text
              Priority: optional
              Homepage: https://docker.com/dhi
              Standards-Version: 3.9.2

              Package: libpng16-16t64
              Version: 1.6.53
              Priority: optional
              Section: libs
              Source: libpng1.6
              Maintainer: Docker Hardened Images <dhi@docker.com>
              Maintainer: Docker Hardened Images <dhi@docker.com>
              Architecture: all
              Depends: libc6 (>= 2.29), zlib1g (>= 1:1.2.3.4)
              Homepage: http://libpng.org/pub/png/libpng.html
              Description: PNG library - runtime (version 1.6)
            dir: ${source.dir}/deb
        - name: libpng-dev deb
          uses: deb/build@v1
          with:
            control: |
              Section: text
              Priority: optional
              Homepage: https://docker.com/dhi
              Standards-Version: 3.9.2

              Package: libpng-dev
              Version: 1.6.53
              Priority: optional
              Section: libdevel
              Source: libpng1.6
              Maintainer: Docker Hardened Images <dhi@docker.com>
              Architecture: all
              Depends: libpng16-16t64 (= 1.6.53), zlib1g-dev
              Homepage: http://libpng.org/pub/png/libpng.html
              Description: PNG library - development (version 1.6)
            dir: ${source.dir}/deb
        - name: deb install
          uses: deb/install@v1
          with:
            files:
              - ${source.dir}/deb/libpng16-16t64_1.6.53_all.deb
              - ${source.dir}/deb/libpng-dev_1.6.53_all.deb
    - name: libpng build
      contents:
        packages:
          - bash
          - build-essential
          - coreutils
          - diffutils
          - dpkg-dev
          - findutils
          - grep
          - pkg-config
          - sed
          - zlib1g-dev
        files:
          - url: git+https://github.com/pnggroup/libpng.git#v1.6.53
            checksum: 4e3f57d50f552841550a36eabbb3fbcecacb7750
            path: ${source.dir}/libpng
            uid: 0
            gid: 0
      pipeline:
        - name: configure and build
          work-dir: ${source.dir}/libpng
          runs: |
            set -eux -o pipefail

            gnuArch="$(dpkg-architecture --query DEB_BUILD_GNU_TYPE)"

            ./configure \
              --prefix="${target.dir}/opt/libpng" \
              --build="$gnuArch" \
              --target="$gnuArch" \
              --host="$gnuArch" \
              --enable-shared \
              --disable-static \
              --disable-silent-rules

            make -j$(nproc)
            make install
            make check
        - uses: strip@v1
          with:
            dir: ${target.dir}/opt/libpng/bin
      outputs:
        - source: ${target.dir}/opt/libpng/lib
          target: /usr/lib
          uid: 0
          gid: 0
        - source: ${target.dir}/opt/libpng/include
          target: /usr/include
          uid: 0
          gid: 0
        - source: ${target.dir}/opt/libpng/bin
          target: /usr/bin
          uid: 0
          gid: 0
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
tests:
  - name: libpng library test
    directory: package/libpng/tests
    commands:
      - go test . -count=1 -v
    exit-code: 0
