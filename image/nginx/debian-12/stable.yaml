# syntax=dhi.io/build:1-debian12

name: Nginx stable
image: dhi.io/nginx
variant: runtime
tags:
  - 1.28-debian12
  - 1.28.1-debian12
platforms:
  - linux/amd64
  - linux/arm64
dates:
  release: "2025-04-23"
vars:
  DEBIAN_EPOCH_MAJOR_MINOR_VERSION: "1.28"
  DEBIAN_EPOCH_MAJOR_VERSION: "1"
  DEBIAN_EPOCH_VERSION: 1.28.1
  NGINX_REPOSITORY: deb [signed-by=/usr/share/keyrings/nginx-archive-keyring.gpg] https://nginx.org/packages/debian bookworm nginx
  VERSION: 1.28.1-1~bookworm
contents:
  repositories:
    - deb [signed-by=/usr/share/keyrings/nginx-archive-keyring.gpg] https://nginx.org/packages/debian bookworm nginx
  keyring:
    - https://nginx.org/keys/nginx_signing.key
  packages:
    - '!libelogind0'
    - '!original-awk'
    - base-files
    - coreutils
    - nginx
  builds:
    - name: nginx
      contents:
        repositories:
          - deb [signed-by=/usr/share/keyrings/nginx-archive-keyring.gpg] https://nginx.org/packages/debian bookworm nginx
        keyring:
          - https://nginx.org/keys/nginx_signing.key
        packages:
          - base-files
          - nginx
          - bash
          - coreutils
          - sed
        mappings:
          nginx: pkg:deb/nginx/nginx@1.28.1-1~bookworm?os_name=debian&os_version=12
      pipeline:
        - name: install
          runs: |
            set -eux -o pipefail

            ln -sf /dev/stdout /var/log/nginx/access.log
            ln -sf /dev/stderr /var/log/nginx/error.log

            sed -i "s,listen       80;,listen       8080;," /etc/nginx/conf.d/default.conf
            sed -i "/user  nginx;/d" /etc/nginx/nginx.conf
            sed -i "s,pid        /run/nginx.pid;,pid        /var/run/nginx.pid;," /etc/nginx/nginx.conf
            sed -i '/^http {$/a\    server_tokens off;' /etc/nginx/nginx.conf

            chown -R 65532:65532 /var/cache/nginx
            chmod -R g+w /var/cache/nginx
            chown -R 65532:65532 /etc/nginx
            chmod -R g+w /etc/nginx
            chown -R 65532:65532 /var/run
            chown -R 65532:65532 /var/log/nginx
      outputs:
        - source: /
          target: /
          uid: 0
          gid: 0
          diff: true
  mappings:
    nginx: pkg:deb/nginx/nginx@1.28.1-1~bookworm?os_name=debian&os_version=12
accounts:
  run-as: nginx
  users:
    - name: nginx
      uid: 65532
      gid: 65532
  groups:
    - name: nginx
      gid: 65532
      members:
        - nginx
    - name: www-data
      gid: 82
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "12"
  version-codename: bookworm
  pretty-name: Docker Hardened Images/Debian GNU/Linux 12 (bookworm)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
environment:
  NGINX_VERSION: 1.28.1-1~bookworm
annotations:
  org.opencontainers.image.description: A minimal Nginx image
  org.opencontainers.image.licenses: BSD-2-Clause
entrypoint:
  - nginx
cmd:
  - -g
  - daemon off;
ports:
  - 8080/tcp
tests:
  - name: Run testcontainers tests
    directory: image/nginx/tests
    commands:
      - go test . -count=1 -v
    exit-code: 0
