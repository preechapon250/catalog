# syntax=dhi.io/build:2-alpine3.22

name: Nginx mainline (dev)
image: dhi.io/nginx
variant: dev
tags:
  - 1-alpine3.22-dev
  - 1.29-alpine3.22-dev
  - 1.29.5-alpine3.22-dev
platforms:
  - linux/amd64
  - linux/arm64
dates:
  release: "2025-06-24"
vars:
  APK_MAJOR_MINOR_VERSION: "1.29"
  APK_MAJOR_VERSION: "1"
  APK_VERSION: 1.29.5
  NGINX_REPOSITORY: http://nginx.org/packages/mainline/alpine/v3.22/main
  VERSION: 1.29.5-r1
contents:
  repositories:
    - https://dl-cdn.alpinelinux.org/alpine/v3.22/main
    - https://dl-cdn.alpinelinux.org/alpine/v3.22/community
    - http://nginx.org/packages/mainline/alpine/v3.22/main
  keyring:
    - https://nginx.org/keys/nginx_signing.rsa.pub
  packages:
    - alpine-baselayout-data
    - apk-tools
    - busybox
    - gettext-envsubst
    - musl-utils
    - nginx=1.29.5-r1
  builds:
    - name: nginx
      contents:
        repositories:
          - https://dl-cdn.alpinelinux.org/alpine/v3.22/main
          - https://dl-cdn.alpinelinux.org/alpine/v3.22/community
          - http://nginx.org/packages/mainline/alpine/v3.22/main
        keyring:
          - https://nginx.org/keys/nginx_signing.rsa.pub
        packages:
          - alpine-baselayout-data
          - bash
          - musl-utils
          - nginx=1.29.5-r1
      pipeline:
        - name: install
          runs: |
            set -eux -o pipefail

            ln -sf /dev/stdout /var/log/nginx/access.log
            ln -sf /dev/stderr /var/log/nginx/error.log

            sed -i "s,listen       80;,listen       8080;," /etc/nginx/conf.d/default.conf
            sed -i "/user  nginx;/d" /etc/nginx/nginx.conf
            sed -i "s,pid        /run/nginx.pid;,pid        /var/run/nginx.pid;," /etc/nginx/nginx.conf
            sed -i '/^http {$/a\    server_tokens off;' /etc/nginx/nginx.conf

            chown -R 65532:65532 /var/cache/nginx
            chmod -R g+w /var/cache/nginx
            chown -R 65532:65532 /etc/nginx
            chmod -R g+w /etc/nginx
            chown -R 65532:65532 /run
            chown -R 65532:65532 /run/lock
            chown -R 65532:65532 /var/run
            chown -R 65532:65532 /var/log/nginx
      outputs:
        - source: /
          target: /
          uid: 0
          gid: 0
          diff: true
accounts:
  root: true
  run-as: root
  users:
    - name: nginx
      uid: 65532
      gid: 65532
  groups:
    - name: nginx
      gid: 65532
      members:
        - nginx
    - name: www-data
      gid: 82
os-release:
  name: Docker Hardened Images (Alpine)
  id: alpine
  version-id: "3.22"
  pretty-name: Docker Hardened Images/Alpine Linux v3.22
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
environment:
  NGINX_VERSION: 1.29.5-r1
paths:
  - type: file
    path: /usr/local/bin/entrypoint.sh
    uid: 0
    gid: 0
    mode: "0755"
    source: image/nginx/bin/entrypoint.sh
  - type: file
    path: /docker-entrypoint.d/10-listen-on-ipv6-by-default.sh
    uid: 0
    gid: 0
    mode: "0755"
    source: image/nginx/bin/10-listen-on-ipv6-by-default.sh
  - type: file
    path: /docker-entrypoint.d/15-local-resolvers.envsh
    uid: 0
    gid: 0
    mode: "0755"
    source: image/nginx/bin/15-local-resolvers.envsh
  - type: file
    path: /docker-entrypoint.d/20-envsubst-on-templates.sh
    uid: 0
    gid: 0
    mode: "0755"
    source: image/nginx/bin/20-envsubst-on-templates.sh
  - type: file
    path: /docker-entrypoint.d/30-tune-worker-processes.sh
    uid: 0
    gid: 0
    mode: "0755"
    source: image/nginx/bin/30-tune-worker-processes.sh
annotations:
  org.opencontainers.image.description: A minimal Nginx image
  org.opencontainers.image.licenses: BSD-2-Clause
entrypoint:
  - /usr/local/bin/entrypoint.sh
cmd:
  - nginx
  - -g
  - daemon off;
ports:
  - 8080/tcp
