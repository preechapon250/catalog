# syntax=dhi.io/build:2-debian13

name: Nginx mainline
image: dhi.io/nginx
variant: runtime
tags:
  - "1"
  - "1.29"
  - 1.29.4
  - 1-debian13
  - 1.29-debian13
  - 1.29.4-debian13
platforms:
  - linux/amd64
  - linux/arm64
dates:
  release: "2025-06-24"
vars:
  DEBIAN_EPOCH_MAJOR_MINOR_VERSION: "1.29"
  DEBIAN_EPOCH_MAJOR_VERSION: "1"
  DEBIAN_EPOCH_VERSION: 1.29.4
  NGINX_REPOSITORY: deb [signed-by=/usr/share/keyrings/nginx-archive-keyring.gpg] https://nginx.org/packages/mainline/debian trixie nginx
  VERSION: 1.29.4-1~trixie
contents:
  repositories:
    - deb [signed-by=/usr/share/keyrings/nginx-archive-keyring.gpg] https://nginx.org/packages/mainline/debian trixie nginx
  keyring:
    - https://nginx.org/keys/nginx_signing.key
  packages:
    - '!libelogind0'
    - '!mawk'
    - '!original-awk'
    - base-files
    - coreutils
    - nginx
  builds:
    - name: nginx
      contents:
        repositories:
          - deb [signed-by=/usr/share/keyrings/nginx-archive-keyring.gpg] https://nginx.org/packages/mainline/debian trixie nginx
        keyring:
          - https://nginx.org/keys/nginx_signing.key
        packages:
          - base-files
          - nginx
          - bash
          - coreutils
          - sed
        mappings:
          nginx: pkg:deb/nginx/nginx@1.29.4-1~trixie?os_name=debian&os_version=13
      pipeline:
        - name: install
          runs: |
            set -eux -o pipefail

            ln -sf /dev/stdout /var/log/nginx/access.log
            ln -sf /dev/stderr /var/log/nginx/error.log

            sed -i "s,listen       80;,listen       8080;," /etc/nginx/conf.d/default.conf
            sed -i "/user  nginx;/d" /etc/nginx/nginx.conf
            sed -i "s,pid        /run/nginx.pid;,pid        /var/run/nginx.pid;," /etc/nginx/nginx.conf
            sed -i '/^http {$/a\    server_tokens off;' /etc/nginx/nginx.conf

            chown -R 65532:65532 /var/cache/nginx
            chmod -R g+w /var/cache/nginx
            chown -R 65532:65532 /etc/nginx
            chmod -R g+w /etc/nginx
            chown -R 65532:65532 /var/run
            chown -R 65532:65532 /var/log/nginx
      outputs:
        - source: /
          target: /
          uid: 0
          gid: 0
          diff: true
  mappings:
    nginx: pkg:deb/nginx/nginx@1.29.4-1~trixie?os_name=debian&os_version=13
accounts:
  run-as: nginx
  users:
    - name: nginx
      uid: 65532
      gid: 65532
  groups:
    - name: nginx
      gid: 65532
      members:
        - nginx
    - name: www-data
      gid: 82
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
environment:
  NGINX_VERSION: 1.29.4-1~trixie
annotations:
  org.opencontainers.image.description: A minimal Nginx image
  org.opencontainers.image.licenses: BSD-2-Clause
entrypoint:
  - nginx
cmd:
  - -g
  - daemon off;
ports:
  - 8080/tcp
