# syntax=dhi.io/build:2-debian12

name: Temporal Server 1.28.x
image: dhi.io/temporalio-server
variant: runtime
tags:
  - 1.28-debian12
  - 1.28.2-debian12
  - 1.28.2-cli-1.5.1-debian12
platforms:
  - linux/amd64
  - linux/arm64
vars:
  ARCH: '#{ target.arch == "amd64" ? "amd64" : "arm64" }'
  CLI_COMMIT_SHA: 2445cdaeca0d2501a09837e388aa78ba1d65edaa
  CLI_VERSION: 1.5.1
  COMMIT_SHA: 09d90574e0f0ca65c33e19dc32a32f63579fc229
  DEBIAN_VERSION: "12"
  DOCKERIZE_COMMIT_SHA: 90dbb4fc2ef9098acd41e8c3ca98d2f730c741d6
  DOCKERIZE_VERSION: 0.9.5
  GO_DIGEST: sha256:ed55bf45b6dd98512e2faaf4425f23397d76ca767e565a9c284691f5c247c593
  GO_VARIANT_SUFFIX: -dev
  GO_VERSION: 1.25.5
  SEMVER_MAJOR_MINOR_VERSION: "1.28"
  SEMVER_MAJOR_VERSION: "1"
  SEMVER_VERSION: 1.28.2
  VERSION: 1.28.2
contents:
  packages:
    - bash
    - ca-certificates
    - coreutils
    - curl
    - grep
    - netcat-openbsd
    - sed
    - tzdata
  builds:
    - name: build-base-dockerize
      uses: dhi.io/golang:1.25.5-debian12-dev@sha256:ed55bf45b6dd98512e2faaf4425f23397d76ca767e565a9c284691f5c247c593
      privileged: true
      contents:
        packages:
          - ca-certificates
        files:
          - url: git+https://github.com/jwilder/dockerize.git#v0.9.5
            path: /go/src/github.com/jwilder/dockerize
            spdx:
              name: dockerize
              version: 0.9.5
              packages:
                - name: dockerize
                  purl: pkg:golang/github.com/jwilder/dockerize@0.9.5
                  license: MIT
            uid: 0
            gid: 0
      pipeline:
        - name: verify dockerize source repo
          uses: git/checkout@v1
          work-dir: /go/src/github.com/jwilder/dockerize
          with:
            expected-commit: 90dbb4fc2ef9098acd41e8c3ca98d2f730c741d6
        - name: go dependencies
          uses: go/bump@v1
          work-dir: /go/src/github.com/jwilder/dockerize
          with:
            deps:
              - golang.org/x/crypto@v0.45.0
            download: true
        - name: build dockerize
          work-dir: /go/src/github.com/jwilder/dockerize
          runs: |
            set -eux -o pipefail

            CGO_ENABLED=0 go build -o ${target.dir}/usr/local/bin/dockerize
      outputs:
        - source: ${target.dir}/usr/local/bin/dockerize
          target: /usr/local/bin/dockerize
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/dockerize
          target: /opt/docker/sbom/dockerize
          uid: 0
          gid: 0
    - name: build-temporal-server-binaries
      uses: dhi.io/golang:1.25.5-debian12-dev@sha256:ed55bf45b6dd98512e2faaf4425f23397d76ca767e565a9c284691f5c247c593
      privileged: true
      contents:
        packages:
          - ca-certificates
          - sed
        files:
          - url: git+https://github.com/temporalio/temporal.git#v1.28.2
            path: /go/src/go.temporal.io/server
            spdx:
              name: temporalio-server
              version: 1.28.2
              packages:
                - name: temporal-server
                  purl: pkg:golang/go.temporal.io/server@1.28.2
                  license: MIT
                - name: tdbg
                  purl: pkg:golang/go.temporal.io/server/cmd/tools/tdbg@1.28.2
                  license: MIT
            uid: 0
            gid: 0
      pipeline:
        - name: verify temporal server source commit
          uses: git/checkout@v1
          work-dir: /go/src/go.temporal.io/server
          with:
            expected-commit: 09d90574e0f0ca65c33e19dc32a32f63579fc229
        - name: go dependencies
          uses: go/bump@v1
          work-dir: /go/src/go.temporal.io/server
          with:
            deps:
              - github.com/golang-jwt/jwt/v4@v4.5.2
              - golang.org/x/crypto@v0.45.0
            download: true
        - name: build temporal server binaries
          work-dir: /go/src/go.temporal.io/server
          runs: |
            set -eux -o pipefail

            CGO_ENABLE=0 go build -o ${target.dir}/usr/local/bin/temporal-server ./cmd/server
            CGO_ENABLE=0 go build -o ${target.dir}/usr/local/bin/tdbg ./cmd/tools/tdbg
        - name: test temporal server binaries
          shell: bash
          runs: |
            set -eux -o pipefail

            ${target.dir}/usr/local/bin/temporal-server --help
            ${target.dir}/usr/local/bin/tdbg --help

            echo "Running core temporal unit tests..."
            go test -C /go/src/go.temporal.io/server -v -timeout=3m ./common/log/...
            go test -C /go/src/go.temporal.io/server -v -timeout=3m ./common/config/...
            go test -C /go/src/go.temporal.io/server -v -timeout=3m ./common/util/...
      outputs:
        - source: ${target.dir}/usr/local/bin
          target: /usr/local/bin
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/temporalio-server
          target: /opt/docker/sbom/temporalio-server
          uid: 0
          gid: 0
    - name: build-cli
      uses: dhi.io/golang:1.25.5-debian12-dev@sha256:ed55bf45b6dd98512e2faaf4425f23397d76ca767e565a9c284691f5c247c593
      privileged: true
      contents:
        packages:
          - ca-certificates
        files:
          - url: git+https://github.com/temporalio/cli.git#v1.5.1
            path: /go/src/github.com/temporalio/cli
            spdx:
              name: temporal-cli
              version: 1.5.1
              packages:
                - name: temporal-cli
                  purl: pkg:dhi/temporal-cli@1.5.1
                  license: MIT
            uid: 0
            gid: 0
      pipeline:
        - name: verify temporal cli source commit
          uses: git/checkout@v1
          work-dir: /go/src/github.com/temporalio/cli
          with:
            expected-commit: 2445cdaeca0d2501a09837e388aa78ba1d65edaa
        - name: go dependencies
          uses: go/bump@v1
          work-dir: /go/src/github.com/temporalio/cli
          with:
            deps:
              - github.com/golang-jwt/jwt/v4@v4.5.2
              - golang.org/x/crypto@v0.45.0
              - go.temporal.io/server@v1.29.2
            download: true
        - name: build temporal CLI binary
          work-dir: /go/src/github.com/temporalio/cli
          runs: |
            set -eux -o pipefail

            CGO_ENABLED=0 go build -o "${target.dir}/usr/local/bin/temporal" ./cmd/temporal
        - name: test temporal CLI binary
          shell: bash
          runs: |
            set -eux -o pipefail

            ${target.dir}/usr/local/bin/temporal --help
      outputs:
        - source: ${target.dir}/usr/local/bin/temporal
          target: /usr/local/bin/temporal
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/temporal-cli
          target: /opt/docker/sbom/temporal-cli
          uid: 0
          gid: 0
    - name: build-configs
      uses: dhi.io/golang:1.25.5-debian12-dev@sha256:ed55bf45b6dd98512e2faaf4425f23397d76ca767e565a9c284691f5c247c593
      privileged: true
      contents:
        packages:
          - ca-certificates
          - coreutils
          - sed
          - gawk
          - diffutils
          - grep
        files:
          - url: git+https://github.com/temporalio/temporal.git#v1.28.2
            path: ${source.dir}/temporal
            uid: 0
            gid: 0
          - url: git+https://github.com/temporalio/docker-builds.git#main
            path: ${source.dir}/docker-builds
            uid: 0
            gid: 0
      pipeline:
        - name: stage configs and scripts
          shell: bash
          runs: |
            set -eux -o pipefail

            cd "${source.dir}"

            mkdir -p "${target.dir}/etc/temporal/config/dynamicconfig"
            mkdir -p "${target.dir}/etc/temporal/schema"

            # Copy configuration files and scripts
            cp temporal/config/dynamicconfig/docker.yaml "${target.dir}/etc/temporal/config/dynamicconfig/docker.yaml"
            cp temporal/docker/config_template.yaml "${target.dir}/etc/temporal/config/config_template.yaml"
            cp -r temporal/schema "${target.dir}/etc/temporal/"

            # Create modified entrypoint script that uses /etc/hosts instead of getent
            cp docker-builds/docker/entrypoint.sh "${source.dir}/entrypoint.sh"

            # Replace getent commands with /etc/hosts parsing to avoid the getent dependency.
            sed -i 's/getent hosts "\$(hostname)"/cat \/etc\/hosts | grep -v ^# | grep "\$HOSTNAME"/g' "${source.dir}/entrypoint.sh"

            # Sanity check: Verify exactly 8 diff lines (2 getent replacements)
            diff_count=$(diff docker-builds/docker/entrypoint.sh "${source.dir}/entrypoint.sh" | wc -l || true)
            if [ "$diff_count" -ne 8 ]; then
              echo "ERROR: Expected exactly 8 diff lines (2 getent replacements), got $diff_count"
              echo "This suggests the upstream entrypoint.sh has changed significantly."
              echo "Diff output:"
              diff docker-builds/docker/entrypoint.sh "${source.dir}/entrypoint.sh" || true
              exit 1
            fi

            # Verify the modified script contains our expected /etc/hosts logic
            if ! grep -q "cat /etc/hosts | grep -v \^#" "${source.dir}/entrypoint.sh"; then
              echo "ERROR: Modified entrypoint script does not contain expected /etc/hosts logic"
              exit 1
            fi

            # Copy the modified entrypoint script, and the other scripts that didn't require modification.
            cp "${source.dir}/entrypoint.sh" "${target.dir}/etc/temporal/entrypoint.sh"
            cp docker-builds/docker/start-temporal.sh "${target.dir}/etc/temporal/start-temporal.sh"
            cp docker-builds/docker/auto-setup.sh "${target.dir}/etc/temporal/auto-setup.sh"

            chmod +x "${target.dir}/etc/temporal/"*.sh
      outputs:
        - source: ${target.dir}/etc/temporal
          target: /etc/temporal
          uid: 0
          gid: 0
    - name: install temporal-sql-tool
      uses: dhi.io/golang:1.25.5-debian12-dev@sha256:ed55bf45b6dd98512e2faaf4425f23397d76ca767e565a9c284691f5c247c593
      privileged: true
      contents:
        packages:
          - ca-certificates
        files:
          - url: git+https://github.com/temporalio/temporal.git#v1.28.2
            path: /go/src/go.temporal.io/server
            spdx:
              name: temporal-sql-tool
              version: 1.28.2
              packages:
                - name: temporal-sql-tool
                  purl: pkg:golang/go.temporal.io/server/cmd/tools/sql@1.28.2
                  license: MIT
            uid: 0
            gid: 0
      pipeline:
        - name: verify temporal server source commit
          uses: git/checkout@v1
          work-dir: /go/src/go.temporal.io/server
          with:
            expected-commit: 09d90574e0f0ca65c33e19dc32a32f63579fc229
        - name: patch uses of crypto/md5
          uses: git/patch@v1
          work-dir: /go/src/go.temporal.io/server
          with:
            patch: ${source.dir}/patch/no-md5.patch
        - name: go dependencies
          uses: go/bump@v1
          work-dir: /go/src/go.temporal.io/server
          with:
            deps:
              - github.com/golang-jwt/jwt/v4@v4.5.2
              - golang.org/x/crypto@v0.45.0
            download: true
        - name: build temporal-sql-tool
          work-dir: /go/src/go.temporal.io/server
          runs: |
            set -eux -o pipefail

            CGO_ENABLED=0 go build -o ${target.dir}/usr/local/bin/temporal-sql-tool ./cmd/tools/sql
        - name: test temporal-sql-tool binaries
          shell: bash
          runs: |
            set -eux -o pipefail

            ${target.dir}/usr/local/bin/temporal-sql-tool --help
      paths:
        - type: directory
          path: /src/patch
          uid: 0
          gid: 0
          source: image/temporalio-server/patch
      outputs:
        - source: ${target.dir}/usr/local/bin/temporal-sql-tool
          target: /usr/local/bin/temporal-sql-tool
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/temporal-sql-tool
          target: /opt/docker/sbom/temporal-sql-tool
          uid: 0
          gid: 0
    - name: install temporal-cassandra-tool
      uses: dhi.io/golang:1.25.5-debian12-dev@sha256:ed55bf45b6dd98512e2faaf4425f23397d76ca767e565a9c284691f5c247c593
      privileged: true
      contents:
        packages:
          - ca-certificates
        files:
          - url: git+https://github.com/temporalio/temporal.git#v1.28.2
            path: /go/src/go.temporal.io/server
            spdx:
              name: temporal-cassandra-tool
              version: 1.28.2
              packages:
                - name: temporal-cassandra-tool
                  purl: pkg:golang/go.temporal.io/server/cmd/tools/cassandra@1.28.2
                  license: MIT
            uid: 0
            gid: 0
      pipeline:
        - name: verify temporal server source commit
          uses: git/checkout@v1
          work-dir: /go/src/go.temporal.io/server
          with:
            expected-commit: 09d90574e0f0ca65c33e19dc32a32f63579fc229
        - name: go dependencies
          uses: go/bump@v1
          work-dir: /go/src/go.temporal.io/server
          with:
            deps:
              - github.com/golang-jwt/jwt/v4@v4.5.2
              - golang.org/x/crypto@v0.45.0
            download: true
        - name: build temporal-cassandra-tool
          work-dir: /go/src/go.temporal.io/server
          runs: |
            set -eux -o pipefail

            CGO_ENABLED=0 go build -o ${target.dir}/usr/local/bin/temporal-cassandra-tool ./cmd/tools/cassandra
        - name: test temporal-cassandra-tool binaries
          shell: bash
          runs: |
            set -eux -o pipefail

            ${target.dir}/usr/local/bin/temporal-cassandra-tool --help
      outputs:
        - source: ${target.dir}/usr/local/bin/temporal-cassandra-tool
          target: /usr/local/bin/temporal-cassandra-tool
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/temporal-cassandra-tool
          target: /opt/docker/sbom/temporal-cassandra-tool
          uid: 0
          gid: 0
accounts:
  run-as: temporal
  users:
    - name: temporal
      uid: 1000
      gid: 1000
  groups:
    - name: temporal
      gid: 1000
      members:
        - temporal
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "12"
  version-codename: bookworm
  pretty-name: Docker Hardened Images/Debian GNU/Linux 12 (bookworm)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
work-dir: /etc/temporal
environment:
  TEMPORAL_HOME: /etc/temporal
paths:
  - type: symlink
    path: /usr/bin/nc
    uid: 0
    gid: 0
    source: /usr/bin/nc.openbsd
  - type: directory
    path: /etc/temporal/config
    uid: 1000
    gid: 1000
    mode: "0777"
annotations:
  org.opencontainers.image.description: Temporal Server - Workflow as Code to build and operate resilient applications
  org.opencontainers.image.licenses: MIT
entrypoint:
  - /etc/temporal/entrypoint.sh
ports:
  - 6933/tcp
  - 6934/tcp
  - 6935/tcp
  - 6939/tcp
  - 7233/tcp
  - 7234/tcp
  - 7235/tcp
  - 7239/tcp
