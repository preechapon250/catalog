# syntax=dhi.io/build:2-debian13

name: MySQL Operator ${DEBIAN_EPOCH_MAJOR_MINOR_VERSION}.x
image: dhi.io/mysql-operator
variant: runtime
tags:
  - 8.4.8-2.1.10
  - 8.4.8-2.1.10-debian13
platforms:
  - linux/amd64
  - linux/arm64
dates:
  release: "2024-04-10"
  end-of-life: "2032-04-30"
vars:
  ANTLR_COMMIT_SHA: cc82115a4e7f53d71d9d905caa2c2dfa4da58899
  ANTLR_VERSION: 4.13.2
  BASE_DIGEST: sha256:74fc43fa240887b8159970e434244039aab0c6efaaa9cf044004cdc22aa2a34d
  BASE_TAG: 20250419-debian13
  COMMIT_SHA: 1bbaa51818489443c052a2b11c049214ae557122
  MYSQL_COMMIT_SHA: 0896fcd61dec11a0904166911a0126f59daaa1bf
  MYSQL_SHELL_COMMIT_SHA: 561cd3dad0eb619e5749a3b1a05c34ba2c54f324
  MYSQL_VERSION: 8.4.8
  PYTHON_DEV_REFERENCE: dhi/python:3.13.12-debian13-dev@sha256:e804df61d954e90edc605f29bfc89d22df071bd35709f42cc8d783b718c41b97
  PYTHON_REFERENCE: dhi/python:3.13.12-debian13@sha256:e3ce38c682400c9fd4872709d88f9dc4f4373cf097a72c10bd80eeecf1198338
  SEMVER_MAJOR_MINOR_VERSION: "8.4"
  SEMVER_MAJOR_VERSION: "8"
  SEMVER_VERSION: 8.4.8
  VERSION: 8.4.8-2.1.10
contents:
  packages:
    - '!libelogind0'
    - '!mawk'
    - '!original-awk'
    - base-files
    - bash
    - coreutils
    - curl
    - libssh-4
    - libssl3t64
    - libstdc++6
  builds:
    - name: mysql-operator
      uses: dhi.io/python:3.13.12-debian13-dev@sha256:e804df61d954e90edc605f29bfc89d22df071bd35709f42cc8d783b718c41b97
      contents:
        packages:
          - bash
          - bison
          - build-essential
          - ca-certificates
          - cmake
          - coreutils
          - diffutils
          - gpg
          - gpg-agent
          - gzip
          - libabsl-dev
          - libaio-dev
          - libboost-all-dev
          - libc-bin
          - libncurses-dev
          - libssl-dev
          - libtirpc-dev
          - pkg-config
          - sed
          - tar
          - wget
          - xz-utils
          - zlib1g-dev
          - libfido2-dev
          - libkrb5-dev
          - libldap2-dev
          - libsasl2-dev
          - libsasl2-modules-gssapi-mit
          - libudev-dev
          - libcurl4-openssl-dev
          - libssh-dev
          - patchelf
        files:
          - url: git+https://github.com/mysql/mysql-operator#8.4.8-2.1.10
            checksum: 1bbaa51818489443c052a2b11c049214ae557122
            path: ${source.dir}/mysql-operator
            spdx:
              name: mysql-operator
              version: 8.4.8-2.1.10
              packages:
                - name: mysql-operator
                  purl: pkg:github/mysql/mysql-operator@8.4.8-2.1.10
                  license: UPL-1.0
            uid: 0
            gid: 0
          - url: git+https://github.com/mysql/mysql-server#mysql-8.4.8
            checksum: 0896fcd61dec11a0904166911a0126f59daaa1bf
            path: ${source.dir}/mysql-server
            spdx:
              name: mysql
              version: 8.4.8
              packages:
                - name: mysql
                  purl: pkg:github/mysql/mysql-server@8.4.8
                  license: GPL-2.0-only
            uid: 0
            gid: 0
          - url: git+https://github.com/antlr/antlr4#4.13.2
            checksum: cc82115a4e7f53d71d9d905caa2c2dfa4da58899
            path: ${source.dir}/antlr4
            spdx:
              name: antlr4
              version: 4.13.2
              packages:
                - name: antlr4
                  purl: pkg:github/antlr/antlr4@4.13.2
                  license: BSD-3-Clause
            uid: 0
            gid: 0
          - url: git+https://github.com/mysql/mysql-shell#8.4.8
            checksum: 561cd3dad0eb619e5749a3b1a05c34ba2c54f324
            path: ${source.dir}/mysql-shell
            spdx:
              name: mysqlsh
              version: 8.4.8
              packages:
                - name: mysqlsh
                  purl: pkg:github/mysql/mysql-shell@8.4.8
                  license: GPL-2.0-only
            uid: 0
            gid: 0
      pipeline:
        - name: build mysql server
          work-dir: ${source.dir}/mysql-server
          runs: |
            set -eux -o pipefail

            mkdir build && cd build

            CMAKE_FLAGS="-DWITH_DEBUG=OFF
              -DWITH_UNIT_TESTS=OFF
              -DWITH_ARCHIVE_STORAGE_ENGINE=OFF
              -DWITH_BLACKHOLE_STORAGE_ENGINE=OFF
              -DWITH_FEDERATED_STORAGE_ENGINE=OFF
              -DWITH_EXAMPLE_STORAGE_ENGINE=OFF
              -DWITH_NDBCLUSTER_STORAGE_ENGINE=OFF
              -DWITH_ROUTER=OFF
              -DINSTALL_MYSQLTESTDIR=
              -DWITH_AUTHENTICATION_KERBEROS=ON
              -DWITH_AUTHENTICATION_LDAP=ON
              -DWITH_AUTHENTICATION_WEBAUTHN=ON
              -DWITH_NDB=OFF"

            # This is not in later versions of Mysql
            if [ "8.4" = "8.0" ]; then
              CMAKE_FLAGS="${CMAKE_FLAGS}
                -DWITH_BOOST=${source.dir}/boost
                -DWITH_PROTOBUF=bundled
                -Dprotobuf_BUILD_SHARED_LIBS=OFF"
            fi

            if [ "8.4" = "9.6" ]; then
              CMAKE_FLAGS="${CMAKE_FLAGS}
                -DWITH_ROUTER=ON"
            fi

            cmake .. $CMAKE_FLAGS

            make -j"$(nproc)"
        - name: build antlr4 runtime
          work-dir: ${source.dir}/antlr4/runtime/Cpp
          privileged: true
          runs: |
            set -eux -o pipefail

            mkdir build && mkdir run && cd build

            cmake ..
            make

            DESTDIR=${target.dir}/antlr4 make install
        - name: build mysql shell
          work-dir: ${source.dir}/mysql-shell
          runs: |
            set -eux -o pipefail

            mkdir build && cd build

            CMAKE_FLAGS="-DMYSQL_SOURCE_DIR=${source.dir}/mysql-server
              -DMYSQL_BUILD_DIR=${source.dir}/mysql-server/build
              -DHAVE_PYTHON=1
              -DBUNDLED_ANTLR_DIR=${target.dir}/antlr4/usr/local
              -DCMAKE_INSTALL_PREFIX=${target.dir}/mysql-shell"

            cmake .. $CMAKE_FLAGS

            make -j"$(nproc)"

            make install
        - name: patch requirements.txt
          work-dir: ${source.dir}/mysql-operator/docker-deps
          runs: |
            set -eux -o pipefail

            sed -i 's/aiohttp==3\.13\.2/aiohttp==3.13.3/g' requirements.txt # CVE-2025-69223
            sed -i 's/pyasn1==0\.6\.1/pyasn1==0.6.2/g' requirements.txt     # CVE-2026-23490
            sed -i 's/urllib3==2\.6\.2/urllib3==2.6.3/g' requirements.txt   # CVE-2026-21441
        - name: install python deps
          work-dir: ${source.dir}/mysql-operator/docker-deps
          privileged: true
          runs: |
            set -eux -o pipefail

            python3 -m pip install --target=${target.dir}/mysql-shell/lib/mysqlsh/python-packages -r requirements.txt --no-deps
        - name: install mysql-shell python bundled deps
          work-dir: ${source.dir}/mysql-operator/docker-deps
          privileged: true
          runs: |
            set -eux -o pipefail

            cat > mysqlsh-bundled-requirements.txt << EOF
              antlr4-python3-runtime==4.13.2
              bcrypt==4.3.0
              cffi==2.0.0
              circuitbreaker==2.1.3
              cryptography==46.0.5
              invoke==2.2.0
              oci==2.164.0
              paramiko==4.0.0
              pyOpenSSL==25.1.0
              pycparser==2.23
              pytz==2025.2
              svg.py==1.6.0
            EOF

            python3 -m pip install --target=${target.dir}/mysql-shell/lib/mysqlsh/python-packages -r mysqlsh-bundled-requirements.txt --no-deps
        - name: install mysql operator
          work-dir: ${source.dir}/mysql-operator
          runs: |
            set -eux -o pipefail

            cp -r mysqloperator ${target.dir}/mysql-shell/lib/mysqlsh/python-packages/

            # Workaround for BC issue with newest Python library for Kubernetes
            # See move here: https://github.com/kubernetes-client/python/issues/1718
            sed -i "s/available_replicas=None,/available_replicas=0,/" ${target.dir}/mysql-shell/lib/mysqlsh/python-packages/kubernetes/client/models/v1_stateful_set_status.py

            ${target.dir}/mysql-shell/bin/mysqlsh --pym compileall ${target.dir}/mysql-shell/lib/mysqlsh/python-packages
      outputs:
        - source: ${source.dir}/mysql-server/build/runtime_output_directory/mysql_config_editor
          target: /usr/libexec/mysqlsh/mysql_config_editor
          uid: 2
          gid: 2
        - source: ${source.dir}/mysql-server/build/plugin_output_directory/authentication_oci_client.so
          target: /usr/local/lib/mysql/plugins/authentication_oci_client.so
          uid: 2
          gid: 2
        - source: ${source.dir}/mysql-server/build/plugin_output_directory/authentication_kerberos_client.so
          target: /usr/local/lib/mysql/plugins/authentication_kerberos_client.so
          uid: 2
          gid: 2
        - source: ${source.dir}/mysql-server/build/plugin_output_directory/authentication_ldap_sasl_client.so
          target: /usr/local/lib/mysql/plugins/authentication_ldap_sasl_client.so
          uid: 2
          gid: 2
        - source: ${target.dir}/mysql-shell/bin/mysqlsh
          target: /usr/local/bin/mysqlsh
          uid: 2
          gid: 2
        - source: ${target.dir}/mysql-shell/bin/mysql-secret-store-login-path
          target: /usr/local/bin/mysql-secret-store-login-path
          uid: 2
          gid: 2
        - source: ${target.dir}/mysql-shell/lib/mysqlsh
          target: /usr/local/lib/mysqlsh
          uid: 2
          gid: 2
        - source: ${target.dir}/mysql-shell/share/mysqlsh
          target: /usr/local/share/mysqlsh
          uid: 2
          gid: 2
        - source: /opt/docker/sbom/mysqlsh
          target: /opt/docker/sbom/mysqlsh
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/mysql-operator
          target: /opt/docker/sbom/mysql-operator
          uid: 0
          gid: 0
  artifacts:
    - name: dhi.io/python:3.13.12-debian13@sha256:e3ce38c682400c9fd4872709d88f9dc4f4373cf097a72c10bd80eeecf1198338
      includes:
        - opt/**
        - usr/**
      uid: 0
      gid: 0
    - name: dhi.io/static:20250419-debian13@sha256:74fc43fa240887b8159970e434244039aab0c6efaaa9cf044004cdc22aa2a34d
      includes:
        - bin
        - etc
        - home
        - lib
        - lib64
        - opt
        - sbin
        - tmp
        - usr
        - var
      excludes:
        - etc/group
        - etc/os-release
        - etc/passwd
        - var/lib/dpkg/status
      uid: 0
      gid: 0
accounts:
  run-as: mysql-operator
  users:
    - name: mysql
      uid: 27
      gid: 27
    - name: mysql-operator
      uid: 2
      gid: 2
  groups:
    - name: mysql
      gid: 27
      members:
        - mysql
    - name: mysql-operator
      gid: 2
      members:
        - mysql-operator
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
environment:
  HOME: /mysqlsh
paths:
  - type: directory
    path: /mysqlsh
    uid: 2
    gid: 2
annotations:
  org.opencontainers.image.description: A minimal MySQL Operator image
  org.opencontainers.image.licenses: UPL 1.0
