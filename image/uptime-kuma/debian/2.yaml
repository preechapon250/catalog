# syntax=dhi/build:1-debian13

# DO NOT EDIT THIS FILE MANUALLY
# generated with 'dhi def merge image/uptime-kuma/debian/2.yaml'

name: Uptime Kuma 2.x
image: dhi/uptime-kuma
variant: runtime
tags:
    - "2"
    - "2.0"
    - 2.0.2
    - 2-debian13
    - 2.0-debian13
    - 2.0.2-debian13
platforms:
    - linux/amd64
    - linux/arm64
vars:
    COMMIT_SHA: c451db542d7c36c66d10a4218628bc6cc0d314a9
    NODE_BUILD_REFERENCE: dhi/node:24.11.1-debian13-dev@sha256:61842dcde615e7f8165deedf661a15170d7be1e4a2649e8330fad312ec50f85b
    NODE_BUILD_VERSION: 24.11.1
    NODE_RUNTIME_REFERENCE: dhi/node:24.11.1-debian13@sha256:be4fd5f42c722bee4e5b8edad60e49b0b0fcb3bda59ecab6a83e9efce37d4a97
    NODE_RUNTIME_VERSION: 24.11.1
    SEMVER_MAJOR_MINOR_VERSION: "2.0"
    SEMVER_MAJOR_VERSION: "2"
    SEMVER_VERSION: 2.0.2
    VERSION: 2.0.2
contents:
    packages:
        - '!base-files'
    builds:
        - name: uptime-kuma
          uses: dhi/node:24.11.1-debian13-dev@sha256:61842dcde615e7f8165deedf661a15170d7be1e4a2649e8330fad312ec50f85b
          contents:
            packages:
                - jq
            files:
                - url: git+https://github.com/louislam/uptime-kuma.git#2.0.2
                  checksum: c451db542d7c36c66d10a4218628bc6cc0d314a9
                  path: ${source.dir}/uptime-kuma-c451db542d7c36c66d10a4218628bc6cc0d314a9
                  uid: 0
                  gid: 0
          pipeline:
            - name: bump
              uses: npm/bump@v1
              privileged: true
              with:
                bumps: ${source.dir}/patch/npm-bump-v2.json
                npm-root: ${source.dir}/uptime-kuma-c451db542d7c36c66d10a4218628bc6cc0d314a9
            - name: install and build
              work-dir: ${source.dir}/uptime-kuma-c451db542d7c36c66d10a4218628bc6cc0d314a9
              privileged: true
              runs: |
                set -eux -o pipefail

                npm ci
                if [ "2" = "1" ]; then
                  npm test # ensure our version bumps have not broken anything
                else
                  npm run test-backend || true # Run backend tests only (skip E2E tests which require Playwright/browser dependencies)
                fi
                npm run build
                rm -r node_modules
                npm ci --omit=dev
            - name: copy app files
              work-dir: ${source.dir}/uptime-kuma-c451db542d7c36c66d10a4218628bc6cc0d314a9
              runs: |
                set -eux -o pipefail

                mkdir -p "${target.dir}/src"

                # Copy over app and dependencies, plus extra files referenced during runtime
                # (`package.json`, `util.js`), ignoring tests/, public/, config/, docker/,
                # and src/ directories
                cp -r package.json dist db server node_modules "${target.dir}"
                cp src/util.js "${target.dir}/src/util.js"
            - name: prepare frontend workspace
              work-dir: ${source.dir}/uptime-kuma-c451db542d7c36c66d10a4218628bc6cc0d314a9
              runs: |
                set -eux -o pipefail

                # Generate a workspace and `package.json` for the frontend by filtering
                # out dev dependencies from existing package
                mkdir frontend
                jq --slurp '
                  .[0] as $pkg |
                  .[1] as $excl |
                  $pkg.devDependencies |
                  to_entries |
                  map(
                    select(
                      [.key] | inside($excl) | not
                    )
                  ) |
                  from_entries |
                  {
                    name: "frontend",
                    version: "2.0.2",
                    dependencies: .
                  }' package.json ./hack/exclude-dev-dependencies.json > ./frontend/package.json
                cp package.json package.json.original
                jq '. | .workspaces = ["frontend"]' package.json.original > package.json
            - name: generate frontend sbom
              work-dir: ${source.dir}/uptime-kuma-c451db542d7c36c66d10a4218628bc6cc0d314a9
              privileged: true
              runs: |
                set -eux -o pipefail

                npm install --workspace=frontend --package-lock-only

                mkdir "${target.dir}/sbom"
                npm sbom --workspace=frontend --package-lock-only --sbom-format=spdx > "${target.dir}/sbom/.spdx.dhi-uptime-kuma-frontend.json"
          paths:
            - type: directory
              path: ${source.dir}/patch
              uid: 0
              gid: 0
              source: image/uptime-kuma/patch
            - type: file
              path: ${source.dir}/uptime-kuma-c451db542d7c36c66d10a4218628bc6cc0d314a9/hack/exclude-dev-dependencies.json
              uid: 0
              gid: 0
              source: image/uptime-kuma/patch/exclude-dev-dependencies.json
          outputs:
            - source: ${target.dir}
              target: /app
              uid: 0
              gid: 0
            - source: /opt/docker/sbom/
              target: /opt/docker/sbom/
              uid: 0
              gid: 0
            - source: ${target.dir}/sbom/
              target: /opt/docker/sbom/dhi-uptime-kuma-frontend
              uid: 0
              gid: 0
    artifacts:
        - name: dhi/node:24.11.1-debian13@sha256:be4fd5f42c722bee4e5b8edad60e49b0b0fcb3bda59ecab6a83e9efce37d4a97
          uid: 0
          gid: 0
accounts:
    root: true
    run-as: node
    users:
        - name: node
          uid: 1000
          gid: 1000
    groups:
        - name: node
          gid: 1000
          members:
            - node
os-release:
    name: Docker Hardened Images (Debian)
    id: debian
    version-id: "13"
    version-codename: trixie
    pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
    home-url: https://docker.com/products/hardened-images/
    bug-report-url: https://docker.com/support/
work-dir: /app
paths:
    - type: directory
      path: /app
      uid: 0
      gid: 0
      mode: "0755"
    - type: directory
      path: /app/data
      uid: 1000
      gid: 1000
      mode: "0755"
annotations:
    org.opencontainers.image.description: A minimal Uptime Kuma image
    org.opencontainers.image.licenses: MIT
cmd:
    - node
    - /app/server/server.js
ports:
    - 3001/tcp
tests:
    - name: Run testcontainers tests
      directory: image/uptime-kuma/tests
      commands:
        - go test . -count=1 -v
      exit-code: 0
    - name: Run common testcontainers tests
      directory: test/go-testing/base
      commands:
        - go test . -count=1 -v
      exit-code: 0
