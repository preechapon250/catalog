# syntax=dhi.io/build:2-debian13

name: WireMock 3.x
image: dhi.io/wiremock
variant: runtime
tags:
  - "3"
  - "3.13"
  - 3-debian13
  - 3.13-debian13
platforms:
  - linux/amd64
  - linux/arm64
vars:
  COMMIT_SHA: 88587aa13b4899da080538e1b21bec0da105491e
  DEBIAN_REFERENCE: dhi/debian-base:trixie-debian13@sha256:9ef766670af4743904b0f992a26b525c6c914648b56ea597ec23452adcf1a95d
  GRADLE_REFERENCE: dhi/gradle:8.14.4-jdk17-debian13-dev@sha256:9e99ca5fc12751435832d452ac2aab0bedca9475fd565521b0608b679fdf7733
  GRADLE_VERSION: 8.14.4
  JAVA_HOME_PATH: /opt/java/openjdk/17-jre
  JAVA_MAJOR_VERSION: "17"
  JRE_REF: dhi/eclipse-temurin:17.0.18.8-debian13@sha256:e86ccb5c8b66bf58cac5e2ca508ef711669fcc00e5508c90fc8e90ad352b64ec
  JRE_VERSION: 17.0.18.8
  NODE_REFERENCE: dhi/node:25.6.1-debian13-dev@sha256:4475f7d3dc74e2a727315c64e0d70e3879385de10788c4a0573ff5b04d175dd5
  NODE_VERSION: 25.6.1
  SEMVER_MAJOR_MINOR_VERSION: "3.13"
  SEMVER_MAJOR_VERSION: "3"
  SEMVER_VERSION: 3.13.2
  VERSION: 3.13.2
contents:
  packages:
    - '!libelogind0'
    - '!mawk'
    - '!original-awk'
    - base-files
  builds:
    - name: wiremock
      uses: dhi.io/gradle:8.14.4-jdk17-debian13-dev@sha256:9e99ca5fc12751435832d452ac2aab0bedca9475fd565521b0608b679fdf7733
      contents:
        packages:
          - bash
          - coreutils
          - findutils
          - git
          - libatomic1
          - libc6
          - libstdc++6
        files:
          - url: git+https://github.com/wiremock/wiremock.git#3.13.2
            checksum: 88587aa13b4899da080538e1b21bec0da105491e
            path: ${source.dir}/wiremock
            spdx:
              name: wiremock
              version: 3.13.2
              packages:
                - name: wiremock
                  purl: pkg:maven/org.wiremock/wiremock@3.13.2
                  license: Apache-2.0
            uid: 0
            gid: 0
        artifacts:
          - name: dhi.io/node:25.6.1-debian13-dev@sha256:4475f7d3dc74e2a727315c64e0d70e3879385de10788c4a0573ff5b04d175dd5
            includes:
              - opt/nodejs/**
              - usr/local/bin/node
              - usr/local/bin/npm
              - usr/local/bin/npx
            uid: 0
            gid: 0
      pipeline:
        - name: build-ui-resources
          work-dir: ${source.dir}/wiremock/ui
          privileged: true
          runs: |
            set -eux -o pipefail

            npm install
            npm run swagger
        - name: build
          work-dir: ${source.dir}/wiremock
          privileged: true
          runs: |
            set -eux -o pipefail

            # Use our gradle installation directly instead of gradlew to avoid wrapper downloading its own version
            export GRADLE_HOME="/opt/java/gradle/gradle-8.14.4"
            export PATH="${GRADLE_HOME}/bin:${PATH}"
            export GRADLE_OPTS="-Dspotless.enabled=false"
            gradle shadowJar --no-daemon -x spotlessCheck -x spotlessJavaCheck -x spotlessJava
        - name: install
          work-dir: ${source.dir}/wiremock
          runs: |
            set -eux -o pipefail

            mkdir -p "${target.dir}/usr/local/bin"
            find build/libs -name "wiremock-standalone*.jar" -type f | head -1 | xargs -I {} cp {} "${target.dir}/usr/local/bin/wiremock-standalone.jar"
      outputs:
        - source: ${target.dir}/usr/local/bin
          target: /usr/local/bin
          uid: 0
          gid: 0
          mode: "0755"
    - name: locale
      uses: dhi.io/debian-base:trixie-debian13@sha256:9ef766670af4743904b0f992a26b525c6c914648b56ea597ec23452adcf1a95d
      contents:
        packages:
          - bash
          - locales
          - coreutils
          - gzip
      pipeline:
        - name: install locales
          runs: |
            set -eux -o pipefail

            ln -s /etc/locale.alias /usr/share/locale/locale.alias

            echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen
            locale-gen en_US.UTF-8
      outputs:
        - source: /usr/share/locale
          target: /usr/share/locale
          uid: 0
          gid: 0
        - source: /usr/lib/locale
          target: /usr/lib/locale
          uid: 0
          gid: 0
  artifacts:
    - name: dhi.io/eclipse-temurin:17.0.18.8-debian13@sha256:e86ccb5c8b66bf58cac5e2ca508ef711669fcc00e5508c90fc8e90ad352b64ec
      includes:
        - opt/**
        - usr/local/bin/**
      uid: 0
      gid: 0
accounts:
  run-as: nonroot
  users:
    - name: nonroot
      uid: 65532
      gid: 65532
  groups:
    - name: nonroot
      gid: 65532
      members:
        - nonroot
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
work-dir: /home/wiremock
environment:
  JAVA_HOME: /opt/java/openjdk/17-jre
  LANG: en_US.UTF-8
  LANGUAGE: en_US:en
  LC_ALL: en_US.UTF-8
  PATH: /usr/local/bin:/usr/local/sbin:/usr/sbin:/usr/bin:/sbin:/bin
paths:
  - type: directory
    path: /home/wiremock
    uid: 65532
    gid: 65532
    mode: "0755"
  - type: directory
    path: /home/wiremock/__files
    uid: 65532
    gid: 65532
    mode: "0755"
  - type: directory
    path: /home/wiremock/mappings
    uid: 65532
    gid: 65532
    mode: "0755"
annotations:
  org.opencontainers.image.description: A minimal WireMock image
  org.opencontainers.image.licenses: Apache-2.0
entrypoint:
  - java
cmd:
  - -jar
  - /usr/local/bin/wiremock-standalone.jar
ports:
  - 8080/tcp
  - 8443/tcp
