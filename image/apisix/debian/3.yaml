# syntax=dhi/build:1-debian13

# DO NOT EDIT THIS FILE MANUALLY
# generated with 'dhi def merge image/apisix/debian/3.yaml'

name: APISIX 3.x
image: dhi/apisix
variant: runtime
tags:
    - "3"
    - "3.14"
    - 3.14.1
    - 3-debian13
    - 3.14-debian13
    - 3.14.1-debian13
platforms:
    - linux/amd64
    - linux/arm64
dates:
    release: "2025-10-10"
vars:
    API7_JSONSCHEMA_COMMIT_SHA: 0096f5e5bfdd210136a98e9d50799d86b9bd040c
    API7_JSONSCHEMA_VERSION: 0.9.8
    APISIX_NGINX_MODULE_COMMIT_SHA: b94ebabffc87d88d540346dc3edb5f7606418305
    APISIX_NGINX_MODULE_VERSION: 1.19.2
    APISIX_RUNTIME_COMMIT_SHA: bae155081e29348c5658cbbc6785ea4c99c38101
    APISIX_RUNTIME_VERSION: 1.3.2
    COMMIT_SHA: 2f8ebf8527cdc878afe30100077c471879a5c133
    ETCD_REFERENCE: dhi/etcd:3-debian13-dev@sha256:2479e5f90c6bec597335b37f001c7b81d37b3cce734ed8b4f151ad0936bfadb9
    ETCD_VERSION: "3"
    LUA_RESTY_EVENTS_COMMIT_SHA: 8448a92cec36ac04ea522e78f6496ba03c9b1fd8
    LUA_RESTY_EVENTS_VERSION: 0.2.0
    LUA_RESTY_LIMIT_TRAFFIC_COMMIT_SHA: 7f9f33e3fd43a84e98619280888deb76ec923ba5
    LUA_RESTY_LIMIT_TRAFFIC_VERSION: 1.0.0
    LUA_VAR_NGINX_MODULE_COMMIT_SHA: dc04c71e14e8a0407831f9019043d7e6da61b3c3
    LUA_VAR_NGINX_MODULE_VERSION: v0.5.3
    LUAROCKS_COMMIT_SHA: 81a9d497bc1217fdd08d85fb908e314ddfb8de6b
    LUAROCKS_VERSION: 3.12.0
    MOD_DUBBO_COMMIT_SHA: 4aabf9448fe4a49ca71009af8e03645ee5dadd15
    MOD_DUBBO_VERSION: 1.0.2
    NGX_MULTI_UPSTREAM_MODULE_COMMIT_SHA: 0c9e4cec7cb8ec281a4e66fe2dcf2b927c8ef46d
    NGX_MULTI_UPSTREAM_MODULE_VERSION: 1.3.2
    OPENRESTY_LUA_RESTY_LIMIT_TRAFFIC_VERSION: "0.09"
    OPENRESTY_PREFIX: /opt/openresty
    OPENRESTY_VERSION: 1.27.1.2
    SEMVER_MAJOR_MINOR_VERSION: "3.14"
    SEMVER_MAJOR_VERSION: "3"
    SEMVER_VERSION: 3.14.1
    VERSION: 3.14.1
    WASM_NGINX_MODULE_COMMIT_SHA: 0b4b31d6ecfdbc587e8ea455ed6e920a98aadff1
    WASM_NGINX_MODULE_VERSION: 0.7.0
    WASMTIME_ARCH: '#{ target.arch == "arm64" ? "aarch64" : "x86_64" }'
    WASMTIME_SHA256: '#{ target.arch == "amd64" ? "sha256:c01a0a2efecd38a4b62422f5f30fca65e172bfc1a1edd7e8cae991a540a3d3a7" : "sha256:bb48e753c6e9e741772df94c5a5db522cd25621960b0ec98c43dd7b2c977b045" }'
    WASMTIME_VERSION: v24.0.5
contents:
    packages:
        - bash
        - brotli
        - ca-certificates
        - coreutils
        - libcrypt1
        - libldap2
        - libpcre2-8-0
        - libstdc++6
        - libyaml-0-2
        - openssl
        - zlib1g
    builds:
        - name: apisix
          contents:
            packages:
                - bash
                - ca-certificates
                - coreutils
                - findutils
                - g++
                - gcc
                - git
                - gnupg
                - gpg
                - gpg-agent
                - grep
                - gzip
                - libc-bin
                - libpcre2-dev
                - libssl-dev
                - libyaml-dev
                - make
                - openssl
                - patch
                - sed
                - tar
                - unzip
                - wget
                - xz-utils
                - zlib1g-dev
            files:
                - url: git+https://github.com/apache/apisix.git#3.14.1
                  checksum: 2f8ebf8527cdc878afe30100077c471879a5c133
                  path: ${source.dir}/apisix-3.14.1
                  spdx:
                    name: apisix
                    version: 3.14.1
                    packages:
                        - name: apisix
                          purl: pkg:dhi/apisix@3.14.1
                          license: Apache-2.0
                  uid: 0
                  gid: 0
                - url: https://openresty.org/download/openresty-1.27.1.2.tar.gz.asc
                  path: ${source.dir}/openresty/sigs/openresty.tar.gz.asc
                  uid: 0
                  gid: 0
                - url: https://openresty.org/download/openresty-1.27.1.2.tar.gz
                  path: ${source.dir}/openresty/openresty.tar.gz
                  spdx:
                    name: openresty
                    version: 1.27.1.2
                    packages:
                        - name: openresty
                          purl: pkg:generic/openresty/openresty@3.14.1
                          license: BSD-2-Clause
                  uid: 0
                  gid: 0
                - url: git+https://github.com/Kong/lua-resty-events.git#0.2.0
                  checksum: 8448a92cec36ac04ea522e78f6496ba03c9b1fd8
                  path: ${source.dir}/openresty/lua-resty-events-0.2.0
                  spdx:
                    name: lua-resty-events
                    version: 0.2.0
                    packages:
                        - name: lua-resty-events
                          purl: pkg:dhi/kong/lua-resty-events@0.2.0
                          license: Apache-2.0
                  uid: 0
                  gid: 0
                - url: git+https://github.com/api7/ngx_multi_upstream_module.git#1.3.2
                  checksum: 0c9e4cec7cb8ec281a4e66fe2dcf2b927c8ef46d
                  path: ${source.dir}/openresty/ngx_multi_upstream_module-1.3.2
                  spdx:
                    name: ngx_multi_upstream_module
                    version: 1.3.2
                    packages:
                        - name: ngx_multi_upstream_module
                          purl: pkg:dhi/api7/ngx_multi_upstream_module@1.3.2
                          license: BSD-2-Clause
                  uid: 0
                  gid: 0
                - url: git+https://github.com/api7/mod_dubbo.git#1.0.2
                  checksum: 4aabf9448fe4a49ca71009af8e03645ee5dadd15
                  path: ${source.dir}/openresty/mod_dubbo-1.0.2
                  spdx:
                    name: mod_dubbo
                    version: 1.0.2
                    packages:
                        - name: mod_dubbo
                          purl: pkg:dhi/api7/mod_dubbo@1.0.2
                          license: BSD-2-Clause
                  uid: 0
                  gid: 0
                - url: git+https://github.com/api7/apisix-nginx-module.git#1.19.2
                  checksum: b94ebabffc87d88d540346dc3edb5f7606418305
                  path: ${source.dir}/openresty/apisix-nginx-module-1.19.2
                  spdx:
                    name: apisix-nginx-module
                    version: 1.19.2
                    packages:
                        - name: apisix-nginx-module
                          purl: pkg:dhi/api7/apisix-nginx-module@1.19.2
                          license: Apache-2.0
                  uid: 0
                  gid: 0
                - url: git+https://github.com/api7/wasm-nginx-module.git#0.7.0
                  checksum: 0b4b31d6ecfdbc587e8ea455ed6e920a98aadff1
                  path: ${source.dir}/openresty/wasm-nginx-module-0.7.0
                  spdx:
                    name: wasm-nginx-module
                    version: 0.7.0
                    packages:
                        - name: wasm-nginx-module
                          purl: pkg:dhi/api7/wasm-nginx-module@0.7.0
                          license: Apache-2.0
                  uid: 0
                  gid: 0
                - url: git+https://github.com/api7/lua-var-nginx-module.git#v0.5.3
                  checksum: dc04c71e14e8a0407831f9019043d7e6da61b3c3
                  path: ${source.dir}/openresty/lua-var-nginx-module-v0.5.3
                  spdx:
                    name: lua-var-nginx-module
                    version: v0.5.3
                    packages:
                        - name: lua-var-nginx-module
                          purl: pkg:dhi/api7/lua-var-nginx-module@v0.5.3
                          license: Apache-2.0
                  uid: 0
                  gid: 0
                - url: git+https://github.com/api7/lua-resty-limit-traffic.git#v1.0.0
                  checksum: 7f9f33e3fd43a84e98619280888deb76ec923ba5
                  path: ${source.dir}/openresty/lua-resty-limit-traffic-1.0.0
                  spdx:
                    name: lua-resty-limit-traffic
                    version: v1.0.0
                    packages:
                        - name: lua-resty-limit-traffic
                          purl: pkg:dhi/api7/lua-resty-limit-traffic@v1.0.0
                          license: BSD
                  uid: 0
                  gid: 0
                - url: git+https://github.com/luarocks/luarocks.git#v3.12.0
                  checksum: 81a9d497bc1217fdd08d85fb908e314ddfb8de6b
                  path: ${source.dir}/luarocks-3.12.0
                  spdx:
                    name: luarocks
                    version: v3.12.0
                    packages:
                        - name: luarocks
                          purl: pkg:dhi/luarocks@v3.12.0
                          license: MIT
                  uid: 0
                  gid: 0
                - url: https://github.com/bytecodealliance/wasmtime/releases/download/v24.0.5/wasmtime-v24.0.5-${WASMTIME_ARCH}-linux-c-api.tar.xz
                  checksum: ${WASMTIME_SHA256}
                  path: ${source.dir}/wasmtime
                  spdx:
                    name: wasmtime-c-api
                    version: v24.0.5
                    packages:
                        - name: wasmtime-c-api
                          purl: pkg:rust/wasmtime@v24.0.5
                          license: Apache-2.0
                  uid: 0
                  gid: 0
                - url: git+https://github.com/api7/apisix-build-tools.git#apisix-runtime/1.3.2
                  checksum: bae155081e29348c5658cbbc6785ea4c99c38101
                  path: ${source.dir}/apisix-build-tools-1.3.2
                  spdx:
                    name: apisix-build-tools
                    version: 1.3.2
                    packages:
                        - name: apisix-build-tools
                          purl: pkg:dhi/api7/apisix-build-tools@1.3.2
                          license: Apache-2.0
                  uid: 0
                  gid: 0
                - url: git+https://github.com/api7/jsonschema.git#v0.9.8
                  checksum: 0096f5e5bfdd210136a98e9d50799d86b9bd040c
                  path: ${source.dir}/jsonschema-0.9.8
                  spdx:
                    name: jsonschema
                    version: 0.9.8
                    packages:
                        - name: jsonschema
                          purl: pkg:dhi/api7/jsonschema@0.9.8
                          license: Apache-2.0
                  uid: 0
                  gid: 0
          pipeline:
            - name: verify and unpack
              work-dir: ${source.dir}/openresty
              runs: |
                set -eux -o pipefail

                GNUPGHOME="$(mktemp -d)"
                export GNUPGHOME

                gpg --import "${source.dir}/key/openresty-key.asc"
                gpg --batch --verify "${source.dir}/openresty/sigs/openresty.tar.gz.asc" openresty.tar.gz

                tar -xvf openresty.tar.gz
            - name: build openresty
              privileged: true
              runs: |
                set -eux -o pipefail

                pushd ${source.dir}/openresty

                pushd ngx_multi_upstream_module-1.3.2
                ./patch.sh ../openresty-1.27.1.2
                popd

                pushd apisix-nginx-module-1.19.2/patch
                ./patch.sh ../../openresty-1.27.1.2
                popd

                pushd wasm-nginx-module-0.7.0
                mv ${source.dir}/wasmtime/wasmtime-v24.0.5-${WASMTIME_ARCH}-linux-c-api wasmtime-c-api
                popd

                pushd openresty-1.27.1.2
                # This swap is present in the upstream script https://github.com/api7/apisix-build-tools/blob/2c3e7dfedafe3e61ea9cd343e8b812185f377d1b/build-apisix-runtime.sh#L148-L158
                rm -rf bundle/lua-resty-limit-traffic-0.09
                mv ../lua-resty-limit-traffic-1.0.0 bundle/lua-resty-limit-traffic-0.09

                ./configure --prefix="/opt/openresty" \
                  --with-cc-opt="-DAPISIX_RUNTIME_VER="1.3.2" -DNGX_LUA_ABORT_AT_PANIC" \
                  --with-ld-opt="-Wl,-rpath,"/opt/openresty"/wasmtime-c-api/lib" \
                  --add-module=../mod_dubbo-"1.0.2" \
                  --add-module=../ngx_multi_upstream_module-"1.3.2" \
                  --add-module=../apisix-nginx-module-"1.19.2" \
                  --add-module=../apisix-nginx-module-"1.19.2"/src/stream \
                  --add-module=../apisix-nginx-module-"1.19.2"/src/meta \
                  --add-module=../wasm-nginx-module-"0.7.0" \
                  --add-module=../lua-var-nginx-module-"v0.5.3" \
                  --add-module=../lua-resty-events-"0.2.0" \
                  --with-poll_module \
                  --with-pcre-jit \
                  --without-http_rds_json_module \
                  --without-http_rds_csv_module \
                  --without-lua_rds_parser \
                  --with-stream \
                  --with-stream_ssl_module \
                  --with-stream_ssl_preread_module \
                  --with-http_v2_module \
                  --with-http_v3_module \
                  --without-mail_pop3_module \
                  --without-mail_imap_module \
                  --without-mail_smtp_module \
                  --with-http_stub_status_module \
                  --with-http_realip_module \
                  --with-http_addition_module \
                  --with-http_auth_request_module \
                  --with-http_secure_link_module \
                  --with-http_random_index_module \
                  --with-http_gzip_static_module \
                  --with-http_sub_module \
                  --with-http_dav_module \
                  --with-http_flv_module \
                  --with-http_mp4_module \
                  --with-http_gunzip_module \
                  --with-threads \
                  --with-compat \
                  --with-luajit-xcflags="-DLUAJIT_NUMMODE=2 -DLUAJIT_ENABLE_LUA52COMPAT" \
                  -j"$(nproc)"

                make -j"$(nproc)"
                make install
                popd

                pushd lua-resty-events-0.2.0
                install -d "/opt/openresty"/lualib/resty/events/
                install -m 664 lualib/resty/events/*.lua "/opt/openresty"/lualib/resty/events/
                install -d "/opt/openresty"/lualib/resty/events/compat/
                install -m 644 lualib/resty/events/compat/*.lua "/opt/openresty"/lualib/resty/events/compat/
                popd

                pushd apisix-nginx-module-1.19.2
                make install OPENRESTY_PREFIX="/opt/openresty"
                popd

                pushd wasm-nginx-module-0.7.0
                make install OPENRESTY_PREFIX="/opt/openresty"
                popd
                popd
            - name: build luarocks
              privileged: true
              runs: |
                set -eux -o pipefail

                pushd luarocks-3.12.0
                ./configure --with-lua=/opt/openresty/luajit
                make build
                make install DESTDIR=/opt/luarocks

                mkdir -p ~/.luarocks
                popd
            - name: build apisix
              privileged: true
              runs: |
                set -eux -o pipefail

                export LUA_PATH="/opt/luarocks/usr/local/share/lua/5.1/?.lua;;"
                export PATH=/opt/luarocks/usr/local/bin:$PATH

                pushd jsonschema-0.9.8
                # This patches the jsonschema package to call lrexlib-prce2 over lrexlib-pcre which in turn relies PCRE 1 which is no longer supported
                sed -i 's/"lrexlib-pcre = \(.*\)"/"lrexlib-pcre2 = \1"/' rockspec/jsonschema-0.9.8-0.rockspec
                sed -i 's/\<rex_pcre\>/rex_pcre2/g' lib/jsonschema.lua
                luarocks make rockspec/jsonschema-0.9.8-0.rockspec --tree /usr/local/apisix
                popd

                pushd apisix-3.14.1
                sed -i 's/"casbin = [^"]*"/"casbin = 1.45.0"/' apisix-master-0.rockspec # This version of casbin upgrades to librex-pcre2

                luarocks install apisix-master-0.rockspec --tree /usr/local/apisix --only-deps

                mkdir -p /usr/local/apisix/bin
                make install ENV_INST_PREFIX=/usr/local/apisix ENV_NGINX_EXEC="/opt/openresty/nginx/sbin/nginx"
                popd

                # Rewrite the bin file to point at the correct lua location
                cat > /usr/local/apisix/bin/apisix << 'EOF'
                #!/bin/bash
                exec luajit /usr/local/apisix/share/lua/5.1/apisix/cli/apisix.lua "$@"
                EOF
          paths:
            - type: file
              path: ${source.dir}/key/openresty-key.asc
              uid: 0
              gid: 0
              source: image/apisix/key/openresty-key.asc
          outputs:
            - source: /opt/docker/sbom
              target: /opt/docker/sbom
              uid: 0
              gid: 0
            - source: /opt/openresty
              target: /opt/openresty
              uid: 0
              gid: 0
            - source: /usr/local/apisix
              target: /usr/local/apisix
              uid: 65532
              gid: 65532
    artifacts:
        - name: dhi/etcd:3-debian13-dev@sha256:2479e5f90c6bec597335b37f001c7b81d37b3cce734ed8b4f151ad0936bfadb9
          includes:
            - usr/local/bin
          uid: 0
          gid: 0
accounts:
    run-as: nonroot
    users:
        - name: nonroot
          uid: 65532
          gid: 65532
    groups:
        - name: nonroot
          gid: 65532
          members:
            - nonroot
os-release:
    name: Docker Hardened Images (Debian)
    id: debian
    version-id: "13"
    version-codename: trixie
    pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
    home-url: https://docker.com/products/hardened-images/
    bug-report-url: https://docker.com/support/
environment:
    LUA_CPATH: /usr/local/apisix/lib/lua/5.1/?.so;;
    LUA_PATH: /usr/local/apisix/share/lua/5.1/?.lua;/usr/local/apisix/share/lua/5.1/?/init.lua;;
    PATH: /opt/openresty/luajit/bin:/opt/openresty/nginx/sbin:/opt/openresty/bin:/usr/local/apisix/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
paths:
    - type: file
      path: /usr/local/bin/docker-entrypoint.sh
      uid: 0
      gid: 0
      mode: "0755"
      source: image/apisix/bin/docker-entrypoint.sh
annotations:
    org.opencontainers.image.description: A minimal APISIX image
    org.opencontainers.image.licenses: Apache-2.0
entrypoint:
    - /usr/local/bin/docker-entrypoint.sh
cmd:
    - docker-start
tests:
    - name: Run testcontainers tests
      directory: image/apisix/tests
      commands:
        - go test . -count=1 -v
      exit-code: 0
    - name: Run common testcontainers tests
      directory: test/go-testing/base
      commands:
        - go test . -count=1 -v
      exit-code: 0
