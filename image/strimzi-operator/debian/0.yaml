# syntax=dhi/build:1-debian13

# DO NOT EDIT THIS FILE MANUALLY
# generated with 'dhi def merge image/strimzi-operator/debian/0.yaml'

name: Strimzi Operator 0.x
image: dhi/strimzi-operator
variant: runtime
tags:
    - "0"
    - "0.49"
    - 0.49.1
    - 0-debian13
    - 0.49-debian13
    - 0.49.1-debian13
platforms:
    - linux/amd64
    - linux/arm64
vars:
    COMMIT_SHA: eb359e808dee4f00230ed031bd381cd2a2f94b9c
    JAVA_MAJOR_VERSION: "21"
    JAVA_REFERENCE: dhi/eclipse-temurin:21.0.9.10-debian13@sha256:8be38a5a3942a69d6ac8a6040c54fb588b6fc29499fa44fec189d2438be4d6a8
    JAVA_VERSION: 21.0.9.10
    MAVEN_REFERENCE: dhi/maven:3.9.12-jdk21-debian13-dev@sha256:54dad2732e2c07f1377491e56c864c20635adf7ab2d60673a0e69455c3e1c947
    MAVEN_VERSION: 3.9.12
    SEMVER_MAJOR_MINOR_VERSION: "0.49"
    SEMVER_MAJOR_VERSION: "0"
    SEMVER_VERSION: 0.49.1
    STRIMZI_HOME: /opt/strimzi
    VERSION: 0.49.1
    YQ_REFERENCE: dhi/pkg-go-yq:4.49.2-debian13@sha256:1364e03f4fa31c3eb6c741262ada6709691dccea3e1f6e32fabf1f711539e639
    YQ_VERSION: 4.49.2
contents:
    packages:
        - bash
        - coreutils
        - libc-bin
        - openssl
        - sed
        - tini
    builds:
        - name: strimzi-kafka-operator
          uses: dhi/maven:3.9.12-jdk21-debian13-dev@sha256:54dad2732e2c07f1377491e56c864c20635adf7ab2d60673a0e69455c3e1c947
          environment:
            JAVA_HOME: /opt/java/openjdk/21
            MAVEN_ARGS: --batch-mode --no-transfer-progress
            MAVEN_HOME: /opt/java/apache-maven-3.9.12
          contents:
            packages:
                - bash
                - unzip
            files:
                - url: git+https://github.com/strimzi/strimzi-kafka-operator.git#0.49.1
                  checksum: eb359e808dee4f00230ed031bd381cd2a2f94b9c
                  path: ${source.dir}/strimzi
                  spdx:
                    name: strimzi
                    version: 0.49.1
                    packages:
                        - name: strimzi
                          purl: pkg:maven/io.strimzi/strimzi@0.49.1
                          license: Apache-2.0
                  uid: 0
                  gid: 0
                - url: https://repo1.maven.org/maven2/at/yawk/lz4/lz4-java/1.10.1/lz4-java-1.10.1.jar
                  path: ${source.dir}/patch/deps/at.yawk.lz4.lz4-java-1.10.1.jar
                  uid: 0
                  gid: 0
            artifacts:
                - name: dhi/pkg-go-yq:4.49.2-debian13@sha256:1364e03f4fa31c3eb6c741262ada6709691dccea3e1f6e32fabf1f711539e639
                  includes:
                    - usr/local/bin/yq
                  uid: 0
                  gid: 0
          pipeline:
            - name: build
              work-dir: ${source.dir}/strimzi
              privileged: true
              runs: |
                set -eux -o pipefail

                mvn -DskipTests -Dcheckstyle.skip -Dmaven.javadoc.skip install
            - name: install
              work-dir: ${source.dir}/strimzi
              runs: |
                set -eux -o pipefail

                mkdir -p '${target.dir}/opt/strimzi'
                for bundle in cluster-operator topic-operator user-operator kafka-init; do
                  unzip -qo "docker-images/artifacts/binaries/${bundle}-0.49.1-dist.zip" -d '${target.dir}/opt/strimzi'
                done
                cp -a docker-images/operator/scripts/. '${target.dir}/opt/strimzi/bin'

                mkdir -p '${target.dir}/opt/v1-api-conversion'
                unzip -qo 'docker-images/artifacts/binaries/v1-api-conversion-0.49.1-dist.zip' -d '${target.dir}/opt/v1-api-conversion'
            - name: replace vulnerable lz4 dep
              runs: |
                set -eux -o pipefail

                rm "${target.dir}/opt/strimzi/lib/org.lz4.lz4-java-1.8.0.jar"
                cp "${source.dir}/patch/deps/at.yawk.lz4.lz4-java-1.10.1.jar" "${target.dir}/opt/strimzi/lib/"
          outputs:
            - source: ${target.dir}/opt/strimzi
              target: /opt/strimzi
              uid: 0
              gid: 0
            - source: ${target.dir}/opt/v1-api-conversion
              target: /opt/v1-api-conversion
              uid: 0
              gid: 0
            - source: /opt/docker/sbom/strimzi
              target: /opt/docker/sbom/strimzi
              uid: 0
              gid: 0
    artifacts:
        - name: dhi/eclipse-temurin:21.0.9.10-debian13@sha256:8be38a5a3942a69d6ac8a6040c54fb588b6fc29499fa44fec189d2438be4d6a8
          includes:
            - opt/**
            - usr/local/bin
          uid: 0
          gid: 0
accounts:
    run-as: nonroot
    users:
        - name: nonroot
          uid: 65532
          gid: 65532
    groups:
        - name: nonroot
          gid: 65532
          members:
            - nonroot
os-release:
    name: Docker Hardened Images (Debian)
    id: debian
    version-id: "13"
    version-codename: trixie
    pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
    home-url: https://docker.com/products/hardened-images/
    bug-report-url: https://docker.com/support/
work-dir: /opt/strimzi
environment:
    JAVA_HOME: /opt/java/openjdk/21-jre
    STRIMZI_HOME: /opt/strimzi
    STRIMZI_VERSION: 0.49.1
annotations:
    org.opencontainers.image.description: A minimal Strimzi Operator image
    org.opencontainers.image.licenses: Apache-2.0
tests:
    - name: Run strimzi-operator testcontainers tests
      directory: image/strimzi-operator/tests
      commands:
        - go test . -count=1 -v
      exit-code: 0
    - name: Run testcontainers basic tests
      directory: test/go-testing/base
      commands:
        - go test . -count=1 -v
      exit-code: 0
