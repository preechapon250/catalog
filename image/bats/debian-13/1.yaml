# syntax=dhi.io/build:2-debian13

name: BATS 1.x
image: dhi.io/bats
variant: runtime
tags:
  - "1"
  - "1.13"
  - 1.13.0
  - 1-debian13
  - 1.13-debian13
  - 1.13.0-debian13
platforms:
  - linux/amd64
  - linux/arm64
dates:
  release: "2025-11-07"
vars:
  BASE_DIGEST: sha256:74fc43fa240887b8159970e434244039aab0c6efaaa9cf044004cdc22aa2a34d
  BASE_TAG: 20250419-debian13
  BATS_ASSERT_COMMIT_SHA: f1e9280eaae8f86cbe278a687e6ba755bc802c1a
  BATS_ASSERT_VERSION: 2.2.4
  BATS_DETIK_COMMIT_SHA: d42699741a2ed7b74ab8178b0038276d6e36faf1
  BATS_DETIK_VERSION: 1.4.0
  BATS_FILE_COMMIT_SHA: 13ad5e2ffcc360281432db3d43a306f7b3667d60
  BATS_FILE_VERSION: 0.4.0
  BATS_SUPPORT_COMMIT_SHA: 24a72e14349690bcbf7c151b9d2d1cdd32d36eb1
  BATS_SUPPORT_VERSION: 0.3.0
  COMMIT_SHA: 3bca150ec86275d6d9d5a4fd7d48ab8b6c6f3d87
  SEMVER_MAJOR_MINOR_VERSION: "1.13"
  SEMVER_MAJOR_VERSION: "1"
  SEMVER_VERSION: 1.13.0
  VERSION: 1.13.0
contents:
  packages:
    - '!base-files'
    - bash
    - ca-certificates
    - coreutils
    - findutils
    - grep
    - ncurses-base
    - ncurses-bin
    - parallel
    - perl
    - sed
    - tar
    - tini
    - util-linux
    - zlib1g
  builds:
    - name: bats-core
      contents:
        packages:
          - bash
          - cmake
          - coreutils
          - make
          - sed
        files:
          - url: git+https://github.com/bats-core/bats-core.git#v1.13.0
            checksum: 3bca150ec86275d6d9d5a4fd7d48ab8b6c6f3d87
            path: ${source.dir}/bats-core
            spdx:
              name: bats
              version: 1.13.0
              packages:
                - purl: pkg:dhi/bats@1.13.0
                  license: MIT
            uid: 0
            gid: 0
          - url: git+https://github.com/bats-core/bats-support.git#v0.3.0
            checksum: 24a72e14349690bcbf7c151b9d2d1cdd32d36eb1
            path: ${source.dir}/bats-support
            spdx:
              name: bats-support
              version: 0.3.0
              packages:
                - name: bats-support
                  purl: pkg:dhi/bats-support@v0.3.0
                  license: 0BSD
            uid: 0
            gid: 0
          - url: git+https://github.com/bats-core/bats-assert.git#v2.2.4
            checksum: f1e9280eaae8f86cbe278a687e6ba755bc802c1a
            path: ${source.dir}/bats-assert
            spdx:
              name: bats-assert
              version: 2.2.4
              packages:
                - name: bats-assert
                  purl: pkg:dhi/bats-assert@v2.2.4
                  license: CC0-1.0
            uid: 0
            gid: 0
          - url: git+https://github.com/bats-core/bats-file.git#v0.4.0
            checksum: 13ad5e2ffcc360281432db3d43a306f7b3667d60
            path: ${source.dir}/bats-file
            spdx:
              name: bats-file
              version: 0.4.0
              packages:
                - name: bats-file
                  purl: pkg:dhi/bats-file@v0.4.0
                  license: CC0-1.0
            uid: 0
            gid: 0
          - url: git+https://github.com/bats-core/bats-detik.git#v1.4.0
            checksum: d42699741a2ed7b74ab8178b0038276d6e36faf1
            path: ${source.dir}/bats-detik
            spdx:
              name: bats-detik
              version: 1.4.0
              packages:
                - name: bats-detik
                  purl: pkg:dhi/bats-detik@v1.4.0
                  license: MIT
            uid: 0
            gid: 0
      pipeline:
        - name: prepare bats core
          runs: |
            set -eux -o pipefail

            mkdir -p ${target.dir}/usr/local/bin

            # Bats core is a set of bash scripts. Upstream Dockerfile copies everything into /opt/bats.
            mkdir -p ${target.dir}/opt/bats
            cp -r ${source.dir}/bats-core/* ${target.dir}/opt/bats

            # Install the different plugins into the correct locations.
            install -Dm755 /${source.dir}/bats-support/load.bash ${target.dir}/usr/lib/bats/bats-support/load.bash
            for fn in "/${source.dir}/bats-support/src/"*.bash; do install -Dm755 "$fn" "${target.dir}/usr/lib/bats/bats-support/src/$(basename "$fn")"; done
            install -Dm755 /${source.dir}/bats-file/load.bash ${target.dir}/usr/lib/bats/bats-file/load.bash
            for fn in "/${source.dir}/bats-file/src/"*.bash; do install -Dm755 "$fn" "${target.dir}/usr/lib/bats/bats-file/src/$(basename "$fn")"; done
            install -Dm755 /${source.dir}/bats-assert/load.bash ${target.dir}/usr/lib/bats/bats-assert/load.bash
            for fn in "/${source.dir}/bats-assert/src/"*.bash; do install -Dm755 "$fn" "${target.dir}/usr/lib/bats/bats-assert/src/$(basename "$fn")"; done

            # Detik is a bit different. Does not have a load.bash and scripts don't go in a src directory.
            for fn in "/${source.dir}/bats-detik/lib/"*.bash; do install -Dm755 "$fn" "${target.dir}/usr/lib/bats/bats-detik/$(basename "$fn")"; done
      outputs:
        - source: ${target.dir}/usr/local/bin
          target: /usr/local/bin
          uid: 0
          gid: 0
        - source: ${target.dir}/opt/bats/bin/bats
          target: /opt/bats/bin/bats
          uid: 0
          gid: 0
        - source: ${target.dir}/opt/bats/
          target: /opt/bats/
          uid: 0
          gid: 0
        - source: ${target.dir}/usr/lib/bats
          target: /usr/lib/bats
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/bats
          target: /opt/docker/sbom/bats
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/bats-support
          target: /opt/docker/sbom/bats-support
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/bats-assert
          target: /opt/docker/sbom/bats-assert
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/bats-file
          target: /opt/docker/sbom/bats-file
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/bats-detik
          target: /opt/docker/sbom/bats-detik
          uid: 0
          gid: 0
  artifacts:
    - name: dhi.io/static:20250419-debian13@sha256:74fc43fa240887b8159970e434244039aab0c6efaaa9cf044004cdc22aa2a34d
      includes:
        - bin
        - etc
        - home
        - lib
        - lib64
        - opt
        - sbin
        - tmp
        - usr
        - var
      excludes:
        - etc/group
        - etc/os-release
        - etc/passwd
        - var/lib/dpkg/status
      uid: 0
      gid: 0
accounts:
  run-as: "65532"
  users:
    - name: nonroot
      uid: 65532
      gid: 65532
  groups:
    - name: nonroot
      gid: 65532
      members:
        - nonroot
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
work-dir: /code
paths:
  - type: symlink
    path: /usr/local/bin/bats
    uid: 0
    gid: 0
    source: /opt/bats/bin/bats
  - type: symlink
    path: /usr/local/bin/bash
    uid: 0
    gid: 0
    source: /usr/bin/bash
  - type: directory
    path: /code
    uid: 65532
    gid: 65532
    mode: "0755"
annotations:
  org.opencontainers.image.description: A minimal BATS testing framework image
  org.opencontainers.image.licenses: MIT
entrypoint:
  - /usr/bin/tini
  - --
  - /usr/local/bin/bash
  - /usr/local/bin/bats
