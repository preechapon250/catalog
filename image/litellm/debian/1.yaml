# syntax=dhi/build:1-debian13

# DO NOT EDIT THIS FILE MANUALLY
# generated with 'dhi def merge image/litellm/debian/1.yaml'

name: LiteLLM 1.x
image: dhi/litellm
variant: runtime
tags:
    - "1"
    - "1.80"
    - 1.80.8
    - 1-debian13
    - 1.80-debian13
    - 1.80.8-debian13
platforms:
    - linux/amd64
    - linux/arm64
vars:
    COMMIT_SHA: 3381d63152f8aeadb41ddf51620eb18520971d23
    DEBIAN_EPOCH_MAJOR_MINOR_VERSION: "1.80"
    DEBIAN_EPOCH_MAJOR_VERSION: "1"
    DEBIAN_EPOCH_VERSION: 1.80.8
    PYTHON_BUILD_DIGEST: sha256:afbe9dc3a5482aa5a10a1b3f6b169d71cfb0565d6ca223279af3c60696ae1cbe
    PYTHON_BUILD_VERSION: 3.13.11
    PYTHON_DIGEST: sha256:64dbcbe81072d513f0ecc24ab92e3131df201ace1f99a3b78ac0c778fa4f7e82
    PYTHON_VERSION: 3.13.11
    SEMVER_MAJOR_MINOR_VERSION: "1.80"
    SEMVER_MAJOR_VERSION: "1"
    SEMVER_VERSION: 1.80.8
    VERSION: 1.80.8
contents:
    packages:
        - '!libelogind0'
        - '!mawk'
        - '!original-awk'
        - base-files
        - bash
        - ca-certificates
        - coreutils
        - libstdc++6
        - openssl
        - tzdata
    builds:
        - name: litellm-build
          uses: dhi/python:3.13.11-debian13-dev@sha256:afbe9dc3a5482aa5a10a1b3f6b169d71cfb0565d6ca223279af3c60696ae1cbe
          privileged: true
          environment:
            VIRTUAL_ENV: /opt/litellm
          contents:
            packages:
                - build-essential
                - libssl-dev
                - coreutils
                - bash
                - ca-certificates
                - grep
                - findutils
                - '!libexpat1'
            files:
                - url: git+https://github.com/BerriAI/litellm.git#3381d63152f8aeadb41ddf51620eb18520971d23
                  path: ${source.dir}/litellm-src
                  spdx:
                    name: litellm
                    version: 1.80.8
                    packages:
                        - name: litellm
                          purl: pkg:pypi/litellm@1.80.8
                          license: MIT
                  uid: 0
                  gid: 0
          pipeline:
            - name: verify
              uses: git/checkout@v1
              with:
                dir: litellm-src
                expected-commit: 3381d63152f8aeadb41ddf51620eb18520971d23
            - name: build python package
              runs: |
                set -eux -o pipefail

                cd "${source.dir}/litellm-src"

                # Install build module since DHI python image doesn't include it by default
                python3 -m pip install build

                # Clean and build the package
                rm -rf dist/*
                python3 -m build
            - name: create virtual environment
              runs: |
                set -eux -o pipefail

                # Create virtual environment for LiteLLM directly at runtime location
                python3 -m venv "$VIRTUAL_ENV"
            - name: install litellm in venv
              runs: |
                set -eux -o pipefail

                cd "${source.dir}/litellm-src"

                # Source the virtual environment
                source "$VIRTUAL_ENV/bin/activate"

                # Install the built wheel using venv pip with proxy extras
                WHEEL_FILES=(dist/litellm-*.whl)
                if [ ${#WHEEL_FILES[@]} -gt 1 ]; then
                  echo "Error: Multiple wheel files found:"
                  printf '  %s\n' "${WHEEL_FILES[@]}"
                  exit 1
                elif [ ${#WHEEL_FILES[@]} -eq 0 ] || [ ! -f "${WHEEL_FILES[0]}" ]; then
                  echo "Error: No wheel files found in dist/"
                  exit 1
                fi
                WHEEL_FILE="${WHEEL_FILES[0]}"
                pip install "${WHEEL_FILE}[proxy]"

                # Install all dependencies directly from requirements.txt to ensure CLI tools are available
                # This includes prisma which provides the prisma-client-py CLI tool needed for prisma generate
                pip install -r requirements.txt

                # Handle PyJWT specifically (upstream requirement)
                pip uninstall jwt -y || true
                pip uninstall PyJWT -y || true
                pip install PyJWT==2.9.0 --no-cache-dir

                # CVE remediation: Upgrade packages to fix known vulnerabilities
                pip install --upgrade 'starlette>=0.49.1'    # Fix CVE-2025-62727
                pip install --upgrade 'aiohttp>=3.12.14'     # Fix CVE-2025-53643
                pip install --upgrade 'cryptography>=44.0.1' # Fix CVE-2024-12797
                pip install --upgrade 'mcp>=1.23.0'          # Fix CVE-2025-66416
            - name: install final packages in venv
              runs: |
                set -eux -o pipefail

                # Source the virtual environment
                source "$VIRTUAL_ENV/bin/activate"

                # Install semantic_router without dependencies using venv pip
                pip install semantic_router --no-deps

                # Generate prisma client using venv python module interface
                # NOTE: This runs code generation that should be audited for security
                python3 -m prisma generate
            - name: prepare system integration
              runs: |
                set -eux -o pipefail

                # Create symlink for litellm executable in /usr/local/bin
                mkdir -p "${target.dir}/usr/local/bin"
                ln -s ../../../opt/litellm/bin/litellm "${target.dir}/usr/local/bin/litellm"

                # Create dummy supervisor script with helpful error message.
                mkdir -p "${target.dir}/usr/bin"
                cat > "${target.dir}/usr/bin/supervisord" << 'EOF'
                #!/bin/bash
                echo "The 'supervisor' package is not installed in the DHI litellm image, and is not supported by default."
                exit 1
                EOF
                chmod +x "${target.dir}/usr/bin/supervisord"
            - name: prepare runtime files
              runs: |
                set -eux -o pipefail

                cd "${source.dir}/litellm-src"

                # Copy source files needed at runtime
                mkdir -p "${target.dir}/app/docker"
                cp docker/entrypoint.sh "${target.dir}/app/docker/"
                cp docker/prod_entrypoint.sh "${target.dir}/app/docker/"

                chmod +x "${target.dir}/app/docker/entrypoint.sh"
                chmod +x "${target.dir}/app/docker/prod_entrypoint.sh"
            - name: python dependencies sbom
              uses: sbom@v1
              with:
                extra-scanners: python-package-cataloger
                prefix: litellm-python
                source: /opt/litellm
          outputs:
            - source: ${target.dir}/app
              target: /app
              uid: 0
              gid: 0
            - source: /opt/litellm
              target: /opt/litellm
              uid: 0
              gid: 0
            - source: ${target.dir}/usr/local/bin
              target: /usr/local/bin
              uid: 0
              gid: 0
            - source: ${target.dir}/usr/bin
              target: /usr/bin
              uid: 0
              gid: 0
            - source: /opt/docker/sbom
              target: /opt/docker/sbom
              uid: 0
              gid: 0
    artifacts:
        - name: dhi/python:3.13.11-debian13@sha256:64dbcbe81072d513f0ecc24ab92e3131df201ace1f99a3b78ac0c778fa4f7e82
          includes:
            - opt/**
            - usr/**
          uid: 0
          gid: 0
accounts:
    run-as: nonroot
    users:
        - name: nonroot
          uid: 65532
          gid: 65532
    groups:
        - name: nonroot
          gid: 65532
          members:
            - nonroot
os-release:
    name: Docker Hardened Images (Debian)
    id: debian
    version-id: "13"
    version-codename: trixie
    pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
    home-url: https://docker.com/products/hardened-images/
    bug-report-url: https://docker.com/support/
work-dir: /app
environment:
    PATH: /opt/litellm/bin:/usr/local/bin:/usr/local/sbin:/usr/sbin:/usr/bin:/sbin:/bin
    PYTHON_VERSION: 3.13.11
paths:
    - type: directory
      path: /app
      uid: 0
      gid: 0
      mode: "0755"
annotations:
    org.opencontainers.image.description: A minimal LiteLLM image - Universal LLM API Gateway
    org.opencontainers.image.licenses: MIT
entrypoint:
    - /app/docker/prod_entrypoint.sh
cmd:
    - --port
    - "4000"
ports:
    - 4000/tcp
tests:
    - name: Run LiteLLM testcontainers litellm_test
      directory: image/litellm/tests
      commands:
        - go test . -count=1 -v -timeout 15m
      exit-code: 0
    - name: Run testcontainers basic tests
      directory: test/go-testing/base
      commands:
        - go test . -count=1 -v
      exit-code: 0
