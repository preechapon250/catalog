# syntax=dhi.io/build:2-debian13

name: LiteLLM 1.x (dev)
image: dhi.io/litellm
variant: dev
tags:
  - 1-dev
  - 1.81-dev
  - 1.81.0-dev
  - 1-debian13-dev
  - 1.81-debian13-dev
  - 1.81.0-debian13-dev
platforms:
  - linux/amd64
  - linux/arm64
vars:
  COMMIT_SHA: 790a5ce0b323c1eefa70c2df25b2780097aa3f80
  DEBIAN_EPOCH_MAJOR_MINOR_VERSION: "1.81"
  DEBIAN_EPOCH_MAJOR_VERSION: "1"
  DEBIAN_EPOCH_VERSION: 1.81.0
  PYTHON_BUILD_REFERENCE: dhi/python:3.13.12-debian13-dev@sha256:fb4baa0ca0211b20cb45e8fcf2509542b4b1ca634dde7f888027c19a39f30299
  PYTHON_BUILD_VERSION: 3.13.12
  PYTHON_REFERENCE: dhi/python:3.13.12-debian13@sha256:b8ab2d350cf8b832825e80338f1b38c2ebe5ad21918d465404e9f91b77343044
  PYTHON_VERSION: 3.13.12
  SEMVER_MAJOR_MINOR_VERSION: "1.81"
  SEMVER_MAJOR_VERSION: "1"
  SEMVER_VERSION: 1.81.0
  VERSION: 1.81.0
contents:
  packages:
    - '!gawk'
    - '!libelogind0'
    - '!mawk'
    - '!original-awk'
    - apt
    - base-files
    - bash
    - ca-certificates
    - coreutils
    - diffutils
    - dpkg
    - findutils
    - grep
    - libc-bin
    - libstdc++6
    - mawk
    - openssl
    - perl-base
    - sed
    - tzdata
    - util-linux
  builds:
    - name: litellm-build
      uses: dhi.io/python:3.13.12-debian13-dev@sha256:fb4baa0ca0211b20cb45e8fcf2509542b4b1ca634dde7f888027c19a39f30299
      environment:
        PATH: /opt/python/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
        VIRTUAL_ENV: /opt/litellm
      contents:
        packages:
          - build-essential
          - libssl-dev
          - coreutils
          - bash
          - ca-certificates
          - grep
          - findutils
          - gzip
          - '!libexpat1'
        files:
          - url: git+https://github.com/BerriAI/litellm.git#790a5ce0b323c1eefa70c2df25b2780097aa3f80
            checksum: 790a5ce0b323c1eefa70c2df25b2780097aa3f80
            path: ${source.dir}/litellm-src
            spdx:
              name: litellm
              version: 1.81.0
              packages:
                - name: litellm
                  purl: pkg:pypi/litellm@1.81.0
                  license: MIT
            uid: 0
            gid: 0
          - url: https://registry.npmjs.org/diff/-/diff-8.0.3.tgz
            path: ${source.dir}/diff-8.0.3.tgz
            uid: 0
            gid: 0
      pipeline:
        - name: build python package
          work-dir: ${source.dir}/litellm-src
          privileged: true
          runs: |
            set -eux -o pipefail

            # Install build module since DHI python image doesn't include it by default
            python3 -m pip install build

            # Clean and build the package
            rm -rf dist/*
            python3 -m build
        - name: create virtual environment
          runs: |
            set -eux -o pipefail

            # Create virtual environment for LiteLLM directly at runtime location
            python3 -m venv "$VIRTUAL_ENV"
        - name: install litellm in venv
          work-dir: ${source.dir}/litellm-src
          privileged: true
          runs: |
            set -eux -o pipefail

            # Source the virtual environment
            source "$VIRTUAL_ENV/bin/activate"

            # Install the built wheel using venv pip with proxy extras
            WHEEL_FILES=(dist/litellm-*.whl)
            if [ ${#WHEEL_FILES[@]} -gt 1 ]; then
              echo "Error: Multiple wheel files found:"
              printf '  %s\n' "${WHEEL_FILES[@]}"
              exit 1
            elif [ ${#WHEEL_FILES[@]} -eq 0 ] || [ ! -f "${WHEEL_FILES[0]}" ]; then
              echo "Error: No wheel files found in dist/"
              exit 1
            fi
            WHEEL_FILE="${WHEEL_FILES[0]}"
            pip install "${WHEEL_FILE}[proxy]"

            # Install all dependencies directly from requirements.txt to ensure CLI tools are available
            # This includes prisma which provides the prisma-client-py CLI tool needed for prisma generate
            pip install -r requirements.txt

            # Handle PyJWT specifically (upstream requirement)
            pip uninstall jwt -y || true
            pip uninstall PyJWT -y || true
            pip install PyJWT==2.9.0 --no-cache-dir

            # CVE remediation: Upgrade packages to fix known vulnerabilities
            pip install --upgrade 'starlette>=0.49.1'              # Fix CVE-2025-62727
            pip install --upgrade 'aiohttp>=3.12.14'               # Fix CVE-2025-53643
            pip install --upgrade 'cryptography>=44.0.1'           # Fix CVE-2024-12797
            pip install --upgrade 'mcp>=1.23.0'                    # Fix CVE-2025-66416
            pip install --upgrade 'fastapi-sso>=0.19.0'            # Fix CVE-2025-14546
            pip install --upgrade 'urllib3>=2.6.3'                 # Fix CVE-2026-21441
            pip install --upgrade 'pynacl>=1.6.2'                  # Fix CVE-2025-69277
            pip install --upgrade 'nodejs-wheel-binaries>=24.13.0' # Fix CVE-2025-55130, CVE-2025-55131, CVE-2025-59466, CVE-2026-21637, CVE-2025-55132
            pip install --upgrade 'python-multipart>=0.0.22'       # Fix CVE-2026-24486
            pip install --upgrade 'orjson>=3.11.5'                 # Fix CVE-2025-67221
        - name: patch diff package in nodejs_wheel
          privileged: true
          runs: |
            set -eux -o pipefail

            # Extract fixed diff version (downloaded in files section)
            mkdir -p /tmp/diff-fix
            tar -xzf ${source.dir}/diff-8.0.3.tgz -C /tmp/diff-fix

            # Find and replace diff package in nodejs_wheel location
            # The path is: /opt/litellm/lib/python3.*/site-packages/nodejs_wheel/lib/node_modules/npm/node_modules/diff
            find "$VIRTUAL_ENV/lib" -type d -path "*/nodejs_wheel/lib/node_modules/npm/node_modules/diff" -print0 | while IFS= read -r -d '' diff_dir; do
              echo "Replacing $diff_dir"
              rm -rf "$diff_dir"
              cp -r /tmp/diff-fix/package "$diff_dir"
            done

            rm -rf /tmp/diff-fix
        - name: install final packages in venv
          privileged: true
          runs: |
            set -eux -o pipefail

            # Source the virtual environment
            source "$VIRTUAL_ENV/bin/activate"

            # Install semantic_router without dependencies using venv pip
            pip install semantic_router --no-deps

            # Generate prisma client using venv python module interface
            # NOTE: This runs code generation that should be audited for security
            python3 -m prisma generate
        - name: prepare system integration
          runs: |
            set -eux -o pipefail

            # Create symlink for litellm executable in /usr/local/bin
            mkdir -p "${target.dir}/usr/local/bin"
            ln -s ../../../opt/litellm/bin/litellm "${target.dir}/usr/local/bin/litellm"

            # Create dummy supervisor script with helpful error message.
            mkdir -p "${target.dir}/usr/bin"
            cat > "${target.dir}/usr/bin/supervisord" << 'EOF'
            #!/bin/bash
            echo "The 'supervisor' package is not installed in the DHI litellm image, and is not supported by default."
            exit 1
            EOF
            chmod +x "${target.dir}/usr/bin/supervisord"
        - name: prepare runtime files
          work-dir: ${source.dir}/litellm-src
          runs: |
            set -eux -o pipefail

            # Copy source files needed at runtime
            mkdir -p "${target.dir}/app/docker"
            cp docker/entrypoint.sh "${target.dir}/app/docker/"
            cp docker/prod_entrypoint.sh "${target.dir}/app/docker/"

            chmod +x "${target.dir}/app/docker/entrypoint.sh"
            chmod +x "${target.dir}/app/docker/prod_entrypoint.sh"
        - name: python dependencies sbom
          uses: sbom@v1
          privileged: true
          with:
            extra-scanners: python-package-cataloger
            prefix: litellm-python
            source: /opt/litellm
      outputs:
        - source: ${target.dir}/app
          target: /app
          uid: 0
          gid: 0
        - source: /opt/litellm
          target: /opt/litellm
          uid: 0
          gid: 0
        - source: ${target.dir}/usr/local/bin
          target: /usr/local/bin
          uid: 0
          gid: 0
        - source: ${target.dir}/usr/bin
          target: /usr/bin
          uid: 0
          gid: 0
        - source: /opt/docker/sbom
          target: /opt/docker/sbom
          uid: 0
          gid: 0
  artifacts:
    - name: dhi.io/python:3.13.12-debian13@sha256:b8ab2d350cf8b832825e80338f1b38c2ebe5ad21918d465404e9f91b77343044
      includes:
        - opt/**
        - usr/**
      uid: 0
      gid: 0
accounts:
  root: true
  run-as: root
  users:
    - name: nonroot
      uid: 65532
      gid: 65532
    - name: _apt
      uid: 42
      gid: 65532
  groups:
    - name: nonroot
      gid: 65532
      members:
        - nonroot
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
work-dir: /app
environment:
  DEBIAN_FRONTEND: noninteractive
  PATH: /opt/litellm/bin:/usr/local/bin:/usr/local/sbin:/usr/sbin:/usr/bin:/sbin:/bin
  PYTHON_VERSION: 3.13.12
paths:
  - type: directory
    path: /app
    uid: 0
    gid: 0
    mode: "0755"
annotations:
  org.opencontainers.image.description: A minimal LiteLLM image - Universal LLM API Gateway
  org.opencontainers.image.licenses: MIT
entrypoint:
  - /app/docker/prod_entrypoint.sh
cmd:
  - --port
  - "4000"
ports:
  - 4000/tcp
