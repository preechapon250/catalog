# syntax=dhi.io/build:2-debian13

name: AWS CLI 2.x
image: dhi.io/awscli
variant: runtime
tags:
  - "2"
  - "2.33"
  - 2.33.7
  - 2-debian13
  - 2.33-debian13
  - 2.33.7-debian13
platforms:
  - linux/amd64
  - linux/arm64
vars:
  ARCH: '#{ target.arch == "amd64" ? "x86_64" : "aarch64" }'
  SEMVER_MAJOR_MINOR_VERSION: "2.33"
  SEMVER_MAJOR_VERSION: "2"
  SEMVER_VERSION: 2.33.7
  VERSION: 2.33.7
contents:
  packages:
    - '!libelogind0'
    - '!mawk'
    - '!original-awk'
    - base-files
    - groff-base
    - less
    - libffi8
    - ncurses-base
    - ncurses-bin
    - zlib1g
  builds:
    - name: awscli
      contents:
        packages:
          - bash
          - coreutils
          - gpg
          - gpg-agent
          - unzip
        files:
          - url: https://awscli.amazonaws.com/awscli-exe-linux-${ARCH}-2.33.7.zip.sig
            path: ${source.dir}/sig/awscli.zip.sig
            uid: 0
            gid: 0
          - url: https://awscli.amazonaws.com/awscli-exe-linux-${ARCH}-2.33.7.zip
            path: ${source.dir}/awscli.zip
            spdx:
              name: awscli
              version: 2.33.7
              packages:
                - name: awscli
                  purl: pkg:dhi/awscli@2.33.7
                  license: Apache-2.0
            uid: 0
            gid: 0
      pipeline:
        - name: install
          runs: |
            set -eux -o pipefail

            GNUPGHOME="$(mktemp -d)"
            export GNUPGHOME

            mkdir -p keys
            cat >> keys/awscli-gpg-key << EOF
            -----BEGIN PGP PUBLIC KEY BLOCK-----

            mQINBF2Cr7UBEADJZHcgusOJl7ENSyumXh85z0TRV0xJorM2B/JL0kHOyigQluUG
            ZMLhENaG0bYatdrKP+3H91lvK050pXwnO/R7fB/FSTouki4ciIx5OuLlnJZIxSzx
            PqGl0mkxImLNbGWoi6Lto0LYxqHN2iQtzlwTVmq9733zd3XfcXrZ3+LblHAgEt5G
            TfNxEKJ8soPLyWmwDH6HWCnjZ/aIQRBTIQ05uVeEoYxSh6wOai7ss/KveoSNBbYz
            gbdzoqI2Y8cgH2nbfgp3DSasaLZEdCSsIsK1u05CinE7k2qZ7KgKAUIcT/cR/grk
            C6VwsnDU0OUCideXcQ8WeHutqvgZH1JgKDbznoIzeQHJD238GEu+eKhRHcz8/jeG
            94zkcgJOz3KbZGYMiTh277Fvj9zzvZsbMBCedV1BTg3TqgvdX4bdkhf5cH+7NtWO
            lrFj6UwAsGukBTAOxC0l/dnSmZhJ7Z1KmEWilro/gOrjtOxqRQutlIqG22TaqoPG
            fYVN+en3Zwbt97kcgZDwqbuykNt64oZWc4XKCa3mprEGC3IbJTBFqglXmZ7l9ywG
            EEUJYOlb2XrSuPWml39beWdKM8kzr1OjnlOm6+lpTRCBfo0wa9F8YZRhHPAkwKkX
            XDeOGpWRj4ohOx0d2GWkyV5xyN14p2tQOCdOODmz80yUTgRpPVQUtOEhXQARAQAB
            tCFBV1MgQ0xJIFRlYW0gPGF3cy1jbGlAYW1hem9uLmNvbT6JAlQEEwEIAD4CGwMF
            CwkIBwIGFQoJCAsCBBYCAwECHgECF4AWIQT7Xbd/1cEYuAURraimMQrMRnJHXAUC
            ZqFYbwUJCv/cOgAKCRCmMQrMRnJHXKYuEAC+wtZ611qQtOl0t5spM9SWZuszbcyA
            0xBAJq2pncnp6wdCOkuAPu4/R3UCIoD2C49MkLj9Y0Yvue8CCF6OIJ8L+fKBv2DI
            yWZGmHL0p9wa/X8NCKQrKxK1gq5PuCzi3f3SqwfbZuZGeK/ubnmtttWXpUtuU/Iz
            VR0u/0sAy3j4uTGKh2cX7XnZbSqgJhUk9H324mIJiSwzvw1Ker6xtH/LwdBeJCck
            bVBdh3LZis4zuD4IZeBO1vRvjot3Oq4xadUv5RSPATg7T1kivrtLCnwvqc6L4LnF
            0OkNysk94L3LQSHyQW2kQS1cVwr+yGUSiSp+VvMbAobAapmMJWP6e/dKyAUGIX6+
            2waLdbBs2U7MXznx/2ayCLPH7qCY9cenbdj5JhG9ibVvFWqqhSo22B/URQE/CMrG
            +3xXwtHEBoMyWEATr1tWwn2yyQGbkUGANneSDFiTFeoQvKNyyCFTFO1F2XKCcuDs
            19nj34PE2TJilTG2QRlMr4D0NgwLLAMg2Los1CK6nXWnImYHKuaKS9LVaCoC8vu7
            IRBik1NX6SjrQnftk0M9dY+s0ZbAN1gbdjZ8H3qlbl/4TxMdr87m8LP4FZIIo261
            Eycv34pVkCePZiP+dgamEiQJ7IL4ZArio9mv6HbDGV6mLY45+l6/0EzCwkI5IyIf
            BfWC9s/USgxchg==
            =ptgS
            -----END PGP PUBLIC KEY BLOCK-----
            EOF

            gpg --import keys/awscli-gpg-key
            gpg --batch --verify sig/awscli.zip.sig awscli.zip
            unzip -q awscli.zip

            ./aws/install -i "${target.dir}/opt/aws-cli" -b "${target.dir}/opt/aws-cli/bin"

            # fix some symlinks
            ln -sfn "/opt/aws-cli/v2/2.33.7" "${target.dir}/opt/aws-cli/v2/current"
            ln -sf "/opt/aws-cli/v2/current/bin/aws" "${target.dir}/opt/aws-cli/bin/aws"
            ln -sf "/opt/aws-cli/v2/current/bin/aws_completer" "${target.dir}/opt/aws-cli/bin/aws_completer"
      outputs:
        - source: ${target.dir}/opt/aws-cli
          target: /opt/aws-cli
          uid: 0
          gid: 0
        - source: /opt/docker/sbom
          target: /opt/docker/sbom
          uid: 0
          gid: 0
accounts:
  run-as: nonroot
  users:
    - name: nonroot
      uid: 65532
      gid: 65532
  groups:
    - name: nonroot
      gid: 65532
      members:
        - nonroot
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
environment:
  AWS_CLI_VERSION: 2.33.7
  PATH: /opt/aws-cli/bin:/usr/sbin:/sbin:/usr/bin:/bin
annotations:
  org.opencontainers.image.description: A minimal AWS CLI image
cmd:
  - aws
  - help
