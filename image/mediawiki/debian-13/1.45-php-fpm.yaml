# syntax=dhi.io/build:2-debian13

name: MediaWiki 1.45 (php-fpm)
image: dhi.io/mediawiki
variant: runtime
flavor: php-fpm
tags:
  - 1-php-fpm
  - 1.45-php-fpm
  - 1.45.1-php-fpm
  - 1-debian13-php-fpm
  - 1.45-debian13-php-fpm
  - 1.45.1-debian13-php-fpm
platforms:
  - linux/amd64
  - linux/arm64
dates:
  release: "2025-12-04"
vars:
  EXPAT_REFERENCE: dhi/pkg-expat:2.7.4-debian13@sha256:1a2ba4b5f4c2a647ccec8ee0d2bccba26bc8704c9c89f9940a9cebadc49cb88d
  IMAGEMAGICK_COMMIT_SHA: dd991e286b96918917a3392d6dc3ffc0e6907a4e
  IMAGEMAGICK_VERSION: 7.1.2-13
  PHP_DEV_REFERENCE: dhi/php:8.3.30-debian13-dev@sha256:bd54468033c807dfa4e579aedad59410f6f0b0a864b994ae563f7c04742b5284
  PHP_INI_DIR: /opt/php-8.3/etc/php
  PHP_MAJOR_MINOR_VERSION: "8.3"
  PHP_PREFIX: /opt/php-8.3
  PHP_REFERENCE: dhi/php:8.3.30-debian13-fpm@sha256:109286536b679f18939ab544572f098104a5d49e51f70870489ebf5b150553a2
  PHP_VERSION: 8.3.30
  PYTHON_REFERENCE: dhi/python:3.13.11-debian13@sha256:82f87b495af6eea80c889c028756a1929a71a8d6b424ebd511b557294a97e55e
  SEMVER_MAJOR_MINOR_VERSION: "1.45"
  SEMVER_MAJOR_VERSION: "1"
  SEMVER_VERSION: 1.45.1
  VERSION: 1.45.1
contents:
  packages:
    - '!imagemagick'
    - '!libelogind0'
    - '!libexpat1'
    - '!mawk'
    - '!original-awk'
    - base-files
    - fontconfig-config
    - git
    - libargon2-1
    - libcurl4t64
    - libfontconfig1
    - libicu76
    - liblcms2-2
    - libltdl7
    - liblua5.1-0
    - libonig5
    - libpcre2-8-0
    - libreadline8t64
    - libsodium23
    - libsqlite3-0
    - libssl3t64
    - libtiff6
    - libwebp7
    - libxml2
    - zlib1g
  builds:
    - name: mediawiki
      uses: dhi.io/php:8.3.30-debian13-dev@sha256:bd54468033c807dfa4e579aedad59410f6f0b0a864b994ae563f7c04742b5284
      contents:
        packages:
          - ca-certificates
          - coreutils
          - curl
          - liblua5.1-0-dev
          - libpcre2-dev
          - tar
        files:
          - url: https://releases.wikimedia.org/mediawiki/1.45/mediawiki-1.45.1.tar.gz
            path: ${source.dir}/mediawiki.tar.gz
            spdx:
              name: mediawiki
              version: 1.45.1
              packages:
                - name: mediawiki
                  purl: pkg:composer/mediawiki/core@1.45.1
                  license: GPL-2.0-or-later
            uid: 0
            gid: 0
          - url: https://releases.wikimedia.org/mediawiki/1.45/mediawiki-1.45.1.tar.gz.sig
            path: ${source.dir}/mediawiki.tar.gz.sig
            uid: 0
            gid: 0
      pipeline:
        - name: verify server GPG
          uses: gpg/verify@v1
          with:
            file: ${source.dir}/mediawiki.tar.gz
            keys: ${source.dir}/keys.txt
            signature: ${source.dir}/mediawiki.tar.gz.sig
        - name: extract source
          work-dir: ${source.dir}/mediawiki
          runs: |
            set -eux -o pipefail

            tar -x --strip-components=1 -f '${source.dir}/mediawiki.tar.gz'
        - name: install php extensions with pecl
          privileged: true
          runs: |
            set -eux -o pipefail

            pecl install APCu
            echo "extension=apcu.so" > /opt/php-8.3/etc/php/conf.d/apcu.ini

            pecl install LuaSandbox
            echo "extension=luasandbox.so" > /opt/php-8.3/etc/php/conf.d/luasandbox.ini
        - name: add calendar php extension
          work-dir: /opt/php-8.3/src/ext/calendar
          privileged: true
          runs: |
            set -eux -o pipefail

            phpize
            ./configure --with-php-config=/opt/php-8.3/bin/php-config
            make -j "$(nproc)"
            make install

            echo "extension=calendar.so" > /opt/php-8.3/etc/php/conf.d/calendar.ini
        - name: add mysqli php extension
          work-dir: /opt/php-8.3/src/ext/mysqli
          privileged: true
          runs: |
            set -eux -o pipefail

            phpize
            ./configure --with-php-config=/opt/php-8.3/bin/php-config
            make -j "$(nproc)"
            make install

            echo "extension=mysqli.so" > /opt/php-8.3/etc/php/conf.d/mysqli.ini
        - name: configure opcache
          runs: |
            set -eux -o pipefail

            cat << 'EOF' >> /opt/php-8.3/etc/php/conf.d/opcache-recommended.ini
            opcache.memory_consumption=128
            opcache.interned_strings_buffer=8
            opcache.max_accelerated_files=4000
            opcache.revalidate_freq=60
            EOF
      paths:
        - type: file
          path: ${source.dir}/keys.txt
          uid: 0
          gid: 0
          source: image/mediawiki/key/keys.txt
      outputs:
        - source: /opt/php-8.3
          target: /opt/php-8.3
          uid: 0
          gid: 0
          diff: true
        - source: ${source.dir}/mediawiki
          target: /var/www/html
          uid: 0
          gid: 0
          diff: true
        - source: /opt/docker/sbom/mediawiki
          target: /opt/docker/sbom/mediawiki
          uid: 0
          gid: 0
    - name: imagemagick
      contents:
        packages:
          - autoconf
          - bash
          - build-essential
          - coreutils
          - grep
          - fontconfig-config
          - libfontconfig1-dev
          - libfreetype-dev
          - libjpeg62-turbo-dev
          - liblcms2-dev
          - liblqr-1-0-dev
          - libltdl-dev
          - liblzma-dev
          - libonig-dev
          - libopenexr-dev
          - libopenjp2-7-dev
          - libpango1.0-dev
          - libpcre2-dev
          - libperl-dev
          - libpng-dev
          - libraw-dev
          - librsvg2-bin
          - librsvg2-dev
          - libtiff-dev
          - libtool
          - libwebp-dev
          - libwmf-dev
          - libx11-dev
          - libxext-dev
          - libxml2-dev
          - libxml2-utils
          - libxt-dev
          - libzip-dev
          - libicu-dev
          - libonig-dev
          - make
          - pkg-config
          - sed
          - xsltproc
          - zlib1g-dev
        files:
          - url: git+https://github.com/ImageMagick/ImageMagick#7.1.2-13
            checksum: dd991e286b96918917a3392d6dc3ffc0e6907a4e
            path: ${source.dir}/imagemagick
            spdx:
              name: imagemagick
              version: 7.1.2-13
              packages:
                - name: imagemagick
                  purl: pkg:dhi/imagemagick/imagemagick@7.1.2-13
                  license: Apache-2.0
            uid: 0
            gid: 0
      pipeline:
        - name: build
          work-dir: ${source.dir}/imagemagick
          environment:
            CC: gcc
            CFLAGS: -Wno-deprecated-declarations -Wdeclaration-after-statement -Wno-error=unused-variable
            CXX: g++
          runs: |
            set -eux -o pipefail

            ./configure \
              --prefix=/usr/local \
              --enable-reproducible-build \
              --disable-static \
              --enable-shared \
              --with-modules \
              --with-quantum-depth=16 \
              --without-magick-plus-plus \
              --without-perl \
              --disable-docs \
              --disable-opencl

            make -j$(nproc)
            make install DESTDIR=${target.dir}
      outputs:
        - source: ${target.dir}/usr/local/bin
          target: /usr/local/bin
          uid: 0
          gid: 0
        - source: ${target.dir}/usr/local/etc
          target: /usr/local/etc
          uid: 0
          gid: 0
        - source: ${target.dir}/usr/local/include
          target: /usr/local/include
          uid: 0
          gid: 0
        - source: ${target.dir}/usr/local/lib
          target: /usr/local/lib
          uid: 0
          gid: 0
        - source: ${target.dir}/usr/local/share
          target: /usr/local/share
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/imagemagick
          target: /opt/docker/sbom/imagemagick
          uid: 0
          gid: 0
  artifacts:
    - name: dhi.io/php:8.3.30-debian13-fpm@sha256:109286536b679f18939ab544572f098104a5d49e51f70870489ebf5b150553a2
      includes:
        - opt/**
        - var/www/html/**
      uid: 0
      gid: 0
    - name: dhi.io/python:3.13.11-debian13@sha256:82f87b495af6eea80c889c028756a1929a71a8d6b424ebd511b557294a97e55e
      includes:
        - opt/**
      uid: 0
      gid: 0
    - name: dhi.io/pkg-expat:2.7.4-debian13@sha256:1a2ba4b5f4c2a647ccec8ee0d2bccba26bc8704c9c89f9940a9cebadc49cb88d
      includes:
        - usr/**
        - var/lib/dpkg/status.d
      uid: 0
      gid: 0
accounts:
  run-as: nonroot
  users:
    - name: nonroot
      uid: 65532
      gid: 65532
  groups:
    - name: nonroot
      gid: 65532
      members:
        - nonroot
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
paths:
  - type: directory
    path: /var/www/data
    uid: 65532
    gid: 65532
    mode: "0755"
  - type: directory
    path: /tmp
    uid: 0
    gid: 0
    mode: "0777"
annotations:
  org.opencontainers.image.description: A minimal MediaWiki image
  org.opencontainers.image.licenses: GPL-2.0
cmd:
  - php-fpm
ports:
  - 9000/tcp
