# syntax=dhi.io/build:1-debian13

name: JMX Exporter 1.x
image: dhi.io/jmx-exporter
variant: runtime
tags:
  - "1"
  - "1.5"
  - 1.5.0
  - 1-debian13
  - 1.5-debian13
  - 1.5.0-debian13
platforms:
  - linux/amd64
  - linux/arm64
vars:
  COMMIT_SHA: 72ad343795ce3e32651bd1810c4d3ed8395b3816
  JAVA_MAJOR_VERSION: "21"
  JAVA_PATH: /opt/java/openjdk/21-jre
  JAVA_REFERENCE: dhi/eclipse-temurin:21.0.9.10-debian13@sha256:8be38a5a3942a69d6ac8a6040c54fb588b6fc29499fa44fec189d2438be4d6a8
  JAVA_VERSION: 21.0.9.10
  MAVEN_REFERENCE: dhi/maven:3.9.11-jdk23-debian13-dev@sha256:97e4283d662a0a0dd680bc67c7cfa519d9cf6ef21567f0a727d050a760df3ff8
  MAVEN_VERSION: 3.9.11
  SEMVER_MAJOR_MINOR_VERSION: "1.5"
  SEMVER_MAJOR_VERSION: "1"
  SEMVER_VERSION: 1.5.0
  VERSION: 1.5.0
contents:
  packages:
    - '!cdebconf'
    - '!debconf'
    - '!dpkg'
    - '!gawk'
    - '!gcc-14-base'
    - '!install-info'
    - '!libacl1'
    - '!libbz2-1.0'
    - '!libelogind0'
    - '!libgcc-s1'
    - '!libgmp10'
    - '!liblzma5'
    - '!libmd0'
    - '!libmpfr6'
    - '!libnewt0.52'
    - '!libpcre2-8-0'
    - '!libreadline8t64'
    - '!libselinux1'
    - '!libsigsegv2'
    - '!libslang2'
    - '!libssl3t64'
    - '!libtextwrap1'
    - '!libtinfo6'
    - '!libzstd1'
    - '!mawk'
    - '!openssl'
    - '!openssl-provider-legacy'
    - '!original-awk'
    - '!readline-common'
    - '!tar'
    - '!zlib1g'
    - base-files
    - ca-certificates
    - libstdc++6
  builds:
    - name: jmx-exporter
      uses: dhi.io/maven:3.9.11-jdk23-debian13-dev@sha256:97e4283d662a0a0dd680bc67c7cfa519d9cf6ef21567f0a727d050a760df3ff8
      contents:
        packages:
          - coreutils
          - tar
          - unzip
          - wget
          - xmlstarlet
        files:
          - url: git+https://github.com/prometheus/jmx_exporter.git#1.5.0
            checksum: 72ad343795ce3e32651bd1810c4d3ed8395b3816
            path: ${source.dir}/jmx-exporter-72ad343795ce3e32651bd1810c4d3ed8395b3816
            spdx:
              name: jmx-exporter
              version: 1.5.0
              packages:
                - name: jmx-exporter
                  purl: pkg:dhi/jmx-exporter@1.5.0
                  license: Apache-2.0
            uid: 0
            gid: 0
      pipeline:
        - name: build
          privileged: true
          runs: |
            set -eux -o pipefail

            cd "${source.dir}/jmx-exporter-72ad343795ce3e32651bd1810c4d3ed8395b3816"

            mvn -B versions:set -DnewVersion="1.5.0" -DprocessAllModules
            mvn -B clean package

            mkdir -p /opt/jmx-exporter
            cp jmx_prometheus_javaagent/target/jmx_prometheus_javaagent-1.5.0.jar /opt/jmx-exporter/jmx_prometheus_javaagent.jar
            cp jmx_prometheus_standalone/target/jmx_prometheus_standalone-1.5.0.jar /opt/jmx-exporter/jmx_prometheus_standalone.jar
        - name: copy examples
          runs: |
            set -eux -o pipefail

            cp -r "${source.dir}/jmx-exporter-72ad343795ce3e32651bd1810c4d3ed8395b3816/examples" /opt/jmx-exporter
        - name: copy jars for sbom
          privileged: true
          runs: |
            set -eux -o pipefail

            cd "${source.dir}/jmx-exporter-72ad343795ce3e32651bd1810c4d3ed8395b3816"

            # maven-shade-plugin is incorrectly scoped as "compile" which causes it and its transitive dependencies to
            # be considered necessary for running the application.
            # Upstream works around this bug by explicitly excluding it from the uber jar, but that doesn't fix the
            # underlying issue, so copy-dependencies will still include them.
            # We fix the issue directly by correcting the scope to "test".
            xmlstarlet ed -L -N m="http://maven.apache.org/POM/4.0.0" \
              -u "//m:dependency[m:groupId='org.apache.maven.plugins' and m:artifactId='maven-shade-plugin']/m:scope" \
              -v "test" pom.xml

            # Install the local dependencies so that copy-dependencies will find them.
            mvn install -pl collector,jmx_prometheus_common

            mkdir -p "${source.dir}/jmx-exporter-72ad343795ce3e32651bd1810c4d3ed8395b3816-deps"
            mvn dependency:copy-dependencies \
              -pl collector,jmx_prometheus_common,jmx_prometheus_javaagent,jmx_prometheus_standalone \
              -DincludeScope=runtime \
              -DoutputDirectory="${source.dir}/jmx-exporter-72ad343795ce3e32651bd1810c4d3ed8395b3816-deps"
        - name: maven sbom
          uses: sbom@v1
          with:
            extra-scanners: java-archive-cataloger
            prefix: jmx-exporter-maven
            source: ${source.dir}/jmx-exporter-72ad343795ce3e32651bd1810c4d3ed8395b3816-deps
      outputs:
        - source: /opt/jmx-exporter
          target: /opt/jmx-exporter
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/jmx-exporter
          target: /opt/docker/sbom/jmx-exporter
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/jmx-exporter-maven
          target: /opt/docker/sbom/jmx-exporter-maven
          uid: 0
          gid: 0
    - name: locale
      uses: dhi.io/debian-base:trixie-debian13@sha256:c7651f9ef631e9a9feada59aff228f9382bdb537e85dc8e9c201093597898c45
      contents:
        packages:
          - bash
          - locales
          - coreutils
          - gzip
      pipeline:
        - name: install locales
          runs: |
            set -eux -o pipefail

            echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen
            locale-gen en_US.UTF-8
      outputs:
        - source: /usr/share/locale
          target: /usr/share/locale
          uid: 0
          gid: 0
        - source: /usr/lib/locale
          target: /usr/lib/locale
          uid: 0
          gid: 0
  artifacts:
    - name: dhi.io/eclipse-temurin:21.0.9.10-debian13@sha256:8be38a5a3942a69d6ac8a6040c54fb588b6fc29499fa44fec189d2438be4d6a8
      includes:
        - opt/**
        - usr/local/bin
      uid: 0
      gid: 0
accounts:
  run-as: nonroot
  users:
    - name: nonroot
      uid: 65532
      gid: 65532
  groups:
    - name: nonroot
      gid: 65532
      members:
        - nonroot
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
work-dir: /opt/jmx-exporter
environment:
  JAVA_HOME: /opt/java/openjdk/21-jre
  LANG: en_US.UTF-8
  LANGUAGE: en_US:en
  LC_ALL: en_US.UTF-8
annotations:
  org.opencontainers.image.description: A minimal JMX Exporter image
  org.opencontainers.image.licenses: Apache-2.0
entrypoint:
  - java
  - -jar
  - jmx_prometheus_standalone.jar
cmd:
  - "5556"
  - examples/standalone_sample_config.yml
ports:
  - 5556/tcp
tests:
  - name: Run testcontainers tests
    directory: image/jmx-exporter/tests
    commands:
      - go test . -count=1 -v
    exit-code: 0
  - name: Run common testcontainers tests
    directory: test/go-testing/base
    commands:
      - go test . -count=1 -v
    exit-code: 0
  - name: Run locales tests
    directory: test/go-testing/locales
    commands:
      - go test . -count=1 -v
    exit-code: 0
