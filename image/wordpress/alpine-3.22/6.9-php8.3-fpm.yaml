# syntax=dhi.io/build:2-alpine3.22

name: WordPress 6.9.1 (php8.3-fpm)
image: dhi.io/wordpress
variant: runtime
flavor: php8.3-fpm
tags:
  - 6.9.1-alpine3.23-php8.3-fpm
platforms:
  - linux/amd64
  - linux/arm64
dates:
  release: "2025-12-02"
vars:
  COMMIT_SHA: 034dcde94c906b65266b79306694fced11d9c3da
  IMAGEMAGICK_COMMIT_SHA: dd991e286b96918917a3392d6dc3ffc0e6907a4e
  IMAGEMAGICK_PREFIX: /opt/imagemagick
  IMAGEMAGICK_VERSION: 7.1.2-13
  IMAGICK_COMMIT_SHA: 70087bab33eab913e99ac77d64d04d1a2fd0b7b0
  IMAGICK_VERSION: 3.8.1
  PHP_DEV_REFERENCE: dhi/php:8.3-alpine3.22-dev@sha256:49694d1695b152e3fa3533568c8eea0d48298e6316e6ba7c23d83e6a5d4429b5
  PHP_FPM_REFERENCE: dhi/php:8.3-alpine3.22-fpm@sha256:f56fe87c8ec8a4b2ecdce880aedf8ed65ef76d0cc99c28778455d204256e375d
  PHP_INI_DIR: /opt/php-8.3/etc/php
  PHP_MAJOR_MINOR: "8.3"
  PHP_PREFIX: /opt/php-8.3
  PHP_SRC_DIR: /opt/php-8.3/src
  PHP_VERSION: "8.3"
  VERSION: 6.9.1
  WORDPRESS_DOCKER_COMMIT_SHA: ecc7cdbdf47591bfa14954933fa2ab4fcce46428
  WORDPRESS_DOCKER_DEFAULT_CONFIG_CHECKSUM: sha256:1513f88b7252f29790f0acad201b1ef0d442f0d80e88c33e4a6d473615084162
  WORDPRESS_DOCKER_ENTRYPOINT_CHECKSUM: sha256:4e925e60ccc324f3f5df8da39d518c88a6d2e1b228113811493c5a975ae9137b
contents:
  repositories:
    - https://dl-cdn.alpinelinux.org/alpine/v3.23/main
    - https://dl-cdn.alpinelinux.org/alpine/v3.23/community
  packages:
    - argon2-libs
    - bash
    - coreutils
    - findutils
    - fontconfig
    - freetype
    - grep
    - icu-libs
    - lcms2
    - libcurl
    - libgomp
    - libjpeg-turbo
    - libltdl
    - libpng
    - libsodium
    - libstdc++
    - libwebp
    - libxml2
    - libzip
    - oniguruma
    - openssl
    - sed
    - sqlite-libs
    - tar
    - tiff
    - util-linux
  files:
    - url: https://raw.githubusercontent.com/docker-library/wordpress/ecc7cdbdf47591bfa14954933fa2ab4fcce46428/latest/php8.3/fpm-alpine/docker-entrypoint.sh
      checksum: sha256:4e925e60ccc324f3f5df8da39d518c88a6d2e1b228113811493c5a975ae9137b
      path: /usr/local/bin/docker-entrypoint.sh
      uid: 0
      gid: 0
      mode: "0755"
    - url: https://raw.githubusercontent.com/docker-library/wordpress/ecc7cdbdf47591bfa14954933fa2ab4fcce46428/latest/php8.3/fpm-alpine/wp-config-docker.php
      checksum: sha256:1513f88b7252f29790f0acad201b1ef0d442f0d80e88c33e4a6d473615084162
      path: /usr/src/wordpress/wp-config-docker.php
      uid: 0
      gid: 0
      mode: "0644"
  builds:
    - name: build php extensions
      uses: dhi.io/php:8.3-alpine3.22-dev@sha256:49694d1695b152e3fa3533568c8eea0d48298e6316e6ba7c23d83e6a5d4429b5
      shell: bash
      contents:
        repositories:
          - https://dl-cdn.alpinelinux.org/alpine/v3.23/main
          - https://dl-cdn.alpinelinux.org/alpine/v3.23/community
        packages:
          - bash
          - build-base
          - fontconfig-dev
          - freetype-dev
          - lcms2-dev
          - libjpeg-turbo-dev
          - libpng-dev
          - libssl3
          - libtool
          - libwebp-dev
          - libxml2-dev
          - libzip-dev
          - make
          - oniguruma-dev
          - pcre2-dev
          - pkgconf
          - tiff-dev
          - zlib-dev
        files:
          - url: git+https://github.com/ImageMagick/ImageMagick.git#7.1.2-13
            checksum: dd991e286b96918917a3392d6dc3ffc0e6907a4e
            path: ${source.dir}/imagemagick
            spdx:
              name: imagemagick
              version: 7.1.2-13
              packages:
                - name: imagemagick
                  purl: pkg:github/ImageMagick/ImageMagick@7.1.2-13
                  license: ImageMagick
            uid: 0
            gid: 0
          - url: git+https://github.com/Imagick/imagick.git#3.8.1
            checksum: 70087bab33eab913e99ac77d64d04d1a2fd0b7b0
            path: ${source.dir}/imagick
            spdx:
              name: imagick
              version: 3.8.1
              packages:
                - name: imagick
                  purl: pkg:composer/imagick/imagick@3.8.1
                  license: PHP-3.01
            uid: 0
            gid: 0
      pipeline:
        - name: build imagemagick
          work-dir: ${source.dir}/imagemagick
          runs: |
            set -eux -o pipefail

            ./configure \
              --prefix=/opt/imagemagick \
              --disable-static \
              --enable-shared \
              --with-modules \
              --with-quantum-depth=16 \
              --without-magick-plus-plus \
              --without-perl \
              --disable-docs \
              --disable-opencl

            make -j$(nproc)
            make install

            # Copy to target directory for output
            mkdir -p ${target.dir}/opt
            cp -a /opt/imagemagick ${target.dir}/opt/

            # Strip debug symbols from libraries
            find ${target.dir}/opt/imagemagick -type f -name "*.so*" -exec strip --strip-unneeded {} \; || true
        - name: build bundled extensions
          runs: |
            set -eux -o pipefail

            # Function to build an extension
            build_ext() {
              local ext=$1
              shift
              cd /opt/php-8.3/src/ext/$ext
              phpize
              ./configure "$@"
              make -j$(nproc)
              make install
            }

            # GD with image format support
            build_ext gd --with-freetype --with-jpeg

            # Database extensions
            build_ext mysqli
            build_ext pdo_mysql

            # Other WordPress requirements
            build_ext zip
            build_ext exif
            build_ext bcmath
        - name: build imagick
          work-dir: ${source.dir}/imagick
          runs: |
            set -eux -o pipefail

            export PKG_CONFIG_PATH=/opt/imagemagick/lib/pkgconfig
            export CFLAGS="-I/opt/imagemagick/include/ImageMagick-7"
            export LDFLAGS="-L/opt/imagemagick/lib"

            phpize
            ./configure --with-imagick=/opt/imagemagick
            make -j$(nproc)
            make install
      outputs:
        - source: /opt/php-8.3/lib/php/extensions
          target: /opt/php-8.3/lib/php/extensions
          uid: 0
          gid: 0
        - source: ${target.dir}/opt/imagemagick
          target: /opt/imagemagick
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/imagemagick
          target: /opt/docker/sbom/imagemagick
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/imagick
          target: /opt/docker/sbom/imagick
          uid: 0
          gid: 0
    - name: wordpress install
      contents:
        packages:
          - bash
          - ca-certificates-bundle
          - busybox
        files:
          - url: git+https://github.com/WordPress/WordPress.git#6.9.1
            checksum: 034dcde94c906b65266b79306694fced11d9c3da
            path: ${source.dir}/wordpress
            spdx:
              name: wordpress
              version: 6.9.1
              packages:
                - name: wordpress
                  purl: pkg:github/WordPress/WordPress@6.9.1
                  license: GPL-2.0-or-later
            uid: 0
            gid: 0
      pipeline:
        - name: install wordpress
          runs: |
            set -eux -o pipefail

            # Copy WordPress to staging location
            mkdir -p ${target.dir}/usr/src/wordpress
            cp -a ${source.dir}/wordpress/. ${target.dir}/usr/src/wordpress/

            # Set permissions for nonroot user
            chown -R 65532:65532 ${target.dir}/usr/src/wordpress
      outputs:
        - source: ${target.dir}/usr/src/wordpress
          target: /usr/src/wordpress
          uid: 65532
          gid: 65532
        - source: /opt/docker/sbom/wordpress
          target: /opt/docker/sbom/wordpress
          uid: 0
          gid: 0
  artifacts:
    - name: dhi.io/php:8.3-alpine3.22-fpm@sha256:f56fe87c8ec8a4b2ecdce880aedf8ed65ef76d0cc99c28778455d204256e375d
      includes:
        - opt/docker/sbom/php
        - opt/php-8.3
      uid: 0
      gid: 0
accounts:
  run-as: nonroot
  users:
    - name: nonroot
      uid: 65532
      gid: 65532
  groups:
    - name: nonroot
      gid: 65532
      members:
        - nonroot
os-release:
  name: Docker Hardened Images (Alpine)
  id: alpine
  version-id: "3.23"
  pretty-name: Docker Hardened Images/Alpine Linux v3.23
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
work-dir: /var/www/html
stop-signal: SIGQUIT
environment:
  LD_LIBRARY_PATH: /opt/imagemagick/lib
  MAGICK_HOME: /opt/imagemagick
  PATH: /opt/imagemagick/bin:/opt/php-8.3/bin:/opt/php-8.3/sbin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
  PHP_INI_DIR: /opt/php-8.3/etc/php
  PHP_PREFIX: /opt/php-8.3
  PHP_VERSION: "8.5"
  WORDPRESS_VERSION: 6.9.1
paths:
  - type: directory
    path: /var/www/html
    uid: 65532
    gid: 65532
    mode: "0755"
  - type: directory
    path: /usr/src/wordpress/wp-content/plugins
    uid: 65532
    gid: 65532
    mode: "1777"
  - type: directory
    path: /usr/src/wordpress/wp-content/themes
    uid: 65532
    gid: 65532
    mode: "1777"
  - type: directory
    path: /usr/src/wordpress/wp-content/uploads
    uid: 65532
    gid: 65532
    mode: "1777"
  - type: directory
    path: /usr/src/wordpress/wp-content/upgrade
    uid: 65532
    gid: 65532
    mode: "1777"
  - type: directory
    path: /usr/src/wordpress/wp-content/cache
    uid: 65532
    gid: 65532
    mode: "1777"
  - type: file
    path: /opt/php-8.3/etc/php/conf.d/opcache-recommended.ini
    uid: 0
    gid: 0
    mode: "0644"
    source: image/wordpress/config/opcache-recommended.ini
  - type: file
    path: /opt/php-8.3/etc/php/conf.d/error-logging.ini
    uid: 0
    gid: 0
    mode: "0644"
    source: image/wordpress/config/error-logging.ini
  - type: file
    path: /opt/php-8.3/etc/php/conf.d/docker-php-ext-gd.ini
    content: extension=gd.so
    uid: 0
    gid: 0
    mode: "0644"
  - type: file
    path: /opt/php-8.3/etc/php/conf.d/docker-php-ext-mysqli.ini
    content: extension=mysqli.so
    uid: 0
    gid: 0
    mode: "0644"
  - type: file
    path: /opt/php-8.3/etc/php/conf.d/docker-php-ext-pdo_mysql.ini
    content: extension=pdo_mysql.so
    uid: 0
    gid: 0
    mode: "0644"
  - type: file
    path: /opt/php-8.3/etc/php/conf.d/docker-php-ext-zip.ini
    content: extension=zip.so
    uid: 0
    gid: 0
    mode: "0644"
  - type: file
    path: /opt/php-8.3/etc/php/conf.d/docker-php-ext-exif.ini
    content: extension=exif.so
    uid: 0
    gid: 0
    mode: "0644"
  - type: file
    path: /opt/php-8.3/etc/php/conf.d/docker-php-ext-bcmath.ini
    content: extension=bcmath.so
    uid: 0
    gid: 0
    mode: "0644"
  - type: file
    path: /opt/php-8.3/etc/php/conf.d/docker-php-ext-imagick.ini
    content: extension=imagick.so
    uid: 0
    gid: 0
    mode: "0644"
  - type: file
    path: /opt/php-8.3/etc/php-fpm.d/zz-wordpress.conf
    content: |
      [www]
      user = nonroot
      group = nonroot
    uid: 0
    gid: 0
    mode: "0644"
annotations:
  org.opencontainers.image.description: A minimal WordPress image
  org.opencontainers.image.licenses: GPL-2.0-or-later
entrypoint:
  - /usr/local/bin/docker-entrypoint.sh
cmd:
  - php-fpm
ports:
  - 9000/tcp
