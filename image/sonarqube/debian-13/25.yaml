# syntax=dhi.io/build:2-debian13

name: SonarQube 25.x
image: dhi.io/sonarqube
variant: runtime
tags:
  - "25"
  - "25.12"
  - 25.12.0
  - 25-debian13
  - 25.12-debian13
  - 25.12.0-debian13
platforms:
  - linux/amd64
  - linux/arm64
vars:
  COMMIT_SHA: bd7a1254715e0df950e61d05c9a07cb1ba42552b
  DEBIAN_REFERENCE: dhi/debian-base:trixie-debian13@sha256:1244523a2f7b6c096c6f98ce0349df6798c775c57322c51f8a4982daf60c256c
  JAVA_HOME_PATH: /opt/java/openjdk
  JDK_MAJOR_VERSION: "17"
  JDK_VERSION: 17.0.17.10
  JRE_REF: dhi/eclipse-temurin:17.0.17.10-debian13@sha256:313eab48ed8980caa5d1281c91fdacc6c931b004536592b03e5587d735acfba4
  MAVEN_REF: dhi/maven:3.9.12-jdk17-debian13-dev@sha256:c4d2a5f1d0ee9625b5797429aa70b318fc34b6e24365c8dd961ef5c3fc79f4a1
  NETTY_VERSION: 4.1.129.Final
  SEMVER_MAJOR_MINOR_VERSION: "25.12"
  SEMVER_MAJOR_VERSION: "25"
  SEMVER_VERSION: 25.12.0
  SONARQUBE_DOCKER_SHA: 2d77476619099afc3df0129af7ebbf372fb72336
  SONARQUBE_DOCKER_VERSION: 25.11.0.114957
  SONARQUBE_HOME: /opt/sonarqube
  VERSION: 25.12.0.117093
contents:
  packages:
    - '!libelogind0'
    - '!mawk'
    - '!original-awk'
    - base-files
    - bash
    - coreutils
    - findutils
    - grep
  builds:
    - name: sonarqube
      uses: dhi.io/maven:3.9.12-jdk17-debian13-dev@sha256:c4d2a5f1d0ee9625b5797429aa70b318fc34b6e24365c8dd961ef5c3fc79f4a1
      contents:
        packages:
          - bash
          - ca-certificates
          - libudev-dev
          - unzip
          - jq
          - grep
        files:
          - url: git+https://github.com/SonarSource/sonarqube.git#25.12.0.117093
            checksum: bd7a1254715e0df950e61d05c9a07cb1ba42552b
            path: ${source.dir}/sonarqube
            spdx:
              name: sonarqube
              version: 25.12.0.117093
              packages:
                - name: sonarqube
                  purl: pkg:dhi/sonarqube@25.12.0.117093
                  license: LGPL-3.0-only
            uid: 0
            gid: 0
          - url: https://raw.githubusercontent.com/SonarSource/docker-sonarqube/25.11.0.114957/community-build/entrypoint.sh
            path: ${source.dir}/entrypoint.sh
            spdx:
              name: docker-sonarqube-entrypoint
              version: 25.11.0.114957
              packages:
                - name: docker-sonarqube-entrypoint
                  purl: pkg:dhi/docker-sonarqube@25.11.0.114957
                  license: LGPL-3.0-only
            uid: 0
            gid: 0
          - url: https://repo1.maven.org/maven2/io/netty/netty-handler/4.1.129.Final/netty-handler-4.1.129.Final.jar
            path: ${source.dir}/patch/deps/netty-handler-4.1.129.Final.jar
            uid: 0
            gid: 0
          - url: https://repo1.maven.org/maven2/io/netty/netty-codec-http2/4.1.129.Final/netty-codec-http2-4.1.129.Final.jar
            path: ${source.dir}/patch/deps/netty-codec-http2-4.1.129.Final.jar
            uid: 0
            gid: 0
          - url: https://repo1.maven.org/maven2/io/netty/netty-common/4.1.129.Final/netty-common-4.1.129.Final.jar
            path: ${source.dir}/patch/deps/netty-common-4.1.129.Final.jar
            uid: 0
            gid: 0
          - url: https://repo1.maven.org/maven2/io/netty/netty-codec/4.1.129.Final/netty-codec-4.1.129.Final.jar
            path: ${source.dir}/patch/deps/netty-codec-4.1.129.Final.jar
            uid: 0
            gid: 0
          - url: https://repo1.maven.org/maven2/io/netty/netty-codec-http/4.1.129.Final/netty-codec-http-4.1.129.Final.jar
            path: ${source.dir}/patch/deps/netty-codec-http-4.1.129.Final.jar
            uid: 0
            gid: 0
          - url: https://repo1.maven.org/maven2/org/bouncycastle/bc-fips/2.1.2/bc-fips-2.1.2.jar
            path: ${source.dir}/patch/deps/bc-fips-2.1.2.jar
            uid: 0
            gid: 0
          - url: https://repo1.maven.org/maven2/org/bouncycastle/bcpkix-jdk18on/1.79/bcpkix-jdk18on-1.79.jar
            path: ${source.dir}/patch/deps/bcpkix-jdk18on-1.79.jar
            uid: 0
            gid: 0
          - url: https://repo1.maven.org/maven2/com/microsoft/sqlserver/mssql-jdbc/13.2.1.jre11/mssql-jdbc-13.2.1.jre11.jar
            path: ${source.dir}/patch/deps/mssql-jdbc-13.2.1.jre11.jar
            uid: 0
            gid: 0
          - url: https://repo1.maven.org/maven2/at/yawk/lz4/lz4-java/1.10.1/lz4-java-1.10.1.jar
            path: ${source.dir}/patch/deps/lz4-java-1.10.1.jar
            uid: 0
            gid: 0
      pipeline:
        - name: set elasticsearch arch
          work-dir: ${source.dir}/sonarqube/sonar-application
          runs: |
            set -eux -o pipefail

            if [ '${target.arch}' = "arm64" ]; then
              sed -i '/zipDist "elasticsearch:elasticsearch:${elasticSearchServerVersion}-linux-x86_64@tar.gz"/s/x86_64/aarch64/g' build.gradle
            fi
        - name: build distribution
          work-dir: ${source.dir}/sonarqube
          privileged: true
          runs: |
            set -eux -o pipefail

            export JAVA_HOME="/opt/java/openjdk/17"
            export PATH="/opt/java/openjdk/17/bin:$PATH"

            ./gradlew :sonar-application:zip -x test --no-daemon --console=plain
        - name: extract and verify
          work-dir: ${source.dir}/sonarqube
          runs: |
            set -eux -o pipefail

            dist_zip=$(find . -name "sonar-application-*.zip" -type f)
            unzip -q "$dist_zip" -d "${target.dir}"
            dist_dir=$(find "${target.dir}" -name "sonarqube-*" -type d)
            mv "$dist_dir" "${target.dir}/sonarqube"
        - name: patch vulnerable JARs
          runs: |
            set -eux -o pipefail

            echo "Apply patches"
            # Apply runtime vulnerability patches using generic DHI patcher
            chmod +x "${source.dir}/patch/dhi-runtime-patch.sh"
            "${source.dir}/patch/dhi-runtime-patch.sh" \
              --app-root "${target.dir}/sonarqube" \
              --patch-dir "${source.dir}/patch/deps" \
              --config "${source.dir}/patch/dhi-patch-config.json"
      paths:
        - type: file
          path: ${source.dir}/patch/dhi-patch-config.json
          uid: 0
          gid: 0
          source: image/sonarqube/patch/dhi-patch-config.json
        - type: file
          path: ${source.dir}/patch/dhi-runtime-patch.sh
          uid: 0
          gid: 0
          source: image/sonarqube/patch/dhi-runtime-patch.sh
      outputs:
        - source: ${target.dir}/sonarqube
          target: /opt/sonarqube
          uid: 0
          gid: 0
        - source: ${source.dir}/entrypoint.sh
          target: /opt/sonarqube/docker/entrypoint.sh
          uid: 0
          gid: 0
          mode: "0755"
        - source: /opt/docker/sbom
          target: /opt/docker/sbom
          uid: 0
          gid: 0
    - name: locale
      uses: dhi.io/debian-base:trixie-debian13@sha256:1244523a2f7b6c096c6f98ce0349df6798c775c57322c51f8a4982daf60c256c
      contents:
        packages:
          - bash
          - locales
          - coreutils
          - gzip
      pipeline:
        - name: install locales
          runs: |
            set -eux -o pipefail

            ln -s /etc/locale.alias /usr/share/locale/locale.alias

            echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen
            locale-gen en_US.UTF-8
      outputs:
        - source: /usr/share/locale
          target: /usr/share/locale
          uid: 0
          gid: 0
        - source: /usr/lib/locale
          target: /usr/lib/locale
          uid: 0
          gid: 0
  artifacts:
    - name: dhi.io/eclipse-temurin:17.0.17.10-debian13@sha256:313eab48ed8980caa5d1281c91fdacc6c931b004536592b03e5587d735acfba4
      includes:
        - opt/**
        - usr/local/bin/**
      uid: 0
      gid: 0
accounts:
  run-as: sonarqube
  users:
    - name: sonarqube
      uid: 65532
      gid: 65532
  groups:
    - name: sonarqube
      gid: 65532
      members:
        - sonarqube
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
work-dir: /opt/sonarqube
environment:
  DOCKER_RUNNING: "true"
  ES_JAVA_HOME: /opt/java/openjdk
  JAVA_HOME: /opt/java/openjdk
  LANG: en_US.UTF-8
  LANGUAGE: en_US:en
  LC_ALL: en_US.UTF-8
  SONAR_VERSION: 25.12.0.117093
  SONARQUBE_HOME: /opt/sonarqube
  SQ_DATA_DIR: /opt/sonarqube/data
  SQ_EXTENSIONS_DIR: /opt/sonarqube/extensions
  SQ_LOGS_DIR: /opt/sonarqube/logs
  SQ_TEMP_DIR: /opt/sonarqube/temp
paths:
  - type: directory
    path: /opt/sonarqube/data
    uid: 65532
    gid: 65532
    mode: "0770"
  - type: directory
    path: /opt/sonarqube/extensions
    uid: 65532
    gid: 65532
    mode: "0770"
  - type: directory
    path: /opt/sonarqube/extensions/plugins
    uid: 65532
    gid: 65532
    mode: "0770"
  - type: directory
    path: /opt/sonarqube/logs
    uid: 65532
    gid: 65532
    mode: "0770"
  - type: directory
    path: /opt/sonarqube/temp
    uid: 65532
    gid: 65532
    mode: "0770"
  - type: directory
    path: /opt/sonarqube/temp/conf
    uid: 65532
    gid: 65532
    mode: "0770"
  - type: directory
    path: /opt/sonarqube/temp/conf/es
    uid: 65532
    gid: 65532
    mode: "0770"
  - type: symlink
    path: /opt/java/openjdk/bin
    uid: 0
    gid: 0
    source: /opt/java/openjdk/17-jre/bin
  - type: symlink
    path: /opt/sonarqube/lib/sonarqube.jar
    uid: 0
    gid: 0
    source: /opt/sonarqube/lib/sonar-application-25.12-SNAPSHOT.jar
annotations:
  org.opencontainers.image.description: A minimal SonarQube image.
  org.opencontainers.image.licenses: GNU Lesser General Public License v3.0
entrypoint:
  - /opt/sonarqube/docker/entrypoint.sh
ports:
  - 9000/tcp
