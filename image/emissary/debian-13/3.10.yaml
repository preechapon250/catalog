# syntax=dhi.io/build:2-debian13

name: Emissary 3.x
image: dhi.io/emissary
variant: runtime
tags:
  - "3"
  - "3.10"
  - 3.10.0
  - 3-debian13
  - 3.10-debian13
  - 3.10.0-debian13
platforms:
  - linux/amd64
  - linux/arm64
vars:
  ARCH: '#{ target.arch == "amd64" ? "x86_64" : "aarch64" }'
  BASE_DIGEST: sha256:74fc43fa240887b8159970e434244039aab0c6efaaa9cf044004cdc22aa2a34d
  BASE_TAG: 20250419-debian13
  COMMIT_SHA: d25610acbea3cd0e57f924f9f6bd9df99a7e33a3
  ENVOY_DIGEST: sha256:75aafdef175111ab3a757e22c354187acf7e11871ed13fccca943ff5c037e8cc
  ENVOY_VERSION: 1.31.10
  GO_DIGEST: sha256:0321bd51a66050dec733d26d791377273598a4f5078d70a0b8a47633af01f55b
  GO_VERSION: 1.24.12
  PYTHON_DIGEST: sha256:fdfa3cc3e9d6eaa2d2d3fa466c44e9278be1840f95aec45b9a9155b56be47f09
  PYTHON_MAJOR_MINOR_VERSION: "3.11"
  PYTHON_VERSION: 3.11.14
  SEMVER_MAJOR_MINOR_VERSION: "3.10"
  SEMVER_MAJOR_VERSION: "3"
  SEMVER_VERSION: 3.10.0
  VERSION: 3.10.0
contents:
  packages:
    - '!libelogind0'
    - '!mawk'
    - '!original-awk'
    - base-files
    - libcap2
    - libffi8
    - libyaml-0-2
    - locales
  builds:
    - name: emissary
      uses: dhi.io/golang:1.24.12-debian13-dev@sha256:0321bd51a66050dec733d26d791377273598a4f5078d70a0b8a47633af01f55b
      environment:
        PATH: /opt/python/bin:/go/bin:/usr/local/go/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
      contents:
        packages:
          - bash
          - binutils
          - binutils-gold
          - build-essential
          - coreutils
          - cargo
          - gcc
          - iptables
          - jq
          - libcap-dev
          - libcap2-bin
          - libffi-dev
          - libncurses6
          - libyaml-dev
          - make
          - openssl
          - patchelf
          - rsync
        files:
          - url: git+https://github.com/emissary-ingress/emissary.git#v3.10.0
            checksum: d25610acbea3cd0e57f924f9f6bd9df99a7e33a3
            path: ${source.dir}/emissary
            spdx:
              name: emissary
              version: 3.10.0
              packages:
                - name: emissary
                  purl: pkg:golang/github.com/emissary-ingress/emissary@3.10.0
                  license: Apache-2.0
            uid: 0
            gid: 0
        artifacts:
          - name: dhi.io/python:3.11.14-debian13@sha256:fdfa3cc3e9d6eaa2d2d3fa466c44e9278be1840f95aec45b9a9155b56be47f09
            includes:
              - opt/**
              - usr/**
            uid: 0
            gid: 0
      pipeline:
        - name: set emissary version
          work-dir: ${source.dir}/emissary
          runs: |
            set -eux -o pipefail

            cat > ./python/ambassador.version << EOF
            3.10.0
            d25610acbea3cd0e57f924f9f6bd9df99a7e33a3
            EOF
        - name: update go dependencies
          uses: go/bump@v1
          work-dir: ${source.dir}/emissary
          with:
            deps:
              - golang.org/x/oauth2@v0.27.0
              - k8s.io/kubernetes@v1.32.10
              - golang.org/x/net@v0.38.0
            download: true
        - name: update python dependencies
          work-dir: ${source.dir}/emissary/python
          runs: |
            set -eux -o pipefail

            sed -i 's/setuptools==75\.8\.2/setuptools==78.1.1/' requirements.txt               # fix CVE-2025-47273 (high)
            sed -i 's/python-json-logger==3\.2\.1/python-json-logger==3.3.0/' requirements.txt # fix CVE-2025-27607 (high)
            sed -i 's/urllib3==2\.3\.0/urllib3==2.6.3/' requirements.txt                       # fix CVE-2026-21441 (high)
            sed -i 's/requests==2\.32\.3/requests==2.32.4/' requirements.txt                   # fix CVE-2024-47081 (medium)
            sed -i 's/flask==3\.1\.0/flask==3.1.1/' requirements.txt                           # fix CVE-2025-47278 (low)
            sed -i 's/werkzeug==3\.1\.3/werkzeug==3.1.5/' requirements.txt                     # CVE-2026-21860
        - name: patch diagd
          uses: git/patch@v1
          work-dir: ${source.dir}/emissary
          with:
            patch: ${source.dir}/patch/diagd.3.10.patch
        - name: install python requirements
          work-dir: ${source.dir}/emissary/python
          privileged: true
          runs: |
            set -eux -o pipefail

            python3 -m venv ${target.dir}/opt/ambassador

            ${target.dir}/opt/ambassador/bin/python3 -m pip install --no-binary=pyyaml -r requirements.txt
            ${target.dir}/opt/ambassador/bin/python3 setup.py install

            find '${target.dir}/opt/ambassador/bin' -type f -executable -exec sed -i '1s|^#!${target.dir}|#!|' {} +
        - name: golang build stage
          work-dir: ${source.dir}/emissary
          runs: |
            set -eux -o pipefail

            GOLDFLAGS=""
            CGO_ENABLED=0 go build \
              -ldflags=$GOLDFLAGS \
              -o ${target.dir}/usr/local/bin/apiext ./cmd/apiext
            CGO_ENABLED=0 go build \
              -ldflags=$GOLDFLAGS \
              -o ${target.dir}/usr/local/bin/busyambassador ./cmd/busyambassador
            CGO_ENABLED=0 go build \
              -ldflags=$GOLDFLAGS \
              -o ${target.dir}/usr/local/bin/wrapper ./cmd/capabilities_wrapper

            setcap cap_net_bind_service=p ${target.dir}/usr/local/bin/wrapper
      paths:
        - type: directory
          path: ${source.dir}/patch
          uid: 0
          gid: 0
          source: image/emissary/patch
      outputs:
        - source: ${target.dir}/opt/ambassador
          target: /opt/ambassador
          uid: 0
          gid: 0
        - source: ${target.dir}/usr/local/bin/apiext
          target: /usr/local/bin/apiext
          uid: 0
          gid: 0
        - source: ${target.dir}/usr/local/bin/busyambassador
          target: /usr/local/bin/busyambassador
          uid: 0
          gid: 0
        - source: ${target.dir}/usr/local/bin/wrapper
          target: /usr/local/bin/wrapper
          uid: 0
          gid: 0
        - source: ${target.dir}/usr/local/bin/wrapper
          target: /usr/local/bin/wrapper
          uid: 0
          gid: 0
        - source: ${source.dir}/emissary/python/ambassador.version
          target: /buildroot/ambassador/python/ambassador.version
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/emissary
          target: /opt/docker/sbom/emissary
          uid: 0
          gid: 0
  artifacts:
    - name: dhi.io/python:3.11.14-debian13@sha256:fdfa3cc3e9d6eaa2d2d3fa466c44e9278be1840f95aec45b9a9155b56be47f09
      includes:
        - opt/**
        - usr/**
      uid: 0
      gid: 0
    - name: dhi.io/pkg-datawire-envoy:1.31.10-debian13@sha256:75aafdef175111ab3a757e22c354187acf7e11871ed13fccca943ff5c037e8cc
      includes:
        - opt/docker/sbom/dhi-pkg-datawire-envoy
        - usr/bin/envoy-static
      uid: 0
      gid: 0
    - name: dhi.io/static:20250419-debian13@sha256:74fc43fa240887b8159970e434244039aab0c6efaaa9cf044004cdc22aa2a34d
      includes:
        - bin
        - etc
        - home
        - lib
        - lib64
        - opt
        - sbin
        - tmp
        - usr
        - var
      excludes:
        - etc/group
        - etc/os-release
        - etc/passwd
        - var/lib/dpkg/status
      uid: 0
      gid: 0
accounts:
  run-as: ambassador
  users:
    - name: ambassador
      uid: 8888
      gid: 8888
  groups:
    - name: ambassador
      gid: 8888
      members:
        - ambassador
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
work-dir: /ambassador
environment:
  PATH: /opt/ambassador/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
  VIRTUAL_ENV: /opt/ambassador
paths:
  - type: directory
    path: /ambassador/sidecars
    uid: 8888
    gid: 8888
    mode: "0775"
  - type: symlink
    path: /usr/local/bin/envoy
    uid: 0
    gid: 0
    source: /usr/bin/envoy-static
  - type: symlink
    path: /usr/local/bin/diagd
    uid: 0
    gid: 0
    source: /opt/ambassador/bin/diagd
annotations:
  org.opencontainers.image.description: A minimal Emissary image
  org.opencontainers.image.licenses: Apache-2.0
entrypoint:
  - busyambassador
  - entrypoint
