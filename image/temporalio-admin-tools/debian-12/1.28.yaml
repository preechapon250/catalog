# syntax=dhi/build:1-debian12

# DO NOT EDIT THIS FILE MANUALLY
# generated with 'dhi def merge image/temporalio-admin-tools/debian-12/1.28.yaml'

name: Temporal Admin Tools 1.x
image: dhi/temporalio-admin-tools
variant: runtime
tags:
    - 1.28-debian12
    - 1.28.1-debian12
    - 1.28.1-cli-1.5.1-debian12
platforms:
    - linux/amd64
    - linux/arm64
vars:
    CLI_VERSION: 1.5.1
    DEBIAN_EPOCH_MAJOR_MINOR_VERSION: "1.28"
    DEBIAN_EPOCH_MAJOR_VERSION: "1"
    DEBIAN_EPOCH_VERSION: 1.28.1
    DEBIAN_VERSION: "12"
    PYTHON_DIGEST_BUILD: sha256:3893c3993b3f3b1ffbd263eb26d27db4f4bbdf6d7a9ebc0d3b562a82700afb06
    PYTHON_DIGEST_FINAL: sha256:15fb52452141a0f573260edd0f2c8696cfad3a1e14a93b943eeb4e1107d258f6
    PYTHON_VERSION_BUILD: 3.12.12
    PYTHON_VERSION_FINAL: 3.12.12
    SEMVER_MAJOR_MINOR_VERSION: "1.28"
    SEMVER_MAJOR_VERSION: "1"
    SEMVER_VERSION: 1.28.1
    TEMPORALIO_SERVER_DIGEST: sha256:1152dae6dec2a1ec2dc86f340f8c7445b6cb62765d72e85cad91097714f52ac9
    VARIANT_SUFFIX: ""
    VERSION: 1.28.1
contents:
    packages:
        - bash
        - bash-completion
        - ca-certificates
        - coreutils
        - curl
        - jq
        - tini
        - tzdata
    builds:
        - name: add bash completion
          contents:
            packages:
                - bash
                - coreutils
            artifacts:
                - name: dhi/temporalio-server:1.28.1-debian12@sha256:1152dae6dec2a1ec2dc86f340f8c7445b6cb62765d72e85cad91097714f52ac9
                  includes:
                    - usr/local/bin/temporal
                  uid: 0
                  gid: 0
          pipeline:
            - name: install bash completion
              runs: |
                set -eux -o pipefail

                # [The OS] has a /etc/bash/bashrc that sources all files named /etc/bash/*.sh for
                # interactive shells, so we can add completion logic in /etc/bash/temporal-completion.sh
                # Completion for temporal depends on the bash-completion package.
                mkdir -p "${target.dir}"/etc/bash/
                /usr/local/bin/temporal completion bash > "${target.dir}"/etc/bash/temporal-completion.sh
          outputs:
            - source: ${target.dir}/etc/bash/temporal-completion.sh
              target: /etc/bash/temporal-completion.sh
              uid: 0
              gid: 0
        - name: add cqlsh
          uses: dhi/python:3.12.12-debian12-dev@sha256:3893c3993b3f3b1ffbd263eb26d27db4f4bbdf6d7a9ebc0d3b562a82700afb06
          privileged: true
          contents:
            packages:
                - bash
                - ca-certificates
          pipeline:
            - name: add cqlsh
              runs: |
                set -eux -o pipefail

                export VIRTUAL_ENV='/opt/cqlsh'
                python3 -m venv "$VIRTUAL_ENV"

                # CVE-2024-5569: zipp 1.0.0 → 3.19.1+
                "$VIRTUAL_ENV/bin/python3" -m pip install 'zipp>=3.19.1'

                "$VIRTUAL_ENV/bin/python3" -m pip install cqlsh

                # Make cqlsh executable available in PATH
                mkdir -p /usr/local/bin
                ln -s ../../../opt/cqlsh/bin/cqlsh /usr/local/bin
          outputs:
            - source: /opt/cqlsh
              target: /opt/cqlsh
              uid: 0
              gid: 0
            - source: /usr/local/bin/cqlsh
              target: /usr/local/bin/cqlsh
              uid: 0
              gid: 0
        - name: add yq
          uses: dhi/python:3.12.12-debian12-dev@sha256:3893c3993b3f3b1ffbd263eb26d27db4f4bbdf6d7a9ebc0d3b562a82700afb06
          privileged: true
          contents:
            packages:
                - bash
                - ca-certificates
          pipeline:
            - name: add yq
              runs: |
                set -eux -o pipefail

                export VIRTUAL_ENV='/opt/yq'
                python3 -m venv "$VIRTUAL_ENV"

                # CVE-2024-5569: zipp 1.0.0 → 3.19.1+
                "$VIRTUAL_ENV/bin/python3" -m pip install 'zipp>=3.19.1'

                "$VIRTUAL_ENV/bin/python3" -m pip install yq

                # Make yq executable available in PATH
                mkdir -p /usr/local/bin
                ln -s ../../../opt/yq/bin/yq /usr/local/bin
          outputs:
            - source: /opt/yq
              target: /opt/yq
              uid: 0
              gid: 0
            - source: /usr/local/bin/yq
              target: /usr/local/bin/yq
              uid: 0
              gid: 0
    artifacts:
        - name: dhi/temporalio-server:1.28.1-debian12@sha256:1152dae6dec2a1ec2dc86f340f8c7445b6cb62765d72e85cad91097714f52ac9
          includes:
            - etc/temporal/schema/**
            - usr/local/bin/tdbg
            - usr/local/bin/temporal
            - usr/local/bin/temporal-cassandra-tool
            - usr/local/bin/temporal-sql-tool
          uid: 0
          gid: 0
        - name: dhi/python:3.12.12-debian12@sha256:15fb52452141a0f573260edd0f2c8696cfad3a1e14a93b943eeb4e1107d258f6
          includes:
            - opt/**
            - usr/**
          uid: 0
          gid: 0
accounts:
    run-as: temporal
    users:
        - name: temporal
          uid: 1000
          gid: 1000
    groups:
        - name: temporal
          gid: 1000
          members:
            - temporal
os-release:
    name: Docker Hardened Images (Debian)
    id: debian
    version-id: "12"
    version-codename: bookworm
    pretty-name: Docker Hardened Images/Debian GNU/Linux 12 (bookworm)
    home-url: https://docker.com/products/hardened-images/
    bug-report-url: https://docker.com/support/
work-dir: /etc/temporal
environment:
    TEMPORAL_HOME: /etc/temporal
paths:
    - type: directory
      path: /etc/temporal/config
      uid: 1000
      gid: 1000
      mode: "0770"
annotations:
    org.opencontainers.image.description: Temporal Admin Tools - Administrative CLI tools for Temporal workflow engine
entrypoint:
    - /usr/bin/tini
    - --
    - sleep
    - infinity
tests:
    - name: Run testcontainers basic tests
      directory: test/go-testing/base
      commands:
        - go test . -count=1 -v
      exit-code: 0
    - name: Run testcontainers tests for shared binaries, cqlsh, and yq
      directory: ecosystem/temporalio/tests/
      commands:
        - go test ./temporalio_shared_binaries_test.go -count=1 -v
        - go test ./temporalio_cqlsh_test.go -count=1 -v
        - go test ./temporalio_yq_test.go -count=1 -v
      exit-code: 0
