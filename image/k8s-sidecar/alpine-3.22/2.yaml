# syntax=dhi.io/build:2-alpine3.22

name: k8s-sidecar 2.x
image: dhi.io/k8s-sidecar
variant: runtime
tags:
  - 2-alpine3.22
  - 2.5-alpine3.22
  - 2.5.1-alpine3.22
platforms:
  - linux/amd64
  - linux/arm64
vars:
  COMMIT_SHA: 1574c267ad4e7ec0ef249560e590c2ea492a0380
  PYTHON_BUILD_REF: dhi/python:3.14.3-alpine3.22-dev@sha256:233754d748c5d88c64e7d94420ddfcd04eb33f79270ec4d79ca9a5e5d4926507
  PYTHON_REF: dhi/python:3.14.3-alpine3.22@sha256:eba76871277e39c9f2c2cd16c2627fcf1020ece9d315709494023c22ecdbece0
  SEMVER_MAJOR_MINOR_VERSION: "2.5"
  SEMVER_MAJOR_VERSION: "2"
  SEMVER_VERSION: 2.5.1
  VERSION: 2.5.1
contents:
  repositories:
    - https://dl-cdn.alpinelinux.org/alpine/v3.22/main
    - https://dl-cdn.alpinelinux.org/alpine/v3.22/community
  packages:
    - busybox
    - ca-certificates-bundle
    - libffi
    - tzdata
  builds:
    - name: k8s-sidecar
      uses: dhi.io/python:3.14.3-alpine3.22-dev@sha256:233754d748c5d88c64e7d94420ddfcd04eb33f79270ec4d79ca9a5e5d4926507
      contents:
        files:
          - url: git+https://github.com/kiwigrid/k8s-sidecar.git#2.5.1
            checksum: 1574c267ad4e7ec0ef249560e590c2ea492a0380
            path: ${source.dir}/k8s-sidecar
            spdx:
              name: k8s-sidecar
              version: 2.5.1
              packages:
                - name: k8s-sidecar
                  purl: pkg:github/kiwigrid/k8s-sidecar@2.5.1
                  license: MIT
            uid: 0
            gid: 0
      pipeline:
        - name: create virtual environment
          runs: |
            set -eux -o pipefail

            mkdir -p "${target.dir}/app"
            python3 -m venv "${target.dir}/app/.venv"
        - name: install python requirements
          work-dir: ${source.dir}/k8s-sidecar/src
          privileged: true
          runs: |
            set -eux -o pipefail

            echo "urllib3==2.6.3" >> "requirements.txt"       # CVE-2026-21441
            echo "cryptography==46.0.5" >> "requirements.txt" # CVE-2026-26007

            "${target.dir}/app/.venv/bin/python3" -m pip install --no-cache-dir -r requirements.txt
        - name: clean python cache and tests
          runs: |
            set -eux -o pipefail

            # Remove compiled Python files (.pyc, .pyo) and __pycache__ directories
            # Remove test directories (test, tests) to reduce image size
            find "${target.dir}/app/.venv" \
              \( -type d -a \( -name test -o -name tests -o -name __pycache__ \) \) \
              -o \( -type f -a \( -name '*.pyc' -o -name '*.pyo' \) \) \
              -exec rm -rf '{}' + || true
        - name: copy source files
          runs: |
            set -eux -o pipefail

            cp -r "${source.dir}/k8s-sidecar/src"/* "${target.dir}/app/"
        - name: python dependencies sbom
          uses: sbom@v1
          with:
            extra-scanners: python-package-cataloger
            prefix: k8s-sidecar-python
            source: /app/.venv
      outputs:
        - source: ${target.dir}/app
          target: /app
          uid: 0
          gid: 0
          mode: "0755"
        - source: /opt/docker/sbom
          target: /opt/docker/sbom
          uid: 0
          gid: 0
  artifacts:
    - name: dhi.io/python:3.14.3-alpine3.22@sha256:eba76871277e39c9f2c2cd16c2627fcf1020ece9d315709494023c22ecdbece0
      includes:
        - opt/**
        - usr/**
      uid: 0
      gid: 0
accounts:
  run-as: nonroot
  users:
    - name: nonroot
      uid: 65532
      gid: 65532
  groups:
    - name: nonroot
      gid: 65532
      members:
        - nonroot
os-release:
  name: Docker Hardened Images (Alpine)
  id: alpine
  version-id: "3.22"
  pretty-name: Docker Hardened Images/Alpine Linux v3.22
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
work-dir: /app
environment:
  PATH: /app/.venv/bin:/usr/local/bin:/usr/local/sbin:/usr/sbin:/usr/bin:/sbin:/bin
  PYTHONUNBUFFERED: "1"
paths:
  - type: directory
    path: /app
    uid: 0
    gid: 0
    mode: "0755"
  - type: directory
    path: /tmp/config
    uid: 65532
    gid: 65532
    mode: "0755"
  - type: directory
    path: /etc/config
    uid: 65532
    gid: 65532
    mode: "0755"
annotations:
  org.opencontainers.image.description: A minimal k8s-sidecar image
  org.opencontainers.image.licenses: MIT
entrypoint:
  - /app/.venv/bin/python
  - -u
  - /app/sidecar.py
ports:
  - 8080/tcp
