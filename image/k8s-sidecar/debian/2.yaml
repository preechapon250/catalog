# syntax=dhi.io/build:2-debian13

name: k8s-sidecar 2.x
image: dhi.io/k8s-sidecar
variant: runtime
tags:
  - "2"
  - "2.2"
  - 2.2.3
  - 2-debian13
  - 2.2-debian13
  - 2.2.3-debian13
platforms:
  - linux/amd64
  - linux/arm64
vars:
  COMMIT_SHA: 539b0af87a3e9f0b205d10be451b8d5ba88fc580
  PYTHON_BUILD_REF: dhi/python:3.14.2-debian13-dev@sha256:84c62df9f2a1fe35903c347a7c05fe8b62484baa49c40b1005f7b5c0c88b10f6
  PYTHON_REF: dhi/python:3.14.2-debian13@sha256:f7dda626c48d33c069bb7183063eda9190f4d3d62d292736b74ce19bea9ac72e
  SEMVER_MAJOR_MINOR_VERSION: "2.2"
  SEMVER_MAJOR_VERSION: "2"
  SEMVER_VERSION: 2.2.3
  VERSION: 2.2.3
contents:
  packages:
    - '!gawk'
    - '!gcc-14'
    - '!gcc-14-base'
    - '!libelogind0'
    - '!libmpfr6'
    - '!libreadline8t64'
    - '!libsigsegv'
    - '!libsigsegv2'
    - '!libtinfo6'
    - '!mawk'
    - '!mpfr4'
    - '!ncurses'
    - '!original-awk'
    - '!readline'
    - '!readline-common'
    - base-files
    - ca-certificates
    - libffi8
    - tzdata
  builds:
    - name: k8s-sidecar
      uses: dhi.io/python:3.14.2-debian13-dev@sha256:84c62df9f2a1fe35903c347a7c05fe8b62484baa49c40b1005f7b5c0c88b10f6
      contents:
        packages:
          - build-essential
          - libssl-dev
          - ca-certificates
          - bash
          - coreutils
          - git
        files:
          - url: git+https://github.com/kiwigrid/k8s-sidecar.git#2.2.3
            checksum: 539b0af87a3e9f0b205d10be451b8d5ba88fc580
            path: ${source.dir}/k8s-sidecar
            spdx:
              name: k8s-sidecar
              version: 2.2.3
              packages:
                - name: k8s-sidecar
                  purl: pkg:github/kiwigrid/k8s-sidecar@2.2.3
                  license: MIT
            uid: 0
            gid: 0
      pipeline:
        - name: create virtual environment
          runs: |
            set -eux -o pipefail

            mkdir -p "${target.dir}/app"
            python3 -m venv "${target.dir}/app/.venv"
        - name: install python requirements
          work-dir: ${source.dir}/k8s-sidecar/src
          privileged: true
          runs: |
            set -eux -o pipefail

            "${target.dir}/app/.venv/bin/python3" -m pip install --no-cache-dir -r requirements.txt
        - name: clean python cache and tests
          runs: |
            set -eux -o pipefail

            # Remove compiled Python files (.pyc, .pyo) and __pycache__ directories
            # Remove test directories (test, tests) to reduce image size
            find "${target.dir}/app/.venv" \
              \( -type d -a \( -name test -o -name tests -o -name __pycache__ \) \) \
              -o \( -type f -a \( -name '*.pyc' -o -name '*.pyo' \) \) \
              -exec rm -rf '{}' + || true
        - name: copy source files
          runs: |
            set -eux -o pipefail

            cp -r "${source.dir}/k8s-sidecar/src"/* "${target.dir}/app/"
        - name: python dependencies sbom
          uses: sbom@v1
          with:
            extra-scanners: python-package-cataloger
            prefix: k8s-sidecar-python
            source: /app/.venv
      outputs:
        - source: ${target.dir}/app
          target: /app
          uid: 0
          gid: 0
          mode: "0755"
        - source: /opt/docker/sbom
          target: /opt/docker/sbom
          uid: 0
          gid: 0
  artifacts:
    - name: dhi.io/python:3.14.2-debian13@sha256:f7dda626c48d33c069bb7183063eda9190f4d3d62d292736b74ce19bea9ac72e
      includes:
        - opt/**
        - usr/**
      uid: 0
      gid: 0
accounts:
  run-as: nonroot
  users:
    - name: nonroot
      uid: 65532
      gid: 65532
  groups:
    - name: nonroot
      gid: 65532
      members:
        - nonroot
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
work-dir: /app
environment:
  PATH: /app/.venv/bin:/usr/local/bin:/usr/local/sbin:/usr/sbin:/usr/bin:/sbin:/bin
  PYTHONUNBUFFERED: "1"
paths:
  - type: directory
    path: /app
    uid: 0
    gid: 0
    mode: "0755"
  - type: directory
    path: /tmp/config
    uid: 65532
    gid: 65532
    mode: "0755"
  - type: directory
    path: /etc/config
    uid: 65532
    gid: 65532
    mode: "0755"
annotations:
  org.opencontainers.image.description: A minimal k8s-sidecar image
  org.opencontainers.image.licenses: MIT
entrypoint:
  - /app/.venv/bin/python
  - -u
  - /app/sidecar.py
ports:
  - 8080/tcp
