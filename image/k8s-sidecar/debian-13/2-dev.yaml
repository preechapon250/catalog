# syntax=dhi.io/build:2-debian13

name: k8s-sidecar 2.x (dev)
image: dhi.io/k8s-sidecar
variant: dev
tags:
  - 2-dev
  - 2.5-dev
  - 2.5.0-dev
  - 2-debian13-dev
  - 2.5-debian13-dev
  - 2.5.0-debian13-dev
platforms:
  - linux/amd64
  - linux/arm64
vars:
  COMMIT_SHA: 4df442cbc46cdb75a9c4b46b50e9a1b86ed2c4a7
  PYTHON_BUILD_REF: dhi/python:3.14.2-debian13-dev@sha256:74c05b08591bd865dd1a105af3a1353467f12510c7094162607742450f7969c9
  PYTHON_REF: dhi/python:3.14.2-debian13@sha256:c055b3667bbfaac0e8e8ef77b0105c6581817e8b05e437352eedab0819e2c2cc
  SEMVER_MAJOR_MINOR_VERSION: "2.5"
  SEMVER_MAJOR_VERSION: "2"
  SEMVER_VERSION: 2.5.0
  VERSION: 2.5.0
contents:
  packages:
    - '!gawk'
    - '!libelogind0'
    - '!original-awk'
    - apt
    - bash
    - ca-certificates
    - coreutils
    - diffutils
    - dpkg
    - findutils
    - grep
    - libc-bin
    - libffi8
    - mawk
    - perl-base
    - sed
    - tzdata
    - util-linux
  builds:
    - name: k8s-sidecar
      uses: dhi.io/python:3.14.2-debian13-dev@sha256:74c05b08591bd865dd1a105af3a1353467f12510c7094162607742450f7969c9
      contents:
        packages:
          - build-essential
          - libssl-dev
          - ca-certificates
          - bash
          - coreutils
          - git
        files:
          - url: git+https://github.com/kiwigrid/k8s-sidecar.git#2.5.0
            checksum: 4df442cbc46cdb75a9c4b46b50e9a1b86ed2c4a7
            path: ${source.dir}/k8s-sidecar
            spdx:
              name: k8s-sidecar
              version: 2.5.0
              packages:
                - name: k8s-sidecar
                  purl: pkg:github/kiwigrid/k8s-sidecar@2.5.0
                  license: MIT
            uid: 0
            gid: 0
      pipeline:
        - name: create virtual environment
          runs: |
            set -eux -o pipefail

            mkdir -p "${target.dir}/app"
            python3 -m venv "${target.dir}/app/.venv"
        - name: install python requirements
          work-dir: ${source.dir}/k8s-sidecar/src
          privileged: true
          runs: |
            set -eux -o pipefail

            echo "urllib3==2.6.3" >> "requirements.txt" # CVE-2026-21441

            "${target.dir}/app/.venv/bin/python3" -m pip install --no-cache-dir -r requirements.txt
        - name: clean python cache and tests
          runs: |
            set -eux -o pipefail

            # Remove compiled Python files (.pyc, .pyo) and __pycache__ directories
            # Remove test directories (test, tests) to reduce image size
            find "${target.dir}/app/.venv" \
              \( -type d -a \( -name test -o -name tests -o -name __pycache__ \) \) \
              -o \( -type f -a \( -name '*.pyc' -o -name '*.pyo' \) \) \
              -exec rm -rf '{}' + || true
        - name: copy source files
          runs: |
            set -eux -o pipefail

            cp -r "${source.dir}/k8s-sidecar/src"/* "${target.dir}/app/"
        - name: python dependencies sbom
          uses: sbom@v1
          with:
            extra-scanners: python-package-cataloger
            prefix: k8s-sidecar-python
            source: /app/.venv
      outputs:
        - source: ${target.dir}/app
          target: /app
          uid: 0
          gid: 0
          mode: "0755"
        - source: /opt/docker/sbom
          target: /opt/docker/sbom
          uid: 0
          gid: 0
  artifacts:
    - name: dhi.io/python:3.14.2-debian13@sha256:c055b3667bbfaac0e8e8ef77b0105c6581817e8b05e437352eedab0819e2c2cc
      includes:
        - opt/**
        - usr/**
      uid: 0
      gid: 0
accounts:
  root: true
  run-as: root
  users:
    - name: nonroot
      uid: 65532
      gid: 65532
    - name: _apt
      uid: 42
      gid: 65532
  groups:
    - name: nonroot
      gid: 65532
      members:
        - nonroot
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
work-dir: /app
environment:
  DEBIAN_FRONTEND: noninteractive
  PATH: /app/.venv/bin:/usr/local/bin:/usr/local/sbin:/usr/sbin:/usr/bin:/sbin:/bin
  PYTHONUNBUFFERED: "1"
paths:
  - type: directory
    path: /tmp
    uid: 0
    gid: 0
    mode: "1777"
annotations:
  org.opencontainers.image.description: A minimal k8s-sidecar image
  org.opencontainers.image.licenses: MIT
entrypoint:
  - /app/.venv/bin/python
  - -u
  - /app/sidecar.py
ports:
  - 8080/tcp
