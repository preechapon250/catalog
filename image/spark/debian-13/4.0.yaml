# syntax=dhi.io/build:2-debian13

name: Spark 4.0.x (Scala 2.13.x, Java 21.x)
image: dhi.io/spark
variant: runtime
tags:
  - "4.0"
  - 4.0.2
  - 4.0-debian13
  - 4.0.2-debian13
platforms:
  - linux/amd64
  - linux/arm64
dates:
  release: "2025-05-19"
  end-of-life: "2026-11-23"
vars:
  COMMIT_SHA: 7cc3b9bcdaab8c923f23cdbc9ce922530e1becf1
  DEBIAN_REFERENCE: dhi/debian-base:trixie-debian13@sha256:1244523a2f7b6c096c6f98ce0349df6798c775c57322c51f8a4982daf60c256c
  JAVA_MAJOR_VERSION: "21"
  JAVA_REFERENCE: dhi/eclipse-temurin:21.0.9.10-debian13@sha256:0261fc5162735dbbd5a002ecd8e17957652aa80314c8af19d4c1f2805a92000a
  JAVA_VERSION: 21.0.9.10
  MAVEN_REFERENCE: dhi/maven:3.9.12-jdk21-debian13-dev@sha256:50d1124c3ead0fb112213d6578160a29774c98db966d55f2e3a3a76329e8a3db
  MAVEN_VERSION: 3.9.12
  NAME_DETAIL: Scala 2.13.x, Java 21.x
  SCALA_VERSION: "2.13"
  SEMVER_MAJOR_MINOR_VERSION: "4.0"
  SEMVER_MAJOR_VERSION: "4"
  SEMVER_VERSION: 4.0.2
  VERSION: 4.0.2
contents:
  packages:
    - '!libelogind0'
    - '!mawk'
    - '!original-awk'
    - base-files
    - bash
    - ca-certificates
    - coreutils
    - grep
    - libffi8
    - mawk
    - sed
    - tini
  builds:
    - name: spark
      uses: dhi.io/maven:3.9.12-jdk21-debian13-dev@sha256:50d1124c3ead0fb112213d6578160a29774c98db966d55f2e3a3a76329e8a3db
      environment:
        MAVEN_ARGS: --batch-mode --no-transfer-progress
      contents:
        packages:
          - bash
          - coreutils
          - grep
          - sed
          - libstdc++6
        files:
          - url: git+https://github.com/apache/spark.git#v4.0.2
            checksum: 7cc3b9bcdaab8c923f23cdbc9ce922530e1becf1
            path: ${source.dir}/spark
            spdx:
              name: spark
              version: 4.0.2
              packages:
                - name: spark
                  purl: pkg:dhi/spark@4.0.2
                  license: Apache-2.0
            uid: 0
            gid: 0
      pipeline:
        - name: patch source
          uses: patch@v1
          work-dir: ${source.dir}/spark
          with:
            options: -p1
            patches:
              - ${source.dir}/patch/gson-4.0.patch
              - ${source.dir}/patch/hadoop-4.0.patch
              - ${source.dir}/patch/ivy-4.0.patch
              - ${source.dir}/patch/jackson-4.0.patch
              - ${source.dir}/patch/lz4-4.0.patch
              - ${source.dir}/patch/libthrift-4.0.patch
        - name: patch deps
          uses: mvn/patch@v1
          with:
            dependencies: ${source.dir}/patch/mvn-deps-4.0.json
            dependencies-key: dependencyManagement.dependencies
            downgrade: false
            mvn-root: ${source.dir}/spark
            properties: ${source.dir}/patch/mvn-properties-4.0.json
        - name: prepare
          work-dir: ${source.dir}/spark
          privileged: true
          runs: |
            set -eux -o pipefail

            # Replace the project's Maven wrapper script with our preferred Maven binary.
            ln -sf '/opt/java/apache-maven-3.9.12/bin/mvn' build/mvn

            # While this can be a partial no-op, it serves to validate 2.13 is supported on this release.
            ./dev/change-scala-version.sh '2.13'
        - name: build
          work-dir: ${source.dir}/spark
          privileged: true
          runs: |
            set -eux -o pipefail

            # -Pscala-2.13: https://github.com/apache/spark/blob/aea64e580cf167d47d790ad8081d0f505d5b4d34/dev/create-release/release-build.sh#L588-L600
            # -Pyarn -Pkubernetes: https://github.com/apache/spark/blob/aea64e580cf167d47d790ad8081d0f505d5b4d34/dev/create-release/release-build.sh#L586
            # -Phadoop-3: https://github.com/apache/spark/blob/aea64e580cf167d47d790ad8081d0f505d5b4d34/dev/create-release/release-build.sh#L783
            # -Phive -Phive-thriftserver: https://github.com/apache/spark/blob/aea64e580cf167d47d790ad8081d0f505d5b4d34/dev/create-release/release-build.sh#L603
            ./dev/make-distribution.sh \
              '-Pscala-2.13' -Pyarn -Pkubernetes -Phadoop-3 -Phive -Phive-thriftserver
        - name: install
          work-dir: ${source.dir}/spark
          privileged: true
          runs: |
            set -eux -o pipefail

            install -d '${target.dir}/opt/spark'
            cp -a -t '${target.dir}/opt/spark' \
              dist/RELEASE \
              dist/jars \
              dist/{bin,sbin} \
              dist/{examples,data} \
              dist/kubernetes/tests

            install -d '${target.dir}/opt/spark/python'
            cp -a -t '${target.dir}/opt/spark/python' \
              dist/python/pyspark \
              dist/python/lib

            install -T -m 0755 dist/kubernetes/dockerfiles/spark/decom.sh \
              '${target.dir}/opt/decom.sh'
            ln -s 'spark-examples_2.13-4.0.2.jar' \
              '${target.dir}/opt/spark/examples/jars/spark-examples-jar'
      paths:
        - type: file
          path: ${source.dir}/patch/gson-4.0.patch
          uid: 0
          gid: 0
          source: image/spark/patch/gson-4.0.patch
        - type: file
          path: ${source.dir}/patch/hadoop-4.0.patch
          uid: 0
          gid: 0
          source: image/spark/patch/hadoop-4.0.patch
        - type: file
          path: ${source.dir}/patch/ivy-4.0.patch
          uid: 0
          gid: 0
          source: image/spark/patch/ivy-4.0.patch
        - type: file
          path: ${source.dir}/patch/jackson-4.0.patch
          uid: 0
          gid: 0
          source: image/spark/patch/jackson-4.0.patch
        - type: file
          path: ${source.dir}/patch/lz4-4.0.patch
          uid: 0
          gid: 0
          source: image/spark/patch/lz4-4.0.patch
        - type: file
          path: ${source.dir}/patch/libthrift-4.0.patch
          uid: 0
          gid: 0
          source: image/spark/patch/libthrift-4.0.patch
        - type: file
          path: ${source.dir}/patch/mvn-properties-4.0.json
          uid: 0
          gid: 0
          source: image/spark/patch/mvn-properties-4.0.json
        - type: file
          path: ${source.dir}/patch/mvn-deps-4.0.json
          uid: 0
          gid: 0
          source: image/spark/patch/mvn-deps-4.0.json
      outputs:
        - source: ${target.dir}/opt/spark
          target: /opt/spark
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/spark
          target: /opt/docker/sbom/spark
          uid: 0
          gid: 0
    - name: locale
      uses: dhi.io/debian-base:trixie-debian13@sha256:1244523a2f7b6c096c6f98ce0349df6798c775c57322c51f8a4982daf60c256c
      contents:
        packages:
          - bash
          - locales
          - coreutils
          - gzip
      pipeline:
        - name: install locales
          runs: |
            set -eux -o pipefail

            ln -s /etc/locale.alias /usr/share/locale/locale.alias

            echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen
            locale-gen en_US.UTF-8
      outputs:
        - source: /usr/share/locale
          target: /usr/share/locale
          uid: 0
          gid: 0
        - source: /usr/lib/locale
          target: /usr/lib/locale
          uid: 0
          gid: 0
  artifacts:
    - name: dhi.io/eclipse-temurin:21.0.9.10-debian13@sha256:0261fc5162735dbbd5a002ecd8e17957652aa80314c8af19d4c1f2805a92000a
      includes:
        - opt/**
      uid: 0
      gid: 0
accounts:
  run-as: nonroot
  users:
    - name: nonroot
      uid: 65532
      gid: 65532
  groups:
    - name: nonroot
      gid: 65532
      members:
        - nonroot
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
environment:
  JAVA_HOME: /opt/java/openjdk/21-jre
  LANG: en_US.UTF-8
  LANGUAGE: en_US:en
  LC_ALL: en_US.UTF-8
  PATH: /opt/spark/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
  SPARK_HOME: /opt/spark
  SPARK_SCALA_VERSION: "2.13"
paths:
  - type: file
    path: /opt/spark/bin/docker-entrypoint.sh
    uid: 0
    gid: 0
    mode: "0755"
    source: image/spark/bin/docker-entrypoint.sh
  - type: directory
    path: /opt/spark/logs
    uid: 65532
    gid: 65532
    mode: "0755"
annotations:
  org.opencontainers.image.description: A minimal Apache Spark image
  org.opencontainers.image.licenses: Apache-2.0
entrypoint:
  - /opt/spark/bin/docker-entrypoint.sh
