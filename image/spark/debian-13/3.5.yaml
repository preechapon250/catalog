# syntax=dhi.io/build:2-debian13

name: Spark 3.5.x (Scala 2.12.x, Java 17.x)
image: dhi.io/spark
variant: runtime
tags:
  - "3"
  - "3.5"
  - 3.5.8
  - 3-debian13
  - 3.5-debian13
  - 3.5.8-debian13
platforms:
  - linux/amd64
  - linux/arm64
dates:
  release: "2023-09-09"
  end-of-life: "2026-04-12"
vars:
  COMMIT_SHA: 5a48a37b2dbd7b51e3640cd1d947438459556cc6
  JAVA_MAJOR_VERSION: "17"
  JAVA_REFERENCE: dhi/eclipse-temurin:17.0.17.10-debian13@sha256:313eab48ed8980caa5d1281c91fdacc6c931b004536592b03e5587d735acfba4
  JAVA_VERSION: 17.0.17.10
  MAVEN_REFERENCE: dhi/maven:3.9.12-jdk17-debian13-dev@sha256:c4d2a5f1d0ee9625b5797429aa70b318fc34b6e24365c8dd961ef5c3fc79f4a1
  MAVEN_VERSION: 3.9.12
  NAME_DETAIL: Scala 2.12.x, Java 17.x
  SCALA_VERSION: "2.12"
  SEMVER_MAJOR_MINOR_VERSION: "3.5"
  SEMVER_MAJOR_VERSION: "3"
  SEMVER_VERSION: 3.5.8
  VERSION: 3.5.8
contents:
  packages:
    - '!libelogind0'
    - '!mawk'
    - '!original-awk'
    - base-files
    - bash
    - ca-certificates
    - coreutils
    - grep
    - libffi8
    - mawk
    - sed
    - tini
  builds:
    - name: spark
      uses: dhi.io/maven:3.9.12-jdk17-debian13-dev@sha256:c4d2a5f1d0ee9625b5797429aa70b318fc34b6e24365c8dd961ef5c3fc79f4a1
      environment:
        MAVEN_ARGS: --batch-mode --no-transfer-progress
      contents:
        packages:
          - bash
          - coreutils
          - grep
          - sed
          - libstdc++6
        files:
          - url: git+https://github.com/apache/spark.git#v3.5.8
            checksum: 5a48a37b2dbd7b51e3640cd1d947438459556cc6
            path: ${source.dir}/spark
            spdx:
              name: spark
              version: 3.5.8
              packages:
                - name: spark
                  purl: pkg:dhi/spark@3.5.8
                  license: Apache-2.0
            uid: 0
            gid: 0
      pipeline:
        - name: patch source
          uses: patch@v1
          work-dir: ${source.dir}/spark
          with:
            options: -p1
            patches:
              - ${source.dir}/patch/gson-3.5.patch
              - ${source.dir}/patch/hadoop-3.5.patch
              - ${source.dir}/patch/ivy-3.5.patch
              - ${source.dir}/patch/jackson-3.5.patch
              - ${source.dir}/patch/lz4-3.5.patch
              - ${source.dir}/patch/libthrift-3.5.patch
        - name: patch deps
          uses: mvn/patch@v1
          with:
            dependencies: ${source.dir}/patch/mvn-deps-3.5.json
            dependencies-key: dependencyManagement.dependencies
            downgrade: false
            mvn-root: ${source.dir}/spark
            properties: ${source.dir}/patch/mvn-properties-3.5.json
        - name: prepare
          work-dir: ${source.dir}/spark
          privileged: true
          runs: |
            set -eux -o pipefail

            # Replace the project's Maven wrapper script with our preferred Maven binary.
            ln -sf '/opt/java/apache-maven-3.9.12/bin/mvn' build/mvn

            # While this can be a partial no-op, it serves to validate 2.12 is supported on this release.
            ./dev/change-scala-version.sh '2.12'
        - name: build
          work-dir: ${source.dir}/spark
          privileged: true
          runs: |
            set -eux -o pipefail

            # -Pscala-2.12: https://github.com/apache/spark/blob/aea64e580cf167d47d790ad8081d0f505d5b4d34/dev/create-release/release-build.sh#L588-L600
            # -Pyarn -Pkubernetes: https://github.com/apache/spark/blob/aea64e580cf167d47d790ad8081d0f505d5b4d34/dev/create-release/release-build.sh#L586
            # -Phadoop-3: https://github.com/apache/spark/blob/aea64e580cf167d47d790ad8081d0f505d5b4d34/dev/create-release/release-build.sh#L783
            # -Phive -Phive-thriftserver: https://github.com/apache/spark/blob/aea64e580cf167d47d790ad8081d0f505d5b4d34/dev/create-release/release-build.sh#L603
            ./dev/make-distribution.sh \
              '-Pscala-2.12' -Pyarn -Pkubernetes -Phadoop-3 -Phive -Phive-thriftserver
        - name: install
          work-dir: ${source.dir}/spark
          privileged: true
          runs: |
            set -eux -o pipefail

            install -d '${target.dir}/opt/spark'
            cp -a -t '${target.dir}/opt/spark' \
              dist/RELEASE \
              dist/jars \
              dist/{bin,sbin} \
              dist/{examples,data} \
              dist/kubernetes/tests

            install -d '${target.dir}/opt/spark/python'
            cp -a -t '${target.dir}/opt/spark/python' \
              dist/python/pyspark \
              dist/python/lib

            install -T -m 0755 dist/kubernetes/dockerfiles/spark/decom.sh \
              '${target.dir}/opt/decom.sh'
            ln -s 'spark-examples_2.12-3.5.8.jar' \
              '${target.dir}/opt/spark/examples/jars/spark-examples-jar'
      paths:
        - type: file
          path: ${source.dir}/patch/gson-3.5.patch
          uid: 0
          gid: 0
          source: image/spark/patch/gson-3.5.patch
        - type: file
          path: ${source.dir}/patch/hadoop-3.5.patch
          uid: 0
          gid: 0
          source: image/spark/patch/hadoop-3.5.patch
        - type: file
          path: ${source.dir}/patch/ivy-3.5.patch
          uid: 0
          gid: 0
          source: image/spark/patch/ivy-3.5.patch
        - type: file
          path: ${source.dir}/patch/jackson-3.5.patch
          uid: 0
          gid: 0
          source: image/spark/patch/jackson-3.5.patch
        - type: file
          path: ${source.dir}/patch/lz4-3.5.patch
          uid: 0
          gid: 0
          source: image/spark/patch/lz4-3.5.patch
        - type: file
          path: ${source.dir}/patch/libthrift-3.5.patch
          uid: 0
          gid: 0
          source: image/spark/patch/libthrift-3.5.patch
        - type: file
          path: ${source.dir}/patch/mvn-properties-3.5.json
          uid: 0
          gid: 0
          source: image/spark/patch/mvn-properties-3.5.json
        - type: file
          path: ${source.dir}/patch/mvn-deps-3.5.json
          uid: 0
          gid: 0
          source: image/spark/patch/mvn-deps-3.5.json
      outputs:
        - source: ${target.dir}/opt/spark
          target: /opt/spark
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/spark
          target: /opt/docker/sbom/spark
          uid: 0
          gid: 0
    - name: locale
      uses: dhi.io/debian-base:trixie-debian13@sha256:c7651f9ef631e9a9feada59aff228f9382bdb537e85dc8e9c201093597898c45
      contents:
        packages:
          - bash
          - locales
          - coreutils
          - gzip
      pipeline:
        - name: install locales
          runs: |
            set -eux -o pipefail

            echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen
            locale-gen en_US.UTF-8
      outputs:
        - source: /usr/share/locale
          target: /usr/share/locale
          uid: 0
          gid: 0
        - source: /usr/lib/locale
          target: /usr/lib/locale
          uid: 0
          gid: 0
  artifacts:
    - name: dhi.io/eclipse-temurin:17.0.17.10-debian13@sha256:313eab48ed8980caa5d1281c91fdacc6c931b004536592b03e5587d735acfba4
      includes:
        - opt/**
      uid: 0
      gid: 0
accounts:
  run-as: nonroot
  users:
    - name: nonroot
      uid: 65532
      gid: 65532
  groups:
    - name: nonroot
      gid: 65532
      members:
        - nonroot
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
environment:
  JAVA_HOME: /opt/java/openjdk/17-jre
  LANG: en_US.UTF-8
  LANGUAGE: en_US:en
  LC_ALL: en_US.UTF-8
  PATH: /opt/spark/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
  SPARK_HOME: /opt/spark
  SPARK_SCALA_VERSION: "2.12"
paths:
  - type: file
    path: /opt/spark/bin/docker-entrypoint.sh
    uid: 0
    gid: 0
    mode: "0755"
    source: image/spark/bin/docker-entrypoint.sh
  - type: directory
    path: /opt/spark/logs
    uid: 65532
    gid: 65532
    mode: "0755"
annotations:
  org.opencontainers.image.description: A minimal Apache Spark image
  org.opencontainers.image.licenses: Apache-2.0
entrypoint:
  - /opt/spark/bin/docker-entrypoint.sh
