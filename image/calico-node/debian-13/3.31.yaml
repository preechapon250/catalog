# syntax=dhi.io/build:2-debian13

name: Calico Node 3.31.x
image: dhi.io/calico-node
variant: runtime
tags:
  - "3"
  - "3.31"
  - 3.31.3
  - v3.31.3
  - 3-debian13
  - 3.31-debian13
  - 3.31.3-debian13
platforms:
  - linux/amd64
  - linux/arm64
dates:
  release: "2025-10-21"
vars:
  BASE_DIGEST: sha256:74fc43fa240887b8159970e434244039aab0c6efaaa9cf044004cdc22aa2a34d
  BASE_TAG: 20250419-debian13
  BIRD_COMMIT_SHA: 1e8dd375d0b4c23c4eb542172f7c592be158fe83
  BIRD_VERSION: 0.3.3
  COMMIT_SHA: 2e3c880bcabff580ddd7a08340878ede207f37be
  GCC_CONFIG_FILES_TAG: releases/gcc-14.2.0
  GCC_CONFIG_GUESS_FILE_SHA: sha256:7d1e3c79b86de601c3a0457855ab854dffd15163f53c91edac54a7be2e9c931b
  GCC_CONFIG_SUB_FILE_SHA: sha256:71b8d73e46e0c31b1dc91ba5306f5ef0af009273b3bb283f31d8dad69666fa9e
  GO_REFERENCE: dhi/golang:1.25.7-debian13-dev@sha256:d241d31631f6bcfdef4f42f70083bb06d51e6401d9ce172a05b9ba37f27c2940
  LIBBPF_COMMIT_SHA: ca72d0731f8c693bd98caba70d951fc0bfe20788
  LIBBPF_VERSION: 1.4.7
  RUNIT_SHA: 634f23c8c4d1d440043be0fe928ddf904626289e97bfe7c5826e93aaf2cc6fe9
  RUNIT_VERSION: 2.3.1
  SEMVER_MAJOR_MINOR_VERSION: "3.31"
  SEMVER_MAJOR_VERSION: "3"
  SEMVER_VERSION: 3.31.3
  VERSION: 3.31.3
contents:
  packages:
    - '!libelogind0'
    - '!mawk'
    - '!original-awk'
    - base-files
    - bash
    - bpftool
    - conntrack
    - coreutils
    - debianutils
    - iproute2
    - ipset
    - iptables
    - kmod
    - libelf1t64
    - libpcap0.8t64
    - net-tools
    - procps
    - zlib1g
  builds:
    - name: calico-node
      uses: dhi.io/golang:1.25.7-debian13-dev@sha256:d241d31631f6bcfdef4f42f70083bb06d51e6401d9ce172a05b9ba37f27c2940
      caches:
        - path: /go/pkg/mod
      contents:
        packages:
          - autoconf
          - bash
          - bison
          - build-essential
          - clang
          - flex
          - gcc
          - gpg
          - gpg-agent
          - gzip
          - iproute2
          - iptables
          - libc6-dev
          - libelf-dev
          - libncurses-dev
          - libpcap-dev
          - libreadline-dev
          - llvm
          - make
          - patch
          - tar
          - wget
          - zlib1g-dev
        files:
          - url: git+https://github.com/projectcalico/calico.git#v3.31.3
            checksum: 2e3c880bcabff580ddd7a08340878ede207f37be
            path: /go/src/github.com/projectcalico/calico
            spdx:
              name: calico-node
              version: 3.31.3
              packages:
                - name: calico
                  purl: pkg:golang/github.com/projectcalico/calico@v3.31.3
                  license: Apache-2.0
            uid: 0
            gid: 0
          - url: git+https://github.com/projectcalico/bird.git#v0.3.3
            checksum: 1e8dd375d0b4c23c4eb542172f7c592be158fe83
            path: ${source.dir}/bird
            spdx:
              name: bird
              version: 0.3.3
              packages:
                - name: bird
                  purl: pkg:golang/github.com/projectcalico/bird@v0.3.3
                  license: GPL-2.0-or-later
            uid: 0
            gid: 0
          - url: https://smarden.org/runit/runit-2.3.1.tar.gz
            checksum: sha256:634f23c8c4d1d440043be0fe928ddf904626289e97bfe7c5826e93aaf2cc6fe9
            path: /packages/runit_2.3.1.tar.gz
            spdx:
              name: runit
              version: 2.3.1
              packages:
                - name: runit
                  purl: pkg:generic/smarden/runit@2.3.1
                  license: BSD-3-Clause
            uid: 0
            gid: 0
          - url: https://smarden.org/runit/sha256sum.asc
            path: /packages/runit_2.3.1-sha256sum.asc
            uid: 0
            gid: 0
          - url: https://raw.githubusercontent.com/gcc-mirror/gcc/refs/tags/releases/gcc-14.2.0/config.guess
            checksum: sha256:7d1e3c79b86de601c3a0457855ab854dffd15163f53c91edac54a7be2e9c931b
            path: ${source.dir}/bird/tools/config.guess
            uid: 0
            gid: 0
          - url: https://raw.githubusercontent.com/gcc-mirror/gcc/refs/tags/releases/gcc-14.2.0/config.sub
            checksum: sha256:71b8d73e46e0c31b1dc91ba5306f5ef0af009273b3bb283f31d8dad69666fa9e
            path: ${source.dir}/bird/tools/config.sub
            uid: 0
            gid: 0
          - url: git+https://github.com/libbpf/libbpf.git#v1.4.7
            checksum: ca72d0731f8c693bd98caba70d951fc0bfe20788
            path: /go/src/github.com/projectcalico/calico/felix/bpf-gpl/libbpf
            spdx:
              name: libbpf
              version: 1.4.7
              packages:
                - name: libbpf
                  purl: pkg:github/libbpf/libbpf@v1.4.7
                  license: LGPL-2.1-only OR BSD-2-Clause
            uid: 0
            gid: 0
      pipeline:
        - name: verify runit gpg signature and checksum
          work-dir: /packages
          runs: |
            set -eux -o pipefail

            # Import GPG key
            gpg --import /${source.dir}/runit-gpg-key.asc

            # Verify the clearsigned sha256sum file
            gpg --verify runit_2.3.1-sha256sum.asc

            # Extract the verified hash from the signed message
            expected_sha256=$(gpg --decrypt runit_2.3.1-sha256sum.asc 2> /dev/null | grep "runit-2.3.1.tar.gz" | awk '{print $1}')

            # Calculate actual hash of the tar.gz file
            actual_sha256=$(sha256sum runit_2.3.1.tar.gz | awk '{print $1}')

            # Verify they match
            if [ "${expected_sha256}" != "${actual_sha256}" ]; then
              echo "SHA256 mismatch for runit-2.3.1.tar.gz"
              echo "Expected: ${expected_sha256}"
              echo "Actual: ${actual_sha256}"
              exit 1
            fi
        - name: create bird binaries
          work-dir: ${source.dir}/bird
          runs: |
            set -eux -o pipefail

            autoconf

            # Set cache variable to bypass runtime struct alignment test
            export bird_cv_c_struct_align=16
            export bird_cv_type_time_t="32-bit signed"

            # Use -fcommon to fix multiple definition errors with modern GCC
            export CFLAGS="-fcommon"

            # Build bird (IPv4 version)
            ./configure --sbindir="${target.dir}/usr/local/bin"

            make -j"$(nproc)"
            make install

            # Clean build artifacts before building bird6
            make clean

            # Build bird6 (IPv6 version)
            ./configure --sbindir="${target.dir}/usr/local/bin" --enable-ipv6
            make -j"$(nproc)"
            make install
        - name: build libbpf static library
          work-dir: /go/src/github.com/projectcalico/calico/felix
          runs: |
            set -eux -o pipefail

            mkdir -p bpf-gpl/libbpf/src/${target.arch}
            make -j"$(nproc)" -C bpf-gpl/libbpf/src BUILD_STATIC_ONLY=1 OBJDIR=${target.arch}
            make -C bpf-gpl/libbpf/src install_headers DESTDIR=/usr PREFIX=
        - name: build bpf objects
          work-dir: /go/src/github.com/projectcalico/calico/felix
          runs: |
            set -eux -o pipefail

            make -j"$(nproc)" -C bpf-gpl all
            make -j"$(nproc)" -C bpf-apache all
        - name: go bump and download deps
          uses: go/bump@v1
          work-dir: go/src/github.com/projectcalico/calico/node
          with:
            deps: []
            download: true
        - name: build 3.31
          uses: go/build@v1
          work-dir: go/src/github.com/projectcalico/calico/node
          with:
            cgo_enabled: 1
            ldflags:
              - -X github.com/projectcalico/calico/pkg/buildinfo.Version=3.31.3
              - -X github.com/projectcalico/calico/pkg/buildinfo.BuildDate=${SOURCE_DATE_EPOCH}
              - -X github.com/projectcalico/calico/pkg/buildinfo.GitRevision=2e3c880bcabff580ddd7a08340878ede207f37be
            output: ${target.dir}/usr/local/bin/calico-node
            packages: ./cmd/calico-node/main.go
        - name: extract runit
          work-dir: /packages
          runs: |
            set -eux -o pipefail

            tar xzf runit_2.3.1.tar.gz
        - name: patch svlogd permissions
          uses: git/patch@v1
          work-dir: /packages/admin/runit-2.3.1
          with:
            patch: ${source.dir}/patch/runit/svlogd_use_0644_permission_instead_of_0744.patch
        - name: install runit
          work-dir: /packages/admin/runit-2.3.1
          runs: |
            set -eux -o pipefail

            # Modify conf-cc to add permissive flags for old code
            echo "gcc -O2 -Wno-implicit-function-declaration -Wno-incompatible-pointer-types" > src/conf-cc
            package/compile
        - name: patch start_runit to use direct runsvdir path
          uses: git/patch@v1
          work-dir: /go/src/github.com/projectcalico/calico
          with:
            patch: ${source.dir}/patch/start_runit/use_direct_runsvdir_path.patch
      paths:
        - type: file
          path: ${source.dir}/runit-gpg-key.asc
          uid: 0
          gid: 0
          mode: "0644"
          source: image/calico-node/key/runit-gpg-key.asc
        - type: file
          path: ${source.dir}/patch/runit/svlogd_use_0644_permission_instead_of_0744.patch
          uid: 0
          gid: 0
          mode: "0644"
          source: image/calico-node/patch/runit/svlogd_use_0644_permission_instead_of_0744.patch
        - type: file
          path: ${source.dir}/patch/start_runit/use_direct_runsvdir_path.patch
          uid: 0
          gid: 0
          mode: "0644"
          source: image/calico-node/patch/start_runit/use_direct_runsvdir_path.patch
      outputs:
        - source: ${target.dir}/usr/local/bin/
          target: /usr/local/bin/
          uid: 0
          gid: 0
        - source: /go/src/github.com/projectcalico/calico/node/filesystem/sbin/start_runit
          target: /usr/local/bin/start_runit
          uid: 0
          gid: 0
          mode: "0755"
        - source: /go/src/github.com/projectcalico/calico/node/filesystem/etc
          target: /etc
          uid: 0
          gid: 0
        - source: /go/src/github.com/projectcalico/calico/confd/etc/calico/confd/conf.d
          target: /etc/calico/confd/conf.d
          uid: 0
          gid: 0
          mode: "0644"
        - source: /go/src/github.com/projectcalico/calico/confd/etc/calico/confd/templates
          target: /etc/calico/confd/templates
          uid: 0
          gid: 0
        - source: /packages/admin/runit-2.3.1/command
          target: /usr/local/bin
          uid: 0
          gid: 0
          mode: "0755"
        - source: ${source.dir}/bird/bird.conf
          target: /usr/local/bin/bird.conf
          uid: 0
          gid: 0
          mode: "0644"
        - source: /go/src/github.com/projectcalico/calico/felix/bpf-gpl/bin
          target: /usr/lib/calico/bpf
          uid: 0
          gid: 0
        - source: /go/src/github.com/projectcalico/calico/felix/bpf-apache/bin
          target: /usr/lib/calico/bpf
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/calico-node
          target: /opt/docker/sbom/calico-node
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/runit
          target: /opt/docker/sbom/runit
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/bird
          target: /opt/docker/sbom/bird
          uid: 0
          gid: 0
  artifacts:
    - name: dhi.io/static:20250419-debian13@sha256:74fc43fa240887b8159970e434244039aab0c6efaaa9cf044004cdc22aa2a34d
      includes:
        - bin
        - etc
        - home
        - lib
        - lib64
        - opt
        - sbin
        - tmp
        - usr
        - var
      excludes:
        - etc/group
        - etc/os-release
        - etc/passwd
        - var/lib/dpkg/status
      uid: 0
      gid: 0
accounts:
  run-as: nonroot
  users:
    - name: nonroot
      uid: 65532
      gid: 65532
  groups:
    - name: nonroot
      gid: 65532
      members:
        - nonroot
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
environment:
  SVDIR: /etc/service/enabled
paths:
  - type: file
    path: /etc/envvars
    uid: 65532
    gid: 65532
    mode: "0644"
  - type: directory
    path: /etc/service
    uid: 65532
    gid: 65532
    mode: "0755"
  - type: directory
    path: /var/lib/calico
    uid: 65532
    gid: 65532
    mode: "0755"
  - type: directory
    path: /run/calico
    uid: 65532
    gid: 65532
    mode: "0755"
  - type: directory
    path: /etc/calico/confd/config
    uid: 65532
    gid: 65532
    mode: "0755"
  - type: symlink
    path: /usr/sbin/iptables
    uid: 0
    gid: 0
    source: iptables-legacy
  - type: symlink
    path: /usr/sbin/ip6tables
    uid: 0
    gid: 0
    source: ip6tables-legacy
  - type: symlink
    path: /bin/calico-node
    uid: 0
    gid: 0
    mode: "4755"
    source: /usr/local/bin/calico-node
  - type: symlink
    path: /bin/bird
    uid: 0
    gid: 0
    mode: "4755"
    source: /usr/local/bin/bird
  - type: symlink
    path: /bin/bird6
    uid: 0
    gid: 0
    mode: "4755"
    source: /usr/local/bin/bird6
  - type: symlink
    path: /bin/birdcl
    uid: 0
    gid: 0
    mode: "0755"
    source: /usr/local/bin/birdcl
  - type: symlink
    path: /bin/birdcl6
    uid: 0
    gid: 0
    mode: "0755"
    source: /usr/local/bin/birdcl6
annotations:
  org.opencontainers.image.description: A minimal Calico Node image.
  org.opencontainers.image.licenses: Apache-2.0
cmd:
  - start_runit
