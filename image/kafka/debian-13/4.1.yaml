# syntax=dhi.io/build:2-debian13

name: Apache Kafka 4.1.x
image: dhi.io/kafka
variant: runtime
tags:
  - "4"
  - "4.1"
  - 4.1.1
  - 4-debian13
  - 4.1-debian13
  - 4.1.1-debian13
platforms:
  - linux/amd64
  - linux/arm64
dates:
  release: "2025-09-02"
vars:
  COMMIT_SHA: be816b82d25370ceac697ccf7c88cea873e9b4e3
  GRADLE_REFERENCE: dhi/gradle:8.14.3-jdk21-debian13-dev@sha256:19dd5388412b3208ee87115bfe7b37d43581bd5389c122f49b850678210522c1
  GRADLE_VERSION: 8.14.3
  JAVA_REFERENCE: dhi/eclipse-temurin:21.0.9.10-debian13@sha256:e0c3e71b08e1051e402957c08de745011f9f1209d27d1e9e8cab1fe6edf9a44b
  JAVA_VERSION: 21.0.9.10
  KAFKA_MAJOR_MINOR_VERSION: ${KAFKA_VERSION:([0-9]+.[0-9]+).*$}
  KAFKA_MAJOR_VERSION: ${KAFKA_VERSION:([0-9]+).*$}
  SCALA_VERSION: "2.13"
  SEMVER_MAJOR_MINOR_VERSION: "4.1"
  SEMVER_MAJOR_VERSION: "4"
  SEMVER_VERSION: 4.1.1
  VERSION: 4.1.1
contents:
  packages:
    - '!libelogind0'
    - '!mawk'
    - '!original-awk'
    - base-files
    - bash
    - ca-certificates
    - coreutils
    - grep
    - netbase
    - sed
    - tzdata
  builds:
    - name: kafka
      uses: dhi.io/gradle:8.14.3-jdk21-debian13-dev@sha256:19dd5388412b3208ee87115bfe7b37d43581bd5389c122f49b850678210522c1
      contents:
        packages:
          - gzip
          - patch
          - sed
          - tar
        files:
          - url: git+https://github.com/apache/kafka.git#4.1.1
            checksum: be816b82d25370ceac697ccf7c88cea873e9b4e3
            path: ${source.dir}/kafka
            spdx:
              name: kafka
              version: 4.1.1
              packages:
                - name: kafka
                  purl: pkg:github/apache/kafka@4.1.1
                  license: Apache-2.0
            uid: 0
            gid: 0
      pipeline:
        - name: apply lz4-java cve patch
          uses: git/patch@v1
          work-dir: ${source.dir}/kafka
          with:
            patch: ${source.dir}/patch/lz4-java-cve.patch
        - name: apply log4j cve patch
          uses: git/patch@v1
          work-dir: ${source.dir}/kafka
          with:
            patch: ${source.dir}/patch/log4j-cve.patch
        - name: build kafka distribution
          work-dir: ${source.dir}/kafka
          privileged: true
          runs: |
            set -eux -o pipefail

            gradle clean releaseTarGz \
              -PscalaVersion=2.13 \
              --no-daemon \
              --console=plain \
              --warning-mode=summary
        - name: extract distribution
          work-dir: ${source.dir}/kafka
          runs: |
            set -eux -o pipefail

            mkdir -p ${target.dir}/opt/kafka

            tar -xzf "core/build/distributions/kafka_2.13-4.1.1.tgz" \
              --strip-components=1 \
              -C ${target.dir}/opt/kafka
        - name: configure
          work-dir: ${source.dir}/kafka
          runs: |
            set -eux -o pipefail

            cp docker/server.properties \
              ${target.dir}/opt/kafka/config/server.properties

            sed -i \
              -e 's|^advertised\.listeners=PLAINTEXT://localhost:9092|advertised.listeners=PLAINTEXT://:9092|' \
              ${target.dir}/opt/kafka/config/server.properties

            chown -Rh 65532:65532 ${target.dir}/opt/kafka/config
            chmod -R 755 ${target.dir}/opt/kafka/config
      paths:
        - type: file
          path: ${source.dir}/patch/lz4-java-cve.patch
          uid: 0
          gid: 0
          source: image/kafka/patch/lz4-java-cve.patch
        - type: file
          path: ${source.dir}/patch/fips-sha256-log-cleaner.patch
          uid: 0
          gid: 0
          source: image/kafka/patch/fips-sha256-log-cleaner.patch
        - type: file
          path: ${source.dir}/patch/log4j-cve.patch
          uid: 0
          gid: 0
          source: image/kafka/patch/log4j-cve.patch
      outputs:
        - source: ${target.dir}/opt/kafka
          target: /opt/kafka
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/kafka
          target: /opt/docker/sbom/kafka
          uid: 0
          gid: 0
    - name: locale
      uses: dhi.io/debian-base:trixie-debian13@sha256:c7651f9ef631e9a9feada59aff228f9382bdb537e85dc8e9c201093597898c45
      contents:
        packages:
          - bash
          - locales
          - coreutils
          - gzip
      pipeline:
        - name: install locales
          runs: |
            set -eux -o pipefail

            echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen
            locale-gen en_US.UTF-8
      outputs:
        - source: /usr/share/locale
          target: /usr/share/locale
          uid: 0
          gid: 0
        - source: /usr/lib/locale
          target: /usr/lib/locale
          uid: 0
          gid: 0
  artifacts:
    - name: dhi.io/eclipse-temurin:21.0.9.10-debian13@sha256:e0c3e71b08e1051e402957c08de745011f9f1209d27d1e9e8cab1fe6edf9a44b
      includes:
        - opt/**
      uid: 0
      gid: 0
accounts:
  run-as: kafka
  users:
    - name: kafka
      uid: 65532
      gid: 65532
  groups:
    - name: kafka
      gid: 65532
      members:
        - kafka
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
work-dir: /opt/kafka
environment:
  KAFKA_LOG4J_OPTS: -Dkafka.logs.dir=/opt/kafka/logs/ -Dlog4j2.configurationFile=file:/opt/kafka/config/log4j2.yaml
  LANG: en_US.UTF-8
  LANGUAGE: en_US:en
  LC_ALL: en_US.UTF-8
paths:
  - type: directory
    path: /opt/kafka/logs
    uid: 65532
    gid: 65532
    mode: "0775"
  - type: directory
    path: /tmp/kraft-combined-logs
    uid: 65532
    gid: 65532
    mode: "0775"
  - type: directory
    path: /usr/local/bin
    uid: 0
    gid: 0
  - type: file
    path: /usr/local/bin/docker-entrypoint.sh
    uid: 0
    gid: 0
    mode: "0755"
    source: image/kafka/bin/docker-entrypoint.sh
annotations:
  org.opencontainers.image.description: A minimal Kafka image
  org.opencontainers.image.licenses: Apache-2.0
entrypoint:
  - /usr/local/bin/docker-entrypoint.sh
ports:
  - 9092/tcp
