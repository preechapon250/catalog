# syntax=dhi.io/build:1-alpine3.22

name: PostgreSQL 14.x
image: dhi.io/postgres
variant: runtime
tags:
  - 14-alpine3.22
  - 14.20-alpine3.22
platforms:
  - linux/amd64
  - linux/arm64
dates:
  release: "2021-09-30"
  end-of-life: "2026-11-12"
vars:
  MAJOR_VERSION: "14"
  MINOR_VERSION: "20"
contents:
  repositories:
    - https://dl-cdn.alpinelinux.org/alpine/v3.22/main
    - https://dl-cdn.alpinelinux.org/alpine/v3.22/community
  packages:
    - alpine-baselayout-data
    - bash
    - busybox
    - icu-data-full
    - icu-libs
    - krb5-libs
    - less
    - libcrypto3
    - libldap
    - libselinux
    - libssl3
    - libuuid
    - libxml2
    - libxslt
    - linux-pam
    - llvm
    - lz4-libs
    - readline
    - tzdata
    - zlib
    - zstd-libs
  builds:
    - name: postgres
      contents:
        repositories:
          - https://dl-cdn.alpinelinux.org/alpine/v3.22/main
          - https://dl-cdn.alpinelinux.org/alpine/v3.22/community
        packages:
          - autoconf
          - automake
          - bison
          - clang
          - curl-dev
          - flex
          - g++
          - gcc
          - icu-dev
          - krb5-dev
          - libselinux-dev
          - liburing-dev
          - libxml2-dev
          - libxslt-dev
          - linux-pam-dev
          - llvm-dev
          - lz4
          - lz4-dev
          - make
          - numactl-dev
          - openldap-dev
          - openssl-dev
          - pkgconf
          - readline-dev
          - tzdata
          - util-linux-dev
          - zlib-dev
          - zstd
          - zstd-dev
        files:
          - url: https://ftp.postgresql.org/pub/source/v14.20/postgresql-14.20.tar.gz
            checksum: https://ftp.postgresql.org/pub/source/v14.20/postgresql-14.20.tar.gz.sha256
            path: ${source.dir}/
            spdx:
              name: postgresql
              version: "14.20"
              packages:
                - name: postgresql
                  purl: pkg:dhi/postgresql@14.20
                  license: PostgreSQL
            uid: 0
            gid: 0
      pipeline:
        - name: patch source
          uses: patch@v1
          work-dir: ${source.dir}/postgresql-14.20
          with:
            options: -p1
            patches:
              - ${source.dir}/patch/initdb.patch
              - ${source.dir}/patch/pager-less.patch
              - ${source.dir}/patch/alpine/dont-use-locale-a-on-musl.pg14.patch
              - ${source.dir}/patch/alpine/icu-collections-hack.pg14.patch
        - name: build and install
          work-dir: ${source.dir}/postgresql-14.20
          runs: |
            set -eux -o pipefail

            ./configure \
              --prefix='/opt/postgresql/14' \
              --with-gssapi \
              --with-icu \
              --with-ldap \
              --with-libcurl \
              --with-libnuma \
              --with-liburing \
              --with-libxml \
              --with-libxslt \
              --with-llvm \
              --with-lz4 \
              --with-pam \
              --with-selinux \
              --with-ssl=openssl \
              --with-uuid=e2fs \
              --with-zstd \
              --with-system-tzdata=/usr/share/zoneinfo

            make world-bin -j"$(nproc)"

            make install-world-bin DESTDIR='${target.dir}'
        - name: configure defaults
          work-dir: ${target.dir}/opt/postgresql/14/share
          runs: |
            set -eux -o pipefail

            sed -E -i postgresql.conf.sample \
              -e "s|^#?(listen_addresses)\s*=\s*\S+.*|\1 = '*'|"
      paths:
        - type: file
          path: ${source.dir}/patch/initdb.patch
          uid: 0
          gid: 0
          source: image/postgres/patch/initdb.patch
        - type: file
          path: ${source.dir}/patch/pager-less.patch
          uid: 0
          gid: 0
          source: image/postgres/patch/pager-less.patch
        - type: file
          path: ${source.dir}/patch/alpine/dont-use-locale-a-on-musl.pg14.patch
          uid: 0
          gid: 0
          source: image/postgres/patch/alpine/dont-use-locale-a-on-musl.pg14.patch
        - type: file
          path: ${source.dir}/patch/alpine/icu-collections-hack.pg14.patch
          uid: 0
          gid: 0
          source: image/postgres/patch/alpine/icu-collections-hack.pg14.patch
      outputs:
        - source: ${target.dir}/opt/postgresql/14
          target: /opt/postgresql/14
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/postgresql
          target: /opt/docker/sbom/postgresql
          uid: 0
          gid: 0
accounts:
  run-as: postgres
  users:
    - name: postgres
      uid: 70
      gid: 70
  groups:
    - name: postgres
      gid: 70
      members:
        - postgres
os-release:
  name: Docker Hardened Images (Alpine)
  id: alpine
  version-id: "3.22"
  pretty-name: Docker Hardened Images/Alpine Linux v3.22
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
stop-signal: SIGINT
environment:
  PATH: /opt/postgresql/14/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
  PG_MAJOR: "14"
  PG_MINOR: "20"
  PGDATA: /var/lib/postgresql/14/data
paths:
  - type: directory
    path: /run/postgresql
    uid: 70
    gid: 70
    mode: "0755"
  - type: directory
    path: /var/lib/postgresql/14
    uid: 70
    gid: 70
    mode: "0700"
  - type: file
    path: /usr/local/bin/docker-entrypoint.sh
    uid: 0
    gid: 0
    mode: "0755"
    source: image/postgres/bin/docker-entrypoint.sh
annotations:
  org.opencontainers.image.description: A minimal PostgreSQL image
  org.opencontainers.image.licenses: PostgreSQL
entrypoint:
  - /usr/local/bin/docker-entrypoint.sh
ports:
  - 5432/tcp
tests:
  - name: Run testcontainers tests
    directory: image/postgres/tests
    commands:
      - go test . -count=1 -v
    exit-code: 0
