# syntax=dhi.io/build:2-debian13

name: OpenResty 1.x
image: dhi.io/openresty
variant: runtime
tags:
  - "1"
  - "1.27"
  - 1.27.1
  - 1-debian13
  - 1.27-debian13
  - 1.27.1-debian13
platforms:
  - linux/amd64
  - linux/arm64
vars:
  SEMVER_MAJOR_MINOR_VERSION: "1.27"
  SEMVER_MAJOR_VERSION: "1"
  SEMVER_VERSION: 1.27.1
  VERSION: 1.27.1.2
contents:
  packages:
    - bash
    - ca-certificates
    - coreutils
    - libcrypt1
    - libpcre2-8-0
    - perl
    - zlib1g
  builds:
    - name: openresty
      contents:
        packages:
          - bash
          - build-essential
          - ca-certificates
          - coreutils
          - findutils
          - git
          - gpg
          - gpg-agent
          - grep
          - gzip
          - jq
          - libc-bin
          - libpcre2-dev
          - libssl-dev
          - make
          - perl
          - sed
          - tar
          - zlib1g-dev
        files:
          - url: https://openresty.org/download/openresty-1.27.1.2.tar.gz.asc
            path: ${source.dir}/sigs/openresty.tar.gz.asc
            uid: 0
            gid: 0
          - url: https://openresty.org/download/openresty-1.27.1.2.tar.gz
            path: ${source.dir}/openresty.tar.gz
            spdx:
              name: openresty
              version: 1.27.1.2
              packages:
                - name: openresty
                  purl: pkg:generic/openresty/openresty@1.27.1.2
                  license: BSD-2-Clause
            uid: 0
            gid: 0
      pipeline:
        - name: verify and unpack
          runs: |
            set -eux -o pipefail

            GNUPGHOME="$(mktemp -d)"
            export GNUPGHOME

            gpg --import "${source.dir}/key/openresty-key.asc"
            gpg --batch --verify "${source.dir}/sigs/openresty.tar.gz.asc" openresty.tar.gz

            tar -xvf openresty.tar.gz --strip-components=1
        - name: build and install
          runs: |
            set -eux -o pipefail

            ./configure --prefix=/opt/openresty -j"$(nproc)"
            make -j"$(nproc)"
            make install DESTDIR='${target.dir}'
        - name: add luajit sbom
          runs: |
            set -eux -o pipefail

            mkdir -p "/opt/docker/sbom/luajit"

            version="$(ls -a ${source.dir}/bundle | grep -m 1 'LuaJIT' | sed -E 's|LuaJIT-([^/]+)/?|\1|')"

            jq -n \
              --arg name "luajit" \
              --arg version "$version" \
              --arg purl "pkg:github/openresty/luajit2@$version" \
              --arg license "MIT" \
              '{
                "spdxVersion": "SPDX-2.3",
                "dataLicense": "CC0-1.0",
                "SPDXID": ("SPDXRef-" + $name),
                "name": ("SPDX document for " + $name + " " + $version),
                "documentNamespace": ($name + "-" + $version),
                "creationInfo": {
                    "creators": [
                        "Organization: Docker, Inc.",
                        "Tool: dhi/build"
                    ],
                    "created": "1970-01-01T00:00:00Z"
                },
                "packages": [
                  {
                    "name": $name,
                    "SPDXID": ("SPDXRef-" + $name),
                    "versionInfo": $version,
                    "filesAnalyzed": false,
                    "licenseConcluded": "NOASSERTION",
                    "licenseDeclared": $license,
                    "externalRefs": [
                      {
                        "referenceCategory": "PACKAGE-MANAGER",
                        "referenceType": "purl",
                        "referenceLocator": $purl
                      }
                    ]
                  }
                ]
              }' > /opt/docker/sbom/luajit/.spdx.luajit.json
      paths:
        - type: file
          path: ${source.dir}/key/openresty-key.asc
          uid: 0
          gid: 0
          source: image/openresty/key/openresty-key.asc
      outputs:
        - source: ${target.dir}/opt/openresty
          target: /opt/openresty
          uid: 0
          gid: 0
        - source: /opt/docker/sbom
          target: /opt/docker/sbom
          uid: 0
          gid: 0
accounts:
  run-as: nonroot
  users:
    - name: nonroot
      uid: 65532
      gid: 65532
  groups:
    - name: nonroot
      gid: 65532
      members:
        - nonroot
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
environment:
  PATH: /opt/openresty/luajit/bin:/opt/openresty/nginx/sbin:/opt/openresty/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
paths:
  - type: directory
    path: /opt/openresty/nginx/logs
    uid: 65532
    gid: 65532
annotations:
  org.opencontainers.image.description: A minimal OpenResty image
  org.opencontainers.image.licenses: BSD-2-Clause
entrypoint:
  - /opt/openresty/bin/openresty
cmd:
  - -g
  - daemon off;
