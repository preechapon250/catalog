# syntax=dhi.io/build:1-debian13

name: Dart 3.x
image: dhi.io/dart
variant: runtime
tags:
  - "3"
  - "3.10"
  - 3.10.7
  - 3-debian13
  - 3.10-debian13
  - 3.10.7-debian13
platforms:
  - linux/amd64
  - linux/arm64
vars:
  ARCH: '#{ target.arch == "amd64" ? "x64" : "arm64" }'
  COMMIT_SHA: 2da4111d8d0cbf2a83c0662251508f017000da8a
  SEMVER_MAJOR_MINOR_VERSION: "3.10"
  SEMVER_MAJOR_VERSION: "3"
  SEMVER_VERSION: 3.10.7
  VERSION: 3.10.7
contents:
  packages:
    - '!libelogind0'
    - '!mawk'
    - '!original-awk'
    - base-files
    - bash
    - ca-certificates
    - coreutils
    - findutils
    - tzdata
  builds:
    - name: dart
      environment:
        PATH: /src/depot_tools:/usr/local/bin:/usr/bin:/bin
      contents:
        packages:
          - bash
          - ca-certificates
          - coreutils
          - curl
          - findutils
          - g++
          - git
          - grep
          - ripgrep
          - sed
          - python3
          - python3-pip
          - xz-utils
        files:
          - url: git+https://chromium.googlesource.com/chromium/tools/depot_tools.git#main
            path: ${source.dir}/depot_tools
            uid: 0
            gid: 0
          - url: git+https://github.com/dart-lang/sdk.git#3.10.7
            checksum: 2da4111d8d0cbf2a83c0662251508f017000da8a
            path: ${source.dir}/dart-sdk/sdk
            spdx:
              name: dart
              version: 3.10.7
              packages:
                - name: dart
                  purl: pkg:dhi/dart@3.10.7
                  license: BSD-3-Clause
            uid: 0
            gid: 0
      pipeline:
        - name: sync-dependencies
          work-dir: ${source.dir}/dart-sdk
          privileged: true
          runs: |
            set -eux -o pipefail

            export PATH="${source.dir}/depot_tools:${PATH}"

            python3 -m pip install --break-system-packages "httplib2<0.21.0"

            printf 'solutions = [\n  {\n    "name": "sdk",\n    "url": "https://github.com/dart-lang/sdk.git@%s",\n    "managed": False,\n    "custom_deps": {},\n  },\n]\n' "2da4111d8d0cbf2a83c0662251508f017000da8a" > .gclient

            python3 "${source.dir}/depot_tools/gclient.py" sync --no-history
            python3 "${source.dir}/depot_tools/gclient.py" runhooks
        - name: prepare-build
          work-dir: ${source.dir}/dart-sdk/sdk
          runs: |
            set -eux -o pipefail

            sed -i "s/Unknown timestamp/$(date -uIm)/" tools/make_version.py

            mkdir -p .dart_tool
            if [ ! -f ".dart_tool/package_config.json" ]; then
              echo '{"configVersion":2,"packages":[],"generated":"2024-01-01T00:00:00.000Z","generator":"manual","generatorVersion":"0.0.0"}' > .dart_tool/package_config.json
            fi
        - name: setup-build-environment
          work-dir: ${source.dir}/dart-sdk/sdk
          runs: |
            set -eux -o pipefail

            export PATH="${source.dir}/depot_tools:${PATH}"

            mkdir -p .git/logs
            echo '' > .git/logs/HEAD

            python3 tools/generate_package_config.py
            python3 tools/generate_sdk_version_file.py
            rg '"_fe_analyzer_shared"' .dart_tool/package_config.json
            rg '"front_end"' .dart_tool/package_config.json
            rg '"kernel"' .dart_tool/package_config.json
        - name: build
          work-dir: ${source.dir}/dart-sdk/sdk
          runs: |
            set -eux -o pipefail

            # Build Dart SDK
            ./tools/build.py --mode release --arch "${ARCH}" create_sdk

            # Move built SDK to target directory
            mkdir -p "${target.dir}/opt"
            if [ "${ARCH}" = "x64" ]; then
              mv out/ReleaseX64/dart-sdk "${target.dir}/opt/dart-sdk"
            else
              mv out/ReleaseARM64/dart-sdk "${target.dir}/opt/dart-sdk"
            fi
      outputs:
        - source: ${target.dir}/opt/dart-sdk
          target: /opt/dart-sdk
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/dart
          target: /opt/docker/sbom/dart
          uid: 0
          gid: 0
accounts:
  run-as: nonroot
  users:
    - name: nonroot
      uid: 65532
      gid: 65532
  groups:
    - name: nonroot
      gid: 65532
      members:
        - nonroot
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
work-dir: /app
environment:
  DART_VERSION: 3.10.7
  PATH: /opt/dart-sdk/bin:/home/nonroot/.pub-cache/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
  PUB_CACHE: /home/nonroot/.pub-cache
paths:
  - type: directory
    path: /app
    uid: 65532
    gid: 65532
    mode: "0755"
  - type: directory
    path: /home/nonroot/.pub-cache
    uid: 65532
    gid: 65532
    mode: "0755"
annotations:
  org.opencontainers.image.description: A minimal Dart SDK image
  org.opencontainers.image.licenses: BSD-3-Clause
cmd:
  - dart
  - --version
tests:
  - name: Run testcontainers tests
    directory: image/dart/tests
    commands:
      - go test . -count=1 -v
    exit-code: 0
