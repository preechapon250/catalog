# syntax=dhi.io/build:1-alpine3.22

name: Dart 3.x
image: dhi.io/dart
variant: runtime
tags:
  - 3-alpine3.22
  - 3.10-alpine3.22
  - 3.10.7-alpine3.22
platforms:
  - linux/amd64
  - linux/arm64
vars:
  ARCH: '#{ target.arch == "amd64" ? "x64" : "arm64" }'
  ARCH_UPPER: '#{ target.arch == "amd64" ? "X64" : "ARM64" }'
  COMMIT_SHA: 2da4111d8d0cbf2a83c0662251508f017000da8a
  SEMVER_MAJOR_MINOR_VERSION: "3.10"
  SEMVER_MAJOR_VERSION: "3"
  SEMVER_VERSION: 3.10.7
  VERSION: 3.10.7
contents:
  repositories:
    - https://dl-cdn.alpinelinux.org/alpine/v3.22/main
    - https://dl-cdn.alpinelinux.org/alpine/v3.22/community
  packages:
    - alpine-baselayout-data
    - busybox
    - ca-certificates-bundle
    - icu-libs
    - libstdc++
    - zlib
  builds:
    - name: dart
      environment:
        CC: gcc
        CXX: g++
        DEPOT_TOOLS_UPDATE: "0"
      contents:
        repositories:
          - https://dl-cdn.alpinelinux.org/alpine/v3.22/main
          - https://dl-cdn.alpinelinux.org/alpine/v3.22/community
          - https://dl-cdn.alpinelinux.org/alpine/edge/testing
        packages:
          - bash
          - build-base
          - busybox
          - dart-bootstrap
          - git
          - gn
          - icu-dev
          - linux-headers
          - lld
          - llvm
          - musl-dev
          - openssl-dev
          - py3-pip
          - python3
          - ripgrep
          - samurai
          - wget
          - zlib-dev
          - zstd
        files:
          - url: git+https://chromium.googlesource.com/chromium/tools/depot_tools.git#main
            path: ${source.dir}/depot_tools
            uid: 0
            gid: 0
          - url: git+https://github.com/dart-lang/sdk.git#3.10.7
            checksum: 2da4111d8d0cbf2a83c0662251508f017000da8a
            path: ${source.dir}/dart-sdk/sdk
            spdx:
              name: dart
              version: 3.10.7
              packages:
                - name: dart
                  purl: pkg:dhi/dart@3.10.7
                  license: BSD-3-Clause
            uid: 0
            gid: 0
      pipeline:
        - name: sync-dependencies
          work-dir: ${source.dir}/dart-sdk
          privileged: true
          runs: |
            set -eux -o pipefail

            export PATH="${source.dir}/depot_tools:${PATH}"

            python3 -m pip install --break-system-packages "httplib2<0.21.0"

            printf 'solutions = [\n  {\n    "name": "sdk",\n    "url": "https://github.com/dart-lang/sdk.git@%s",\n    "managed": False,\n    "custom_deps": {},\n  },\n]\n' "2da4111d8d0cbf2a83c0662251508f017000da8a" > .gclient

            python3 "${source.dir}/depot_tools/gclient.py" sync --no-history --nohooks
        - name: setup-bootstrap-dart
          work-dir: ${source.dir}/dart-sdk/sdk
          runs: |
            set -eux -o pipefail

            mkdir -p tools/sdks
            rm -rf tools/sdks/dart-sdk
            ln -s /usr/lib/dart tools/sdks/dart-sdk
            tools/sdks/dart-sdk/bin/dart --version
        - name: setup-buildtools
          work-dir: ${source.dir}/dart-sdk/sdk
          runs: |
            set -eux -o pipefail

            mkdir -p buildtools
            rm -f buildtools/gn
            ln -s /usr/bin/gn buildtools/gn

            mkdir -p buildtools/ninja
            rm -f buildtools/ninja/ninja
            ln -s /usr/bin/samu buildtools/ninja/ninja
        - name: setup-toolchain-wrappers
          work-dir: ${source.dir}/dart-sdk/sdk
          runs: |
            set -eux -o pipefail

            mkdir -p "${target.dir}/toolchain_wrappers"
            for prefix in aarch64-linux-gnu x86_64-linux-gnu; do
              printf '#!/bin/sh\nexec /usr/bin/gcc "$@"\n' > "${target.dir}/toolchain_wrappers/${prefix}-gcc"
              printf '#!/bin/sh\nexec /usr/bin/g++ "$@"\n' > "${target.dir}/toolchain_wrappers/${prefix}-g++"
              chmod +x "${target.dir}/toolchain_wrappers/${prefix}-gcc" "${target.dir}/toolchain_wrappers/${prefix}-g++"

              for tool in nm strip objcopy objdump readelf ar ranlib; do
                printf '#!/bin/sh\nexec /usr/bin/%s "$@"\n' "$tool" > "${target.dir}/toolchain_wrappers/${prefix}-$tool"
                chmod +x "${target.dir}/toolchain_wrappers/${prefix}-$tool"
              done

              printf '#!/bin/sh\nexec /usr/bin/gcc "$@"\n' > "/usr/bin/${prefix}-gcc"
              printf '#!/bin/sh\nexec /usr/bin/g++ "$@"\n' > "/usr/bin/${prefix}-g++"
              chmod +x "/usr/bin/${prefix}-gcc" "/usr/bin/${prefix}-g++"
              for tool in nm strip objcopy objdump readelf ar ranlib; do
                printf '#!/bin/sh\nexec /usr/bin/%s "$@"\n' "$tool" > "/usr/bin/${prefix}-$tool"
                chmod +x "/usr/bin/${prefix}-$tool"
              done
            done
        - name: setup-build-environment
          work-dir: ${source.dir}/dart-sdk/sdk
          runs: |
            set -eux -o pipefail

            export PATH="${target.dir}/toolchain_wrappers:${source.dir}/depot_tools:${PATH}"

            mkdir -p "out/Release${ARCH_UPPER}"
            touch "out/Release${ARCH_UPPER}/args.gn"

            mkdir -p .git/logs
            echo '' > .git/logs/HEAD

            python3 tools/generate_package_config.py
            python3 tools/generate_sdk_version_file.py
        - name: disable-analytics
          work-dir: ${source.dir}/dart-sdk/sdk
          runs: |
            set -eux -o pipefail

            mkdir -p tools/bots
            echo '' > tools/bots/dartdoc_footer.html
            rm -f third_party/devtools/web/devtools_analytics.js

            JOBS="${JOBS:-2}"
            rg --no-ignore -l 'google-analytics\.com' . \
              | rg -v "\.map$" \
              | xargs -t -n 1 -P "${JOBS}" sed -i -E 's|([^/]+\.)?google-analytics\.com|0\.0\.0\.0|g' || true
            rg --no-ignore -l 'UA-[0-9]+-[0-9]+' . \
              | xargs -t -n 1 -P "${JOBS}" sed -i -E 's|UA-[0-9]+-[0-9]+|UA-2137-0|g' || true
        - name: prepare-build
          work-dir: ${source.dir}/dart-sdk/sdk
          runs: |
            set -eux -o pipefail

            sed -i "s/Unknown timestamp/$(date -uIm)/" tools/make_version.py

            mkdir -p .dart_tool
            if [ ! -f ".dart_tool/package_config.json" ]; then
              echo '{"configVersion":2,"packages":[],"generated":"2024-01-01T00:00:00.000Z","generator":"manual","generatorVersion":"0.0.0"}' > .dart_tool/package_config.json
            fi
        - name: build-dart-sdk
          work-dir: ${source.dir}/dart-sdk/sdk
          runs: |
            set -eux -o pipefail

            export PATH="${target.dir}/toolchain_wrappers:${source.dir}/depot_tools:${PATH}"

            ./tools/build.py \
              --no-clang \
              --mode release \
              --arch ${ARCH} \
              --no-verify-sdk-hash \
              --gn-args='dart_snapshot_kind="app-jit" dart_sysroot=""' \
              create_sdk
        - name: install-sdk
          runs: |
            set -eux -o pipefail

            mkdir -p "${target.dir}/opt/dart-sdk"
            cp -r "${source.dir}/dart-sdk/sdk/out/Release${ARCH_UPPER}/dart-sdk"/* "${target.dir}/opt/dart-sdk/"
      outputs:
        - source: ${target.dir}/opt/dart-sdk
          target: /opt/dart-sdk
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/dart
          target: /opt/docker/sbom/dart
          uid: 0
          gid: 0
accounts:
  run-as: nonroot
  users:
    - name: nonroot
      uid: 65532
      gid: 65532
  groups:
    - name: nonroot
      gid: 65532
      members:
        - nonroot
os-release:
  name: Docker Hardened Images (Alpine)
  id: alpine
  version-id: "3.22"
  pretty-name: Docker Hardened Images/Alpine Linux v3.22
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
work-dir: /app
environment:
  DART_VERSION: 3.10.7
  PATH: /opt/dart-sdk/bin:/home/nonroot/.pub-cache/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
  PUB_CACHE: /home/nonroot/.pub-cache
paths:
  - type: directory
    path: /app
    uid: 65532
    gid: 65532
    mode: "0755"
  - type: directory
    path: /home/nonroot/.pub-cache
    uid: 65532
    gid: 65532
    mode: "0755"
annotations:
  org.opencontainers.image.description: A minimal Dart SDK image
  org.opencontainers.image.licenses: BSD-3-Clause
cmd:
  - dart
  - --version
tests:
  - name: Run testcontainers tests
    directory: image/dart/tests
    commands:
      - go test . -count=1 -v
    exit-code: 0
