# syntax=dhi.io/build:2-debian13

name: Airflow 3.x (dev)
image: dhi.io/airflow
variant: dev
tags:
  - 3-dev
  - 3.1-dev
  - 3.1.5-dev
  - 3-debian13-dev
  - 3-python3.12-dev
  - 3.1-debian13-dev
  - 3.1-python3.12-dev
  - 3.1.5-debian13-dev
  - 3.1.5-python3.12-dev
  - 3-python3.12-debian13-dev
  - 3.1-python3.12-debian13-dev
  - 3.1.5-python3.12-debian13-dev
platforms:
  - linux/amd64
  - linux/arm64
dates:
  release: "2025-04-22"
vars:
  COMMIT_SHA: a42f2fba5051645adfe56526d38db4e8155f5157
  NODE_DIGEST: sha256:3b834f27bae6cccc45f254e1837ed21b9b550708d6c87449e1be3189b8fa46ad
  NODE_VERSION: 22.21.1
  PYTHON_BUILD_DIGEST: sha256:3182f9f0ec2bea938af32387c1e7a367f57c7c1a09fa4df86ef880f99aae0eb8
  PYTHON_BUILD_VERSION: 3.12.12
  PYTHON_DIGEST: sha256:1269127ef2c19f4ebd94e95996ba085f5e8f36cf955163261ab735ff3ab779c2
  PYTHON_FIPS_TAG: ""
  PYTHON_MAJOR_MINOR_VERSION: "3.12"
  PYTHON_VERSION: 3.12.12
  RUST_DIGEST: sha256:2fea67b3346112547b7860567465a18046a53f3183be893caed8fee3139c3644
  RUST_VERSION: 1.92.0
  SEMVER_MAJOR_MINOR_VERSION: "3.1"
  SEMVER_MAJOR_VERSION: "3"
  SEMVER_VERSION: 3.1.5
  VERSION: 3.1.5
contents:
  packages:
    - '!gawk'
    - '!libelogind0'
    - '!mawk'
    - '!original-awk'
    - apt
    - base-files
    - bash
    - ca-certificates
    - diffutils
    - dpkg
    - grep
    - libc-bin
    - libffi8
    - mawk
    - perl-base
    - sed
    - tzdata
    - util-linux
  builds:
    - name: airflow
      uses: dhi.io/python:3.12.12-debian13-dev@sha256:3182f9f0ec2bea938af32387c1e7a367f57c7c1a09fa4df86ef880f99aae0eb8
      environment:
        UV_NO_MANAGED_PYTHON: "true"
        UV_PYTHON_DOWNLOADS: never
      contents:
        packages:
          - bash
          - build-essential
          - g++
          - gfortran
          - git
          - libffi-dev
          - libldap2-dev
          - libmariadb-dev
          - libpq-dev
          - libsasl2-dev
          - libssl-dev
          - libxml2-dev
          - libxslt1-dev
          - pkg-config
          - patchelf
          - unixodbc-dev
        files:
          - url: git+https://github.com/apache/airflow.git#3.1.5
            checksum: a42f2fba5051645adfe56526d38db4e8155f5157
            path: ${source.dir}/airflow
            spdx:
              name: airflow
              version: 3.1.5
              packages:
                - name: airflow
                  purl: pkg:dhi/airflow@3.1.5
                  license: Apache-2.0
            uid: 0
            gid: 0
          - url: https://raw.githubusercontent.com/apache/airflow/constraints-3.1.5/constraints-3.12.txt
            path: ${source.dir}/airflow/constraints.txt
            uid: 0
            gid: 0
        artifacts:
          - name: dhi.io/pkg-node:22.21.1-debian13@sha256:3b834f27bae6cccc45f254e1837ed21b9b550708d6c87449e1be3189b8fa46ad
            includes:
              - opt/nodejs
              - usr/local/bin/node
              - usr/local/bin/npm
            uid: 0
            gid: 0
          - name: dhi.io/rust:1.92.0-debian13@sha256:2fea67b3346112547b7860567465a18046a53f3183be893caed8fee3139c3644
            includes:
              - usr/local/bin/cargo
              - usr/local/bin/rustc
              - usr/local/lib
            uid: 0
            gid: 0
      pipeline:
        - name: install uv
          privileged: true
          runs: |
            set -eux -o pipefail

            pip install uv
        - name: edit constraints
          runs: |
            set -eux -o pipefail

            # Patch constraints file with targeted upgrades to remediate CVEs
            sed -i 's/aiomysql==0\.2\.0/aiomysql==0.3.0/g' ${source.dir}/airflow/constraints.txt           # CVE-2025-62611
            sed -i 's/cryptography==42\.0\.8/cryptography==44.0.1/g' ${source.dir}/airflow/constraints.txt # GHSA-h4gh-qq45-vh27, CVE-2024-12797
            sed -i 's/eventlet==0\.40\.2/eventlet==0.40.3/g' ${source.dir}/airflow/constraints.txt         # CVE-2025-58068
            sed -i 's/h2==4\.2\.0/h2==4.3.0/g' ${source.dir}/airflow/constraints.txt                       # CVE-2025-57804
            sed -i 's/Authlib==1\.6\.4/Authlib==1.6.5/g' ${source.dir}/airflow/constraints.txt             # CVE-2025-61920
            sed -i 's/python-ldap==3\.4\.4/python-ldap==3.4.5/' ${source.dir}/airflow/constraints.txt      # CVE-2025-61911, CVE-2025-61912
            sed -i 's/aiohttp==3\.13\.2/aiohttp==3.13.3/' ${source.dir}/airflow/constraints.txt            # CVE-2025-69223, CVE-2025-69227, CVE-2025-69229, CVE-2025-69228, CVE-2025-68161

            # starlette 0.49.1 contains a fix for HIGH CVE-2025-62727
            # airflow 3.1.1 requires fastapi 0.117.1 which requires starlette 0.48.0
            # airflow's constraint on fastapi is necessary, as fastapi 0.118.0 includes changes that break airflow 3.1.1
            # fastapi's constraint on starlette is unnecessary, though, as starlette 0.49.1 does not include any changes that should break compatibility with fastapi 0.117.1
            # So we use uv overrides to force starlette 0.49.1 to be installed alongside fastapi 0.117.1
            sed -i 's/starlette==0\.48\.0/starlette==0.49.1/' ${source.dir}/airflow/constraints.txt # CVE-2025-62727
            echo "starlette==0.49.1" >> ${source.dir}/airflow/overrides.txt                         # CVE-2025-62727

            sed -i 's/urllib3==2\.5\.0/urllib3==2.6.0/' ${source.dir}/airflow/constraints.txt     # CVE-2025-66418, CVE-2025-66471
            sed -i 's/filelock==3\.20\.0/filelock==3.20.1/' ${source.dir}/airflow/constraints.txt # CVE-2025-68146
        - name: build
          privileged: true
          runs: |
            set -eux -o pipefail

            cd '${source.dir}/airflow'

            # Build the core packages
            uv build --package apache-airflow
            uv build --package apache-airflow-core
            uv build --package apache-airflow-task-sdk

            # providers are released with different tags
            git fetch --tags

            # Build the few core providers
            providers="common-compat common-io common-sql smtp standard"
            providers_only_binary_flags=""
            for provider in $providers; do
              ${source.dir}/scripts/build-provider $provider
              providers_only_binary_flags="$providers_only_binary_flags --only-binary=apache-airflow-providers-$provider"
            done

            uv pip install \
              --constraints constraints.txt \
              --overrides overrides.txt \
              --no-binary=:all: \
              --only-binary=apache-airflow \
              --only-binary=apache-airflow-core \
              --only-binary=apache-airflow-task-sdk \
              $providers_only_binary_flags \
              --prefix ${target.dir}/opt/airflow \
              dist/*.whl
        - name: install ray independently
          privileged: true
          runs: |
            set -eux -o pipefail

            # Fixes CVE-2025-62593 in ray.
            # Note that patching dependencies with this causes some confusion to the uv resolver,
            # so this is most cleanly done after the initial install.
            uv pip install --prefix ${target.dir}/opt/airflow "ray>=2.52.0"

            # Fixes CVE-2025-69223 in ray.
            uv pip install -U --target ${target.dir}/opt/airflow/lib/python3.12/site-packages/ray/_private/runtime_env/agent/thirdparty_files 'aiohttp>=3.13.3'
        - name: create default config
          runs: |
            set -eux -o pipefail

            # Create the default configuration file. Otherwise, airflow will try to create it on startup and fail if it doesn't have permission.
            export PYTHONPATH="${target.dir}/opt/airflow/lib/python3.12/site-packages"
            "${target.dir}/opt/airflow/bin/airflow" config list --defaults > "${target.dir}/opt/airflow/airflow.cfg"
        - name: build main ui
          privileged: true
          runs: |
            set -eux -o pipefail

            # Previous build steps checked out tags for different providers
            cd "${source.dir}/airflow"
            git checkout "a42f2fba5051645adfe56526d38db4e8155f5157"

            # pkg-node currently does not contain corepack
            npm install -g corepack

            # we must cd as corepack has no flag to set cwd (nodejs/corepack#677)
            cd '${source.dir}/airflow/airflow-core/src/airflow/ui'

            # Add overrides. At time of writing, pnpm-workspace.yaml doesn't exist. If it ever does, we'll need to properly merge our contents with it.
            test ! -f pnpm-workspace.yaml
            cat > pnpm-workspace.yaml << EOF
            overrides:
              "prismjs@1.27.0": "1.30.0"  # CVE-2024-53382
              "axios@1.11.0": "1.12.0"    # CVE-2025-58754
              "mdast-util-to-hast@13.2.0": "13.2.1"    # CVE-2025-66400
            EOF

            /opt/nodejs/node-v22.21.1/bin/corepack pnpm install
            /opt/nodejs/node-v22.21.1/bin/corepack pnpm run build --outDir ${target.dir}/ui

            # prep for sbom
            rm -rf node_modules
            /opt/nodejs/node-v22.21.1/bin/corepack pnpm install --frozen-lockfile --production
        - name: main ui sbom
          uses: sbom@v1
          with:
            extraScanners: javascript-package-cataloger
            prefix: airflow-ui
            source: ${source.dir}/airflow/airflow-core/src/airflow/ui
        - name: build simple auth ui
          privileged: true
          runs: |
            set -eux -o pipefail

            cd '${source.dir}/airflow/airflow-core/src/airflow/api_fastapi/auth/managers/simple/ui'

            # Add overrides. At time of writing, pnpm-workspace.yaml doesn't exist. If it ever does, we'll need to properly merge our contents with it.
            test ! -f pnpm-workspace.yaml
            cat > pnpm-workspace.yaml << EOF
            overrides:
              "axios@1.11.0": "1.12.0"  # CVE-2025-58754
            EOF

            /opt/nodejs/node-v22.21.1/bin/corepack pnpm install
            /opt/nodejs/node-v22.21.1/bin/corepack pnpm run build --outDir ${target.dir}/simple-auth-ui

            # prep for sbom
            rm -rf node_modules
            /opt/nodejs/node-v22.21.1/bin/corepack pnpm install --frozen-lockfile --production
        - name: simple auth ui sbom
          uses: sbom@v1
          with:
            extraScanners: javascript-package-cataloger
            prefix: airflow-simple-auth-ui
            source: ${source.dir}/airflow/airflow-core/src/airflow/api_fastapi/auth/managers/simple/ui
        - name: add constraints for dev
          runs: |
            set -eux -o pipefail

            # This allows users to use the same constraints when installing providers
            cp ${source.dir}/airflow/constraints.txt ${target.dir}/opt/airflow/constraints.txt
      paths:
        - type: file
          path: ${source.dir}/scripts/build-provider
          uid: 0
          gid: 0
          mode: "0755"
          source: image/airflow/bin/build-provider
      outputs:
        - source: ${target.dir}/opt/airflow
          target: /opt/airflow
          uid: 0
          gid: 0
        - source: ${target.dir}/ui
          target: /opt/airflow/lib/python3.12/site-packages/airflow/ui/dist
          uid: 0
          gid: 0
        - source: ${target.dir}/simple-auth-ui
          target: /opt/airflow/lib/python3.12/site-packages/airflow/api_fastapi/auth/managers/simple/ui/dist
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/airflow-ui
          target: /opt/docker/sbom/airflow-ui
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/airflow-simple-auth-ui
          target: /opt/docker/sbom/airflow-simple-auth-ui
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/airflow
          target: /opt/docker/sbom/airflow
          uid: 0
          gid: 0
  artifacts:
    - name: dhi.io/python:3.12.12-debian13-dev@sha256:3182f9f0ec2bea938af32387c1e7a367f57c7c1a09fa4df86ef880f99aae0eb8
      includes:
        - opt/**
        - usr/**
      uid: 0
      gid: 0
accounts:
  root: true
  run-as: root
  users:
    - name: airflow
      uid: 50000
      gid: 50000
    - name: _apt
      uid: 42
      gid: 65532
  groups:
    - name: airflow
      gid: 50000
      members:
        - airflow
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
work-dir: /opt/airflow
environment:
  AIRFLOW_HOME: /opt/airflow
  DEBIAN_FRONTEND: noninteractive
  PATH: /opt/airflow/bin:/opt/python/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
  PYTHONPATH: /opt/airflow/lib/python3.12/site-packages
paths:
  - type: directory
    path: /opt/airflow/logs
    uid: 50000
    gid: 50000
    mode: "0755"
annotations:
  org.opencontainers.image.description: A minimal Airflow image
  org.opencontainers.image.licenses: Apache-2.0
entrypoint:
  - /usr/bin/bash
ports:
  - 8080/tcp
