# syntax=dhi.io/build:1-debian13

name: CouchDB 3.4.x (dev)
image: dhi.io/couchdb
variant: dev
tags:
  - 3.4-dev
  - 3.4.3-dev
  - 3.4-debian13-dev
  - 3.4.3-debian13-dev
platforms:
  - linux/amd64
  - linux/arm64
dates:
  release: "2024-09-20"
vars:
  COMMIT_SHA: e12b967d7f674f8388092bf2b043a978cabce151
  COUCHDB_DOCKER_COMMIT_SHA: 4c82ee090d6299c27616f30d93c9622f769431dd
  COUCHDB_DOCKER_DEFAULT_INI_CHECKSUM: sha256:341de88134122400019a4cbf398dc35774bdd4f2dab3b6b9ad4fec596e627656
  COUCHDB_DOCKER_ENTRYPOINT_CHECKSUM: sha256:d3042b6e100bfe2b9f124f654afc6bdbcad9e9e870511c60e9010da759b60962
  COUCHDB_DOCKER_VM_ARGS_CHECKSUM: sha256:5f84c4bfc47f16f404443dc1437829372ab9ee126d30fc819a2927a4cd333da7
  ERLANG_DEV_REFERENCE: dhi/erlang-otp:27.3-debian13-dev@sha256:d8236434cc25dd1f94180805072f9b844e6ec7e4059e7066913b47957baf10dc
  ERLANG_REFERENCE: dhi/erlang-otp:27.3-debian13@sha256:f91c9a0513b63081ba2ffaa71c54af4dc9bfaac7ca569affc10cce2bce72fadd
  GOSU_REFERENCE: dhi/pkg-gosu:1.19-debian13@sha256:21c6f50effa2c329fee8cbd2326db957286238b4294cf19319435e96a81b1209
  GOSU_VERSION: "1.19"
  NODE_REFERENCE: dhi/node:22.22.0-debian13-dev@sha256:23c18825cef025b69547cca4c9b481bb78a64f558076b58906b58a9f5ec76a0e
  PYTHON_REFERENCE: dhi/python:3.13.12-debian13-dev@sha256:fb4baa0ca0211b20cb45e8fcf2509542b4b1ca634dde7f888027c19a39f30299
  REBAR_COMMIT_SHA: f2b8b08862e00db4b0306852c9a0291dd7e69650
  REBAR_VERSION: 3.26.0
  SEMVER_MAJOR_MINOR_VERSION: "3.4"
  SEMVER_MAJOR_VERSION: "3"
  SEMVER_VERSION: 3.4.3
  VERSION: 3.4.3
contents:
  packages:
    - '!gawk'
    - '!libelogind0'
    - '!original-awk'
    - apt
    - bash
    - ca-certificates
    - coreutils
    - diffutils
    - dpkg
    - findutils
    - grep
    - libc-bin
    - libcurl4t64
    - libicu76
    - libmozjs-128-0
    - libncurses6
    - libstdc++6
    - mawk
    - perl-base
    - sed
    - tini
    - util-linux
  files:
    - url: https://raw.githubusercontent.com/apache/couchdb-docker/4c82ee090d6299c27616f30d93c9622f769431dd/3.4.3/docker-entrypoint.sh
      checksum: sha256:d3042b6e100bfe2b9f124f654afc6bdbcad9e9e870511c60e9010da759b60962
      path: /usr/local/bin/docker-entrypoint.sh
      uid: 0
      gid: 0
      mode: "0755"
    - url: https://raw.githubusercontent.com/apache/couchdb-docker/4c82ee090d6299c27616f30d93c9622f769431dd/3.4.3/10-docker-default.ini
      checksum: sha256:341de88134122400019a4cbf398dc35774bdd4f2dab3b6b9ad4fec596e627656
      path: /opt/couchdb/etc/default.d/10-docker-default.ini
      uid: 65532
      gid: 65532
      mode: "0644"
  builds:
    - name: build couchdb
      uses: dhi.io/erlang-otp:27.3-debian13-dev@sha256:d8236434cc25dd1f94180805072f9b844e6ec7e4059e7066913b47957baf10dc
      contents:
        packages:
          - bash
          - build-essential
          - ca-certificates
          - coreutils
          - dbus-daemon
          - dpkg-dev
          - elixir
          - findutils
          - gcc-14
          - git
          - libabsl-dev
          - libbinutils
          - libcairo2-dev
          - libcairo2-dev
          - libgtk-4-dev
          - libicu-dev
          - libisl-dev
          - libjs-jquery
          - libjxl-dev
          - liblsan0
          - libmount-dev
          - libmozjs-128-dev
          - libncurses-dev
          - libsepol-dev
          - libsvtav1enc2
          - libsystemd-dev
          - libxfixes-dev
          - libxi6
          - libxml2
          - libz3-dev
          - make
          - mesa-utils
          - perl
          - pkg-config
          - python3.13-venv
          - sed
        files:
          - url: git+https://github.com/apache/couchdb#3.4.3
            checksum: e12b967d7f674f8388092bf2b043a978cabce151
            path: ${source.dir}/couchdb
            spdx:
              name: couchdb
              version: 3.4.3
              packages:
                - purl: pkg:github/apache/couchdb@3.4.3
                  license: Apache-2.0
            uid: 0
            gid: 0
          - url: git+https://github.com/erlang/rebar3.git#3.26.0
            checksum: f2b8b08862e00db4b0306852c9a0291dd7e69650
            path: /usr/src/rebar3
            spdx:
              name: rebar3
              version: 3.26.0
              packages:
                - name: rebar3
                  purl: pkg:erlang/github.com/erlang/rebar3@3.26.0
                  license: Apache-2.0
            uid: 0
            gid: 0
          - url: https://raw.githubusercontent.com/apache/couchdb-docker/4c82ee090d6299c27616f30d93c9622f769431dd/3.4.3/vm.args
            checksum: sha256:5f84c4bfc47f16f404443dc1437829372ab9ee126d30fc819a2927a4cd333da7
            path: ${source.dir}/opt/couchdb/etc/vm.args
            uid: 65532
            gid: 65532
            mode: "0644"
        artifacts:
          - name: dhi.io/node:22.22.0-debian13-dev@sha256:23c18825cef025b69547cca4c9b481bb78a64f558076b58906b58a9f5ec76a0e
            includes:
              - opt/**
              - usr/**
            uid: 0
            gid: 0
          - name: dhi.io/pkg-gosu:1.19-debian13@sha256:21c6f50effa2c329fee8cbd2326db957286238b4294cf19319435e96a81b1209
            includes:
              - usr/local/sbin/gosu
            uid: 0
            gid: 0
          - name: dhi.io/python:3.13.12-debian13-dev@sha256:fb4baa0ca0211b20cb45e8fcf2509542b4b1ca634dde7f888027c19a39f30299
            includes:
              - /opt/**
              - /usr/**
            uid: 0
            gid: 0
      pipeline:
        - name: install rebar3
          work-dir: /usr/src/rebar3
          runs: |
            set -eux -o pipefail

            # Set up environment to use the staged Erlang installation
            export PATH="/usr/local/bin:$PATH"
            export ERL_ROOTDIR="/usr/local/lib/erlang"

            ./bootstrap
            install -D -m755 rebar3 /usr/local/bin/rebar3
        - name: configure
          work-dir: ${source.dir}/couchdb
          privileged: true
          runs: |
            set -eux -o pipefail

            # Create mozjs symlink for the appropriate architecture
            if [ -d /usr/include/aarch64-linux-gnu/mozjs-128 ]; then
              ln -sf /usr/include/aarch64-linux-gnu/mozjs-128 /usr/include/mozjs-128
            elif [ -d /usr/include/x86_64-linux-gnu/mozjs-128 ]; then
              ln -sf /usr/include/x86_64-linux-gnu/mozjs-128 /usr/include/mozjs-128
            fi

            ./configure --spidermonkey-version 128 --rebar3 /usr/local/bin/rebar3
        - name: build
          work-dir: ${source.dir}/couchdb
          privileged: true
          runs: |
            set -eux -o pipefail

            mkdir -p ${target.dir}/opt/couchdb

            make -j "$(nproc)"
            make release
            mv rel/couchdb/* ${target.dir}/opt/couchdb/

            # Set ownership and permissions
            chown -R 65532:65532 ${target.dir}/opt/couchdb
            find ${target.dir}/opt/couchdb/etc -type d ! -perm 0755 -exec chmod 0755 {} \;
            find ${target.dir}/opt/couchdb/etc -type f ! -perm 0644 -exec chmod 0644 {} \;
        - name: tests
          work-dir: ${source.dir}/couchdb
          privileged: true
          runs: |
            set -eux -o pipefail

            # Create symlink for Mix elixir-init step
            mkdir -p bin
            ln -sf /usr/local/bin/rebar3 ./bin/rebar3

            # Create non-root user for tests to properly validate file permissions
            useradd -u 1000 -m -s /bin/bash testuser || true
            chown -R testuser:testuser ${source.dir}/couchdb
            # Run full test suite as non-root using gosu
            cd ${source.dir}/couchdb && gosu testuser make check
      outputs:
        - source: ${target.dir}/opt/couchdb
          target: /opt/couchdb
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/couchdb
          target: /opt/docker/sbom/couchdb
          uid: 0
          gid: 0
  artifacts:
    - name: dhi.io/erlang-otp:27.3-debian13@sha256:f91c9a0513b63081ba2ffaa71c54af4dc9bfaac7ca569affc10cce2bce72fadd
      includes:
        - /usr/local/**
      uid: 0
      gid: 0
accounts:
  root: true
  run-as: root
  users:
    - name: couchdb
      uid: 65532
      gid: 65532
    - name: _apt
      uid: 42
      gid: 65532
  groups:
    - name: couchdb
      gid: 65532
      members:
        - couchdb
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
environment:
  DEBIAN_FRONTEND: noninteractive
paths:
  - type: directory
    path: /opt/couchdb/etc/default.d
    uid: 65532
    gid: 65532
    mode: "0755"
  - type: directory
    path: /opt/couchdb/data
    uid: 65532
    gid: 65532
    mode: "0700"
  - type: directory
    path: /opt/couchdb/etc/local.d
    uid: 65532
    gid: 65532
    mode: "0755"
annotations:
  org.opencontainers.image.description: A minimal CouchDB Image
  org.opencontainers.image.licenses: Apache-2.0
entrypoint:
  - tini
  - --
  - /usr/local/bin/docker-entrypoint.sh
cmd:
  - /opt/couchdb/bin/couchdb
ports:
  - 5984/tcp
  - 4369/tcp
  - 9100/tcp
