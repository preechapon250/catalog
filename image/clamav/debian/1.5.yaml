# syntax=dhi/build:1-debian13

# DO NOT EDIT THIS FILE MANUALLY
# generated with 'dhi def merge image/clamav/debian/1.5.yaml'

name: ClamAV 1.5.x
image: dhi/clamav
variant: runtime
tags:
    - "1"
    - "1.5"
    - 1.5.1
    - 1-debian13
    - 1.5-debian13
    - 1.5.1-debian13
platforms:
    - linux/amd64
    - linux/arm64
dates:
    release: "2025-10-07"
vars:
    COMMIT_SHA: 0a6802e88ac2efc194d1feb26e912a313ab85f81
    PYTHON_DIGEST: sha256:0f3812f9995cc2947f614192c38b9d7d0836ebc16911e297d0c402c10ad1a843
    PYTHON_VERSION: 3.13.11
    RUST_DIGEST: sha256:b51048f4ff7a88671f37514ec740a411fa41c40b9848696fb0704b6d20fb98e7
    RUST_VERSION: 1.92.0
    SEMVER_MAJOR_MINOR_VERSION: "1.5"
    SEMVER_MAJOR_VERSION: "1"
    SEMVER_VERSION: 1.5.1
    VERSION: 1.5.1
contents:
    packages:
        - ca-certificates
        - coreutils
        - dash
        - grep
        - libbz2-1.0
        - libcurl4t64
        - libjson-c5
        - libmilter1.0.1
        - libncurses6
        - libpcre2-8-0
        - libssl3t64
        - libxml2
        - ncurses-base
        - netcat-openbsd
        - sed
        - tzdata
        - zlib1g
    files:
        - url: https://raw.githubusercontent.com/Cisco-Talos/clamav-docker/refs/heads/main/clamav/1.5/debian/scripts/docker-entrypoint-unprivileged.sh
          path: /usr/local/bin/docker-entrypoint-unprivileged.sh
          uid: 0
          gid: 0
          mode: "0755"
        - url: https://raw.githubusercontent.com/Cisco-Talos/clamav-docker/refs/heads/main/clamav/1.5/debian/scripts/docker-entrypoint.sh
          path: /usr/local/bin/docker-entrypoint.sh
          uid: 0
          gid: 0
          mode: "0755"
    builds:
        - name: build clamav
          environment:
            PATH: /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/opt/python/bin
          contents:
            packages:
                - bash
                - bison
                - ca-certificates
                - check
                - cmake
                - coreutils
                - flex
                - g++
                - gcc
                - libbz2-dev
                - libc6-dev
                - libcurl4-openssl-dev
                - libjson-c-dev
                - libmilter-dev
                - libncurses-dev
                - libpcre2-dev
                - libssl-dev
                - libxml2-dev
                - make
                - net-tools
                - pkg-config
                - sed
                - zlib1g-dev
            files:
                - url: git+https://github.com/Cisco-Talos/clamav#clamav-1.5.1
                  checksum: 0a6802e88ac2efc194d1feb26e912a313ab85f81
                  path: ${source.dir}/clamav
                  spdx:
                    name: clamav
                    version: 1.5.1
                    packages:
                        - purl: pkg:dhi/clamav@1.5.1
                          license: GPL-2.0
                  uid: 0
                  gid: 0
            artifacts:
                - name: dhi/rust:1.92.0-debian13@sha256:b51048f4ff7a88671f37514ec740a411fa41c40b9848696fb0704b6d20fb98e7
                  includes:
                    - usr/local/bin/cargo
                    - usr/local/bin/rustc
                    - usr/local/lib
                  uid: 0
                  gid: 0
                - name: dhi/python:3.13.11-debian13-dev@sha256:0f3812f9995cc2947f614192c38b9d7d0836ebc16911e297d0c402c10ad1a843
                  includes:
                    - opt/**
                  uid: 0
                  gid: 0
          pipeline:
            - name: install pytest
              privileged: true
              runs: |
                set -eux -o pipefail

                pip3 install pytest
            - name: compile
              work-dir: ${source.dir}/clamav/build
              privileged: true
              runs: |
                set -eux -o pipefail

                cmake .. \
                  -DCMAKE_BUILD_TYPE="Release" \
                  -DCMAKE_INSTALL_PREFIX="/usr" \
                  -DCMAKE_INSTALL_LIBDIR="/usr/lib" \
                  -DAPP_CONFIG_DIRECTORY="/etc/clamav" \
                  -DDATABASE_DIRECTORY="/var/lib/clamav" \
                  -DENABLE_CLAMONACC=OFF \
                  -DENABLE_EXAMPLES=OFF \
                  -DENABLE_JSON_SHARED=ON \
                  -DENABLE_MAN_PAGES=OFF \
                  -DENABLE_MILTER=ON \
                  -DENABLE_STATIC_LIB=OFF

                make -j$(($(nproc) - 1)) install DESTDIR="${target.dir}/clamav"
            - name: tests
              work-dir: ${source.dir}/clamav/build
              runs: |
                set -eux -o pipefail

                ctest -V --timeout 3000
            - name: setup configuration
              work-dir: ${source.dir}/clamav
              runs: |
                set -eux -o pipefail

                sed -e "s|^\(Example\)|\# \1|" \
                  -e "s|.*\(LocalSocket\) .*|\1 /tmp/clamd.sock|" \
                  -e "s|.*\(TCPSocket\) .*|\1 3310|" \
                  -e "s|.*\(TCPAddr\) .*|#\1 0.0.0.0|" \
                  -e "s|.*\(User\) .*|\1 clamav|" \
                  -e "s|^\#\(LogFile\) .*|\1 /var/log/clamav/clamd.log|" \
                  -e "s|^\#\(LogTime\).*|\1 yes|" \
                  ${target.dir}/clamav/etc/clamav/clamd.conf.sample > ${target.dir}/clamav/etc/clamav/clamd.conf

                sed -e "s|^\(Example\)|\# \1|" \
                  -e "s|.*\(DatabaseOwner\) .*|\1 clamav|" \
                  -e "s|^\#\(UpdateLogFile\) .*|\1 /var/log/clamav/freshclam.log|" \
                  -e "s|^\#\(NotifyClamd\).*|\1 /etc/clamav/clamd.conf|" \
                  -e "s|^\#\(ScriptedUpdates\).*|\1 yes|" \
                  ${target.dir}/clamav/etc/clamav/freshclam.conf.sample > ${target.dir}/clamav/etc/clamav/freshclam.conf

                sed -e "s|^\(Example\)|\# \1|" \
                  -e "s|.*\(MilterSocket\) .*|\1 inet:7357|" \
                  -e "s|.*\(User\) .*|\1 clamav|" \
                  -e "s|^\#\(LogFile\) .*|\1 /var/log/clamav/milter.log|" \
                  -e "s|^\#\(LogTime\).*|\1 yes|" \
                  -e "s|.*\(\ClamdSocket\) .*|\1 unix:/tmp/clamd.sock|" \
                  ${target.dir}/clamav/etc/clamav/clamav-milter.conf.sample > ${target.dir}/clamav/etc/clamav/clamav-milter.conf
            - name: update databases
              work-dir: ${target.dir}/clamav
              privileged: true
              runs: |
                set -eux -o pipefail

                # Create the necessary folder for freshclam to run
                mkdir -p /var/lib/clamav /var/log/clamav

                # Copy all the lib files in /usr/lib so freshclam can find them when running.
                ln -s ${target.dir}/clamav/usr/lib/lib* /usr/lib/

                # Copy all the config in /etc/clamav so freshclam can find the config and certificats
                ln -s ${target.dir}/clamav/etc/clamav /etc/clamav

                usr/bin/freshclam \
                  --config-file=etc/clamav/freshclam.conf \
                  --user=$(whoami)

                rm -f /var/lib/clamav/freshclam.dat
                rm -f /var/lib/clamav/mirrors.dat
          outputs:
            - source: ${target.dir}/clamav/usr
              target: /usr
              uid: 0
              gid: 0
            - source: ${target.dir}/clamav/etc/clamav
              target: /etc/clamav
              uid: 0
              gid: 0
            - source: /var/lib/clamav
              target: /var/lib/clamav
              uid: 65532
              gid: 65532
              mode: "0755"
accounts:
    run-as: clamav
    users:
        - name: clamav
          uid: 65532
          gid: 65532
    groups:
        - name: clamav
          gid: 65532
          members:
            - clamav
os-release:
    name: Docker Hardened Images (Debian)
    id: debian
    version-id: "13"
    version-codename: trixie
    pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
    home-url: https://docker.com/products/hardened-images/
    bug-report-url: https://docker.com/support/
environment:
    TZ: Etc/UTC
paths:
    - type: directory
      path: /run/clamav
      uid: 65532
      gid: 65532
      mode: "0755"
    - type: directory
      path: /run/lock
      uid: 65532
      gid: 65532
      mode: "0755"
    - type: symlink
      path: /var/lock
      uid: 65532
      gid: 65532
      mode: "0755"
      source: /run/lock
    - type: directory
      path: /var/lib/clamav
      uid: 65532
      gid: 65532
      mode: "0755"
    - type: directory
      path: /var/log/clamav
      uid: 65532
      gid: 65532
      mode: "0755"
    - type: directory
      path: /tmp
      uid: 65532
      gid: 65532
      mode: "0755"
    - type: symlink
      path: /usr/local/bin/init
      uid: 65532
      gid: 65532
      mode: "0755"
      source: /usr/local/bin/docker-entrypoint.sh
    - type: symlink
      path: /usr/local/bin/init-unprivileged
      uid: 65532
      gid: 65532
      mode: "0755"
      source: /usr/local/bin/docker-entrypoint-unprivileged.sh
annotations:
    org.opencontainers.image.description: A minimal ClamAV image
    org.opencontainers.image.licenses: GPL-2.0
entrypoint:
    - /usr/local/bin/docker-entrypoint.sh
ports:
    - "3310"
    - "7357"
tests:
    - name: Run testcontainers tests
      directory: image/clamav/tests
      commands:
        - go test . -count=1 -v
      exit-code: 0
    - name: Run base tests
      directory: test/go-testing/base
      commands:
        - go test . -count=1 -v
      exit-code: 0
