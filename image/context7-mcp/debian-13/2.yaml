# syntax=dhi.io/build:2-debian13

name: Upstash Context7 MCP 2.x
image: dhi.io/context7-mcp
variant: runtime
tags:
  - "2"
  - "2.1"
  - 2.1.1
  - latest
  - 2-debian13
  - 2.1-debian13
  - 2.1.1-debian13
platforms:
  - linux/amd64
  - linux/arm64
vars:
  ARCH: '#{ target.arch == "amd64" ? "x64" : "arm64" }'
  COMMIT_SHA: c21081c71ab69c8b88da1b139841e2ea73228bb4
  NODE_BUILD_REFERENCE: dhi/node:24.13.0-debian13-sfw-dev@sha256:546513dbe0c5bb8605abde323b0af9fe9a113edb6eb0ba82f56be28391bcd962
  NODE_RUNTIME_REFERENCE: dhi/node:24.13.0-debian13@sha256:c2368c70538c2459b90d588e5344013064da76aeba6fc4443457b2c376e60cd7
  PNPM_VERSION: 10.28.2
  SEMVER_MAJOR_MINOR_VERSION: "2.1"
  SEMVER_MAJOR_VERSION: "2"
  SEMVER_VERSION: 2.1.1
  VERSION: 2.1.1
contents:
  packages:
    - '!libelogind0'
    - '!mawk'
    - '!original-awk'
    - base-files
  builds:
    - name: context7-mcp
      uses: dhi.io/node:24.13.0-debian13-sfw-dev@sha256:546513dbe0c5bb8605abde323b0af9fe9a113edb6eb0ba82f56be28391bcd962
      contents:
        files:
          - url: https://github.com/pnpm/pnpm/releases/download/v10.28.2/pnpm-linux-${ARCH}
            path: /usr/local/bin/pnpm
            uid: 0
            gid: 0
            mode: "0755"
          - url: git+https://github.com/upstash/context7.git#@upstash/context7-mcp@2.1.1
            checksum: c21081c71ab69c8b88da1b139841e2ea73228bb4
            path: ${source.dir}/context7-c21081c71ab69c8b88da1b139841e2ea73228bb4
            spdx:
              name: context7-mcp
              version: 2.1.1
              packages:
                - name: context7-mcp
                  purl: pkg:dhi/context7-mcp@2.1.1
                  license: MIT
            uid: 0
            gid: 0
      pipeline:
        - name: update dependencies
          work-dir: ${source.dir}/context7-c21081c71ab69c8b88da1b139841e2ea73228bb4
          privileged: true
          runs: |
            set -eux -o pipefail

            npm pkg set pnpm.overrides."@modelcontextprotocol/sdk"=1.25.2 # CVE-2026-0621
            sfw pnpm update
        - name: update dependencies
          work-dir: ${source.dir}/context7-c21081c71ab69c8b88da1b139841e2ea73228bb4/packages/mcp
          privileged: true
          runs: |
            set -eux -o pipefail

            sfw pnpm update
        - name: build
          work-dir: ${source.dir}/context7-c21081c71ab69c8b88da1b139841e2ea73228bb4
          privileged: true
          runs: |
            set -eux -o pipefail

            sfw pnpm install --frozen-lockfile
            sfw pnpm --filter @upstash/context7-mcp build
        - name: setup
          work-dir: ${source.dir}/context7-c21081c71ab69c8b88da1b139841e2ea73228bb4
          privileged: true
          environment:
            CI: "true"
          runs: |
            set -eux -o pipefail

            sfw pnpm install --frozen-lockfile --prod --filter @upstash/context7-mcp

            # remove all esbuild dependencies
            rm -rf node_modules/.pnpm/*esbuild*
      outputs:
        - source: ${source.dir}/context7-c21081c71ab69c8b88da1b139841e2ea73228bb4/packages/mcp
          target: /app/packages/mcp
          uid: 0
          gid: 0
        - source: ${source.dir}/context7-c21081c71ab69c8b88da1b139841e2ea73228bb4/node_modules
          target: /app/node_modules
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/context7-mcp
          target: /opt/docker/sbom/context7-mcp
          uid: 0
          gid: 0
  artifacts:
    - name: dhi.io/node:24.13.0-debian13@sha256:c2368c70538c2459b90d588e5344013064da76aeba6fc4443457b2c376e60cd7
      uid: 0
      gid: 0
accounts:
  run-as: node
  users:
    - name: node
      uid: 1000
      gid: 1000
  groups:
    - name: node
      gid: 1000
      members:
        - node
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
work-dir: /app/packages/mcp
annotations:
  org.opencontainers.image.description: Upstash Context7 MCP Server
  org.opencontainers.image.licenses: MIT
labels:
  io.modelcontextprotocol.server.name: io.upstash/context7-mcp
cmd:
  - node
  - dist/index.js
  - --transport
  - http
  - --port
  - "8080"
ports:
  - 8080/tcp
