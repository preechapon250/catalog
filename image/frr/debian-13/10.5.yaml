# syntax=dhi.io/build:2-debian13

name: FRRouting 10.x
image: dhi.io/frr
variant: runtime
tags:
  - "10"
  - "10.5"
  - 10.5.1
  - 10-debian13
  - 10.5-debian13
  - 10.5.1-debian13
platforms:
  - linux/amd64
  - linux/arm64
vars:
  COMMIT_SHA: d17791ee7ee76a0407d3fdbebf81bd242840741b
  PYTHON_BUILD_REFERENCE: dhi/python:3.12.12-debian13-dev@sha256:24e13f1fc03f94e85eced365faac8323d2c33369c3a68576b18e6aa3e0b5e26d
  PYTHON_BUILD_VERSION: 3.12.12
  PYTHON_MAJOR_MINOR_VERSION: "3.12"
  PYTHON_REFERENCE: dhi/python:3.12.12-debian13@sha256:8fdf129968594c319caf810dcf15b2541d08d2b166a9306f6aaf3637c3168e06
  PYTHON_VERSION: 3.12.12
  SEMVER_MAJOR_MINOR_VERSION: "10.5"
  SEMVER_MAJOR_VERSION: "10"
  SEMVER_VERSION: 10.5.1
  VERSION: 10.5.1
contents:
  packages:
    - '!libelogind0'
    - '!mawk'
    - '!original-awk'
    - base-files
    - bash
    - coreutils
    - grep
    - iproute2
    - libc-ares2
    - libelf1t64
    - libjson-c5
    - libpcre2-8-0
    - libpcre2-posix3
    - libreadline8
    - librtr0t64
    - libsnmp40t64
    - libssl3t64
    - libyang3
    - lsof
    - tini
  builds:
    - name: frr
      uses: dhi.io/python:3.12.12-debian13-dev@sha256:24e13f1fc03f94e85eced365faac8323d2c33369c3a68576b18e6aa3e0b5e26d
      contents:
        packages:
          - autoconf
          - automake
          - bison
          - diffutils
          - flex
          - grep
          - gzip
          - libc-ares-dev
          - libcap-dev
          - libcap2-bin
          - libtool
          - libjson-c-dev
          - libelf-dev
          - libpcre2-dev
          - libreadline-dev
          - librtr-dev
          - libsnmp-dev
          - libssl-dev
          - libyang-dev
          - m4
          - make
          - patch
          - pkg-config
          - sed
          - libprotobuf-c-dev
          - protobuf-c-compiler
        files:
          - url: git+https://github.com/FRRouting/frr.git#frr-10.5.1
            checksum: d17791ee7ee76a0407d3fdbebf81bd242840741b
            path: ${source.dir}/frr
            spdx:
              name: frr
              version: 10.5.1
              packages:
                - name: frr
                  purl: pkg:dhi/frr@10.5.1
                  license: GPL-2.0
            uid: 0
            gid: 0
      pipeline:
        - name: fix docker-start script
          uses: git/patch@v1
          work-dir: ${source.dir}/frr
          with:
            patch: ${source.dir}/patch/docker-start.patch
        - name: patch out unnecessary root checks
          uses: git/patch@v1
          work-dir: ${source.dir}/frr
          with:
            patch: ${source.dir}/patch/remove-root-checks.patch
        - name: install pytest
          privileged: true
          runs: |
            set -eux -o pipefail

            pip install pytest
        - name: build
          work-dir: ${source.dir}/frr
          runs: |
            set -eux -o pipefail

            autoreconf -is -Wall,no-override

            # configure flags based are largely on the debian package build flags (which is what is installed in the upstream image)
            # Also see their reference docs https://docs.frrouting.org/en/latest/installation.html#build-configuration
            configure_flags=(
              # These are custom flags for DHI to put things in /usr/local, /etc, /var
              --prefix=/usr/local
              --sbindir=/usr/local/lib/frr
              LDFLAGS="-Wl,-rpath,/usr/local/lib"
              --sysconfdir=/etc
              --localstatedir=/var

              # Needed to link to system openssl - especially important for fips
              --with-crypto=openssl

              # No need for docs generation
              --disable-doc

              # No need for pam in DHI
              --without-libpam

              # Based on debian package build with no special profiles
              # https://github.com/FRRouting/frr/blob/d17791ee7ee76a0407d3fdbebf81bd242840741b/debian/rules#L16-L46
              --enable-rpki
              --disable-scripting
              --enable-pim6d
              --disable-grpc
              --disable-address-sanitizer

              # Straight from debian package build
              # https://github.com/FRRouting/frr/blob/d17791ee7ee76a0407d3fdbebf81bd242840741b/debian/rules#L71-L78
              --disable-dependency-tracking
              --enable-snmp
              --enable-fpm
              --disable-protobuf
              --disable-zeromq
              --enable-ospfapi
              --enable-bgp-vnc
              --enable-multipath=256
              --enable-pcre2posix

              # Straight from debian package build. These align with the accounts configured for the runtime image.
              # https://github.com/FRRouting/frr/blob/d17791ee7ee76a0407d3fdbebf81bd242840741b/debian/rules#L80-L84
              --enable-user=frr
              --enable-group=frr
              --enable-vty-group=frrvty
              --enable-configfile-mask=0640
              --enable-logfile-mask=0640
            )

            ./configure "${configure_flags[@]}"

            make check
            make
            make DESTDIR="${target.dir}" install
        - name: setcap binaries
          work-dir: ${target.dir}/usr/local/lib/frr
          runs: |
            set -eux -o pipefail

            # necessary caps defined in each executable's *_main.c file
            # using =+p (permitted) instead of =+ep (effective+permitted) because FRR's
            # lib/privs.c explicitly clears CAP_EFFECTIVE and raises caps only when needed
            setcap 'cap_net_bind_service,cap_net_raw=+p' babeld
            setcap 'cap_net_bind_service,cap_net_raw,cap_sys_admin=+p' bfdd
            setcap 'cap_net_admin,cap_net_bind_service,cap_net_raw,cap_sys_admin=+p' bgpd
            setcap 'cap_net_admin,cap_net_bind_service,cap_net_raw=+p' eigrpd
            setcap 'cap_net_bind_service,cap_net_raw,cap_sys_admin=+p' fabricd
            setcap 'cap_net_bind_service,cap_net_raw,cap_sys_admin=+p' isisd
            setcap 'cap_net_admin,cap_net_bind_service=+p' ldpd
            setcap 'cap_net_admin,cap_net_bind_service,cap_net_raw,cap_sys_admin=+p' mgmtd
            setcap 'cap_net_admin,cap_net_raw,cap_dac_override=+p' nhrpd
            setcap 'cap_net_bind_service,cap_net_raw,cap_sys_admin=+p' ospf6d
            setcap 'cap_net_admin,cap_net_bind_service,cap_net_raw,cap_sys_admin=+p' ospfd
            setcap 'cap_net_admin,cap_net_bind_service,cap_net_raw=+p' pbrd
            setcap 'cap_net_admin,cap_net_bind_service,cap_net_raw,cap_sys_admin=+p' pim6d
            setcap 'cap_net_admin,cap_net_bind_service,cap_net_raw,cap_sys_admin=+p' pimd
            setcap 'cap_net_bind_service,cap_net_raw,cap_sys_admin=+p' ripd
            setcap 'cap_net_bind_service,cap_net_raw,cap_sys_admin=+p' ripngd
            setcap 'cap_net_raw=+p' vrrpd
            setcap 'cap_net_admin,cap_net_raw,cap_sys_admin=+p' zebra
        - name: install static files
          work-dir: ${source.dir}/frr
          runs: |
            set -eux -o pipefail

            mkdir -p "${target.dir}/etc/frr"
            install -m 0644 tools/etc/frr/frr.conf "${target.dir}/etc/frr/frr.conf"
            install -m 0644 tools/etc/frr/daemons "${target.dir}/etc/frr/daemons"
            install -m 0644 tools/etc/frr/support_bundle_commands.conf "${target.dir}/etc/frr/support_bundle_commands.conf"
            install -m 0644 tools/etc/frr/vtysh.conf "${target.dir}/etc/frr/vtysh.conf"

            install -m 0644 docker/debian/docker-start "${target.dir}/usr/local/bin/docker-start"
      paths:
        - type: file
          path: ${source.dir}/patch/remove-root-checks.patch
          uid: 0
          gid: 0
          source: image/frr/patch/remove-root-checks.patch
        - type: file
          path: ${source.dir}/patch/docker-start.patch
          uid: 0
          gid: 0
          source: image/frr/patch/docker-start.patch
      outputs:
        - source: ${target.dir}/usr/local/bin
          target: /usr/local/bin
          uid: 0
          gid: 0
          mode: "0755"
        - source: ${target.dir}/usr/local/lib
          target: /usr/local/lib
          uid: 0
          gid: 0
          mode: "0755"
        - source: ${target.dir}/etc/frr
          target: /etc/frr
          uid: 0
          gid: 0
          mode: "0644"
  artifacts:
    - name: dhi.io/python:3.12.12-debian13@sha256:8fdf129968594c319caf810dcf15b2541d08d2b166a9306f6aaf3637c3168e06
      includes:
        - opt
      uid: 0
      gid: 0
accounts:
  run-as: frr
  users:
    - name: frr
      uid: 1000
      gid: 1000
  groups:
    - name: frr
      gid: 1000
      members:
        - frr
    - name: frrvty
      gid: 1001
      members:
        - frr
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
environment:
  FRR_NO_ROOT: "yes"
paths:
  - type: directory
    path: /var/run/frr
    uid: 1000
    gid: 1000
  - type: directory
    path: /var/lib/frr
    uid: 1000
    gid: 1000
  - type: directory
    path: /etc/frr
    uid: 1000
    gid: 1000
  - type: symlink
    path: /usr/lib/frr
    uid: 0
    gid: 0
    source: /usr/local/lib/frr
  - type: symlink
    path: /usr/bin/vtysh
    uid: 0
    gid: 0
    source: /usr/local/bin/vtysh
annotations:
  org.opencontainers.image.description: A minimal FRRouting image
  org.opencontainers.image.licenses: GPL-2.0
entrypoint:
  - tini
  - --
cmd:
  - /usr/local/bin/docker-start
