# syntax=dhi.io/build:2-debian13

name: Piraeus Server 1.x
image: dhi.io/piraeus-server
variant: runtime
tags:
  - "1"
  - "1.33"
  - 1.33.1
  - 1-debian13
  - 1.33-debian13
  - 1.33.1-debian13
platforms:
  - linux/amd64
  - linux/arm64
dates:
  release: "2019-08-08"
vars:
  BASE_DIGEST: sha256:74fc43fa240887b8159970e434244039aab0c6efaaa9cf044004cdc22aa2a34d
  BASE_TAG: 20250419-debian13
  COMMIT_SHA: 4f78b2e2550bd5f0e6a06bd9bbc6bc46ee348edb
  DEBIAN_REFERENCE: dhi/debian-base:trixie-debian13@sha256:9ef766670af4743904b0f992a26b525c6c914648b56ea597ec23452adcf1a95d
  GOLANG_REFERENCE: dhi/golang:1.25.7-debian13-dev@sha256:d241d31631f6bcfdef4f42f70083bb06d51e6401d9ce172a05b9ba37f27c2940
  GRADLE_REFERENCE: dhi/gradle:8.14.4-jdk17-debian13-dev@sha256:64824bb4e0a25d33315c444f0face92efdccefb3b5391bbd222939b91537f81d
  GRADLE_VERSION: 8.14.4
  JRE_PATH: /opt/java/openjdk/17-jre
  JRE_REFERENCE: dhi/eclipse-temurin:17.0.18.8-debian13@sha256:e86ccb5c8b66bf58cac5e2ca508ef711669fcc00e5508c90fc8e90ad352b64ec
  JRE_VERSION: 17.0.18.8
  K8S_AWAIT_ELECTION_COMMIT_SHA: a0b8ad628a23290de9ad08101b18bdecf69705ed
  K8S_AWAIT_ELECTION_VERSION: v0.4.2
  KUBECTL_REFERENCE: dhi/kubectl:1.34.3-debian13@sha256:50bf3325bce60c5e9fe1d392a191ed79567a4c17210c7d36f8708d04fe4d55f7
  LINSTOR_CLIENT_COMMIT_SHA: 9c57f040eb3834500db508e4f04d361d006cb6b5
  LINSTOR_CLIENT_VERSION: 1.27.1
  LINSTOR_COMMIT_SHA: 95da7940d6efb6a39ea303c5f37b03478a6fab0b
  LINSTOR_VERSION: 1.33.1
  LOSETUP_CONTAINER_ARCH: '#{ target.arch == "amd64" ? "x86_64" : "aarch64" }'
  LOSETUP_CONTAINER_CHECKSUM: '#{ target.arch == "amd64" ? "sha256:63aab762aa930cc2c8bcd2e6d7759ee80e15d6d363858dfaa3e728d33442105a" : "sha256:8b066c37c44bb811f54c0ff3ee1805d014cff012539d5ec9a6dc58a3c7511721" }'
  LOSETUP_CONTAINER_CHECKSUM_AMD64: sha256:63aab762aa930cc2c8bcd2e6d7759ee80e15d6d363858dfaa3e728d33442105a
  LOSETUP_CONTAINER_CHECKSUM_ARM64: sha256:8b066c37c44bb811f54c0ff3ee1805d014cff012539d5ec9a6dc58a3c7511721
  LOSETUP_CONTAINER_VERSION: v1.1.0
  PROTOC_ARCH: '#{ target.arch == "amd64" ? "x86_64" : "aarch_64" }'
  PROTOC_CHECKSUM: '#{ target.arch == "amd64" ? "sha256:96553041f1a91ea0efee963cb16f462f5985b4d65365f3907414c360044d8065" : "sha256:6c554de11cea04c56ebf8e45b54434019b1cd85223d4bbd25c282425e306ecc2" }'
  PROTOC_COMMIT_SHA: 74211c0dfc2777318ab53c2cd2c317a2ef9012de
  PROTOC_VERSION: "31.1"
  PYTHON_BUILD_REFERENCE: dhi/python:3.13.12-debian13-dev@sha256:e804df61d954e90edc605f29bfc89d22df071bd35709f42cc8d783b718c41b97
  PYTHON_LINSTOR_COMMIT_SHA: 578e45c998938a7696fe9258cd6b9e22a3941738
  PYTHON_LINSTOR_VERSION: 1.27.1
  PYTHON_MAJOR_MINOR_VERSION: "3.13"
  PYTHON_REFERENCE: dhi/python:3.13.12-debian13@sha256:e3ce38c682400c9fd4872709d88f9dc4f4373cf097a72c10bd80eeecf1198338
  PYTHON_VERSION: 3.13.12
  SEMVER_MAJOR_MINOR_VERSION: "1.33"
  SEMVER_MAJOR_VERSION: "1"
  SEMVER_VERSION: 1.33.1
  VERSION: 1.33.1
contents:
  packages:
    - '!base-files'
    - '!libpython3-stdlib'
    - '!libpython3.13'
    - '!libpython3.13-minimal'
    - '!libpython3.13-stdlib'
    - '!python3'
    - '!python3-minimal'
    - '!python3.13'
    - '!python3.13-minimal'
    - '!udev'
    - bash
    - cryptsetup
    - curl
    - drbd-utils
    - e2fsprogs
    - findutils
    - iproute2
    - iputils-ping
    - jq
    - lsscsi
    - lvm2
    - multipath-tools
    - net-tools
    - netcat-traditional
    - nvme-cli
    - procps
    - sed
    - socat
    - sysstat
    - util-linux
    - xfsprogs
    - zstd
  builds:
    - name: piraeus-server
      uses: dhi.io/golang:1.25.7-debian13-dev@sha256:d241d31631f6bcfdef4f42f70083bb06d51e6401d9ce172a05b9ba37f27c2940
      contents:
        packages:
          - curl
          - tar
          - wget
          - gzip
          - git
        files:
          - url: git+https://github.com/piraeusdatastore/piraeus.git#4f78b2e2550bd5f0e6a06bd9bbc6bc46ee348edb
            checksum: 4f78b2e2550bd5f0e6a06bd9bbc6bc46ee348edb
            path: ${source.dir}/piraeus
            spdx:
              name: piraeus
              version: 1.33.1
              packages:
                - name: piraeus
                  purl: pkg:github/piraeusdatastore/piraeus@1.33.1
                  license: Apache-2.0
            uid: 0
            gid: 0
          - url: git+https://github.com/LINBIT/k8s-await-election.git#v0.4.2
            checksum: a0b8ad628a23290de9ad08101b18bdecf69705ed
            path: /go/src/github.com/linbit/k8s-await-election
            spdx:
              name: k8s-await-election
              version: v0.4.2
              packages:
                - name: k8s-await-election
                  purl: pkg:golang/github.com/linbit/k8s-await-election@v0.4.2
                  license: Apache-2.0
            uid: 0
            gid: 0
          - url: https://github.com/LINBIT/losetup-container/releases/download/v1.1.0/losetup-container-${LOSETUP_CONTAINER_ARCH}-unknown-linux-gnu.tar.gz
            checksum: ${LOSETUP_CONTAINER_CHECKSUM}
            path: ${source.dir}/losetup-container.tar.gz
            spdx:
              name: losetup-container
              version: v1.1.0
              packages:
                - name: losetup-container
                  purl: pkg:github/LINBIT/losetup-container@v1.1.0
                  license: GPL-2.0
            uid: 0
            gid: 0
      pipeline:
        - name: copy-entrypoint-script
          work-dir: ${source.dir}/piraeus
          runs: |
            set -eux -o pipefail

            mkdir -p ${target.dir}/usr/bin
            install -m 0755 dockerfiles/piraeus-server/entry.sh ${target.dir}/usr/bin/piraeus-entry.sh
        - name: update-go-dependencies
          uses: go/bump@v1
          work-dir: /go/src/github.com/linbit/k8s-await-election
          with:
            deps: []
            download: true
        - name: build-k8s-await-election
          uses: go/build@v1
          work-dir: /go/src/github.com/linbit/k8s-await-election
          with:
            output: ${target.dir}/usr/bin/k8s-await-election
        - name: install-losetup-container
          runs: |
            set -eux -o pipefail

            mkdir -p ${target.dir}/usr/local/sbin
            tar -xz -C ${target.dir}/usr/local/sbin -f ${source.dir}/losetup-container.tar.gz
            printf '#!/bin/sh\nLOSETUP_CONTAINER_ORIGINAL_LOSETUP=/usr/bin/losetup exec /usr/local/sbin/losetup-container "$@"\n' > ${target.dir}/usr/local/sbin/losetup
      outputs:
        - source: ${target.dir}/usr/bin/piraeus-entry.sh
          target: /usr/bin/piraeus-entry.sh
          uid: 0
          gid: 0
          mode: "0755"
        - source: ${target.dir}/usr/bin/k8s-await-election
          target: /usr/bin/k8s-await-election
          uid: 0
          gid: 0
          mode: "0755"
        - source: ${target.dir}/usr/local/sbin/losetup-container
          target: /usr/local/sbin/losetup-container
          uid: 0
          gid: 0
          mode: "0755"
        - source: ${target.dir}/usr/local/sbin/losetup
          target: /usr/local/sbin/losetup
          uid: 0
          gid: 0
          mode: "0755"
        - source: /opt/docker/sbom/k8s-await-election
          target: /opt/docker/sbom/k8s-await-election
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/losetup-container
          target: /opt/docker/sbom/losetup-container
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/piraeus
          target: /opt/docker/sbom/piraeus
          uid: 0
          gid: 0
    - name: linstor-client
      uses: dhi.io/python:3.13.12-debian13-dev@sha256:e804df61d954e90edc605f29bfc89d22df071bd35709f42cc8d783b718c41b97
      contents:
        packages:
          - git
          - make
          - python3-setuptools
        files:
          - url: git+https://github.com/LINBIT/linstor-api-py.git#v1.27.1
            checksum: 578e45c998938a7696fe9258cd6b9e22a3941738
            path: ${source.dir}/linstor-api-py
            spdx:
              name: python-linstor
              version: 1.27.1
              packages:
                - name: python-linstor
                  purl: pkg:github/LINBIT/linstor-api-py@1.27.1
                  license: LGPL-3.0
            uid: 0
            gid: 0
          - url: git+https://github.com/LINBIT/linstor-client.git#v1.27.1
            checksum: 9c57f040eb3834500db508e4f04d361d006cb6b5
            path: ${source.dir}/linstor-client
            spdx:
              name: linstor-client
              version: 1.27.1
              packages:
                - name: linstor-client
                  purl: pkg:github/LINBIT/linstor-client@1.27.1
                  license: GPL-3.0
            uid: 0
            gid: 0
      pipeline:
        - name: initialize-python-linstor-submodules
          work-dir: ${source.dir}/linstor-api-py
          runs: |
            set -eux -o pipefail

            git submodule update --init --recursive
        - name: patch-python-linstor-for-python312
          work-dir: ${source.dir}/linstor-api-py
          runs: |
            set -eux -o pipefail

            # Replace distutils.version import with packaging.version
            sed -i 's/from distutils\.version import StrictVersion/from packaging.version import Version as StrictVersion/' linstor/linstorapi.py
        - name: build-python-linstor
          work-dir: ${source.dir}/linstor-api-py
          privileged: true
          runs: |
            set -eux -o pipefail

            # Install packaging for Python 3.12+ compatibility (distutils.version was removed)
            python3 -m pip install --no-cache-dir setuptools wheel packaging
            python3 setup.py build
        - name: install-python-linstor
          work-dir: ${source.dir}/linstor-api-py
          privileged: true
          runs: |
            set -eux -o pipefail

            PYTHON_SITE_PACKAGES=$(python3 -c "import site; print(site.getsitepackages()[0])")
            PYTHON_PREFIX=$(python3 -c "import sys; print(sys.prefix)")
            # Calculate site-packages path relative to prefix (strip prefix from absolute path)
            SITE_PACKAGES_RELATIVE="${PYTHON_SITE_PACKAGES#${PYTHON_PREFIX}/}"
            TEMP_INSTALL_DIR="/tmp/python-linstor-install"
            TEMP_SITE_PACKAGES="/tmp/python-site-packages"

            python3 setup.py install --prefix="${TEMP_INSTALL_DIR}" --root=/ --single-version-externally-managed

            mkdir -p "${TEMP_SITE_PACKAGES}"
            # When using --prefix, setup.py installs to ${PREFIX}/${SITE_PACKAGES_RELATIVE}
            # not ${PREFIX}${PYTHON_SITE_PACKAGES} (which would include the prefix twice)
            INSTALL_PATH="${TEMP_INSTALL_DIR}/${SITE_PACKAGES_RELATIVE}/linstor"
            INSTALL_SITE_PACKAGES="${TEMP_INSTALL_DIR}/${SITE_PACKAGES_RELATIVE}"
            cp -r "${INSTALL_PATH}" "${TEMP_SITE_PACKAGES}/"

            # Copy egg-info files from install directory to temp site packages
            # Copy python-linstor egg-info (uses python_linstor pattern with underscore)
            cp -r "${INSTALL_SITE_PACKAGES}"/python_linstor*.egg-info "${TEMP_SITE_PACKAGES}/"

            export PYTHONPATH="${TEMP_SITE_PACKAGES}${PYTHONPATH:+:${PYTHONPATH}}"
            # Install setuptools and packaging for Python 3.12+ compatibility
            python3 -m pip install --no-cache-dir --target "${TEMP_SITE_PACKAGES}" setuptools packaging
        - name: build-linstor-client
          work-dir: ${source.dir}/linstor-client
          privileged: true
          runs: |
            set -eux -o pipefail

            python3 -m pip install --no-cache-dir setuptools wheel
            TEMP_SITE_PACKAGES="/tmp/python-site-packages"
            export PYTHONPATH="${TEMP_SITE_PACKAGES}${PYTHONPATH:+:${PYTHONPATH}}"
            python3 setup.py build
        - name: install-linstor-components
          runs: |
            set -eux -o pipefail

            PYTHON_SITE_PACKAGES=$(python3 -c "import site; print(site.getsitepackages()[0])")
            PYTHON_PREFIX=$(python3 -c "import sys; print(sys.prefix)")
            PYTHON_BIN_DIR=$(python3 -c "import sys; print(sys.prefix + '/bin')")
            # Calculate site-packages path relative to prefix (strip prefix from absolute path)
            SITE_PACKAGES_RELATIVE="${PYTHON_SITE_PACKAGES#${PYTHON_PREFIX}/}"
            TEMP_CLIENT_INSTALL_DIR="/tmp/linstor-client-install"
            TEMP_SITE_PACKAGES="/tmp/python-site-packages"
            STAGING_DIR="/tmp/staging-python-packages"
            PYTHON_PACKAGES_DIR="${target.dir}/python-packages-site-packages"

            export PYTHONPATH="${PYTHON_SITE_PACKAGES}${PYTHONPATH:+:${PYTHONPATH}}"

            cd ${source.dir}/linstor-client
            python3 setup.py install --prefix="${TEMP_CLIENT_INSTALL_DIR}" --root=/ --single-version-externally-managed

            mkdir -p "${target.dir}/usr/bin"
            mkdir -p "${STAGING_DIR}"
            mkdir -p "${PYTHON_PACKAGES_DIR}"

            cp -r "${TEMP_SITE_PACKAGES}/linstor" "${STAGING_DIR}/"

            # Copy python-linstor egg-info from temp site packages to staging
            cp -r "${TEMP_SITE_PACKAGES}"/python_linstor*.egg-info "${STAGING_DIR}/"

            cp -r "${TEMP_SITE_PACKAGES}/setuptools" "${STAGING_DIR}/"

            # Copy packaging module for Python 3.12+ compatibility (distutils.version was removed)
            cp -r "${TEMP_SITE_PACKAGES}/packaging" "${STAGING_DIR}/"

            # When using --prefix, setup.py installs to ${PREFIX}/${SITE_PACKAGES_RELATIVE}
            # not ${PREFIX}${PYTHON_SITE_PACKAGES} (which would include the prefix twice)
            CLIENT_INSTALL_PATH="${TEMP_CLIENT_INSTALL_DIR}/${SITE_PACKAGES_RELATIVE}/linstor_client"
            CLIENT_MAIN_PY_PATH="${TEMP_CLIENT_INSTALL_DIR}/${SITE_PACKAGES_RELATIVE}/linstor_client_main.py"
            CLIENT_INSTALL_SITE_PACKAGES="${TEMP_CLIENT_INSTALL_DIR}/${SITE_PACKAGES_RELATIVE}"

            cp -r "${CLIENT_INSTALL_PATH}" "${STAGING_DIR}/"

            cp "${CLIENT_MAIN_PY_PATH}" "${STAGING_DIR}/"

            # Copy linstor-client egg-info
            cp -r "${CLIENT_INSTALL_SITE_PACKAGES}"/linstor_client*.egg-info "${STAGING_DIR}/"

            cp -r "${STAGING_DIR}"/* "${PYTHON_PACKAGES_DIR}/"

            # When using --prefix, setup.py installs scripts to ${PREFIX}/bin (relative to prefix)
            # not ${PREFIX}${PYTHON_BIN_DIR} (which would include the prefix twice)
            PYTHON_BIN_RELATIVE="${PYTHON_BIN_DIR#${PYTHON_PREFIX}/}"
            LINSTOR_SCRIPT_PATH="${TEMP_CLIENT_INSTALL_DIR}/${PYTHON_BIN_RELATIVE}/linstor"
            cp "${LINSTOR_SCRIPT_PATH}" "${target.dir}/usr/bin/linstor"
      outputs:
        - source: ${target.dir}/usr/bin/linstor
          target: /usr/bin/linstor
          uid: 0
          gid: 0
          mode: "0755"
        - source: ${target.dir}/python-packages-site-packages/linstor_client
          target: /opt/python-3.13.12/lib/python3.13/site-packages/linstor_client
          uid: 0
          gid: 0
        - source: ${target.dir}/python-packages-site-packages/linstor_client_main.py
          target: /opt/python-3.13.12/lib/python3.13/site-packages/linstor_client_main.py
          uid: 0
          gid: 0
        - source: ${target.dir}/python-packages-site-packages/linstor
          target: /opt/python-3.13.12/lib/python3.13/site-packages/linstor
          uid: 0
          gid: 0
        - source: ${target.dir}/python-packages-site-packages/python_linstor*.egg-info
          target: /opt/python-3.13.12/lib/python3.13/site-packages
          uid: 0
          gid: 0
        - source: ${target.dir}/python-packages-site-packages/setuptools
          target: /opt/python-3.13.12/lib/python3.13/site-packages/setuptools
          uid: 0
          gid: 0
        - source: ${target.dir}/python-packages-site-packages/packaging
          target: /opt/python-3.13.12/lib/python3.13/site-packages/packaging
          uid: 0
          gid: 0
        - source: ${target.dir}/python-packages-site-packages/linstor_client*.egg-info
          target: /opt/python-3.13.12/lib/python3.13/site-packages
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/linstor-client
          target: /opt/docker/sbom/linstor-client
          uid: 0
          gid: 0
    - name: linstor-server
      uses: dhi.io/gradle:8.14.4-jdk17-debian13-dev@sha256:64824bb4e0a25d33315c444f0face92efdccefb3b5391bbd222939b91537f81d
      contents:
        packages:
          - git
          - protobuf-compiler
          - unzip
          - make
          - python3
          - jq
          - grep
        files:
          - url: git+https://github.com/LINBIT/linstor-server.git#v1.33.1
            checksum: 95da7940d6efb6a39ea303c5f37b03478a6fab0b
            path: ${source.dir}/linstor-server
            spdx:
              name: linstor-server
              version: 1.33.1
              packages:
                - name: linstor-server
                  purl: pkg:github/LINBIT/linstor-server@1.33.1
                  license: GPL-2.0
            uid: 0
            gid: 0
          - url: https://github.com/protocolbuffers/protobuf/releases/download/v31.1/protoc-31.1-linux-${PROTOC_ARCH}.zip
            checksum: ${PROTOC_CHECKSUM}
            path: ${source.dir}/protoc-31.1-linux-${PROTOC_ARCH}.zip
            spdx:
              name: protoc
              version: "31.1"
              packages:
                - name: protoc
                  purl: pkg:github/protocolbuffers/protobuf@31.1
                  license: BSD-3-Clause
            uid: 0
            gid: 0
      pipeline:
        - name: initialize submodules
          work-dir: ${source.dir}/linstor-server
          runs: |
            set -eux -o pipefail

            git config --global user.email "build@dhi.io" || true
            git config --global user.name "DHI Build" || true
            git fetch --tags --unshallow 2> /dev/null || git fetch --tags || true
            git submodule init
            git submodule update
        - name: upgrade vulnerable dependencies
          work-dir: ${source.dir}/linstor-server
          runs: |
            set -eux -o pipefail

            SCRIPT_DIR="${source.dir}/scripts"
            PATCH_DIR="${source.dir}/patch"
            SED_BUMP_SCRIPT="${SCRIPT_DIR}/sed_bump.sh"

            # Bump build.gradle dependencies
            BUMPS_FILE="${PATCH_DIR}/dependency_bumps_build.gradle.json"
            export DHI_WITH_FILE="./build.gradle"
            export DHI_WITH_BUMPS="$BUMPS_FILE"
            "$SED_BUMP_SCRIPT"

            # Bump gradle.lockfile dependencies
            BUMPS_FILE="${PATCH_DIR}/dependency_bumps_gradle.lockfile.json"
            export DHI_WITH_FILE="./gradle.lockfile"
            export DHI_WITH_BUMPS="$BUMPS_FILE"
            "$SED_BUMP_SCRIPT"
        - name: build LINSTOR
          work-dir: ${source.dir}/linstor-server
          privileged: true
          runs: |
            set -eux -o pipefail

            # Use our gradle installation directly instead of gradlew to avoid wrapper downloading its own version
            export GRADLE_HOME="/opt/java/gradle/gradle-8.14.4"
            export PATH="${GRADLE_HOME}/bin:${PATH}"

            # Install protoc with correct architecture (downloaded via files: block)
            # The upstream gradle getProtoc task hardcodes linux-x86_64, which fails on arm64
            PROTOC_DIR="tools/protoc-31.1"
            mkdir -p "${PROTOC_DIR}"
            unzip -o "${source.dir}/protoc-31.1-linux-${PROTOC_ARCH}.zip" -d "${PROTOC_DIR}"
            chmod +x "${PROTOC_DIR}/bin/protoc"

            # Verify protoc works on this architecture
            "${PROTOC_DIR}/bin/protoc" --version

            gradle install --no-daemon -x test -PversionOverride=v1.33.1
        - name: install LINSTOR artifacts
          work-dir: ${source.dir}/linstor-server
          runs: |
            set -eux -o pipefail

            mkdir -p "${target.dir}/usr/share/linstor-server/lib"
            mkdir -p "${target.dir}/usr/share/linstor-server/bin"

            # Copy controller libraries
            cp -r controller/build/install/controller/lib/* "${target.dir}/usr/share/linstor-server/lib/"

            # Copy satellite JAR
            cp satellite/build/install/satellite/lib/satellite*.jar "${target.dir}/usr/share/linstor-server/lib/"

            # Copy wrapper scripts
            cp controller/build/install/controller/bin/Controller "${target.dir}/usr/share/linstor-server/bin/Controller"
            cp satellite/build/install/satellite/bin/Satellite "${target.dir}/usr/share/linstor-server/bin/Satellite"
            mkdir -p "${target.dir}/usr/share/linstor-server/lib/conf"
      paths:
        - type: file
          path: ${source.dir}/scripts/sed_bump.sh
          uid: 0
          gid: 0
          mode: "0755"
          source: image/piraeus-server/scripts/sed_bump.sh
        - type: file
          path: ${source.dir}/patch/dependency_bumps_build.gradle.json
          uid: 0
          gid: 0
          mode: "0644"
          source: image/piraeus-server/patch/dependency_bumps_build.gradle.json
        - type: file
          path: ${source.dir}/patch/dependency_bumps_gradle.lockfile.json
          uid: 0
          gid: 0
          mode: "0644"
          source: image/piraeus-server/patch/dependency_bumps_gradle.lockfile.json
      outputs:
        - source: ${target.dir}/usr/share/linstor-server/lib
          target: /usr/share/linstor-server/lib
          uid: 0
          gid: 0
        - source: ${target.dir}/usr/share/linstor-server/bin
          target: /usr/share/linstor-server/bin
          uid: 0
          gid: 0
          mode: "0755"
        - source: /opt/docker/sbom/linstor-server
          target: /opt/docker/sbom/linstor-server
          uid: 0
          gid: 0
    - name: locale
      uses: dhi.io/debian-base:trixie-debian13@sha256:9ef766670af4743904b0f992a26b525c6c914648b56ea597ec23452adcf1a95d
      contents:
        packages:
          - bash
          - locales
          - coreutils
          - gzip
      pipeline:
        - name: install locales
          runs: |
            set -eux -o pipefail

            ln -s /etc/locale.alias /usr/share/locale/locale.alias

            echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen
            locale-gen en_US.UTF-8
      outputs:
        - source: /usr/share/locale
          target: /usr/share/locale
          uid: 0
          gid: 0
        - source: /usr/lib/locale
          target: /usr/lib/locale
          uid: 0
          gid: 0
  artifacts:
    - name: dhi.io/eclipse-temurin:17.0.18.8-debian13@sha256:e86ccb5c8b66bf58cac5e2ca508ef711669fcc00e5508c90fc8e90ad352b64ec
      includes:
        - opt/**
        - usr/local/bin/**
      excludes:
        - usr/lib/ssl/certs
        - usr/lib/ssl/private
      uid: 0
      gid: 0
    - name: dhi.io/kubectl:1.34.3-debian13@sha256:50bf3325bce60c5e9fe1d392a191ed79567a4c17210c7d36f8708d04fe4d55f7
      includes:
        - opt/docker/sbom/kubectl
        - usr/local/bin/kubectl
      excludes:
        - usr/lib/ssl/certs
        - usr/lib/ssl/private
      uid: 0
      gid: 0
    - name: dhi.io/python:3.13.12-debian13@sha256:e3ce38c682400c9fd4872709d88f9dc4f4373cf097a72c10bd80eeecf1198338
      includes:
        - opt/docker/sbom/python
        - opt/python-3.13.12/**
        - usr/**
      excludes:
        - opt/python-3.13.12/lib/python3.13/site-packages/linstor
        - opt/python-3.13.12/lib/python3.13/site-packages/linstor_client
        - opt/python-3.13.12/lib/python3.13/site-packages/linstor_client_main.py
        - opt/python-3.13.12/lib/python3.13/site-packages/linstor_client*.egg-info
        - opt/python-3.13.12/lib/python3.13/site-packages/python_linstor*.egg-info
        - opt/python-3.13.12/lib/python3.13/site-packages/setuptools
        - usr/lib/ssl/certs
        - usr/lib/ssl/private
      uid: 0
      gid: 0
    - name: dhi.io/static:20250419-debian13@sha256:74fc43fa240887b8159970e434244039aab0c6efaaa9cf044004cdc22aa2a34d
      includes:
        - bin
        - etc
        - home
        - lib
        - lib64
        - opt
        - sbin
        - tmp
        - usr
        - var
      excludes:
        - etc/group
        - etc/os-release
        - etc/passwd
        - var/lib/dpkg/status
      uid: 0
      gid: 0
accounts:
  run-as: nonroot
  users:
    - name: nonroot
      uid: 65532
      gid: 65532
  groups:
    - name: nonroot
      gid: 65532
      members:
        - nonroot
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
work-dir: /
environment:
  JAVA_HOME: /opt/java/openjdk/17-jre
  LANG: en_US.UTF-8
  LANGUAGE: en_US:en
  LC_ALL: en_US.UTF-8
paths:
  - type: symlink
    path: /opt/python
    uid: 0
    gid: 0
    source: /opt/python-3.13.12
  - type: directory
    path: /var/log/linstor-controller
    uid: 65532
    gid: 65532
    mode: "0775"
  - type: directory
    path: /logs
    uid: 65532
    gid: 65532
    mode: "0775"
  - type: directory
    path: /var/lib/linstor.d
    uid: 65532
    gid: 65532
    mode: "0775"
  - type: directory
    path: /var/lib/linstor
    uid: 65532
    gid: 65532
    mode: "0775"
  - type: directory
    path: /etc/drbd.d
    uid: 65532
    gid: 65532
    mode: "0775"
  - type: file
    path: /etc/lvm/lvm.conf
    content: |
      activation {
          udev_sync = 0
          udev_rules = 0
          monitoring = 0
      }
      devices {
          global_filter = [ "r|^/dev/drbd|" ]
          obtain_device_list_from_udev = 0
      }
    uid: 65532
    gid: 65532
    mode: "0644"
  - type: file
    path: /etc/drbd.d/global_common.conf
    content: |
      global { usage-count no; }
    uid: 65532
    gid: 65532
    mode: "0644"
annotations:
  org.opencontainers.image.description: A minimal Piraeus Server image
  org.opencontainers.image.licenses: Apache-2.0
entrypoint:
  - /usr/bin/k8s-await-election
  - /usr/bin/piraeus-entry.sh
cmd:
  - startSatellite
ports:
  - 3366/tcp
  - 3367/tcp
  - 3370/tcp
  - 3371/tcp
  - 3376/tcp
  - 3377/tcp
