# syntax=dhi.io/build:2-debian13

name: Trino 479
image: dhi.io/trino
variant: runtime
tags:
  - "479"
  - 479-debian13
platforms:
  - linux/amd64
  - linux/arm64
dates:
  release: "2025-10-29"
vars:
  ARCH: '#{ target.arch == "amd64" ? "amd64" : "arm64" }'
  COMMIT_SHA: 1b3a3e39a657642b0c4f76a5439dae859f93b4b1
  DEBIAN_REFERENCE: dhi/debian-base:trixie-debian13@sha256:1244523a2f7b6c096c6f98ce0349df6798c775c57322c51f8a4982daf60c256c
  GO_REF: dhi/golang:1.25.7-debian13-dev@sha256:d241d31631f6bcfdef4f42f70083bb06d51e6401d9ce172a05b9ba37f27c2940
  JAVA_MAJOR_VERSION: "25"
  JAVA_VERSION: 25.0.2
  JDK_REF: dhi/eclipse-temurin:25.0.1-jdk-debian13-dev@sha256:79208312bdfd04cb8d73821c60a9b5225c2b9c1a42ee0e497c42d3a051615a9a
  JRE_REF: dhi/eclipse-temurin:25.0.2-debian13@sha256:567f0bf2eddd417122154795d508947793da71ea40262cd6de7be027f2c4c0f8
  JVM_KILL_COMMIT: 8a6ae95b38905f98ce6b7b727efb2dc75da16e11
  LAUNCHER_COMMIT_SHA: dba71d80b53f24ac930176ec6b4071ba4a4b9da1
  LAUNCHER_VERSION: "313"
  MAVEN_REF: dhi/maven:3.9.12-jdk25-debian13-dev@sha256:dace02fb67919d893ae11aac8bb70d499a00307da1e4d54e3bbed694c0374dd6
  MAVEN_VERSION: 3.9.12
  NODE_REF: dhi/node:22.22.0-debian13@sha256:929e379216af18f2998563acdacef4554897f30d19fdcc7ee25955c97f736c2e
  VERSION: "479"
contents:
  packages:
    - '!libelogind0'
    - '!mawk'
    - '!original-awk'
    - base-files
    - bash
    - coreutils
    - curl
    - grep
    - libstdc++6
  builds:
    - name: jvmkill
      uses: dhi.io/eclipse-temurin:25.0.1-jdk-debian13-dev@sha256:79208312bdfd04cb8d73821c60a9b5225c2b9c1a42ee0e497c42d3a051615a9a
      contents:
        packages:
          - gcc
          - libc6-dev
        files:
          - url: git+https://github.com/airlift/jvmkill.git#8a6ae95b38905f98ce6b7b727efb2dc75da16e11
            checksum: 8a6ae95b38905f98ce6b7b727efb2dc75da16e11
            path: ${source.dir}/jvmkill
            spdx:
              name: jvmkill
              packages:
                - name: jvmkill
                  purl: pkg:generic/airlift/jvmkill
                  license: Apache-2.0
            uid: 0
            gid: 0
      pipeline:
        - name: build jvmkill
          work-dir: ${source.dir}/jvmkill
          runs: |
            set -eux -o pipefail

            INCLUDE="-I${JAVA_HOME}/include -I${JAVA_HOME}/include/linux"
            CFLAGS="-Wall -Werror -fPIC -shared ${INCLUDE}"
            gcc ${CFLAGS} -o libjvmkill.so jvmkill.c
      outputs:
        - source: ${source.dir}/jvmkill/libjvmkill.so
          target: /usr/lib/trino/bin/libjvmkill.so
          uid: 1000
          gid: 1000
          mode: "0644"
        - source: /opt/docker/sbom/jvmkill
          target: /opt/docker/sbom/jvmkill
          uid: 0
          gid: 0
    - name: trino
      uses: dhi.io/golang:1.25.7-debian13-dev@sha256:d241d31631f6bcfdef4f42f70083bb06d51e6401d9ce172a05b9ba37f27c2940
      environment:
        JAVA_HOME: /opt/java/openjdk/25
      contents:
        packages:
          - gzip
        files:
          - url: git+https://github.com/trinodb/trino.git#479
            checksum: 1b3a3e39a657642b0c4f76a5439dae859f93b4b1
            path: ${source.dir}/trino
            spdx:
              name: trino
              version: "479"
              packages:
                - name: trino
                  purl: pkg:dhi/trino@479
                  license: Apache-2.0
            uid: 0
            gid: 0
          - url: git+https://github.com/airlift/launcher.git#313
            checksum: dba71d80b53f24ac930176ec6b4071ba4a4b9da1
            path: /go/src/github.com/airlift/launcher
            spdx:
              name: launcher
              version: "313"
              packages:
                - name: launcher
                  purl: pkg:golang/launcher@313
            uid: 0
            gid: 0
          - url: https://repo1.maven.org/maven2/at/yawk/lz4/lz4-java/1.10.1/lz4-java-1.10.1.jar
            path: ${source.dir}/patch/at.yawk.lz4.lz4-java-1.10.1.jar
            uid: 0
            gid: 0
        artifacts:
          - name: dhi.io/node:22.22.0-debian13@sha256:929e379216af18f2998563acdacef4554897f30d19fdcc7ee25955c97f736c2e
            includes:
              - opt/nodejs
              - usr/local/bin
            uid: 0
            gid: 0
          - name: dhi.io/eclipse-temurin:25.0.1-jdk-debian13-dev@sha256:79208312bdfd04cb8d73821c60a9b5225c2b9c1a42ee0e497c42d3a051615a9a
            includes:
              - opt/**
            uid: 0
            gid: 0
          - name: dhi.io/maven:3.9.12-jdk25-debian13-dev@sha256:dace02fb67919d893ae11aac8bb70d499a00307da1e4d54e3bbed694c0374dd6
            includes:
              - opt/**
              - usr/local/bin/**
            uid: 0
            gid: 0
      pipeline:
        - name: patch dependencies
          uses: patch@v1
          work-dir: ${source.dir}/trino
          with:
            options: -p1
            patches:
              - /src/patch/ch-guava-grpc.patch
              - /src/patch/lz4.patch
        - name: maven patch
          uses: mvn/patch@v1
          with:
            dependencies: ${source.dir}/patch/mvn-deps.json
            dependencies-key: dependencyManagement.dependencies
            downgrade: false
            mvn-root: ${source.dir}/trino
        - name: opensearch plugin - maven patch
          uses: mvn/patch@v1
          with:
            downgrade: false
            mvn-root: ${source.dir}/trino/plugin/trino-opensearch
            properties: ${source.dir}/patch/opensearch-mvn-properties.json
        - name: build
          work-dir: ${source.dir}/trino
          privileged: true
          runs: |
            set -eux -o pipefail

            ./mvnw sortpom:sort
            ./mvnw package -q -DskipTests -Dair.check.skip-all -Dmaven.enforcer.skip=true -Dmaven.test.failure.ignore=true \
              -pl '!:trino-docs' -am

            tar -C "${target.dir}" -xzf "${source.dir}/trino/core/trino-server/target/trino-server-479.tar.gz" --wildcards \
              "trino-server-479/lib" \
              "trino-server-479/plugin" \
              "trino-server-479/secrets-plugin" \
              "trino-server-479/bin/launcher*" \
              "trino-server-479/bin/linux-${ARCH}"
        - name: remove optional plugins
          work-dir: ${target.dir}/trino-server-479/plugin
          runs: |
            set -eux -o pipefail

            PLUGINS_TO_REMOVE=$(ls | jq -R -r -n --slurpfile allowlist ${source.dir}/patch/minimal-plugins.json '[inputs] - $allowlist[0] | .[]')

            echo "Removing all plugins that aren't in essential list..."

            for plugin_folder in $PLUGINS_TO_REMOVE; do
              rm -r "${plugin_folder}"
            done
        - name: patch launcher
          uses: go/bump@v1
          work-dir: /go/src/github.com/airlift/launcher/src/main/go
          with:
            deps: []
            download: true
        - name: build launcher
          uses: go/build@v1
          work-dir: /go/src/github.com/airlift/launcher/src/main/go
          with:
            ldflags:
              - -extldflags=-static
              - -X launcher/args.Version=313
            output: ${target.dir}/trino-server-479/bin/linux-${ARCH}/launcher
      paths:
        - type: file
          path: /src/patch/ch-guava-grpc.patch
          uid: 0
          gid: 0
          source: image/trino/patch/ch-guava-grpc.patch
        - type: file
          path: /src/patch/lz4.patch
          uid: 0
          gid: 0
          source: image/trino/patch/lz4.patch
        - type: file
          path: /src/patch/minimal-plugins.json
          uid: 0
          gid: 0
          source: image/trino/patch/minimal-plugins.json
        - type: file
          path: /src/patch/mvn-deps.json
          uid: 0
          gid: 0
          source: image/trino/patch/mvn-deps.json
        - type: file
          path: /src/patch/opensearch-mvn-properties.json
          uid: 0
          gid: 0
          source: image/trino/patch/opensearch-mvn-properties.json
      outputs:
        - source: ${source.dir}/trino/client/trino-cli/target/trino-cli-479-executable.jar
          target: /usr/bin/trino
          uid: 1000
          gid: 1000
        - source: ${target.dir}/trino-server-479
          target: /usr/lib/trino
          uid: 1000
          gid: 1000
        - source: ${source.dir}/trino/core/docker/bin
          target: /usr/lib/trino/bin
          uid: 1000
          gid: 1000
        - source: ${source.dir}/trino/core/docker/default/etc
          target: /etc/trino
          uid: 1000
          gid: 1000
        - source: /opt/docker/sbom/trino
          target: /opt/docker/sbom/trino
          uid: 0
          gid: 0
    - name: locale
      uses: dhi.io/debian-base:trixie-debian13@sha256:1244523a2f7b6c096c6f98ce0349df6798c775c57322c51f8a4982daf60c256c
      contents:
        packages:
          - bash
          - locales
          - coreutils
          - gzip
      pipeline:
        - name: install locales
          runs: |
            set -eux -o pipefail

            ln -s /etc/locale.alias /usr/share/locale/locale.alias

            echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen
            locale-gen en_US.UTF-8
      outputs:
        - source: /usr/share/locale
          target: /usr/share/locale
          uid: 0
          gid: 0
        - source: /usr/lib/locale
          target: /usr/lib/locale
          uid: 0
          gid: 0
  artifacts:
    - name: dhi.io/eclipse-temurin:25.0.2-debian13@sha256:567f0bf2eddd417122154795d508947793da71ea40262cd6de7be027f2c4c0f8
      includes:
        - opt/**
      uid: 0
      gid: 0
accounts:
  run-as: trino
  users:
    - name: trino
      uid: 1000
      gid: 1000
  groups:
    - name: trino
      gid: 1000
      members:
        - trino
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
environment:
  CATALOG_MANAGEMENT: static
  LANG: en_US.UTF-8
  LANGUAGE: en_US:en
  LC_ALL: en_US.UTF-8
  PATH: /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/opt/java/openjdk/25-jre/bin
paths:
  - type: directory
    path: /data/trino
    uid: 1000
    gid: 1000
annotations:
  org.opencontainers.image.description: A minimal Trino image
  org.opencontainers.image.licenses: Apache-2.0
cmd:
  - /usr/lib/trino/bin/run-trino
ports:
  - 8080/tcp
