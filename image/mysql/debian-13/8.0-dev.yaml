# syntax=dhi.io/build:2-debian13

name: MySQL 8.0.x (dev)
image: dhi.io/mysql
variant: dev
tags:
  - 8.0-dev
  - 8.0.45-dev
  - 8.0-debian13-dev
  - 8.0.45-debian13-dev
platforms:
  - linux/amd64
  - linux/arm64
dates:
  release: "2018-04-08"
  end-of-life: "2026-04-30"
vars:
  ARCH: '#{ target.arch == "amd64" ? "x86_64" : "aarch64" }'
  COMMIT_SHA: 666701570c392a6052341b6ddb9c21869bb1d733
  DEBIAN_EPOCH_MAJOR_MINOR_VERSION: "8.0"
  DEBIAN_EPOCH_MAJOR_VERSION: "8"
  DEBIAN_EPOCH_VERSION: 8.0.45
  GOSU_REFERENCE: dhi/pkg-gosu:1.19-debian13@sha256:21838cdbc7876e163da0f2bc4db1228cc32ebfd66284f4bbdc15ce06f40349e4
  GOSU_VERSION: "1.19"
  VERSION: 8.0.45
contents:
  packages:
    - '!gawk'
    - '!libelogind0'
    - '!mawk'
    - '!original-awk'
    - apt
    - base-files
    - bash
    - ca-certificates
    - coreutils
    - diffutils
    - dpkg
    - findutils
    - grep
    - libaio1t64
    - libc-bin
    - libncurses6
    - libnuma1
    - libstdc++6
    - mawk
    - perl-base
    - sed
    - util-linux
  builds:
    - name: mysql
      contents:
        packages:
          - bash
          - bison
          - build-essential
          - ca-certificates
          - cmake
          - coreutils
          - diffutils
          - gpg
          - gpg-agent
          - gzip
          - libaio-dev
          - libabsl-dev
          - libboost-all-dev
          - libncurses-dev
          - libssl-dev
          - libtirpc-dev
          - libc-bin
          - pkg-config
          - sed
          - tar
          - wget
          - xz-utils
          - zlib1g-dev
        files:
          - url: git+https://github.com/mysql/mysql-server#mysql-8.0.45
            checksum: 666701570c392a6052341b6ddb9c21869bb1d733
            path: ${source.dir}/mysql
            spdx:
              name: mysql
              version: 8.0.45
              packages:
                - name: mysql
                  purl: pkg:github/mysql/mysql-server@8.0.45
                  license: GPL-2.0-only
            uid: 0
            gid: 0
          - url: https://archives.boost.io/release/1.77.0/source/boost_1_77_0.tar.gz
            checksum: sha256:5347464af5b14ac54bb945dc68f1dd7c56f0dad7262816b956138fc53bcc0131
            path: ${source.dir}/boost
            spdx:
              name: boost
              version: 1.77.0
              packages:
                - name: boost
                  purl: pkg:github/boostorg/boost@1.77.0
                  license: BSL-1.0
            uid: 0
            gid: 0
      pipeline:
        - name: build
          work-dir: ${source.dir}/mysql
          runs: |
            set -eux -o pipefail

            mkdir build && cd build

            CMAKE_FLAGS="-DCMAKE_INSTALL_PREFIX=${target.dir}/opt/mysql
              -DWITH_DEBUG=OFF
              -DWITH_UNIT_TESTS=OFF
              -DWITH_ARCHIVE_STORAGE_ENGINE=OFF
              -DWITH_BLACKHOLE_STORAGE_ENGINE=OFF
              -DWITH_FEDERATED_STORAGE_ENGINE=OFF
              -DWITH_EXAMPLE_STORAGE_ENGINE=OFF
              -DWITH_NDBCLUSTER_STORAGE_ENGINE=OFF
              -DWITH_ROUTER=OFF
              -DINSTALL_MYSQLTESTDIR=
              -DWITH_NDB=OFF"

            # This is not an in later versions of Mysql
            if [ "8.0" = "8.0" ]; then
              CMAKE_FLAGS="${CMAKE_FLAGS} -DWITH_BOOST=${source.dir}/boost"
            fi

            cmake .. $CMAKE_FLAGS

            make -j"$(nproc)"

            make install
      outputs:
        - source: ${target.dir}/opt/mysql
          target: /opt/mysql
          uid: 65532
          gid: 65532
        - source: /opt/docker/sbom/mysql
          target: /opt/docker/sbom/mysql
          uid: 0
          gid: 0
  artifacts:
    - name: dhi.io/pkg-gosu:1.19-debian13@sha256:21838cdbc7876e163da0f2bc4db1228cc32ebfd66284f4bbdc15ce06f40349e4
      includes:
        - opt/docker/sbom/gosu
        - usr/local/sbin/gosu
      uid: 0
      gid: 0
accounts:
  root: true
  run-as: root
  users:
    - name: mysql
      uid: 65532
      gid: 65532
    - name: _apt
      uid: 42
      gid: 65532
  groups:
    - name: mysql
      gid: 65532
      members:
        - mysql
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
environment:
  DEBIAN_FRONTEND: noninteractive
  MYSQLDATA: /var/lib/mysql
  PATH: /opt/mysql/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
paths:
  - type: directory
    path: /var/lib/mysql-files
    uid: 65532
    gid: 65532
    mode: "0755"
  - type: directory
    path: /var/lib/mysql
    uid: 65532
    gid: 65532
    mode: "0755"
  - type: directory
    path: /var/run/mysqld
    uid: 65532
    gid: 65532
    mode: "0755"
  - type: directory
    path: /var/lib/data/
    uid: 65532
    gid: 65532
    mode: "0755"
  - type: file
    path: /usr/local/bin/docker-entrypoint.sh
    uid: 0
    gid: 0
    mode: "0755"
    source: image/mysql/bin/docker-entrypoint.sh
  - type: symlink
    path: /usr/lib/${ARCH}-linux-gnu/libaio.so.1
    uid: 0
    gid: 0
    source: libaio.so.1t64
annotations:
  org.opencontainers.image.description: A minimal MySQL image
  org.opencontainers.image.licenses: GPL-2.0-only
entrypoint:
  - /usr/local/bin/docker-entrypoint.sh
cmd:
  - mysqld
ports:
  - 3306/tcp
  - 33060/tcp
