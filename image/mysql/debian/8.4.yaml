# syntax=dhi.io/build:2-debian13

name: MySQL 8.4.x
image: dhi.io/mysql
variant: runtime
tags:
  - "8.4"
  - lts
  - 8.4.7
  - 8.4-debian13
  - lts-debian13
  - 8.4.7-debian13
platforms:
  - linux/amd64
  - linux/arm64
dates:
  release: "2024-04-10"
  end-of-life: "2032-04-30"
vars:
  ARCH: '#{ target.arch == "amd64" ? "x86_64" : "aarch64" }'
  COMMIT_SHA: aa461240270d809bcac336483b886b3d1789d4d9
  DEBIAN_EPOCH_MAJOR_MINOR_VERSION: "8.4"
  DEBIAN_EPOCH_MAJOR_VERSION: "8"
  DEBIAN_EPOCH_VERSION: 8.4.7
  VERSION: 8.4.7
contents:
  packages:
    - '!libelogind0'
    - '!mawk'
    - '!original-awk'
    - base-files
    - bash
    - coreutils
    - findutils
    - libaio1t64
    - libncurses6
    - libnuma1
    - libstdc++6
  builds:
    - name: mysql
      contents:
        packages:
          - bash
          - bison
          - build-essential
          - ca-certificates
          - cmake
          - coreutils
          - diffutils
          - gpg
          - gpg-agent
          - gzip
          - libaio-dev
          - libabsl-dev
          - libboost-all-dev
          - libncurses-dev
          - libssl-dev
          - libtirpc-dev
          - libc-bin
          - pkg-config
          - sed
          - tar
          - wget
          - xz-utils
          - zlib1g-dev
        files:
          - url: git+https://github.com/mysql/mysql-server#mysql-8.4.7
            checksum: aa461240270d809bcac336483b886b3d1789d4d9
            path: ${source.dir}/mysql
            spdx:
              name: mysql
              version: 8.4.7
              packages:
                - name: mysql
                  purl: pkg:github/mysql/mysql-server@8.4.7
                  license: GPL-2.0-only
            uid: 0
            gid: 0
      pipeline:
        - name: build
          work-dir: ${source.dir}/mysql
          runs: |
            set -eux -o pipefail

            mkdir build && cd build

            CMAKE_FLAGS="-DCMAKE_INSTALL_PREFIX=${target.dir}/opt/mysql
              -DWITH_DEBUG=OFF
              -DWITH_UNIT_TESTS=OFF
              -DWITH_ARCHIVE_STORAGE_ENGINE=OFF
              -DWITH_BLACKHOLE_STORAGE_ENGINE=OFF
              -DWITH_FEDERATED_STORAGE_ENGINE=OFF
              -DWITH_EXAMPLE_STORAGE_ENGINE=OFF
              -DWITH_NDBCLUSTER_STORAGE_ENGINE=OFF
              -DWITH_ROUTER=OFF
              -DINSTALL_MYSQLTESTDIR=
              -DWITH_NDB=OFF"

            # This is not an in later versions of Mysql
            if [ "8.4" = "8.0" ]; then
              CMAKE_FLAGS="${CMAKE_FLAGS} -DWITH_BOOST=${source.dir}/boost"
            fi

            cmake .. $CMAKE_FLAGS

            make -j"$(nproc)"

            make install
        - name: strip
          uses: strip@v1
          with:
            dir: ${target.dir}/opt/mysql/bin
      outputs:
        - source: ${target.dir}/opt/mysql
          target: /opt/mysql
          uid: 65532
          gid: 65532
        - source: /opt/docker/sbom/mysql
          target: /opt/docker/sbom/mysql
          uid: 0
          gid: 0
accounts:
  run-as: mysql
  users:
    - name: mysql
      uid: 65532
      gid: 65532
  groups:
    - name: mysql
      gid: 65532
      members:
        - mysql
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
environment:
  MYSQLDATA: /var/lib/mysql
  PATH: /opt/mysql/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
paths:
  - type: directory
    path: /var/lib/mysql-files
    uid: 65532
    gid: 65532
    mode: "0755"
  - type: directory
    path: /var/lib/mysql
    uid: 65532
    gid: 65532
    mode: "0755"
  - type: directory
    path: /var/run/mysqld
    uid: 65532
    gid: 65532
    mode: "0755"
  - type: directory
    path: /var/lib/data/
    uid: 65532
    gid: 65532
    mode: "0755"
  - type: file
    path: /usr/local/bin/docker-entrypoint.sh
    uid: 0
    gid: 0
    mode: "0755"
    source: image/mysql/bin/docker-entrypoint.sh
  - type: symlink
    path: /usr/lib/${ARCH}-linux-gnu/libaio.so.1
    uid: 0
    gid: 0
    source: libaio.so.1t64
annotations:
  org.opencontainers.image.description: A minimal MySQL image
  org.opencontainers.image.licenses: GPL-2.0-only
entrypoint:
  - /usr/local/bin/docker-entrypoint.sh
cmd:
  - mysqld
ports:
  - 3306/tcp
  - 33060/tcp
