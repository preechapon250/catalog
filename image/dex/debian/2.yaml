# syntax=dhi.io/build:1-debian13

name: Dex 2.x
image: dhi.io/dex
variant: runtime
tags:
  - "2"
  - "2.44"
  - 2.44.0
  - 2-debian13
  - 2.44-debian13
  - 2.44.0-debian13
platforms:
  - linux/amd64
  - linux/arm64
vars:
  BASE_DIGEST: sha256:d46a757d9ec2c6f6d9b7c4cdcfdb9bc65c9614c53ee28e0f489ed844fd2b79c8
  BASE_TAG: 20250419-glibc-debian13
  COMMIT_SHA: 2dce75009acfcd9df77d57f2d144aae999a4c569
  GO_DIGEST: sha256:a45faad20adc1286eef26b1f30e170b54791c217ce69457784de66b0a13d1fe6
  GO_TAG: 1.25.5-debian13-dev
  GO_VERSION: 1.25.5
  GOMPLATE_COMMIT_SHA: 3e4035cbb6f85df1a98dc9636fd4927a0b5ac00e
  GOMPLATE_VERSION: 4.3.3
  SEMVER_MAJOR_MINOR_VERSION: "2.44"
  SEMVER_MAJOR_VERSION: "2"
  SEMVER_VERSION: 2.44.0
  VERSION: 2.44.0
contents:
  packages:
    - '!base-files'
    - '!gcc-14-base'
    - '!libc6'
    - '!libgcc-s1'
    - libsqlite3-0
  builds:
    - name: gomplate
      uses: dhi.io/golang:1.25.5-debian13-dev@sha256:a45faad20adc1286eef26b1f30e170b54791c217ce69457784de66b0a13d1fe6
      privileged: true
      contents:
        files:
          - url: git+https://github.com/hairyhenderson/gomplate.git#v4.3.3
            path: /go/src/github.com/hairyhenderson/gomplate
            spdx:
              name: gomplate
              version: 4.3.3
              packages:
                - name: gomplate
                  purl: pkg:golang/github.com/hairyhenderson/gomplate@4.3.3
                  license: MIT
            uid: 0
            gid: 0
      pipeline:
        - name: verify
          uses: git/checkout@v1
          with:
            dir: /go/src/github.com/hairyhenderson/gomplate
            expected-commit: 3e4035cbb6f85df1a98dc9636fd4927a0b5ac00e
        - name: update go dependencies
          uses: go/bump@v1
          with:
            deps:
              - golang.org/x/crypto@v0.45.0
            dir: /go/src/github.com/hairyhenderson/gomplate
            download: true
        - name: build
          work-dir: /go/src/github.com/hairyhenderson/gomplate
          runs: |
            set -eux -o pipefail

            GOLDFLAGS="-X github.com/hairyhenderson/gomplate/v4/version.GitCommit=3e4035cbb6f85df1a98dc9636fd4927a0b5ac00e
                        -X github.com/hairyhenderson/gomplate/v4/version.Version=4.3.3"

            CGO_ENABLED=0 go build \
              -ldflags="$GOLDFLAGS" \
              -o "${target.dir}/usr/local/bin/gomplate" \
              ./cmd/gomplate
      outputs:
        - source: ${target.dir}/usr/local/bin/gomplate
          target: /usr/local/bin/gomplate
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/gomplate
          target: /opt/docker/sbom/gomplate
          uid: 0
          gid: 0
    - name: dex
      uses: dhi.io/golang:1.25.5-debian13-dev@sha256:a45faad20adc1286eef26b1f30e170b54791c217ce69457784de66b0a13d1fe6
      privileged: true
      contents:
        packages:
          - libsqlite3-dev
        files:
          - url: git+https://github.com/dexidp/dex.git#v2.44.0
            path: /go/src/github.com/dexidp/dex
            spdx:
              name: dex
              version: 2.44.0
              packages:
                - name: dex
                  purl: pkg:golang/github.com/dexidp/dex@2.44.0
                  license: Apache-2.0
            uid: 0
            gid: 0
      pipeline:
        - name: verify
          uses: git/checkout@v1
          with:
            dir: /go/src/github.com/dexidp/dex
            expected-commit: 2dce75009acfcd9df77d57f2d144aae999a4c569
        - name: update go dependencies
          uses: go/bump@v1
          with:
            deps:
              - golang.org/x/crypto@v0.45.0
            dir: /go/src/github.com/dexidp/dex
            download: true
        - name: build
          work-dir: /go/src/github.com/dexidp/dex
          runs: |
            set -eux -o pipefail

            GOLDFLAGS="-X main.version=2.44.0"

            # CGO_ENABLED=1 for go-sqlite3
            # The libsqlite3 tag causes go-sqlite3 to be linked against the system libsqlite3, which is desirable because:
            #   - We trust the debian version of sqlite
            #   - The debian sqlite will automatically get included in the SBOM correctly
            CGO_ENABLED=1 go build \
              -tags="libsqlite3" \
              -ldflags="$GOLDFLAGS" \
              -o "${target.dir}/usr/local/bin/dex" \
              ./cmd/dex

            CGO_ENABLED=0 go build \
              -o "${target.dir}/usr/local/bin/docker-entrypoint" \
              ./cmd/docker-entrypoint
        - name: install static files
          runs: |
            set -eux -o pipefail

            install -D -m 0644 /go/src/github.com/dexidp/dex/config.docker.yaml '${target.dir}/etc/dex/config.docker.yaml'

            mkdir -p '${target.dir}/srv/dex'
            cp -r /go/src/github.com/dexidp/dex/web '${target.dir}/srv/dex/'
      outputs:
        - source: ${target.dir}/etc/dex
          target: /etc/dex
          uid: 0
          gid: 0
        - source: ${target.dir}/srv/dex/web
          target: /srv/dex/web
          uid: 0
          gid: 0
        - source: ${target.dir}/usr/local/bin/dex
          target: /usr/local/bin/dex
          uid: 0
          gid: 0
        - source: ${target.dir}/usr/local/bin/docker-entrypoint
          target: /usr/local/bin/docker-entrypoint
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/dex
          target: /opt/docker/sbom/dex
          uid: 0
          gid: 0
  artifacts:
    - name: dhi.io/static:20250419-glibc-debian13@sha256:d46a757d9ec2c6f6d9b7c4cdcfdb9bc65c9614c53ee28e0f489ed844fd2b79c8
      includes:
        - bin
        - etc
        - home
        - lib
        - lib64
        - opt
        - sbin
        - tmp
        - usr
        - var
      excludes:
        - etc/group
        - etc/os-release
        - etc/passwd
        - var/lib/dpkg/status
      uid: 0
      gid: 0
accounts:
  run-as: nonroot
  users:
    - name: nonroot
      uid: 65532
      gid: 65532
  groups:
    - name: nonroot
      gid: 65532
      members:
        - nonroot
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
paths:
  - type: directory
    path: /var/dex
    uid: 65532
    gid: 65532
  - type: directory
    path: /etc/dex
    uid: 0
    gid: 0
annotations:
  org.opencontainers.image.description: A minimal Dex image
  org.opencontainers.image.licenses: Apache-2.0
entrypoint:
  - docker-entrypoint
cmd:
  - dex
  - serve
  - /etc/dex/config.docker.yaml
ports:
  - 5556/tcp
  - 5558/tcp
tests:
  - name: Run testcontainers tests
    directory: image/dex/tests
    commands:
      - go test . -count=1 -v
    exit-code: 0
  - name: Run common testcontainers tests
    directory: test/go-testing/base
    commands:
      - go test . -count=1 -v
    exit-code: 0
