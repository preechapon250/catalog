# syntax=dhi.io/build:2-debian13

name: OpenSearch 3.x
image: dhi.io/opensearch
variant: runtime
tags:
  - "3"
  - "3.4"
  - 3.4.0
  - 3-debian13
  - 3.4-debian13
  - 3.4.0-debian13
platforms:
  - linux/amd64
  - linux/arm64
dates:
  release: "2025-05-06"
vars:
  ALERTING_COMMIT_SHA: aaa1033eb69d81bb6beee613827f5f60c80b7d73
  ALERTING_VERSION: 3.4.0.0
  ANOMALY_DETECTION_COMMIT_SHA: 5972db4c67102cdfdd2db305224fcd9a5bab3cdf
  ANOMALY_DETECTION_VERSION: 3.4.0.0
  ASYNCHRONOUS_SEARCH_COMMIT_SHA: 718d20c4a4880307b4e373cd81d353308e264497
  ASYNCHRONOUS_SEARCH_VERSION: 3.4.0.0
  BCFIPS_VERSION: 2.1.2
  BCPKIXFIPS_VERSION: 2.1.10
  BCRNGJENT_VERSION: 1.3.6
  BCTLSFIPS_VERSION: 2.1.22
  BCUTILFIPS_VERSION: 2.1.5
  COMMIT_SHA: 00336141f90b2456d7aa35e9052fd6baf7147423
  COMMON_UTILS_COMMIT_SHA: 87149f431206352c3636535e6c041e66fdb73a06
  COMMON_UTILS_VERSION: 3.4.0.0
  CROSS_CLUSTER_REPLICATION_COMMIT_SHA: 31ede6fac3e6b1993a890493bca7811b356bc77d
  CROSS_CLUSTER_REPLICATION_VERSION: 3.4.0.0
  CUSTOM_CODECS_COMMIT_SHA: 9380d8a247ca26f6f9e7403a76c50cb6e2c343e7
  CUSTOM_CODECS_VERSION: 3.4.0.0
  DEBIAN_REFERENCE: dhi/debian-base:trixie-debian13@sha256:1244523a2f7b6c096c6f98ce0349df6798c775c57322c51f8a4982daf60c256c
  FLOW_FRAMEWORK_COMMIT_SHA: 394946dbf9b405ad958c1011acd61d01566177a5
  FLOW_FRAMEWORK_VERSION: 3.4.0.0
  GEOSPATIAL_COMMIT_SHA: 5482b55fbeed67ed10c40b5bbe1275c59223c3ae
  GEOSPATIAL_VERSION: 3.4.0.0
  GRADLE_REF: dhi/gradle:8.14.3-jdk21-debian13-dev@sha256:eb8d725f32a98e1e2f2931bd7df2fd78b40a5356faf670133e6d87e2e4b77053
  GRADLE_VERSION: 8.14.3
  INDEX_MANAGEMENT_COMMIT_SHA: 198dd246b48097c40511fbb528d658a5c5751d7c
  INDEX_MANAGEMENT_VERSION: 3.4.0.0
  JOB_SCHEDULER_COMMIT_SHA: 2efb3da9bc5cb89e63aa56163ddc66129eb2743d
  JOB_SCHEDULER_VERSION: 3.4.0.0
  JRE_MAJOR_VERSION: "21"
  JRE_REF: dhi/eclipse-temurin:21.0.9.10-debian13@sha256:e0c3e71b08e1051e402957c08de745011f9f1209d27d1e9e8cab1fe6edf9a44b
  JRE_VERSION: 21.0.9.10
  K_NN_COMMIT_SHA: 88e369808a39669f8c0d0ff2f2aa2d1a487c6901
  K_NN_VERSION: 3.4.0.0
  ML_COMMONS_COMMIT_SHA: c05cebc4314b058f2d8117255d9d0270e50667e5
  ML_COMMONS_VERSION: 3.4.0.0
  NETTY_PATCH_VERSION: 4.2.8.Final
  NEURAL_SEARCH_COMMIT_SHA: 6923b994109b1a4f5c207d67937f3797196882a3
  NEURAL_SEARCH_VERSION: 3.4.0.0
  NOTIFICATIONS_COMMIT_SHA: b9dd1ea87ec9fcab12d01dac0c33c5c728779b88
  NOTIFICATIONS_CORE_COMMIT_SHA: b9dd1ea87ec9fcab12d01dac0c33c5c728779b88
  NOTIFICATIONS_VERSION: 3.4.0.0
  OBSERVABILITY_COMMIT_SHA: 56f73660e15246ec588d7d685725e4adda0f65f1
  OBSERVABILITY_VERSION: 3.4.0.0
  OPENSEARCH_BUILD_COMMIT_SHA: 9917c3edf20efcd4db8328b732a6cfc4673675ca
  OPENSEARCH_BUILD_VERSION: 3.4.0
  OPENSEARCH_LEARNING_TO_RANK_BASE_COMMIT_SHA: 3ce0630dc3cdf4b8569f35e768f5ca263b633a9b
  OPENSEARCH_LEARNING_TO_RANK_BASE_VERSION: 3.4.0.0
  OPENSEARCH_MAJOR_MINOR_VERSION: "3.4"
  OPENSEARCH_REMOTE_METADATA_SDK_COMMIT_SHA: c5e8503b3b3b7fdfc1b4a1d925351e11d0cd721c
  OPENSEARCH_REMOTE_METADATA_SDK_VERSION: 3.4.0.0
  OPENSEARCH_SYSTEM_TEMPLATES_COMMIT_SHA: b25869c9da42d0efdfdbe5d140b45863ab46b346
  OPENSEARCH_SYSTEM_TEMPLATES_VERSION: 3.4.0.0
  PERFORMANCE_ANALYZER_COMMIT_SHA: 380901ff664a72717abfe145db2ec2c78cd36826
  PERFORMANCE_ANALYZER_VERSION: 3.4.0.0
  QUERY_INSIGHTS_COMMIT_SHA: f04f4a52597fb736705e64955f18a117ed7ead66
  QUERY_INSIGHTS_VERSION: 3.4.0.0
  REPORTING_COMMIT_SHA: e5868ebda1dec29b222aa3954fd83f4ef89f4387
  REPORTING_VERSION: 3.4.0.0
  SEARCH_RELEVANCE_COMMIT_SHA: 1ae04bfe3e07847990e0689d9d6a60cff813f480
  SEARCH_RELEVANCE_VERSION: 3.4.0.0
  SECURITY_ANALYTICS_COMMIT_SHA: c9e7457eacbed2082f349e53b42ac8fcf4d56442
  SECURITY_ANALYTICS_VERSION: 3.4.0.0
  SECURITY_COMMIT_SHA: b4293103b1c53d96e0e2bf40ec56a0468e3fdc8e
  SECURITY_VERSION: 3.4.0.0
  SEMVER_MAJOR_MINOR_VERSION: "3.4"
  SEMVER_MAJOR_VERSION: "3"
  SEMVER_VERSION: 3.4.0
  SKILLS_COMMIT_SHA: 309c481eacde99ace02f28a870b631a57b0f3de3
  SKILLS_VERSION: 3.4.0.0
  SQL_COMMIT_SHA: 52fe8aa5bd19e8008e4c11bcbd2ea69946b5724e
  SQL_VERSION: 3.4.0.0
  USER_BEHAVIOR_INSIGHTS_COMMIT_SHA: 4e4fe30a97515bbde311c3902e68ab52172375f0
  USER_BEHAVIOR_INSIGHTS_VERSION: 3.4.0.0
  VERSION: 3.4.0
contents:
  packages:
    - '!libelogind0'
    - '!mawk'
    - '!original-awk'
    - base-files
    - bash
    - ca-certificates
    - coreutils
    - findutils
    - grep
    - libstdc++6
  builds:
    - name: opensearch from source
      uses: dhi.io/gradle:8.14.3-jdk21-debian13-dev@sha256:eb8d725f32a98e1e2f2931bd7df2fd78b40a5356faf670133e6d87e2e4b77053
      environment:
        CI: "true"
        GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx2g -XX:MaxMetaspaceSize=512m"
      contents:
        packages:
          - bash
          - coreutils
          - findutils
          - git
          - grep
          - gzip
          - sed
          - tar
          - unzip
          - xz-utils
          - zip
        files:
          - url: git+https://github.com/opensearch-project/OpenSearch.git#3.4.0
            checksum: 00336141f90b2456d7aa35e9052fd6baf7147423
            path: ${source.dir}/OpenSearch
            spdx:
              name: opensearch
              version: 3.4.0
              packages:
                - name: opensearch
                  purl: pkg:dhi/opensearch@3.4.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/common-utils.git#3.4.0.0
            checksum: 87149f431206352c3636535e6c041e66fdb73a06
            path: ${source.dir}/common-utils
            spdx:
              name: opensearch-common-utils
              version: 3.4.0.0
              packages:
                - name: opensearch-common-utils
                  purl: pkg:dhi/opensearch-common-utils@3.4.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/opensearch-remote-metadata-sdk.git#3.4.0.0
            checksum: c5e8503b3b3b7fdfc1b4a1d925351e11d0cd721c
            path: ${source.dir}/opensearch-remote-metadata-sdk
            spdx:
              name: opensearch-remote-metadata-sdk
              version: 3.4.0.0
              packages:
                - name: opensearch-remote-metadata-sdk
                  purl: pkg:dhi/opensearch-remote-metadata-sdk@3.4.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/alerting.git#3.4.0.0
            checksum: aaa1033eb69d81bb6beee613827f5f60c80b7d73
            path: ${source.dir}/alerting
            spdx:
              name: opensearch-alerting
              version: 3.4.0.0
              packages:
                - name: opensearch-alerting
                  purl: pkg:dhi/opensearch-alerting@3.4.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/anomaly-detection.git#3.4.0.0
            checksum: 5972db4c67102cdfdd2db305224fcd9a5bab3cdf
            path: ${source.dir}/anomaly-detection
            spdx:
              name: opensearch-anomaly-detection
              version: 3.4.0.0
              packages:
                - name: opensearch-anomaly-detection
                  purl: pkg:dhi/opensearch-anomaly-detection@3.4.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/asynchronous-search.git#3.4.0.0
            checksum: 718d20c4a4880307b4e373cd81d353308e264497
            path: ${source.dir}/asynchronous-search
            spdx:
              name: opensearch-asynchronous-search
              version: 3.4.0.0
              packages:
                - name: opensearch-asynchronous-search
                  purl: pkg:dhi/opensearch-asynchronous-search@3.4.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/custom-codecs.git#3.4.0.0
            checksum: 9380d8a247ca26f6f9e7403a76c50cb6e2c343e7
            path: ${source.dir}/custom-codecs
            spdx:
              name: opensearch-custom-codecs
              version: 3.4.0.0
              packages:
                - name: opensearch-custom-codecs
                  purl: pkg:dhi/opensearch-custom-codecs@3.4.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/cross-cluster-replication.git#3.4.0.0
            checksum: 31ede6fac3e6b1993a890493bca7811b356bc77d
            path: ${source.dir}/cross-cluster-replication
            spdx:
              name: opensearch-cross-cluster-replication
              version: 3.4.0.0
              packages:
                - name: opensearch-cross-cluster-replication
                  purl: pkg:dhi/opensearch-cross-cluster-replication@3.4.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/flow-framework.git#3.4.0.0
            checksum: 394946dbf9b405ad958c1011acd61d01566177a5
            path: ${source.dir}/flow-framework
            spdx:
              name: opensearch-flow-framework
              version: 3.4.0.0
              packages:
                - name: opensearch-flow-framework
                  purl: pkg:dhi/opensearch-flow-framework@3.4.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/geospatial.git#3.4.0.0
            checksum: 5482b55fbeed67ed10c40b5bbe1275c59223c3ae
            path: ${source.dir}/geospatial
            spdx:
              name: opensearch-geospatial
              version: 3.4.0.0
              packages:
                - name: opensearch-geospatial
                  purl: pkg:dhi/opensearch-geospatial@3.4.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/index-management.git#3.4.0.0
            checksum: 198dd246b48097c40511fbb528d658a5c5751d7c
            path: ${source.dir}/index-management
            spdx:
              name: opensearch-index-management
              version: 3.4.0.0
              packages:
                - name: opensearch-index-management
                  purl: pkg:dhi/opensearch-index-management@3.4.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/job-scheduler.git#3.4.0.0
            checksum: 2efb3da9bc5cb89e63aa56163ddc66129eb2743d
            path: ${source.dir}/job-scheduler
            spdx:
              name: opensearch-job-scheduler
              version: 3.4.0.0
              packages:
                - name: opensearch-job-scheduler
                  purl: pkg:dhi/opensearch-job-scheduler@3.4.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/k-NN.git#3.4.0.0
            checksum: 88e369808a39669f8c0d0ff2f2aa2d1a487c6901
            path: ${source.dir}/k-NN
            spdx:
              name: opensearch-knn
              version: 3.4.0.0
              packages:
                - name: opensearch-knn
                  purl: pkg:dhi/opensearch-knn@3.4.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/ml-commons.git#3.4.0.0
            checksum: c05cebc4314b058f2d8117255d9d0270e50667e5
            path: ${source.dir}/ml-commons
            spdx:
              name: opensearch-ml
              version: 3.4.0.0
              packages:
                - name: opensearch-ml
                  purl: pkg:dhi/opensearch-ml@3.4.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/neural-search.git#3.4.0.0
            checksum: 6923b994109b1a4f5c207d67937f3797196882a3
            path: ${source.dir}/neural-search
            spdx:
              name: opensearch-neural-search
              version: 3.4.0.0
              packages:
                - name: opensearch-neural-search
                  purl: pkg:dhi/opensearch-neural-search@3.4.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/notifications.git#3.4.0.0
            checksum: b9dd1ea87ec9fcab12d01dac0c33c5c728779b88
            path: ${source.dir}/notifications
            spdx:
              name: opensearch-notifications
              version: 3.4.0.0
              packages:
                - name: opensearch-notifications
                  purl: pkg:dhi/opensearch-notifications@3.4.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/observability.git#3.4.0.0
            checksum: 56f73660e15246ec588d7d685725e4adda0f65f1
            path: ${source.dir}/observability
            spdx:
              name: opensearch-observability
              version: 3.4.0.0
              packages:
                - name: opensearch-observability
                  purl: pkg:dhi/opensearch-observability@3.4.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/opensearch-learning-to-rank-base.git#3.4.0.0
            checksum: 3ce0630dc3cdf4b8569f35e768f5ca263b633a9b
            path: ${source.dir}/opensearch-learning-to-rank-base
            spdx:
              name: opensearch-ltr
              version: 3.4.0.0
              packages:
                - name: opensearch-ltr
                  purl: pkg:dhi/opensearch-ltr@3.4.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/opensearch-system-templates.git#3.4.0.0
            checksum: b25869c9da42d0efdfdbe5d140b45863ab46b346
            path: ${source.dir}/opensearch-system-templates
            spdx:
              name: opensearch-system-templates
              version: 3.4.0.0
              packages:
                - name: opensearch-system-templates
                  purl: pkg:dhi/opensearch-system-templates@3.4.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/performance-analyzer.git#3.4.0.0
            checksum: 380901ff664a72717abfe145db2ec2c78cd36826
            path: ${source.dir}/performance-analyzer
            spdx:
              name: opensearch-performance-analyzer
              version: 3.4.0.0
              packages:
                - name: opensearch-performance-analyzer
                  purl: pkg:dhi/opensearch-performance-analyzer@3.4.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/query-insights.git#3.4.0.0
            checksum: f04f4a52597fb736705e64955f18a117ed7ead66
            path: ${source.dir}/query-insights
            spdx:
              name: opensearch-query-insights
              version: 3.4.0.0
              packages:
                - name: opensearch-query-insights
                  purl: pkg:dhi/opensearch-query-insights@3.4.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/reporting.git#3.4.0.0
            checksum: e5868ebda1dec29b222aa3954fd83f4ef89f4387
            path: ${source.dir}/reporting
            spdx:
              name: opensearch-reports-scheduler
              version: 3.4.0.0
              packages:
                - name: opensearch-reports-scheduler
                  purl: pkg:dhi/opensearch-reports-scheduler@3.4.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/search-relevance.git#3.4.0.0
            checksum: 1ae04bfe3e07847990e0689d9d6a60cff813f480
            path: ${source.dir}/search-relevance
            spdx:
              name: opensearch-search-relevance
              version: 3.4.0.0
              packages:
                - name: opensearch-search-relevance
                  purl: pkg:dhi/opensearch-search-relevance@3.4.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/security.git#3.4.0.0
            checksum: b4293103b1c53d96e0e2bf40ec56a0468e3fdc8e
            path: ${source.dir}/security
            spdx:
              name: opensearch-security
              version: 3.4.0.0
              packages:
                - name: opensearch-security
                  purl: pkg:dhi/opensearch-security@3.4.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/security-analytics.git#3.4.0.0
            checksum: c9e7457eacbed2082f349e53b42ac8fcf4d56442
            path: ${source.dir}/security-analytics
            spdx:
              name: opensearch-security-analytics
              version: 3.4.0.0
              packages:
                - name: opensearch-security-analytics
                  purl: pkg:dhi/opensearch-security-analytics@3.4.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/skills.git#3.4.0.0
            checksum: 309c481eacde99ace02f28a870b631a57b0f3de3
            path: ${source.dir}/skills
            spdx:
              name: opensearch-skills
              version: 3.4.0.0
              packages:
                - name: opensearch-skills
                  purl: pkg:dhi/opensearch-skills@3.4.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/sql.git#3.4.0.0
            checksum: 52fe8aa5bd19e8008e4c11bcbd2ea69946b5724e
            path: ${source.dir}/sql
            spdx:
              name: opensearch-sql
              version: 3.4.0.0
              packages:
                - name: opensearch-sql
                  purl: pkg:dhi/opensearch-sql@3.4.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/user-behavior-insights.git#3.4.0.0
            checksum: 4e4fe30a97515bbde311c3902e68ab52172375f0
            path: ${source.dir}/user-behavior-insights
            spdx:
              name: opensearch-user-behavior-insights
              version: 3.4.0.0
              packages:
                - name: opensearch-user-behavior-insights
                  purl: pkg:dhi/opensearch-user-behavior-insights@3.4.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/opensearch-build.git#3.4.0
            checksum: 9917c3edf20efcd4db8328b732a6cfc4673675ca
            path: ${source.dir}/opensearch-build
            uid: 1000
            gid: 1000
          - url: https://repo1.maven.org/maven2/io/netty/netty-buffer/4.2.8.Final/netty-buffer-4.2.8.Final.jar
            path: ${source.dir}/patch/deps/netty-buffer-4.2.8.Final.jar
            uid: 1000
            gid: 1000
          - url: https://repo1.maven.org/maven2/io/netty/netty-codec/4.2.8.Final/netty-codec-4.2.8.Final.jar
            path: ${source.dir}/patch/deps/netty-codec-4.2.8.Final.jar
            uid: 1000
            gid: 1000
          - url: https://repo1.maven.org/maven2/io/netty/netty-codec-http/4.2.8.Final/netty-codec-http-4.2.8.Final.jar
            path: ${source.dir}/patch/deps/netty-codec-http-4.2.8.Final.jar
            uid: 1000
            gid: 1000
          - url: https://repo1.maven.org/maven2/io/netty/netty-codec-http2/4.2.8.Final/netty-codec-http2-4.2.8.Final.jar
            path: ${source.dir}/patch/deps/netty-codec-http2-4.2.8.Final.jar
            uid: 1000
            gid: 1000
          - url: https://repo1.maven.org/maven2/io/netty/netty-common/4.2.8.Final/netty-common-4.2.8.Final.jar
            path: ${source.dir}/patch/deps/netty-common-4.2.8.Final.jar
            uid: 1000
            gid: 1000
          - url: https://repo1.maven.org/maven2/io/netty/netty-handler/4.2.8.Final/netty-handler-4.2.8.Final.jar
            path: ${source.dir}/patch/deps/netty-handler-4.2.8.Final.jar
            uid: 1000
            gid: 1000
          - url: https://repo1.maven.org/maven2/io/netty/netty-resolver/4.2.8.Final/netty-resolver-4.2.8.Final.jar
            path: ${source.dir}/patch/deps/netty-resolver-4.2.8.Final.jar
            uid: 1000
            gid: 1000
          - url: https://repo1.maven.org/maven2/io/netty/netty-transport/4.2.8.Final/netty-transport-4.2.8.Final.jar
            path: ${source.dir}/patch/deps/netty-transport-4.2.8.Final.jar
            uid: 1000
            gid: 1000
          - url: https://repo1.maven.org/maven2/io/netty/netty-transport-classes-epoll/4.2.8.Final/netty-transport-classes-epoll-4.2.8.Final.jar
            path: ${source.dir}/patch/deps/netty-transport-classes-epoll-4.2.8.Final.jar
            uid: 1000
            gid: 1000
          - url: https://repo1.maven.org/maven2/io/netty/netty-transport-native-unix-common/4.2.8.Final/netty-transport-native-unix-common-4.2.8.Final.jar
            path: ${source.dir}/patch/deps/netty-transport-native-unix-common-4.2.8.Final.jar
            uid: 1000
            gid: 1000
      pipeline:
        - name: patch core
          uses: git/patch@v1
          work-dir: ${source.dir}/OpenSearch
          with:
            patch: ${source.dir}/patch/core.patch
        - name: patch security plugin
          uses: git/patch@v1
          work-dir: ${source.dir}/security
          with:
            patch: ${source.dir}/patch/plugin-security.patch
        - name: build OpenSearch core
          work-dir: ${source.dir}/OpenSearch
          privileged: true
          runs: |
            set -eux -o pipefail

            gradle publishToMavenLocal -Dbuild.snapshot=false -Dopensearch.version=3.4.0
            gradle :build-tools:publishToMavenLocal -Dbuild.snapshot=false -Dopensearch.version=3.4.0

            # Then create the distribution
            gradle localDistro -Dbuild.snapshot=false -Dopensearch.version=3.4.0

            # Remove the bundled jdk
            rm -r "${source.dir}/OpenSearch/build/distribution/local/opensearch-3.4.0/jdk"
        - name: build OpenSearch plugin utils
          work-dir: ${source.dir}/common-utils
          privileged: true
          runs: |
            set -eux -o pipefail

            gradle build -Dbuild.snapshot=false -Dopensearch.version=3.4.0
            gradle publishToMavenLocal -Dbuild.snapshot=false -Dopensearch.version=3.4.0
        - name: build opensearch-remote-metadata-sdk
          work-dir: ${source.dir}/opensearch-remote-metadata-sdk
          privileged: true
          runs: |
            set -eux -o pipefail

            gradle build -Dbuild.snapshot=false -Dopensearch.version=3.4.0
            gradle publishToMavenLocal -Dbuild.snapshot=false -Dopensearch.version=3.4.0
        - name: build plugins
          privileged: true
          runs: |
            set -eux -o pipefail

            plugins=(
              alerting
              anomaly-detection
              asynchronous-search
              cross-cluster-replication
              custom-codecs
              flow-framework
              geospatial
              index-management
              job-scheduler
              k-NN
              ml-commons
              neural-search
              notifications/notifications
              observability
              opensearch-learning-to-rank-base
              opensearch-system-templates
              performance-analyzer
              query-insights
              reporting
              search-relevance
              security
              security-analytics
              skills
              sql
              user-behavior-insights
            )

            for plugindir in "${plugins[@]}"; do
              cd ${source.dir}/${plugindir}
              gradle assemble -Dbuild.snapshot=false -Dopensearch.version=3.4.0
            done
        - name: assemble opensearch distribution
          runs: |
            set -eux -o pipefail

            mv "${source.dir}/OpenSearch/build/distribution/local/opensearch-3.4.0" "${target.dir}/opensearch"

            plugin_zip_dirs=(
              alerting/alerting
              anomaly-detection
              asynchronous-search
              cross-cluster-replication
              custom-codecs
              flow-framework
              geospatial
              index-management
              job-scheduler
              k-NN
              ml-commons/plugin
              neural-search
              notifications/notifications/core # notifications has two plugins: "core" and "notifications"
              notifications/notifications/notifications
              observability
              opensearch-learning-to-rank-base
              opensearch-system-templates
              performance-analyzer
              query-insights
              reporting
              search-relevance
              security
              security-analytics
              skills
              sql/plugin
              user-behavior-insights
            )

            for plugin_zip_dir in "${plugin_zip_dirs[@]}"; do
              zipfile=$(echo ${source.dir}/$plugin_zip_dir/build/distributions/*.zip)
              if [ ! -f "$zipfile" ]; then
                echo "ERROR: Zip file not found for plugin: ${plugin_zip_dir}"
                exit 1
              fi
              echo "Found plugin zip file: $zipfile"

              # The plugin name is different from the repository name
              # We could pull it out of settings.gradle or we can get it here from the zip file name
              basezip="$(basename "$zipfile" .zip)"
              plugin_name="${basezip%-*}"

              mkdir -p "${target.dir}/opensearch/plugins/$plugin_name"
              unzip -o "$zipfile" -d "${target.dir}/opensearch/plugins/$plugin_name/"
            done

            # Some plugins have additional configuration files to install
            install -Dm644 ${source.dir}/notifications/notifications/notifications/src/main/config/notifications.yml "${target.dir}/opensearch/config/opensearch-notifications/notifications.yml"
            install -Dm644 ${source.dir}/notifications/notifications/core/src/main/config/notifications-core.yml "${target.dir}/opensearch/config/opensearch-notifications-core/notifications-core.yml"
            install -Dm644 ${source.dir}/observability/src/main/config/observability.yml "${target.dir}/opensearch/config/opensearch-observability/observability.yml"
            mkdir -p "${target.dir}/opensearch/config/opensearch-performance-analyzer"
            install -Dm644 ${source.dir}/performance-analyzer/config/* "${target.dir}/opensearch/config/opensearch-performance-analyzer/"
            install -Dm644 ${source.dir}/reporting/src/main/config/reports-scheduler.yml "${target.dir}/opensearch/config/opensearch-reports-scheduler/reports-scheduler.yml"
            mkdir -p "${target.dir}/opensearch/config/opensearch-security"
            install -Dm644 ${source.dir}/security/config/* "${target.dir}/opensearch/config/opensearch-security/"
        - name: replace vulnerable netty in security-analytics
          work-dir: ${target.dir}/opensearch/plugins/opensearch-security-analytics
          runs: |
            set -eux -o pipefail

            sa_commons_jar="$(ls security-analytics-commons-*.jar)"

            echo "Checking bundled Netty in ${sa_commons_jar}..."
            if ! /opt/java/openjdk/21/bin/jar tf "${sa_commons_jar}" | grep -q '^io/netty/'; then
              echo "ERROR: No embedded netty classes found in commons jar" >&2
              exit 1
            fi

            # Extract version from netty-codec-http pom.properties
            bundled_netty_ver="$(unzip -p "${sa_commons_jar}" 'META-INF/maven/io.netty/netty-codec-http/pom.properties' 2> /dev/null | grep '^version=' | cut -d= -f2 || echo "")"

            if [[ -n "${bundled_netty_ver}" ]]; then
              # Compare versions (simple lexicographic comparison is good enough for now)
              if [[ "${bundled_netty_ver}" > "4.2.8.Final" ]] || [[ "${bundled_netty_ver}" = "4.2.8.Final" ]]; then
                echo "ERROR: Bundled Netty version ${bundled_netty_ver} is >= target version 4.2.8.Final" >&2
                exit 1
              fi
              echo "Bundled version ${bundled_netty_ver} < target 4.2.8.Final, proceeding with upgrade..."
            else
              echo "WARNING: Found netty classes but could not determine version, proceeding..."
            fi

            echo "Stripping all embedded netty classes from: ${sa_commons_jar}"
            zip -qd "${sa_commons_jar}" 'io/netty/*' 'META-INF/maven/io.netty/*/*' || true
            if /opt/java/openjdk/21/bin/jar tf "${sa_commons_jar}" | grep -q '^io/netty/'; then
              echo "ERROR: Failed to strip embedded netty classes from commons jar" >&2
              exit 1
            fi

            echo "Bundling netty 4.2.8.Final jars..."
            for netty_dep in netty-buffer netty-codec netty-codec-http netty-codec-http2 netty-common netty-handler netty-resolver netty-transport netty-transport-classes-epoll netty-transport-native-unix-common; do
              cp ${source.dir}/patch/deps/${netty_dep}-4.2.8.Final.jar .
            done
        - name: copy config and entrypoint files
          runs: |
            set -eux -o pipefail

            mkdir -p "${target.dir}/usr/local/bin"
            cp "${source.dir}/opensearch-build/docker/release/config/opensearch/opensearch-docker-entrypoint-3.x.sh" "${target.dir}/usr/local/bin/docker-entrypoint.sh"
            cp "${source.dir}/opensearch-build/config/opensearch.yml" "${target.dir}/opensearch/config/opensearch.yml"
            cp "${source.dir}/opensearch-build/docker/release/config/opensearch/log4j2.properties" "${target.dir}/opensearch/config/log4j2.properties"
      paths:
        - type: file
          path: /src/patch/core.patch
          uid: 0
          gid: 0
          mode: "0444"
          source: image/opensearch/patch/core.patch
        - type: file
          path: /src/patch/plugin-security.patch
          uid: 0
          gid: 0
          mode: "0444"
          source: image/opensearch/patch/plugin-security.patch
      accounts:
        run-as: opensearch
        users:
          - name: opensearch
            uid: 1000
            gid: 1000
        groups:
          - name: opensearch
            gid: 1000
            members:
              - opensearch
      outputs:
        - source: ${target.dir}/opensearch
          target: /usr/share/opensearch
          uid: 0
          gid: 0
        - source: ${target.dir}/usr/local/bin/docker-entrypoint.sh
          target: /usr/local/bin/docker-entrypoint.sh
          uid: 0
          gid: 0
          mode: "0555"
        - source: /opt/docker/sbom/
          target: /opt/docker/sbom/
          uid: 0
          gid: 0
    - name: locale
      uses: dhi.io/debian-base:trixie-debian13@sha256:1244523a2f7b6c096c6f98ce0349df6798c775c57322c51f8a4982daf60c256c
      contents:
        packages:
          - bash
          - locales
          - coreutils
          - gzip
      pipeline:
        - name: install locales
          runs: |
            set -eux -o pipefail

            ln -s /etc/locale.alias /usr/share/locale/locale.alias

            echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen
            locale-gen en_US.UTF-8
      outputs:
        - source: /usr/share/locale
          target: /usr/share/locale
          uid: 0
          gid: 0
        - source: /usr/lib/locale
          target: /usr/lib/locale
          uid: 0
          gid: 0
  artifacts:
    - name: dhi.io/eclipse-temurin:21.0.9.10-debian13@sha256:e0c3e71b08e1051e402957c08de745011f9f1209d27d1e9e8cab1fe6edf9a44b
      includes:
        - opt/**
        - usr/local/bin/**
      uid: 0
      gid: 0
accounts:
  run-as: opensearch
  users:
    - name: opensearch
      uid: 1000
      gid: 1000
  groups:
    - name: opensearch
      gid: 1000
      members:
        - opensearch
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
work-dir: /usr/share/opensearch
environment:
  HOME: /usr/share/opensearch
  JAVA_HOME: /opt/java/openjdk/21-jre
  LANG: en_US.UTF-8
  LANGUAGE: en_US:en
  LC_ALL: en_US.UTF-8
  OPENSEARCH_HOME: /usr/share/opensearch
  OPENSEARCH_PATH_CONF: /usr/share/opensearch/config
  PATH: /usr/share/opensearch/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
paths:
  - type: directory
    path: /usr/share/opensearch/data
    uid: 1000
    gid: 1000
    mode: "0755"
  - type: directory
    path: /usr/share/opensearch/logs
    uid: 1000
    gid: 1000
    mode: "0755"
annotations:
  org.opencontainers.image.description: A minimal OpenSearch image
  org.opencontainers.image.licenses: Apache-2.0
entrypoint:
  - /usr/local/bin/docker-entrypoint.sh
cmd:
  - opensearch
ports:
  - 9200/tcp
  - 9300/tcp
  - 9600/tcp
  - 9650/tcp
