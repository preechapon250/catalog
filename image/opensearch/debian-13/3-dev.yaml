# syntax=dhi.io/build:2-debian13

name: OpenSearch 3.x (dev)
image: dhi.io/opensearch
variant: dev
tags:
  - 3-dev
  - 3.5-dev
  - 3.5.0-dev
  - 3-debian13-dev
  - 3.5-debian13-dev
  - 3.5.0-debian13-dev
platforms:
  - linux/amd64
  - linux/arm64
dates:
  release: "2025-05-06"
vars:
  ALERTING_COMMIT_SHA: 29907a3d846f08576c0f4eaad885c4ddc2dcc715
  ALERTING_VERSION: 3.5.0.0
  ANOMALY_DETECTION_COMMIT_SHA: 5fe42ccfe41460a97b4bfecaee1f890bf16436cf
  ANOMALY_DETECTION_VERSION: 3.5.0.0
  ASYNCHRONOUS_SEARCH_COMMIT_SHA: ec363090bfd56267b456b9959f786d57e98312b7
  ASYNCHRONOUS_SEARCH_VERSION: 3.5.0.0
  BCFIPS_VERSION: 2.1.2
  BCPKIXFIPS_VERSION: 2.1.10
  BCRNGJENT_VERSION: 1.3.6
  BCTLSFIPS_VERSION: 2.1.22
  BCUTILFIPS_VERSION: 2.1.5
  COMMIT_SHA: bbc94f0bdc3a759011e6529ecfe52840856f91a3
  COMMON_UTILS_COMMIT_SHA: 1669ec046c476b837125cdc69870556e8a3b7ed1
  COMMON_UTILS_VERSION: 3.5.0.0
  CROSS_CLUSTER_REPLICATION_COMMIT_SHA: 248172361438c1310b88f0e1a04b5e1d644a55cc
  CROSS_CLUSTER_REPLICATION_VERSION: 3.5.0.0
  CUSTOM_CODECS_COMMIT_SHA: 13ff572476e5d246b7289f6929593055c15b5d45
  CUSTOM_CODECS_VERSION: 3.5.0.0
  DEBIAN_REFERENCE: dhi/debian-base:trixie-debian13@sha256:9ef766670af4743904b0f992a26b525c6c914648b56ea597ec23452adcf1a95d
  FLOW_FRAMEWORK_COMMIT_SHA: b360458ccec22214ad414028a7efb75d195f9bb3
  FLOW_FRAMEWORK_VERSION: 3.5.0.0
  GEOSPATIAL_COMMIT_SHA: b34da8452014af5e4ae74e5b7dd5d31ddec5fa44
  GEOSPATIAL_VERSION: 3.5.0.0
  GOSU_REFERENCE: dhi/pkg-gosu:1.19-debian13@sha256:0adf47c4681aa332d8fee82c62c5198236ded4a663703977b0a4fc7690cd8100
  GOSU_VERSION: "1.19"
  GRADLE_REF: dhi/gradle:8.14.4-jdk21-debian13-dev@sha256:9f2372a2c99a038f44f38cf2ee077b8b0c1b6ce1185e71eb7c228c12e5a1de06
  GRADLE_VERSION: 8.14.4
  INDEX_MANAGEMENT_COMMIT_SHA: 1159a589250a56691ced083b324413d401054382
  INDEX_MANAGEMENT_VERSION: 3.5.0.0
  JOB_SCHEDULER_COMMIT_SHA: dcb639fb9de6c60c7773da44299c23adfa9f54d0
  JOB_SCHEDULER_VERSION: 3.5.0.0
  JRE_MAJOR_VERSION: "21"
  JRE_REF: dhi/eclipse-temurin:21.0.10.7-debian13@sha256:6c6079768261b7f033e00ca6a86e5a3a9ee17068a1ba5ebd3328fec30360b871
  JRE_VERSION: 21.0.10.7
  K_NN_COMMIT_SHA: 1aced12bc5c188ae0151419fc51766646d94cad5
  K_NN_VERSION: 3.5.0.0
  ML_COMMONS_COMMIT_SHA: 581b229c899fe007eff44a8718192cb74778f67a
  ML_COMMONS_VERSION: 3.5.0.0
  NETTY_PATCH_VERSION: 4.2.8.Final
  NEURAL_SEARCH_COMMIT_SHA: 0a5975c49302648b6a2c27a9d5c539044d91bfb0
  NEURAL_SEARCH_VERSION: 3.5.0.0
  NOTIFICATIONS_COMMIT_SHA: 0ea5fdda7f430a0efe11b9465ad4c3d4f2a3776e
  NOTIFICATIONS_CORE_COMMIT_SHA: 0ea5fdda7f430a0efe11b9465ad4c3d4f2a3776e
  NOTIFICATIONS_VERSION: 3.5.0.0
  OBSERVABILITY_COMMIT_SHA: 24fc538cf1a50d253a37e9c13298cebca024f95c
  OBSERVABILITY_VERSION: 3.5.0.0
  OPENSEARCH_BUILD_COMMIT_SHA: 139499ff11880353a9a2e47efabe762e7261754d
  OPENSEARCH_BUILD_VERSION: 3.5.0
  OPENSEARCH_LEARNING_TO_RANK_BASE_COMMIT_SHA: 2f37b2151b1480d969029f07cd6db8969e5e92da
  OPENSEARCH_LEARNING_TO_RANK_BASE_VERSION: 3.5.0.0
  OPENSEARCH_MAJOR_MINOR_VERSION: "3.5"
  OPENSEARCH_REMOTE_METADATA_SDK_COMMIT_SHA: c0b1895b552da0ee41e118e29540aaadff3ccc46
  OPENSEARCH_REMOTE_METADATA_SDK_VERSION: 3.5.0.0
  OPENSEARCH_SYSTEM_TEMPLATES_COMMIT_SHA: 6557742fa29a9dcd04c8c39f7491de7802249bcc
  OPENSEARCH_SYSTEM_TEMPLATES_VERSION: 3.5.0.0
  PERFORMANCE_ANALYZER_COMMIT_SHA: 78d9b25abe6f0b34709536a2eddf4120eddb030d
  PERFORMANCE_ANALYZER_VERSION: 3.5.0.0
  QUERY_INSIGHTS_COMMIT_SHA: 34110db8f4aa6437891e6b28dff730b2b2ec62a5
  QUERY_INSIGHTS_VERSION: 3.5.0.0
  REPORTING_COMMIT_SHA: 7032eef2cd847b3dc4e805adaca2e6c0a516f05a
  REPORTING_VERSION: 3.5.0.0
  SEARCH_RELEVANCE_COMMIT_SHA: f12487a51dab91fbcf7a1aac1e5ac4f43001b0a6
  SEARCH_RELEVANCE_VERSION: 3.5.0.0
  SECURITY_ANALYTICS_COMMIT_SHA: 1435464d84e284d514817616c3b957228f1c5518
  SECURITY_ANALYTICS_VERSION: 3.5.0.0
  SECURITY_COMMIT_SHA: 2cb891d7fb74aa649dc3767d2742a83da62f6f44
  SECURITY_VERSION: 3.5.0.0
  SEMVER_MAJOR_MINOR_VERSION: "3.5"
  SEMVER_MAJOR_VERSION: "3"
  SEMVER_VERSION: 3.5.0
  SKILLS_COMMIT_SHA: 06525fc4f39fbd0d07a7fef73c792b174293a3a5
  SKILLS_VERSION: 3.5.0.0
  SQL_COMMIT_SHA: d680c44ccdcfa638fc16c73d74cde48832701650
  SQL_VERSION: 3.5.0.0
  USER_BEHAVIOR_INSIGHTS_COMMIT_SHA: c333370754765c1a505390bdad1c069a66ceea6d
  USER_BEHAVIOR_INSIGHTS_VERSION: 3.5.0.0
  VERSION: 3.5.0
contents:
  packages:
    - '!gawk'
    - '!libelogind0'
    - '!mawk'
    - '!original-awk'
    - apt
    - base-files
    - bash
    - ca-certificates
    - coreutils
    - diffutils
    - dpkg
    - findutils
    - grep
    - libc-bin
    - libstdc++6
    - mawk
    - perl-base
    - sed
    - util-linux
  builds:
    - name: opensearch from source
      uses: dhi.io/gradle:8.14.4-jdk21-debian13-dev@sha256:9f2372a2c99a038f44f38cf2ee077b8b0c1b6ce1185e71eb7c228c12e5a1de06
      environment:
        CI: "true"
        GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx2g -XX:MaxMetaspaceSize=512m"
      contents:
        packages:
          - bash
          - coreutils
          - findutils
          - git
          - grep
          - gzip
          - sed
          - tar
          - unzip
          - xz-utils
          - zip
        files:
          - url: git+https://github.com/opensearch-project/OpenSearch.git#3.5.0
            checksum: bbc94f0bdc3a759011e6529ecfe52840856f91a3
            path: ${source.dir}/OpenSearch
            spdx:
              name: opensearch
              version: 3.5.0
              packages:
                - name: opensearch
                  purl: pkg:dhi/opensearch@3.5.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/common-utils.git#3.5.0.0
            checksum: 1669ec046c476b837125cdc69870556e8a3b7ed1
            path: ${source.dir}/common-utils
            spdx:
              name: opensearch-common-utils
              version: 3.5.0.0
              packages:
                - name: opensearch-common-utils
                  purl: pkg:dhi/opensearch-common-utils@3.5.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/opensearch-remote-metadata-sdk.git#3.5.0.0
            checksum: c0b1895b552da0ee41e118e29540aaadff3ccc46
            path: ${source.dir}/opensearch-remote-metadata-sdk
            spdx:
              name: opensearch-remote-metadata-sdk
              version: 3.5.0.0
              packages:
                - name: opensearch-remote-metadata-sdk
                  purl: pkg:dhi/opensearch-remote-metadata-sdk@3.5.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/alerting.git#3.5.0.0
            checksum: 29907a3d846f08576c0f4eaad885c4ddc2dcc715
            path: ${source.dir}/alerting
            spdx:
              name: opensearch-alerting
              version: 3.5.0.0
              packages:
                - name: opensearch-alerting
                  purl: pkg:dhi/opensearch-alerting@3.5.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/anomaly-detection.git#3.5.0.0
            checksum: 5fe42ccfe41460a97b4bfecaee1f890bf16436cf
            path: ${source.dir}/anomaly-detection
            spdx:
              name: opensearch-anomaly-detection
              version: 3.5.0.0
              packages:
                - name: opensearch-anomaly-detection
                  purl: pkg:dhi/opensearch-anomaly-detection@3.5.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/asynchronous-search.git#3.5.0.0
            checksum: ec363090bfd56267b456b9959f786d57e98312b7
            path: ${source.dir}/asynchronous-search
            spdx:
              name: opensearch-asynchronous-search
              version: 3.5.0.0
              packages:
                - name: opensearch-asynchronous-search
                  purl: pkg:dhi/opensearch-asynchronous-search@3.5.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/custom-codecs.git#3.5.0.0
            checksum: 13ff572476e5d246b7289f6929593055c15b5d45
            path: ${source.dir}/custom-codecs
            spdx:
              name: opensearch-custom-codecs
              version: 3.5.0.0
              packages:
                - name: opensearch-custom-codecs
                  purl: pkg:dhi/opensearch-custom-codecs@3.5.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/cross-cluster-replication.git#3.5.0.0
            checksum: 248172361438c1310b88f0e1a04b5e1d644a55cc
            path: ${source.dir}/cross-cluster-replication
            spdx:
              name: opensearch-cross-cluster-replication
              version: 3.5.0.0
              packages:
                - name: opensearch-cross-cluster-replication
                  purl: pkg:dhi/opensearch-cross-cluster-replication@3.5.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/flow-framework.git#3.5.0.0
            checksum: b360458ccec22214ad414028a7efb75d195f9bb3
            path: ${source.dir}/flow-framework
            spdx:
              name: opensearch-flow-framework
              version: 3.5.0.0
              packages:
                - name: opensearch-flow-framework
                  purl: pkg:dhi/opensearch-flow-framework@3.5.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/geospatial.git#3.5.0.0
            checksum: b34da8452014af5e4ae74e5b7dd5d31ddec5fa44
            path: ${source.dir}/geospatial
            spdx:
              name: opensearch-geospatial
              version: 3.5.0.0
              packages:
                - name: opensearch-geospatial
                  purl: pkg:dhi/opensearch-geospatial@3.5.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/index-management.git#3.5.0.0
            checksum: 1159a589250a56691ced083b324413d401054382
            path: ${source.dir}/index-management
            spdx:
              name: opensearch-index-management
              version: 3.5.0.0
              packages:
                - name: opensearch-index-management
                  purl: pkg:dhi/opensearch-index-management@3.5.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/job-scheduler.git#3.5.0.0
            checksum: dcb639fb9de6c60c7773da44299c23adfa9f54d0
            path: ${source.dir}/job-scheduler
            spdx:
              name: opensearch-job-scheduler
              version: 3.5.0.0
              packages:
                - name: opensearch-job-scheduler
                  purl: pkg:dhi/opensearch-job-scheduler@3.5.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/k-NN.git#3.5.0.0
            checksum: 1aced12bc5c188ae0151419fc51766646d94cad5
            path: ${source.dir}/k-NN
            spdx:
              name: opensearch-knn
              version: 3.5.0.0
              packages:
                - name: opensearch-knn
                  purl: pkg:dhi/opensearch-knn@3.5.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/ml-commons.git#3.5.0.0
            checksum: 581b229c899fe007eff44a8718192cb74778f67a
            path: ${source.dir}/ml-commons
            spdx:
              name: opensearch-ml
              version: 3.5.0.0
              packages:
                - name: opensearch-ml
                  purl: pkg:dhi/opensearch-ml@3.5.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/neural-search.git#3.5.0.0
            checksum: 0a5975c49302648b6a2c27a9d5c539044d91bfb0
            path: ${source.dir}/neural-search
            spdx:
              name: opensearch-neural-search
              version: 3.5.0.0
              packages:
                - name: opensearch-neural-search
                  purl: pkg:dhi/opensearch-neural-search@3.5.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/notifications.git#3.5.0.0
            checksum: 0ea5fdda7f430a0efe11b9465ad4c3d4f2a3776e
            path: ${source.dir}/notifications
            spdx:
              name: opensearch-notifications
              version: 3.5.0.0
              packages:
                - name: opensearch-notifications
                  purl: pkg:dhi/opensearch-notifications@3.5.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/observability.git#3.5.0.0
            checksum: 24fc538cf1a50d253a37e9c13298cebca024f95c
            path: ${source.dir}/observability
            spdx:
              name: opensearch-observability
              version: 3.5.0.0
              packages:
                - name: opensearch-observability
                  purl: pkg:dhi/opensearch-observability@3.5.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/opensearch-learning-to-rank-base.git#3.5.0.0
            checksum: 2f37b2151b1480d969029f07cd6db8969e5e92da
            path: ${source.dir}/opensearch-learning-to-rank-base
            spdx:
              name: opensearch-ltr
              version: 3.5.0.0
              packages:
                - name: opensearch-ltr
                  purl: pkg:dhi/opensearch-ltr@3.5.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/opensearch-system-templates.git#3.5.0.0
            checksum: 6557742fa29a9dcd04c8c39f7491de7802249bcc
            path: ${source.dir}/opensearch-system-templates
            spdx:
              name: opensearch-system-templates
              version: 3.5.0.0
              packages:
                - name: opensearch-system-templates
                  purl: pkg:dhi/opensearch-system-templates@3.5.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/performance-analyzer.git#3.5.0.0
            checksum: 78d9b25abe6f0b34709536a2eddf4120eddb030d
            path: ${source.dir}/performance-analyzer
            spdx:
              name: opensearch-performance-analyzer
              version: 3.5.0.0
              packages:
                - name: opensearch-performance-analyzer
                  purl: pkg:dhi/opensearch-performance-analyzer@3.5.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/query-insights.git#3.5.0.0
            checksum: 34110db8f4aa6437891e6b28dff730b2b2ec62a5
            path: ${source.dir}/query-insights
            spdx:
              name: opensearch-query-insights
              version: 3.5.0.0
              packages:
                - name: opensearch-query-insights
                  purl: pkg:dhi/opensearch-query-insights@3.5.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/reporting.git#3.5.0.0
            checksum: 7032eef2cd847b3dc4e805adaca2e6c0a516f05a
            path: ${source.dir}/reporting
            spdx:
              name: opensearch-reports-scheduler
              version: 3.5.0.0
              packages:
                - name: opensearch-reports-scheduler
                  purl: pkg:dhi/opensearch-reports-scheduler@3.5.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/search-relevance.git#3.5.0.0
            checksum: f12487a51dab91fbcf7a1aac1e5ac4f43001b0a6
            path: ${source.dir}/search-relevance
            spdx:
              name: opensearch-search-relevance
              version: 3.5.0.0
              packages:
                - name: opensearch-search-relevance
                  purl: pkg:dhi/opensearch-search-relevance@3.5.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/security.git#3.5.0.0
            checksum: 2cb891d7fb74aa649dc3767d2742a83da62f6f44
            path: ${source.dir}/security
            spdx:
              name: opensearch-security
              version: 3.5.0.0
              packages:
                - name: opensearch-security
                  purl: pkg:dhi/opensearch-security@3.5.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/security-analytics.git#3.5.0.0
            checksum: 1435464d84e284d514817616c3b957228f1c5518
            path: ${source.dir}/security-analytics
            spdx:
              name: opensearch-security-analytics
              version: 3.5.0.0
              packages:
                - name: opensearch-security-analytics
                  purl: pkg:dhi/opensearch-security-analytics@3.5.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/skills.git#3.5.0.0
            checksum: 06525fc4f39fbd0d07a7fef73c792b174293a3a5
            path: ${source.dir}/skills
            spdx:
              name: opensearch-skills
              version: 3.5.0.0
              packages:
                - name: opensearch-skills
                  purl: pkg:dhi/opensearch-skills@3.5.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/sql.git#3.5.0.0
            checksum: d680c44ccdcfa638fc16c73d74cde48832701650
            path: ${source.dir}/sql
            spdx:
              name: opensearch-sql
              version: 3.5.0.0
              packages:
                - name: opensearch-sql
                  purl: pkg:dhi/opensearch-sql@3.5.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/user-behavior-insights.git#3.5.0.0
            checksum: c333370754765c1a505390bdad1c069a66ceea6d
            path: ${source.dir}/user-behavior-insights
            spdx:
              name: opensearch-user-behavior-insights
              version: 3.5.0.0
              packages:
                - name: opensearch-user-behavior-insights
                  purl: pkg:dhi/opensearch-user-behavior-insights@3.5.0
                  license: Apache-2.0
            uid: 1000
            gid: 1000
          - url: git+https://github.com/opensearch-project/opensearch-build.git#3.5.0
            checksum: 139499ff11880353a9a2e47efabe762e7261754d
            path: ${source.dir}/opensearch-build
            uid: 1000
            gid: 1000
          - url: https://repo1.maven.org/maven2/io/netty/netty-buffer/4.2.8.Final/netty-buffer-4.2.8.Final.jar
            path: ${source.dir}/patch/deps/netty-buffer-4.2.8.Final.jar
            uid: 1000
            gid: 1000
          - url: https://repo1.maven.org/maven2/io/netty/netty-codec/4.2.8.Final/netty-codec-4.2.8.Final.jar
            path: ${source.dir}/patch/deps/netty-codec-4.2.8.Final.jar
            uid: 1000
            gid: 1000
          - url: https://repo1.maven.org/maven2/io/netty/netty-codec-http/4.2.8.Final/netty-codec-http-4.2.8.Final.jar
            path: ${source.dir}/patch/deps/netty-codec-http-4.2.8.Final.jar
            uid: 1000
            gid: 1000
          - url: https://repo1.maven.org/maven2/io/netty/netty-codec-http2/4.2.8.Final/netty-codec-http2-4.2.8.Final.jar
            path: ${source.dir}/patch/deps/netty-codec-http2-4.2.8.Final.jar
            uid: 1000
            gid: 1000
          - url: https://repo1.maven.org/maven2/io/netty/netty-common/4.2.8.Final/netty-common-4.2.8.Final.jar
            path: ${source.dir}/patch/deps/netty-common-4.2.8.Final.jar
            uid: 1000
            gid: 1000
          - url: https://repo1.maven.org/maven2/io/netty/netty-handler/4.2.8.Final/netty-handler-4.2.8.Final.jar
            path: ${source.dir}/patch/deps/netty-handler-4.2.8.Final.jar
            uid: 1000
            gid: 1000
          - url: https://repo1.maven.org/maven2/io/netty/netty-resolver/4.2.8.Final/netty-resolver-4.2.8.Final.jar
            path: ${source.dir}/patch/deps/netty-resolver-4.2.8.Final.jar
            uid: 1000
            gid: 1000
          - url: https://repo1.maven.org/maven2/io/netty/netty-transport/4.2.8.Final/netty-transport-4.2.8.Final.jar
            path: ${source.dir}/patch/deps/netty-transport-4.2.8.Final.jar
            uid: 1000
            gid: 1000
          - url: https://repo1.maven.org/maven2/io/netty/netty-transport-classes-epoll/4.2.8.Final/netty-transport-classes-epoll-4.2.8.Final.jar
            path: ${source.dir}/patch/deps/netty-transport-classes-epoll-4.2.8.Final.jar
            uid: 1000
            gid: 1000
          - url: https://repo1.maven.org/maven2/io/netty/netty-transport-native-unix-common/4.2.8.Final/netty-transport-native-unix-common-4.2.8.Final.jar
            path: ${source.dir}/patch/deps/netty-transport-native-unix-common-4.2.8.Final.jar
            uid: 1000
            gid: 1000
      pipeline:
        - name: patch security plugin
          uses: git/patch@v1
          work-dir: ${source.dir}/security
          with:
            patch: ${source.dir}/patch/plugin-security.patch
        - name: build OpenSearch core
          work-dir: ${source.dir}/OpenSearch
          privileged: true
          runs: |
            set -eux -o pipefail

            gradle publishToMavenLocal -Dbuild.snapshot=false -Dopensearch.version=3.5.0
            gradle :build-tools:publishToMavenLocal -Dbuild.snapshot=false -Dopensearch.version=3.5.0

            # Then create the distribution
            gradle localDistro -Dbuild.snapshot=false -Dopensearch.version=3.5.0

            # Remove the bundled jdk
            rm -r "${source.dir}/OpenSearch/build/distribution/local/opensearch-3.5.0/jdk"
        - name: build OpenSearch plugin utils
          work-dir: ${source.dir}/common-utils
          privileged: true
          runs: |
            set -eux -o pipefail

            gradle build -Dbuild.snapshot=false -Dopensearch.version=3.5.0
            gradle publishToMavenLocal -Dbuild.snapshot=false -Dopensearch.version=3.5.0
        - name: build opensearch-remote-metadata-sdk
          work-dir: ${source.dir}/opensearch-remote-metadata-sdk
          privileged: true
          runs: |
            set -eux -o pipefail

            gradle build -Dbuild.snapshot=false -Dopensearch.version=3.5.0
            gradle publishToMavenLocal -Dbuild.snapshot=false -Dopensearch.version=3.5.0
        - name: build plugins
          privileged: true
          runs: |
            set -eux -o pipefail

            plugins=(
              alerting
              anomaly-detection
              asynchronous-search
              cross-cluster-replication
              custom-codecs
              flow-framework
              geospatial
              index-management
              job-scheduler
              k-NN
              ml-commons
              neural-search
              notifications/notifications
              observability
              opensearch-learning-to-rank-base
              opensearch-system-templates
              performance-analyzer
              query-insights
              reporting
              search-relevance
              security
              security-analytics
              skills
              sql
              user-behavior-insights
            )

            for plugindir in "${plugins[@]}"; do
              cd ${source.dir}/${plugindir}
              gradle assemble -Dbuild.snapshot=false -Dopensearch.version=3.5.0
            done
        - name: assemble opensearch distribution
          runs: |
            set -eux -o pipefail

            mv "${source.dir}/OpenSearch/build/distribution/local/opensearch-3.5.0" "${target.dir}/opensearch"

            plugin_zip_dirs=(
              alerting/alerting
              anomaly-detection
              asynchronous-search
              cross-cluster-replication
              custom-codecs
              flow-framework
              geospatial
              index-management
              job-scheduler
              k-NN
              ml-commons/plugin
              neural-search
              notifications/notifications/core # notifications has two plugins: "core" and "notifications"
              notifications/notifications/notifications
              observability
              opensearch-learning-to-rank-base
              opensearch-system-templates
              performance-analyzer
              query-insights
              reporting
              search-relevance
              security
              security-analytics
              skills
              sql/plugin
              user-behavior-insights
            )

            for plugin_zip_dir in "${plugin_zip_dirs[@]}"; do
              zipfile=$(echo ${source.dir}/$plugin_zip_dir/build/distributions/*.zip)
              if [ ! -f "$zipfile" ]; then
                echo "ERROR: Zip file not found for plugin: ${plugin_zip_dir}"
                exit 1
              fi
              echo "Found plugin zip file: $zipfile"

              # The plugin name is different from the repository name
              # We could pull it out of settings.gradle or we can get it here from the zip file name
              basezip="$(basename "$zipfile" .zip)"
              plugin_name="${basezip%-*}"

              mkdir -p "${target.dir}/opensearch/plugins/$plugin_name"
              unzip -o "$zipfile" -d "${target.dir}/opensearch/plugins/$plugin_name/"
            done

            # Some plugins have additional configuration files to install
            install -Dm644 ${source.dir}/notifications/notifications/notifications/src/main/config/notifications.yml "${target.dir}/opensearch/config/opensearch-notifications/notifications.yml"
            install -Dm644 ${source.dir}/notifications/notifications/core/src/main/config/notifications-core.yml "${target.dir}/opensearch/config/opensearch-notifications-core/notifications-core.yml"
            install -Dm644 ${source.dir}/observability/src/main/config/observability.yml "${target.dir}/opensearch/config/opensearch-observability/observability.yml"
            mkdir -p "${target.dir}/opensearch/config/opensearch-performance-analyzer"
            install -Dm644 ${source.dir}/performance-analyzer/config/* "${target.dir}/opensearch/config/opensearch-performance-analyzer/"
            install -Dm644 ${source.dir}/reporting/src/main/config/reports-scheduler.yml "${target.dir}/opensearch/config/opensearch-reports-scheduler/reports-scheduler.yml"
            mkdir -p "${target.dir}/opensearch/config/opensearch-security"
            install -Dm644 ${source.dir}/security/config/* "${target.dir}/opensearch/config/opensearch-security/"
        - name: replace vulnerable netty in security-analytics
          work-dir: ${target.dir}/opensearch/plugins/opensearch-security-analytics
          runs: |
            set -eux -o pipefail

            sa_commons_jar="$(ls security-analytics-commons-*.jar)"

            echo "Checking bundled Netty in ${sa_commons_jar}..."
            if ! /opt/java/openjdk/21/bin/jar tf "${sa_commons_jar}" | grep -q '^io/netty/'; then
              echo "ERROR: No embedded netty classes found in commons jar" >&2
              exit 1
            fi

            # Extract version from netty-codec-http pom.properties
            bundled_netty_ver="$(unzip -p "${sa_commons_jar}" 'META-INF/maven/io.netty/netty-codec-http/pom.properties' 2> /dev/null | grep '^version=' | cut -d= -f2 || echo "")"

            if [[ -n "${bundled_netty_ver}" ]]; then
              # Compare versions (simple lexicographic comparison is good enough for now)
              if [[ "${bundled_netty_ver}" > "4.2.8.Final" ]] || [[ "${bundled_netty_ver}" = "4.2.8.Final" ]]; then
                echo "ERROR: Bundled Netty version ${bundled_netty_ver} is >= target version 4.2.8.Final" >&2
                exit 1
              fi
              echo "Bundled version ${bundled_netty_ver} < target 4.2.8.Final, proceeding with upgrade..."
            else
              echo "WARNING: Found netty classes but could not determine version, proceeding..."
            fi

            echo "Stripping all embedded netty classes from: ${sa_commons_jar}"
            zip -qd "${sa_commons_jar}" 'io/netty/*' 'META-INF/maven/io.netty/*/*' || true
            if /opt/java/openjdk/21/bin/jar tf "${sa_commons_jar}" | grep -q '^io/netty/'; then
              echo "ERROR: Failed to strip embedded netty classes from commons jar" >&2
              exit 1
            fi

            echo "Bundling netty 4.2.8.Final jars..."
            for netty_dep in netty-buffer netty-codec netty-codec-http netty-codec-http2 netty-common netty-handler netty-resolver netty-transport netty-transport-classes-epoll netty-transport-native-unix-common; do
              cp ${source.dir}/patch/deps/${netty_dep}-4.2.8.Final.jar .
            done
        - name: patch dev entrypoint to drop root
          uses: git/patch@v1
          work-dir: ${source.dir}/opensearch-build
          with:
            patch: ${source.dir}/patch/dev-entrypoint.patch
        - name: copy config and entrypoint files
          runs: |
            set -eux -o pipefail

            mkdir -p "${target.dir}/usr/local/bin"
            cp "${source.dir}/opensearch-build/docker/release/config/opensearch/opensearch-docker-entrypoint-3.x.sh" "${target.dir}/usr/local/bin/docker-entrypoint.sh"
            cp "${source.dir}/opensearch-build/config/opensearch.yml" "${target.dir}/opensearch/config/opensearch.yml"
            cp "${source.dir}/opensearch-build/docker/release/config/opensearch/log4j2.properties" "${target.dir}/opensearch/config/log4j2.properties"
      paths:
        - type: file
          path: /src/patch/plugin-security.patch
          uid: 0
          gid: 0
          mode: "0444"
          source: image/opensearch/patch/plugin-security.patch
        - type: file
          path: /src/patch/dev-entrypoint.patch
          uid: 0
          gid: 0
          mode: "0444"
          source: image/opensearch/patch/dev-entrypoint.patch
      accounts:
        run-as: opensearch
        users:
          - name: opensearch
            uid: 1000
            gid: 1000
        groups:
          - name: opensearch
            gid: 1000
            members:
              - opensearch
      outputs:
        - source: ${target.dir}/opensearch
          target: /usr/share/opensearch
          uid: 0
          gid: 0
        - source: ${target.dir}/usr/local/bin/docker-entrypoint.sh
          target: /usr/local/bin/docker-entrypoint.sh
          uid: 0
          gid: 0
          mode: "0555"
        - source: /opt/docker/sbom/
          target: /opt/docker/sbom/
          uid: 0
          gid: 0
    - name: locale
      uses: dhi.io/debian-base:trixie-debian13@sha256:9ef766670af4743904b0f992a26b525c6c914648b56ea597ec23452adcf1a95d
      contents:
        packages:
          - bash
          - locales
          - coreutils
          - gzip
      pipeline:
        - name: install locales
          runs: |
            set -eux -o pipefail

            ln -s /etc/locale.alias /usr/share/locale/locale.alias

            echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen
            locale-gen en_US.UTF-8
      outputs:
        - source: /usr/share/locale
          target: /usr/share/locale
          uid: 0
          gid: 0
        - source: /usr/lib/locale
          target: /usr/lib/locale
          uid: 0
          gid: 0
  artifacts:
    - name: dhi.io/eclipse-temurin:21.0.10.7-debian13@sha256:6c6079768261b7f033e00ca6a86e5a3a9ee17068a1ba5ebd3328fec30360b871
      includes:
        - opt/**
        - usr/local/bin/**
      uid: 0
      gid: 0
    - name: dhi.io/pkg-gosu:1.19-debian13@sha256:0adf47c4681aa332d8fee82c62c5198236ded4a663703977b0a4fc7690cd8100
      includes:
        - opt/docker/sbom/gosu
        - usr/local/sbin/gosu
      uid: 0
      gid: 0
accounts:
  root: true
  run-as: root
  users:
    - name: opensearch
      uid: 1000
      gid: 1000
    - name: _apt
      uid: 42
      gid: 65532
  groups:
    - name: opensearch
      gid: 1000
      members:
        - opensearch
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
work-dir: /usr/share/opensearch
environment:
  DEBIAN_FRONTEND: noninteractive
  HOME: /usr/share/opensearch
  JAVA_HOME: /opt/java/openjdk/21-jre
  LANG: en_US.UTF-8
  LANGUAGE: en_US:en
  LC_ALL: en_US.UTF-8
  OPENSEARCH_HOME: /usr/share/opensearch
  OPENSEARCH_PATH_CONF: /usr/share/opensearch/config
  PATH: /usr/share/opensearch/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
paths:
  - type: directory
    path: /usr/share/opensearch/data
    uid: 1000
    gid: 1000
    mode: "0755"
  - type: directory
    path: /usr/share/opensearch/logs
    uid: 1000
    gid: 1000
    mode: "0755"
annotations:
  org.opencontainers.image.description: A minimal OpenSearch image
  org.opencontainers.image.licenses: Apache-2.0
entrypoint:
  - /usr/local/bin/docker-entrypoint.sh
cmd:
  - opensearch
ports:
  - 9200/tcp
  - 9300/tcp
  - 9600/tcp
  - 9650/tcp
