# syntax=dhi/build:1-debian13

# DO NOT EDIT THIS FILE MANUALLY
# generated with 'dhi def merge image/fluentd/debian/1.19.yaml'

name: Fluentd 1.19.x
image: dhi/fluentd
variant: runtime
tags:
    - "1"
    - "1.19"
    - 1.19.1
    - 1-debian13
    - 1.19-debian13
    - 1.19.1-debian13
platforms:
    - linux/amd64
    - linux/arm64
vars:
    EXPAT_DIGEST: sha256:bf522255414eb53b8992e36dc64fde670d477c0b3be62c84209c4409de35e324
    EXPAT_VERSION: 2.7.3
    GEM_HOME: /usr/local/bundle
    JEMALLOC_VERSION: 5.3.0
    RUBY_DEV_DIGEST: sha256:f3c06301b536e31dba999bcf6f8fe033f882b1eae42e5525d0433f65b49bf10c
    RUBY_DEV_VERSION: 3.4.7
    RUBY_DIGEST: sha256:65361f864d67b3076a5014387e9bcc17e146e283e624aeca6213928a5f626ef5
    RUBY_VERSION: 3.4.8
    SEMVER_MAJOR_MINOR_VERSION: "1.19"
    SEMVER_MAJOR_VERSION: "1"
    SEMVER_VERSION: 1.19.1
    VERSION: 1.19.1
contents:
    packages:
        - '!libelogind0'
        - '!mawk'
        - '!original-awk'
        - base-files
        - bash
        - ca-certificates
        - coreutils
        - libcrypt1
        - libstdc++6
        - libyaml-0-2
        - tini
    builds:
        - name: jemalloc
          contents:
            packages:
                - bash
                - build-essential
                - coreutils
                - grep
                - libc-bin
                - sed
            files:
                - url: https://github.com/jemalloc/jemalloc/releases/download/5.3.0/jemalloc-5.3.0.tar.bz2
                  path: ${source.dir}/jemalloc.tar.bz2
                  spdx:
                    name: jemalloc
                    version: 5.3.0
                    packages:
                        - name: jemalloc
                          purl: pkg:dhi/jemalloc@5.3.0
                          license: MIT
                  uid: 0
                  gid: 0
          pipeline:
            - name: install jemalloc
              runs: |
                set -eux -o pipefail

                mkdir -p ${target.dir}/opt/jemalloc
                tar -xjf ${source.dir}/jemalloc.tar.bz2 -C ${target.dir}/opt/jemalloc --strip-components=1
                cd ${target.dir}/opt/jemalloc

                # Don't use MADV_FREE to reduce memory usage and improve stability
                # https://github.com/fluent/fluentd-docker-image/pull/350
                echo "je_cv_madv_free=no" > config.cache

                ncpus=$(getconf _NPROCESSORS_ONLN)
                ncpus=$((ncpus > 6 ? 6 : ncpus))

                ./configure -C
                make -j${ncpus}
          outputs:
            - source: ${target.dir}/opt/jemalloc/lib
              target: /usr/lib/libjemalloc
              uid: 0
              gid: 0
        - name: fluent
          uses: dhi/ruby:3.4.7-debian13-dev@sha256:f3c06301b536e31dba999bcf6f8fe033f882b1eae42e5525d0433f65b49bf10c
          privileged: true
          environment:
            BUNDLE_APP_CONFIG: ${BUNDLE_APP_CONFIG}
            BUNDLE_SILENCE_ROOT_WARNING: ${BUNDLE_SILENCE_ROOT_WARNING}
            GEM_HOME: /usr/local/bundle
            LD_LIBRARY_PATH: ${LD_LIBRARY_PATH}
          contents:
            packages:
                - bash
          pipeline:
            - name: install fluentd gem
              runs: |
                set -eux -o pipefail

                gem install oj
                gem install json
                gem install rexml
                gem install async
                gem install async-http
                gem install fluentd -v 1.19.1 --no-doc
            - name: cleanup
              runs: |
                set -eux -o pipefail

                for f in /usr/local/bundle/bin/*; do
                  [[ -f $f && ${f##*/} != fluentd ]] && rm -v $f
                done

                # Ensure fluentd remains!
                fluentd --version
          outputs:
            - source: /usr/local/bin
              target: /usr/local/bin
              uid: 0
              gid: 0
            - source: /usr/local/bundle
              target: /usr/local/bundle
              uid: 0
              gid: 0
            - source: /usr/local/include
              target: /usr/local/include
              uid: 0
              gid: 0
            - source: /opt/docker/sbom
              target: /opt/docker/sbom
              uid: 0
              gid: 0
    artifacts:
        - name: dhi/ruby:3.4.8-debian13@sha256:65361f864d67b3076a5014387e9bcc17e146e283e624aeca6213928a5f626ef5
          includes:
            - usr/**
          uid: 0
          gid: 0
accounts:
    run-as: nonroot
    users:
        - name: nonroot
          uid: 65532
          gid: 65532
    groups:
        - name: nonroot
          gid: 65532
          members:
            - nonroot
os-release:
    name: Docker Hardened Images (Debian)
    id: debian
    version-id: "13"
    version-codename: trixie
    pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
    home-url: https://docker.com/products/hardened-images/
    bug-report-url: https://docker.com/support/
environment:
    BUNDLE_APP_CONFIG: /usr/local/bundle
    BUNDLE_SILENCE_ROOT_WARNING: "true"
    GEM_HOME: /usr/local/bundle
    PATH: /usr/local/bundle/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
paths:
    - type: directory
      path: /etc/fluent
      uid: 0
      gid: 0
    - type: directory
      path: /etc/fluent/plugins
      uid: 0
      gid: 0
    - type: directory
      path: /var/log/fluent
      uid: 65532
      gid: 65532
      mode: "0755"
    - type: file
      path: /usr/local/bin/docker-entrypoint.sh
      uid: 0
      gid: 0
      mode: "0755"
      source: image/fluentd/bin/docker-entrypoint.sh
    - type: file
      path: /etc/fluent/fluent.conf
      uid: 0
      gid: 0
      mode: "0755"
      source: image/fluentd/config/fluent.conf
annotations:
    org.opencontainers.image.description: A minimal Fluentd image
    org.opencontainers.image.licenses: Apache-2.0
entrypoint:
    - /usr/bin/tini
    - --
    - /usr/local/bin/docker-entrypoint.sh
cmd:
    - fluentd
ports:
    - 24224/tcp
    - 5140/tcp
tests:
    - name: Run testcontainers tests
      directory: image/fluentd/tests
      commands:
        - go test . -count=1 -v
      exit-code: 0
