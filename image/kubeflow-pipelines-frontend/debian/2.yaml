# syntax=dhi.io/build:2-debian13

name: Kubeflow Pipelines Frontend 2.x
image: dhi.io/kubeflow-pipelines-frontend
variant: runtime
tags:
  - "2"
  - "2.15"
  - 2.15.0
  - 2-debian13
  - 2.15-debian13
  - 2.15.0-debian13
platforms:
  - linux/amd64
  - linux/arm64
vars:
  COMMIT_SHA: 8fe8d7bdd88f027bde080f619762a0b3294796db
  NODE_BUILD_REFERENCE: dhi/node:24.12.0-debian13-dev@sha256:0a90afadabdddcdd7e9eecef7048e5a0f1f45e6f165c2a035be091f1efd2255e
  NODE_RUNTIME_REFERENCE: dhi/node:24.12.0-debian13@sha256:e805d972f53c2db92cab8c56242ba8609736e461ef16d4073d52d5404263bbc9
  SEMVER_MAJOR_MINOR_VERSION: "2.15"
  SEMVER_MAJOR_VERSION: "2"
  SEMVER_VERSION: 2.15.0
  VERSION: 2.15.0
contents:
  packages:
    - '!libelogind0'
    - '!mawk'
    - '!original-awk'
    - base-files
  builds:
    - name: frontend
      uses: dhi.io/node:24.12.0-debian13-dev@sha256:0a90afadabdddcdd7e9eecef7048e5a0f1f45e6f165c2a035be091f1efd2255e
      contents:
        packages:
          - bash
        files:
          - url: git+https://github.com/kubeflow/pipelines.git#2.15.0
            checksum: 8fe8d7bdd88f027bde080f619762a0b3294796db
            path: ${source.dir}/kubeflow-pipelines
            spdx:
              name: kubeflow-pipelines
              version: 2.15.0
              packages:
                - name: kubeflow-pipelines
                  purl: pkg:github/kubeflow/pipelines@2.15.0#frontend
                  license: Apache-2.0
            uid: 0
            gid: 0
      pipeline:
        - name: move dev dependencies from prod (webui)
          work-dir: ${source.dir}/kubeflow-pipelines/frontend
          runs: |
            set -eux -o pipefail

            jq --argjson keys '["@craco/craco", "@types/lodash.groupby", "@types/pako", "http-proxy-middleware", "ts-proto"]' \
              '. |
                    ([.dependencies | to_entries[] | select(.key | IN($keys[]))]) as $dev
                | .dependencies |= ( . | delpaths($keys | group_by(.)))
              | .devDependencies |= . + ($dev | from_entries)
              | .overrides |= del(.express)' \
              package.json > tmp.json && mv tmp.json package.json
        - name: patch webserver
          uses: patch@v1
          with:
            dir: ${source.dir}/kubeflow-pipelines/frontend/server
            options: -p1
            patches:
              - ${source.dir}/patch/server/crypto-js.patch
              - ${source.dir}/patch/server/proxy-middleware.patch
        - name: bump webserver dependencies
          uses: npm/bump@v1
          privileged: true
          with:
            bumps: ${source.dir}/patch/server/npm-bumps.json
            npm-root: ${source.dir}/kubeflow-pipelines/frontend/server
        - name: bump webui dependencies
          uses: npm/bump@v1
          privileged: true
          with:
            bumps: ${source.dir}/patch/browser/npm-bumps.json
            npm-root: ${source.dir}/kubeflow-pipelines/frontend
        - name: build webui
          work-dir: ${source.dir}/kubeflow-pipelines/frontend
          privileged: true
          runs: |
            set -eux -o pipefail

            npm ci
            npm run build

            # Generate SBOM
            mkdir -p /opt/docker/sbom/kubeflow-pipelines-frontend
            npm sbom --omit=dev --omit=peer --package-lock-only --sbom-format=spdx \
              > /opt/docker/sbom/kubeflow-pipelines-frontend/.spdx.kubeflow-pipelines-frontend-browser.json
        - name: build webserver
          work-dir: ${source.dir}/kubeflow-pipelines/frontend/server
          shell: bash
          privileged: true
          runs: |
            set -eux -o pipefail

            npm install
            npm run build

            # Remove all dependencies and reinstall just the production ones
            rm -rf node_modules/*
            npm ci --omit=dev

            rm -rf server/integration-tests
        - name: install
          work-dir: ${source.dir}/kubeflow-pipelines/frontend
          runs: |
            set -eux -o pipefail

            cp -a build '${target.dir}/app'

            cp -a server/dist '${target.dir}/app/server'
            cp -a server/node_modules '${target.dir}/app/server/node_modules'

            install -T -m 0444 <(printf '8fe8d7bdd88f027bde080f619762a0b3294796db') \
              ${target.dir}/app/server/COMMIT_HASH
            install -T -m 0444 <(printf '2.15.0') \
              ${target.dir}/app/server/TAG_NAME
            install -T -m 0444 <(date -ud @${SOURCE_DATE_EPOCH} --rfc-3339=sec) \
              ${target.dir}/app/server/BUILD_DATE
      paths:
        - type: directory
          path: ${source.dir}/patch/server
          uid: 0
          gid: 0
          source: image/kubeflow-pipelines-frontend/patch/server
        - type: directory
          path: ${source.dir}/patch/browser
          uid: 0
          gid: 0
          source: image/kubeflow-pipelines-frontend/patch/browser
      outputs:
        - source: ${target.dir}/app
          target: /app
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/kubeflow-pipelines
          target: /opt/docker/sbom/kubeflow-pipelines
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/kubeflow-pipelines-frontend
          target: /opt/docker/sbom/kubeflow-pipelines-frontend
          uid: 0
          gid: 0
  artifacts:
    - name: dhi.io/node:24.12.0-debian13@sha256:e805d972f53c2db92cab8c56242ba8609736e461ef16d4073d52d5404263bbc9
      includes:
        - opt/**
        - usr/**
      uid: 0
      gid: 0
accounts:
  run-as: nonroot
  users:
    - name: nonroot
      uid: 65532
      gid: 65532
  groups:
    - name: nonroot
      gid: 65532
      members:
        - nonroot
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
annotations:
  org.opencontainers.image.description: A minimal Kubeflow Pipelines frontend image
  org.opencontainers.image.licenses: Apache-2.0
entrypoint:
  - node
cmd:
  - /app/server/server.js
  - /app
  - "3000"
