# syntax=dhi.io/build:1-debian13

name: Apache NiFi 2.7
image: dhi.io/nifi
variant: runtime
tags:
  - "2"
  - "2.7"
  - 2.7.2
  - 2-debian13
  - 2.7-debian13
  - 2.7.2-debian13
platforms:
  - linux/amd64
  - linux/arm64
dates:
  release: "2025-09-21"
vars:
  COMMIT_SHA: 098c97460988449ef4fba5508a83b20cc65ce9ab
  JAVA_HOME: /opt/java/openjdk/21-jre
  JAVA_MAJOR_VERSION: "21"
  JAVA_REFERENCE: dhi/eclipse-temurin:21.0.9.10-debian13@sha256:8be38a5a3942a69d6ac8a6040c54fb588b6fc29499fa44fec189d2438be4d6a8
  MAVEN_REFERENCE: dhi/maven:3.9.12-jdk21-debian13-dev@sha256:54dad2732e2c07f1377491e56c864c20635adf7ab2d60673a0e69455c3e1c947
  MAVEN_VERSION: 3.9.12
  NIFI_HOME: /opt/nifi/nifi-current
  PYTHON_REFERENCE: dhi/python:3.12.12-debian13@sha256:1269127ef2c19f4ebd94e95996ba085f5e8f36cf955163261ab735ff3ab779c2
  PYTHON_VERSION: 3.12.12
  SEMVER_MAJOR_MINOR_VERSION: "2.7"
  SEMVER_MAJOR_VERSION: "2"
  SEMVER_VERSION: 2.7.2
  UV_ARCH: '#{ target.arch == "amd64" ? "x86_64-unknown-linux-gnu" : "aarch64-unknown-linux-gnu" }'
  UV_VERSION: 0.9.22
  VERSION: 2.7.2
contents:
  packages:
    - '!libelogind0'
    - '!mawk'
    - '!original-awk'
    - base-files
    - bash
    - coreutils
    - grep
    - hostname
    - mawk
    - procps
    - sed
    - xmlstarlet
  builds:
    - name: nifi
      uses: dhi.io/maven:3.9.12-jdk21-debian13-dev@sha256:54dad2732e2c07f1377491e56c864c20635adf7ab2d60673a0e69455c3e1c947
      environment:
        MAVEN_OPTS: -Xmx2g -XX:ReservedCodeCacheSize=1g
      contents:
        packages:
          - bash
          - ca-certificates
          - coreutils
          - curl
          - git
          - gpg
          - gpg-agent
          - grep
          - gzip
          - jq
          - libstdc++6
          - tar
          - unzip
        files:
          - url: git+https://github.com/apache/nifi.git#rel/nifi-2.7.2
            checksum: 098c97460988449ef4fba5508a83b20cc65ce9ab
            path: ${source.dir}/nifi
            spdx:
              name: nifi
              version: 2.7.2
              packages:
                - name: nifi
                  purl: pkg:github/apache/nifi@2.7.2
                  license: Apache-2.0
            uid: 0
            gid: 0
          - url: https://github.com/astral-sh/uv/releases/download/0.9.22/uv-${UV_ARCH}.tar.gz
            checksum: https://github.com/astral-sh/uv/releases/download/0.9.22/uv-${UV_ARCH}.tar.gz.sha256
            path: ${source.dir}/uv-${UV_ARCH}.tar.gz
            spdx:
              name: uv-binary
              version: 0.9.22
              packages:
                - name: uv
                  purl: pkg:github/astral-sh/uv@0.9.22
                  license: MIT OR Apache-2.0
            uid: 0
            gid: 0
      pipeline:
        - name: setup uv
          runs: |
            set -eux -o pipefail

            # Create target directory first
            mkdir -p "${target.dir}/nifi-uv/.local/bin"

            # Extract UV binary to target location
            UV_TAR="${source.dir}/uv-${UV_ARCH}.tar.gz"
            UV_ARCH_DIR="uv-${UV_ARCH}"
            echo "Extracting UV binary from $UV_TAR"
            tar -xzf "$UV_TAR" -C "${target.dir}/nifi-uv/.local/bin" --strip-components=1 "${UV_ARCH_DIR}/uv"

            # Make binary executable
            chmod +x "${target.dir}/nifi-uv/.local/bin/uv"

            # Verify uv binary was installed correctly
            "${target.dir}/nifi-uv/.local/bin/uv" --version
        - name: patch
          uses: mvn/patch@v1
          with:
            mvn-root: ${source.dir}/nifi
            properties: ${source.dir}/patch/mvn-properties.json
        - name: patch email processors
          uses: mvn/patch@v1
          with:
            dependencies: ${source.dir}/patch/mvn-deps.json
            mvn-root: ${source.dir}/nifi/nifi-extension-bundles/nifi-email-bundle/nifi-email-processors
        - name: patch standard bundle
          uses: mvn/patch@v1
          with:
            dependencies: ${source.dir}/patch/mvn-deps.json
            mvn-root: ${source.dir}/nifi/nifi-extension-bundles/nifi-standard-bundle
        - name: git patch extension bundles
          uses: patch@v1
          work-dir: ${source.dir}/nifi
          with:
            options: -p1
            patches:
              - ${source.dir}/patch/jose4j.patch
        - name: build nifi web api
          work-dir: ${source.dir}/nifi/nifi-framework-bundle/nifi-framework/nifi-web/nifi-web-api
          privileged: true
          runs: |
            set -eux -o pipefail

            # Build NiFi-WebAPI
            mvn package -DskipTests
        - name: build nifi toolkit
          work-dir: ${source.dir}/nifi/nifi-toolkit
          privileged: true
          runs: |
            set -eux -o pipefail

            # Build NiFi-Toolkit
            mvn package -DskipTests
        - name: build nifi
          work-dir: ${source.dir}/nifi
          privileged: true
          runs: |
            set -eux -o pipefail

            # Build NiFi
            mvn package -DskipTests
        - name: extract nifi
          work-dir: ${source.dir}/nifi
          runs: |
            set -eux -o pipefail

            # Extract the built NiFi distribution
            nifi_dist=$(find nifi-assembly/target -name "nifi-*-bin.zip" | head -1)
            if [ -z "$nifi_dist" ]; then
                echo "unable to find nifi zip" 1>&2
                exit 1
            fi
            mkdir -p "${target.dir}/nifi/nifi-current"
            unzip "$nifi_dist" -d "${target.dir}/nifi/nifi-current"

            # Secure directory flattening
            shopt -s nullglob dotglob
            nifi_dirs=("${target.dir}"/nifi/nifi-current/nifi-[0-9]*.[0-9]*.[0-9]*)
            case ${#nifi_dirs[@]} in
                0) echo "Error: No NiFi directory found"; exit 1 ;;
                1) mv "${nifi_dirs[0]}"/* "${target.dir}/nifi/nifi-current/"; rmdir "${nifi_dirs[0]}" ;;
                *) echo "Error: Multiple NiFi directories found"; exit 1 ;;
            esac
        - name: extract nifi toolkit
          work-dir: ${source.dir}/nifi/nifi-toolkit
          runs: |
            set -eux -o pipefail

            TOOLKIT_DIST=$(find nifi-toolkit-assembly/target -name "nifi-toolkit-*-bin.zip" | head -1)
            mkdir -p "${target.dir}/nifi/nifi-toolkit-current"
            unzip "$TOOLKIT_DIST" -d "${target.dir}/nifi/nifi-toolkit-current"

            # Secure toolkit directory flattening
            shopt -s nullglob dotglob
            toolkit_dirs=("${target.dir}"/nifi/nifi-toolkit-current/nifi-toolkit-[0-9]*.[0-9]*.[0-9]*)
            case ${#toolkit_dirs[@]} in
                0) echo "Error: No NiFi toolkit directory found"; exit 1 ;;
                1) mv "${toolkit_dirs[0]}"/* "${target.dir}/nifi/nifi-toolkit-current/"; rmdir "${toolkit_dirs[0]}" ;;
                *) echo "Error: Multiple NiFi toolkit directories found"; exit 1 ;;
            esac
        - name: final setup
          runs: |
            set -eux -o pipefail

            # IMPORTANT: Order matters - set execute permissions before ownership changes
            # Step 1: Set executable permissions on root-owned files
            chmod +x "${target.dir}/nifi/nifi-current/bin/"*.sh
            chmod +x "${target.dir}/nifi/nifi-toolkit-current/bin/"*.sh

            # Step 2: Transfer conf ownership to runtime user for modifications
            chown -R 1000:1000 ${target.dir}/nifi/nifi-current/conf
            chmod -R u+rwX,g+rX,o+rX ${target.dir}/nifi/nifi-current/conf

            # Step 3: Set "other" permissions on root-owned bin files for user 1000 access
            chmod o+rX ${target.dir}/nifi/nifi-current/bin/*.sh
            chmod o+rX ${target.dir}/nifi/nifi-toolkit-current/bin/*.sh

            # NiFi lib directory - needed for bootstrap and runtime (read-only access)
            if [ -d "${target.dir}/nifi/nifi-current/lib" ]; then
              # Give nifi user read and execute access to lib directory and subdirectories
              chmod -R u+rX,g+rX,o+rX ${target.dir}/nifi/nifi-current/lib
            fi

            # NiFi toolkit lib directory - needed for CLI tool JAR access
            if [ -d "${target.dir}/nifi/nifi-toolkit-current/lib" ]; then
              # Give nifi user read and execute access to toolkit lib directory and subdirectories
              chmod -R u+rX,g+rX,o+rX ${target.dir}/nifi/nifi-toolkit-current/lib
            fi
      paths:
        - type: file
          path: /src/patch/mvn-properties.json
          uid: 0
          gid: 0
          source: image/nifi/patch/mvn-properties.json
        - type: file
          path: /src/patch/mvn-deps.json
          uid: 0
          gid: 0
          source: image/nifi/patch/mvn-deps.json
        - type: file
          path: /src/patch/jose4j.patch
          uid: 0
          gid: 0
          source: image/nifi/patch/jose4j.patch
      outputs:
        - source: ${target.dir}/nifi
          target: /opt/nifi
          uid: 0
          gid: 0
        - source: ${source.dir}/nifi/nifi-docker/dockerhub/sh
          target: /opt/nifi/scripts
          uid: 0
          gid: 0
          mode: "0755"
        - source: ${target.dir}/nifi-uv/.local
          target: /home/nifi/.local
          uid: 0
          gid: 0
    - name: locale
      uses: dhi.io/debian-base:trixie-debian13@sha256:c7651f9ef631e9a9feada59aff228f9382bdb537e85dc8e9c201093597898c45
      contents:
        packages:
          - bash
          - locales
          - coreutils
          - gzip
      pipeline:
        - name: install locales
          runs: |
            set -eux -o pipefail

            echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen
            locale-gen en_US.UTF-8
      outputs:
        - source: /usr/share/locale
          target: /usr/share/locale
          uid: 0
          gid: 0
        - source: /usr/lib/locale
          target: /usr/lib/locale
          uid: 0
          gid: 0
  artifacts:
    - name: dhi.io/eclipse-temurin:21.0.9.10-debian13@sha256:8be38a5a3942a69d6ac8a6040c54fb588b6fc29499fa44fec189d2438be4d6a8
      includes:
        - opt/**
      uid: 0
      gid: 0
    - name: dhi.io/python:3.12.12-debian13@sha256:1269127ef2c19f4ebd94e95996ba085f5e8f36cf955163261ab735ff3ab779c2
      includes:
        - opt/**
        - usr/**
      uid: 0
      gid: 0
accounts:
  run-as: nifi
  users:
    - name: nifi
      uid: 1000
      gid: 1000
  groups:
    - name: nifi
      gid: 1000
      members:
        - nifi
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
work-dir: /opt/nifi/nifi-current
environment:
  JAVA_HOME: /opt/java/openjdk/21-jre
  LANG: en_US.UTF-8
  LANGUAGE: en_US:en
  LC_ALL: en_US.UTF-8
  NIFI_HOME: /opt/nifi/nifi-current
  PATH: /home/nifi/.local/bin:/opt/nifi/bin:/opt/python/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
paths:
  - type: directory
    path: /home/nifi/.local
    uid: 0
    gid: 0
    mode: "0755"
    recursive: true
  - type: directory
    path: /home/nifi/.cache
    uid: 1000
    gid: 1000
    mode: "0755"
    recursive: true
  - type: directory
    path: /opt/nifi/nifi-current/logs
    uid: 1000
    gid: 1000
    mode: "0755"
  - type: directory
    path: /opt/nifi/nifi-current/run
    uid: 1000
    gid: 1000
    mode: "0755"
  - type: directory
    path: /opt/nifi/nifi-current/work
    uid: 1000
    gid: 1000
    mode: "0755"
  - type: directory
    path: /opt/nifi/nifi-current/content_repository
    uid: 1000
    gid: 1000
    mode: "0755"
  - type: directory
    path: /opt/nifi/nifi-current/database_repository
    uid: 1000
    gid: 1000
    mode: "0755"
  - type: directory
    path: /opt/nifi/nifi-current/flowfile_repository
    uid: 1000
    gid: 1000
    mode: "0755"
  - type: directory
    path: /opt/nifi/nifi-current/provenance_repository
    uid: 1000
    gid: 1000
    mode: "0755"
  - type: directory
    path: /opt/nifi/nifi-current/state
    uid: 1000
    gid: 1000
    mode: "0755"
  - type: directory
    path: /opt/nifi/nifi-current/python_extensions
    uid: 1000
    gid: 1000
    mode: "0755"
  - type: directory
    path: /opt/nifi/nifi-current/nar_extensions
    uid: 1000
    gid: 1000
    mode: "0755"
annotations:
  org.opencontainers.image.description: A minimal Apache NiFi image built from source
  org.opencontainers.image.licenses: Apache-2.0
entrypoint:
  - /opt/nifi/scripts/start.sh
ports:
  - "8443"
  - "10000"
  - "8000"
tests:
  - name: Run testcontainers tests
    directory: image/nifi/tests
    commands:
      - go test . -count=1 -v
    exit-code: 0
  - name: Run testcontainers basic tests
    directory: test/go-testing/base
    commands:
      - go test . -count=1 -v
    exit-code: 0
  - name: Run locales tests
    directory: test/go-testing/locales
    commands:
      - go test . -count=1 -v
    exit-code: 0
