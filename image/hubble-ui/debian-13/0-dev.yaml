# syntax=dhi.io/build:2-debian13

name: Cilium Hubble UI 0.x (dev)
image: dhi.io/hubble-ui
variant: dev
tags:
  - 0-dev
  - 0.13-dev
  - 0.13.3-dev
  - 0-debian13-dev
  - 0.13-debian13-dev
  - 0.13.3-debian13-dev
platforms:
  - linux/amd64
  - linux/arm64
vars:
  BASE_DIGEST: sha256:74fc43fa240887b8159970e434244039aab0c6efaaa9cf044004cdc22aa2a34d
  BASE_TAG: 20250419-debian13
  COMMIT_SHA: 3ef88cd8b72b698c3643e7c2f584165b613659a5
  NGINX_REFERENCE: dhi/nginx:1.29.4-debian13@sha256:3b341cd0cffb638496bc3d9536bef7f7cffeca23173b0a0c184dee03417ce07b
  NODE_BUILD_REFERENCE: dhi/node:22.22.0-debian13-dev@sha256:7391687c0ebc6ddacb1be52bee3c05e19a213f483f87fc6a5fc1af1140aaf283
  SEMVER_MAJOR_MINOR_VERSION: "0.13"
  SEMVER_MAJOR_VERSION: "0"
  SEMVER_VERSION: 0.13.3
  VERSION: 0.13.3
contents:
  packages:
    - '!gawk'
    - '!libelogind0'
    - '!mawk'
    - '!original-awk'
    - apt
    - base-files
    - base-passwd
    - bash
    - ca-certificates
    - coreutils
    - diffutils
    - dpkg
    - findutils
    - grep
    - libc-bin
    - mawk
    - perl-base
    - sed
    - util-linux
  builds:
    - name: hubble-ui
      uses: dhi.io/node:22.22.0-debian13-dev@sha256:7391687c0ebc6ddacb1be52bee3c05e19a213f483f87fc6a5fc1af1140aaf283
      contents:
        files:
          - url: git+https://github.com/cilium/hubble-ui.git#v0.13.3
            checksum: 3ef88cd8b72b698c3643e7c2f584165b613659a5
            path: ${source.dir}/hubble-ui
            spdx:
              name: hubble-ui
              version: 0.13.3
              packages:
                - name: hubble-ui
                  purl: pkg:github/cilium/hubble-ui@v0.13.3
                  license: Apache-2.0
            uid: 0
            gid: 0
      pipeline:
        - name: build hubble-ui
          work-dir: ${source.dir}/hubble-ui
          privileged: true
          runs: |
            set -eux -o pipefail

            # Install dependencies
            npm ci

            NODE_ENV=production npm run build

            # Copy built files to target
            mkdir -p "${target.dir}/app"
            cp -r server/public/* "${target.dir}/app/"
        - name: prepare for sbom
          work-dir: ${source.dir}/hubble-ui
          runs: |
            set -eux -o pipefail

            # Add version to package.json for SBOM generation
            tmp=$(mktemp)
            jq --arg version "0.13.3" '.version = $version' package.json > "$tmp" && mv "$tmp" package.json
        - name: bump dependencies
          uses: npm/bump@v1
          work-dir: ${source.dir}/hubble-ui
          privileged: true
          with:
            bumps: ${source.dir}/patch/npm-bumps.json
            npm-root: ${source.dir}/hubble-ui
        - name: reinstall dependencies for sbom
          work-dir: ${source.dir}/hubble-ui
          privileged: true
          runs: |
            set -eux -o pipefail

            # Clean and reinstall only production dependencies for accurate SBOM
            rm -rf node_modules
            npm install --omit=dev --ignore-scripts
        - name: generate sbom
          uses: sbom@v1
          with:
            prefix: hubble-ui
            source: ${source.dir}/hubble-ui
      paths:
        - type: directory
          path: ${source.dir}/patch
          uid: 0
          gid: 0
          source: image/hubble-ui/patch
      outputs:
        - source: ${target.dir}/app
          target: /app
          uid: 65532
          gid: 65532
          mode: "0755"
        - source: /opt/docker/sbom/hubble-ui
          target: /opt/docker/sbom/hubble-ui
          uid: 0
          gid: 0
accounts:
  root: true
  run-as: root
  users:
    - name: nginx
      uid: 65532
      gid: 65532
    - name: _apt
      uid: 42
      gid: 65532
  groups:
    - name: nginx
      gid: 65532
      members:
        - nginx
    - name: www-data
      gid: 82
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
environment:
  DEBIAN_FRONTEND: noninteractive
paths:
  - type: directory
    path: /var/run
    uid: 65532
    gid: 65532
    mode: "0777"
  - type: directory
    path: /var/cache/nginx
    uid: 65532
    gid: 65532
    mode: "0777"
  - type: file
    path: /etc/nginx/conf.d/default.conf
    uid: 0
    gid: 0
    mode: "0644"
    source: image/hubble-ui/config/default.conf
annotations:
  org.opencontainers.image.description: A minimal Cilium Hubble UI image
  org.opencontainers.image.licenses: Apache-2.0
entrypoint:
  - nginx
cmd:
  - -g
  - daemon off;
ports:
  - 8080/tcp
