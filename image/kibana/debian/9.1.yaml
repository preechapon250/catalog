# syntax=dhi/build:1-debian13

# DO NOT EDIT THIS FILE MANUALLY
# generated with 'dhi def merge image/kibana/debian/9.1.yaml'

name: Kibana 9.1.x
image: dhi/kibana
variant: runtime
tags:
    - "9.1"
    - 9.1.9
    - 9.1-debian13
    - 9.1.9-debian13
platforms:
    - linux/amd64
    - linux/arm64
dates:
    release: "2025-07-23"
vars:
    ARCH: '#{ target.arch == "amd64" ? "amd64" : "arm64" }'
    COMMIT_SHA: 126c439648663caa7554075ebc3d1e9a6f8ad93c
    GO_ARCH: '#{ target.arch == "amd64" ? "x86_64" : "aarch64" }'
    NODE_ARCH: '#{ target.arch == "amd64" ? "x64" : "arm64" }'
    NODE_DIGEST: sha256:9f2cc2b28df3ddcbf95208b8bd18df85fdc2ef63fc89b2a8bd2e9ec31731f873
    NODE_MAJOR_VERSION: "22"
    NODE_VERSION: 22.21.1
    SEMVER_MAJOR_MINOR_VERSION: "9.1"
    SEMVER_MAJOR_VERSION: "9"
    SEMVER_VERSION: 9.1.9
    VERSION: 9.1.9
contents:
    packages:
        - '!libelogind0'
        - '!mawk'
        - '!original-awk'
        - base-files
        - bash
        - coreutils
        - findutils
        - grep
        - libstdc++6
        - tini
    builds:
        - name: kibana
          uses: dhi/node:22.21.1-debian13-dev@sha256:9f2cc2b28df3ddcbf95208b8bd18df85fdc2ef63fc89b2a8bd2e9ec31731f873
          contents:
            packages:
                - bash
                - jq
            files:
                - url: git+https://github.com/elastic/kibana.git#v9.1.9
                  checksum: 126c439648663caa7554075ebc3d1e9a6f8ad93c
                  path: ${source.dir}/kibana
                  spdx:
                    name: kibana
                    version: 9.1.9
                    packages:
                        - name: kibana
                          purl: pkg:dhi/kibana@9.1.9
                          license: Apache-2.0
                  uid: 65532
                  gid: 65532
          pipeline:
            - name: update node engine
              work-dir: ${source.dir}/kibana
              runs: |
                set -eux -o pipefail

                # Upstream pins a patch version of Node, which may not receive security-related updates,
                # so update this requirement to the current version of Node.

                # First, check the major version of Node against the build version;
                # this prevents unintentional major version bumps
                REQUIRED_VERSION=$(sed -nr "s/\"node\": \"([0-9]+)\.[0-9]+\.[0-9]+\".*/\1/p" package.json | tr -d " ")
                if [ "$REQUIRED_VERSION" != "22" ]; then
                  echo "Error: upstream requirement for Node v$REQUIRED_VERSION not met by build v22."
                  echo "Error: if version change is intentional, update this version verification logic."
                  exit 1
                fi

                # Then, update the "engines.node" requirement to reference the current Node build version;
                # otherwise the upstream version check logic will fail
                sed -ir "s/\"node\": \"[0-9]\+\.[0-9]\+\.[0-9]\+\"/\"node\": \"22.21.1\"/g" package.json
            - name: add yarn resolutions
              work-dir: ${source.dir}/kibana
              runs: |
                set -eux -o pipefail

                # Update tar-fs to fix CVE-2025-59343
                # We are using Yarn resolutions here because there are two different major versions of tar-fs in the yarn.lock.
                # But we only want to upgrade the vulnerable one that is included in the final image.
                jq '.resolutions //= {} | .resolutions += { "@puppeteer/browsers/tar-fs": "^3.1.1", "geckodriver/tar-fs": "^3.1.1", "sharp/tar-fs": "^3.1.1" }' package.json > tmp.json && mv tmp.json package.json
            - name: bump yarn deps (9.1)
              uses: yarn/patch@v1
              privileged: true
              with:
                patches: ${source.dir}/patches/yarn-patches_9.1.json
                yarn-root: ${source.dir}/kibana
            - name: remove dangling packages
              work-dir: ${source.dir}/kibana
              privileged: true
              runs: |
                set -eux -o pipefail

                yarn remove expr-eval
            - name: git patch elasticsearch
              uses: git/patch@v1
              with:
                dir: ${source.dir}/kibana
                patch: ${source.dir}/patches/expr-eval_9.1.patch
            - name: build kibana
              work-dir: ${source.dir}/kibana
              privileged: true
              runs: |
                set -eux -o pipefail

                echo "startup --batch" > .bazelrc.user

                yarn kbn bootstrap

                # Symlink the build system's Node to the `.node_binaries` directory, since
                # Kibana bundles Node alongside its application code. The build system will
                # grab a license and `bin` files from Node to bundle in the final app dir.
                # Note: There's a hardcoded dependency on `linux-x64` directory in the build tooling
                # when it gathers package info to create NOTICE.txt, so create that directory always,
                # regardless of arch.
                mkdir -p "${source.dir}/kibana/.node_binaries/22.21.1/glibc-217/linux-x64"
                ln -s "/opt/nodejs/node-v22.21.1" "${source.dir}/kibana/.node_binaries/22.21.1/glibc-217/linux-x64/extract"
                if [ ${NODE_ARCH} != "x64" ]; then
                  mkdir -p "${source.dir}/kibana/.node_binaries/22.21.1/glibc-217/linux-${NODE_ARCH}"
                  ln -s "/opt/nodejs/node-v22.21.1" "${source.dir}/kibana/.node_binaries/22.21.1/glibc-217/linux-${NODE_ARCH}/extract"
                fi

                # 1. Invoke the build script directly (instead of using "yarn build"), since the option to
                # build the application for all platforms is hard-coded in "yarn build".
                # 2. The initializing logic of Kibana's internal tooling will check the required Node version,
                # download a version of Node, and verify the checksums of the downloaded binaries. These steps
                # are not needed for our build environment, since Node is already present. This behavior is
                # disabled with `--skip-initialize`. Other builds that aren't needed for this image are disabled
                # with the other `--skip` options.
                node --no-experimental-require-module -- \
                  scripts/build --skip-os-packages --skip-initialize \
                  --skip-docker-cloud-fips --skip-docker-contexts --skip-docker-ubi \
                  --skip-docker-wolfi --skip-docker-cloud --skip-docker-cloud-fips \
                  --skip-docker-serverless --skip-docker-fips

                mkdir -p "${target.dir}/opt/kibana/kibana-9.1.9"

                cp -r "${source.dir}/kibana/build/default/kibana-9.1.9-SNAPSHOT-linux-${GO_ARCH}"/* "${target.dir}/opt/kibana/kibana-9.1.9"

                cd "${target.dir}/opt/kibana/kibana-9.1.9"
                rm -rf data
          paths:
            - type: file
              path: ${source.dir}/patches/yarn-patches_9.1.json
              uid: 65532
              gid: 65532
              mode: "0444"
              source: image/kibana/patch/yarn-patches_9.1.json
            - type: file
              path: ${source.dir}/patches/yarn-patches_9.2.json
              uid: 65532
              gid: 65532
              mode: "0444"
              source: image/kibana/patch/yarn-patches_9.2.json
            - type: file
              path: ${source.dir}/patches/expr-eval_9.1.patch
              uid: 65532
              gid: 65532
              mode: "0444"
              source: image/kibana/patch/expr-eval_9.1.patch
          accounts:
            run-as: node
            users:
                - name: node
                  uid: 65532
                  gid: 65532
          outputs:
            - source: ${target.dir}/opt/kibana/kibana-9.1.9
              target: /opt/kibana/kibana-9.1.9
              uid: 0
              gid: 0
            - source: /opt/docker/sbom/kibana
              target: /opt/docker/sbom/kibana
              uid: 0
              gid: 0
accounts:
    run-as: nonroot
    users:
        - name: nonroot
          uid: 65532
          gid: 65532
    groups:
        - name: nonroot
          gid: 65532
          members:
            - nonroot
os-release:
    name: Docker Hardened Images (Debian)
    id: debian
    version-id: "13"
    version-codename: trixie
    pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
    home-url: https://docker.com/products/hardened-images/
    bug-report-url: https://docker.com/support/
environment:
    ELASTIC_CONTAINER: "true"
    KIBANA_VERSION: 9.1.9
    PATH: /opt/kibana/kibana-9.1.9/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
paths:
    - type: directory
      path: /usr/share
      uid: 0
      gid: 0
      mode: "0755"
    - type: symlink
      path: /usr/share/kibana
      uid: 0
      gid: 0
      source: /opt/kibana/kibana-9.1.9
    - type: directory
      path: /opt/kibana/kibana-9.1.9/data
      uid: 65532
      gid: 65532
      mode: "0755"
    - type: file
      path: /usr/local/bin/kibana-docker
      uid: 0
      gid: 0
      mode: "0755"
      source: image/kibana/bin/kibana-docker
    - type: file
      path: /opt/kibana/kibana-9.1.9/config/kibana.yml
      uid: 65532
      gid: 65532
      mode: "0644"
      source: image/kibana/config/kibana.yml
    - type: symlink
      path: /usr/local/bin/tini
      uid: 0
      gid: 0
      source: /usr/bin/tini
annotations:
    org.opencontainers.image.description: A minimal Kibana image
    org.opencontainers.image.licenses: Elastic-License-2.0
entrypoint:
    - /usr/local/bin/tini
    - --
cmd:
    - /usr/local/bin/kibana-docker
ports:
    - 5601/tcp
tests:
    - name: Run testcontainers tests
      directory: image/kibana/tests
      commands:
        - go test . -count=1 -v
      exit-code: 0
