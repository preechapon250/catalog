# syntax=dhi.io/build:1-debian12

name: Temporal UI 2.x
image: dhi.io/temporalio-ui
variant: runtime
tags:
  - 2.44-debian12
  - 2.44.0-debian12
platforms:
  - linux/amd64
  - linux/arm64
vars:
  COMMIT_SHA: d6aaa3381530ee17620959b26981865223decab6
  DEBIAN_VERSION: "12"
  DOCKERIZE_COMMIT_SHA: 90dbb4fc2ef9098acd41e8c3ca98d2f730c741d6
  DOCKERIZE_VERSION: 0.9.5
  GO_REFERENCE: dhi/golang:1.24.11-debian12-dev@sha256:b735e718818bc18ea91d9068a70518f44f06d00f4ba0f201ec46307087cb00aa
  GO_VERSION: 1.24.11
  NODE_REFERENCE: dhi/node:24.12.0-debian12-dev@sha256:3cd51cdb63f4b9605984e7c4a0b3b945f825e465589f53c16be62fd6b65a4c05
  NODE_VERSION: 24.12.0
  SEMVER_MAJOR_MINOR_VERSION: "2.44"
  SEMVER_MAJOR_VERSION: "2"
  SEMVER_VERSION: 2.44.0
  VERSION: 2.44.0
contents:
  packages:
    - '!libelogind0'
    - '!original-awk'
    - base-files
    - bash
    - ca-certificates
    - tzdata
  builds:
    - name: build-ui
      uses: dhi.io/golang:1.24.11-debian12-dev@sha256:b735e718818bc18ea91d9068a70518f44f06d00f4ba0f201ec46307087cb00aa
      contents:
        packages:
          - bash
        files:
          - url: git+https://github.com/temporalio/ui.git#v2.44.0
            checksum: d6aaa3381530ee17620959b26981865223decab6
            path: ${source.dir}/ui
            spdx:
              name: temporalio-ui
              version: 2.44.0
              packages:
                - name: temporalio-ui
                  purl: pkg:dhi/temporalio-ui@2.44.0
                  license: MIT
            uid: 0
            gid: 0
        artifacts:
          - name: dhi.io/node:24.12.0-debian12-dev@sha256:3cd51cdb63f4b9605984e7c4a0b3b945f825e465589f53c16be62fd6b65a4c05
            includes:
              - opt/nodejs
              - usr/local/bin
            uid: 0
            gid: 0
      pipeline:
        - name: bump golang.org/x/crypto
          uses: go/bump@v1
          work-dir: ${source.dir}/ui/server
          with:
            deps:
              - golang.org/x/crypto@v0.45.0
            download: true
        - name: bump pnpm
          work-dir: ${source.dir}/ui
          privileged: true
          runs: |
            set -eux -o pipefail

            npm pkg set pnpm.overrides.cookie=0.7.0
            npm pkg set pnpm.overrides.validator=13.15.20
            npm pkg set pnpm.overrides.esbuild=0.27.0
            npm pkg set pnpm.overrides.valibot=1.2.0      # CVE-2025-66020
            npm pkg set pnpm.overrides.validator=13.15.22 # CVE-2025-12758

            pnpm update babel/runtime@7.26.10
        - name: install dependencies
          work-dir: ${source.dir}/ui
          privileged: true
          runs: |
            set -eux -o pipefail

            pnpm install
        - name: build ui assets
          work-dir: ${source.dir}/ui
          runs: |
            set -eux -o pipefail

            pnpm build:server
        - name: build ui server
          work-dir: ${source.dir}/ui
          runs: |
            set -eux -o pipefail

            # Link in standard location.
            mkdir -p /go/src/github.com/temporalio/ui-server
            ln -s "${source.dir}/ui/server" /go/src/github.com/temporalio/ui-server/v2
            cd /go/src/github.com/temporalio/ui-server/v2

            # Build UI server binary
            CGO_ENABLED=0 go build -o ${target.dir}/home/ui-server/ui-server ./cmd/server/main.go
        - name: remove dev assets
          work-dir: ${source.dir}/ui
          runs: |
            set -eux -o pipefail

            pnpm prune --prod --ignore-scripts
        - name: ui sbom
          uses: sbom@v1
          with:
            extra-scanners: javascript-package-cataloger
            prefix: temporalio-ui-server
            source: ${source.dir}/ui/node_modules
      outputs:
        - source: ${target.dir}/home/ui-server/ui-server
          target: /home/ui-server/ui-server
          uid: 0
          gid: 0
        - source: ${source.dir}/ui/server/docker/start-ui-server.sh
          target: /home/ui-server/start-ui-server.sh
          uid: 0
          gid: 0
          mode: "755"
        - source: ${source.dir}/ui/server/config
          target: /home/ui-server/config
          uid: 0
          gid: 0
        - source: ${source.dir}/ui/server/ui/assets
          target: /home/ui-server/ui/assets
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/temporalio-ui
          target: /opt/docker/sbom/temporalio-ui
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/temporalio-ui-server
          target: /opt/docker/sbom/temporalio-ui-server
          uid: 0
          gid: 0
    - name: build-base-dockerize
      uses: dhi.io/golang:1.24.11-debian12-dev@sha256:b735e718818bc18ea91d9068a70518f44f06d00f4ba0f201ec46307087cb00aa
      contents:
        packages:
          - bash
        files:
          - url: git+https://github.com/jwilder/dockerize.git#v0.9.5
            checksum: 90dbb4fc2ef9098acd41e8c3ca98d2f730c741d6
            path: /go/src/github.com/jwilder/dockerize
            spdx:
              name: dockerize
              version: 0.9.5
              packages:
                - name: dockerize
                  purl: pkg:golang/github.com/jwilder/dockerize@0.9.5
                  license: MIT
            uid: 0
            gid: 0
      pipeline:
        - name: update go dependencies
          uses: go/bump@v1
          work-dir: /go/src/github.com/jwilder/dockerize
          with:
            deps:
              - golang.org/x/crypto@v0.45.0
            download: true
        - name: build dockerize
          work-dir: /go/src/github.com/jwilder/dockerize
          runs: |
            set -eux -o pipefail

            CGO_ENABLED=0 go build -o ${target.dir}/usr/local/bin/dockerize
      outputs:
        - source: ${target.dir}/usr/local/bin/dockerize
          target: /usr/local/bin/dockerize
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/dockerize
          target: /opt/docker/sbom/dockerize
          uid: 0
          gid: 0
accounts:
  run-as: temporal
  users:
    - name: temporal
      uid: 5000
      gid: 5000
  groups:
    - name: temporal
      gid: 5000
      members:
        - temporal
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "12"
  version-codename: bookworm
  pretty-name: Docker Hardened Images/Debian GNU/Linux 12 (bookworm)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
work-dir: /home/ui-server
environment:
  TEMPORAL_CLOUD_UI: "false"
paths:
  - type: directory
    path: /home/ui-server/config
    uid: 5000
    gid: 5000
    mode: "0755"
  - type: directory
    path: /etc/temporal/config/
    uid: 5000
    gid: 5000
annotations:
  org.opencontainers.image.description: Temporal UI - Web interface for Temporal workflow management
  org.opencontainers.image.licenses: MIT
entrypoint:
  - /home/ui-server/start-ui-server.sh
ports:
  - 8080/tcp
tests:
  - name: Run testcontainers tests for the web service
    directory: image/temporalio-ui/tests
    commands:
      - go test . -count=1 -v
    exit-code: 0
  - name: Run common testcontainers tests
    directory: test/go-testing/base
    commands:
      - go test . -count=1 -v
    exit-code: 0
