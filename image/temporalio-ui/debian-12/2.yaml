# syntax=dhi.io/build:2-debian12

name: Temporal UI 2.x
image: dhi.io/temporalio-ui
variant: runtime
tags:
  - 2.44-debian12
  - 2.44.1-debian12
platforms:
  - linux/amd64
  - linux/arm64
vars:
  COMMIT_SHA: 8537bf45a48e52cf8ab0b3c16bf4c04bf9099666
  DEBIAN_VERSION: "12"
  DOCKERIZE_COMMIT_SHA: 90dbb4fc2ef9098acd41e8c3ca98d2f730c741d6
  DOCKERIZE_VERSION: 0.9.5
  GO_REFERENCE: dhi/golang:1.24.11-debian12-dev@sha256:2d6fa073cf359a0a7db5e5b81a78bbdd8a144a028acb9e73421c638437b26d58
  GO_VERSION: 1.24.11
  NODE_REFERENCE: dhi/node:24.13.0-debian12-dev@sha256:73c6e15d18ab107b249f5f2719c92aa61a356b88057e811df52fe2e456615f25
  NODE_VERSION: 24.13.0
  SEMVER_MAJOR_MINOR_VERSION: "2.44"
  SEMVER_MAJOR_VERSION: "2"
  SEMVER_VERSION: 2.44.1
  VERSION: 2.44.1
contents:
  packages:
    - '!libelogind0'
    - '!original-awk'
    - base-files
    - bash
    - ca-certificates
    - tzdata
  builds:
    - name: build-ui
      uses: dhi.io/golang:1.24.11-debian12-dev@sha256:2d6fa073cf359a0a7db5e5b81a78bbdd8a144a028acb9e73421c638437b26d58
      contents:
        packages:
          - bash
        files:
          - url: git+https://github.com/temporalio/ui.git#v2.44.1
            checksum: 8537bf45a48e52cf8ab0b3c16bf4c04bf9099666
            path: ${source.dir}/ui
            spdx:
              name: temporalio-ui
              version: 2.44.1
              packages:
                - name: temporalio-ui
                  purl: pkg:dhi/temporalio-ui@2.44.1
                  license: MIT
            uid: 0
            gid: 0
        artifacts:
          - name: dhi.io/node:24.13.0-debian12-dev@sha256:73c6e15d18ab107b249f5f2719c92aa61a356b88057e811df52fe2e456615f25
            includes:
              - opt/nodejs
              - usr/local/bin
            uid: 0
            gid: 0
      pipeline:
        - name: bump golang.org/x/crypto
          uses: go/bump@v1
          work-dir: ${source.dir}/ui/server
          with:
            deps:
              - golang.org/x/crypto@v0.45.0
            download: true
        - name: bump pnpm
          work-dir: ${source.dir}/ui
          privileged: true
          runs: |
            set -eux -o pipefail

            npm pkg set pnpm.overrides.cookie=0.7.0
            npm pkg set pnpm.overrides.validator=13.15.20
            npm pkg set pnpm.overrides.esbuild=0.27.0
            npm pkg set pnpm.overrides.valibot=1.2.0                  # CVE-2025-66020
            npm pkg set pnpm.overrides.validator=13.15.22             # CVE-2025-12758
            npm pkg set pnpm.overrides.qs=6.14.1                      # CVE-2025-15284
            npm pkg set pnpm.overrides.devalue=5.6.2                  # CVE-2026-22774, CVE-2026-22775
            npm pkg set pnpm.overrides."@octokit/endpoint"=10.1.3     # CVE-2025-25285
            npm pkg set pnpm.overrides."@octokit/request-error"=6.1.7 # CVE-2025-25289

            pnpm update babel/runtime@7.26.10
        - name: install dependencies
          work-dir: ${source.dir}/ui
          privileged: true
          runs: |
            set -eux -o pipefail

            pnpm install
        - name: build ui assets
          work-dir: ${source.dir}/ui
          runs: |
            set -eux -o pipefail

            pnpm build:server
        - name: build ui server
          work-dir: ${source.dir}/ui
          runs: |
            set -eux -o pipefail

            # Link in standard location.
            mkdir -p /go/src/github.com/temporalio/ui-server
            ln -s "${source.dir}/ui/server" /go/src/github.com/temporalio/ui-server/v2
            cd /go/src/github.com/temporalio/ui-server/v2

            # Build UI server binary
            CGO_ENABLED=0 go build -o ${target.dir}/home/ui-server/ui-server ./cmd/server/main.go
        - name: remove dev assets
          work-dir: ${source.dir}/ui
          runs: |
            set -eux -o pipefail

            pnpm prune --prod --ignore-scripts
        - name: ui sbom
          uses: sbom@v1
          with:
            extra-scanners: javascript-package-cataloger
            prefix: temporalio-ui-server
            source: ${source.dir}/ui/node_modules
      outputs:
        - source: ${target.dir}/home/ui-server/ui-server
          target: /home/ui-server/ui-server
          uid: 0
          gid: 0
        - source: ${source.dir}/ui/server/docker/start-ui-server.sh
          target: /home/ui-server/start-ui-server.sh
          uid: 0
          gid: 0
          mode: "755"
        - source: ${source.dir}/ui/server/config
          target: /home/ui-server/config
          uid: 0
          gid: 0
        - source: ${source.dir}/ui/server/ui/assets
          target: /home/ui-server/ui/assets
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/temporalio-ui
          target: /opt/docker/sbom/temporalio-ui
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/temporalio-ui-server
          target: /opt/docker/sbom/temporalio-ui-server
          uid: 0
          gid: 0
    - name: build-base-dockerize
      uses: dhi.io/golang:1.24.11-debian12-dev@sha256:2d6fa073cf359a0a7db5e5b81a78bbdd8a144a028acb9e73421c638437b26d58
      contents:
        packages:
          - bash
        files:
          - url: git+https://github.com/jwilder/dockerize.git#v0.9.5
            checksum: 90dbb4fc2ef9098acd41e8c3ca98d2f730c741d6
            path: /go/src/github.com/jwilder/dockerize
            spdx:
              name: dockerize
              version: 0.9.5
              packages:
                - name: dockerize
                  purl: pkg:golang/github.com/jwilder/dockerize@0.9.5
                  license: MIT
            uid: 0
            gid: 0
      pipeline:
        - name: update go dependencies
          uses: go/bump@v1
          work-dir: /go/src/github.com/jwilder/dockerize
          with:
            deps:
              - golang.org/x/crypto@v0.45.0
            download: true
        - name: build dockerize
          work-dir: /go/src/github.com/jwilder/dockerize
          runs: |
            set -eux -o pipefail

            CGO_ENABLED=0 go build -o ${target.dir}/usr/local/bin/dockerize
      outputs:
        - source: ${target.dir}/usr/local/bin/dockerize
          target: /usr/local/bin/dockerize
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/dockerize
          target: /opt/docker/sbom/dockerize
          uid: 0
          gid: 0
accounts:
  run-as: temporal
  users:
    - name: temporal
      uid: 5000
      gid: 5000
  groups:
    - name: temporal
      gid: 5000
      members:
        - temporal
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "12"
  version-codename: bookworm
  pretty-name: Docker Hardened Images/Debian GNU/Linux 12 (bookworm)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
work-dir: /home/ui-server
environment:
  TEMPORAL_CLOUD_UI: "false"
paths:
  - type: directory
    path: /home/ui-server/config
    uid: 5000
    gid: 5000
    mode: "0755"
  - type: directory
    path: /etc/temporal/config/
    uid: 5000
    gid: 5000
annotations:
  org.opencontainers.image.description: Temporal UI - Web interface for Temporal workflow management
  org.opencontainers.image.licenses: MIT
entrypoint:
  - /home/ui-server/start-ui-server.sh
ports:
  - 8080/tcp
