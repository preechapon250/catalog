# syntax=dhi/build:1-alpine3.22

# DO NOT EDIT THIS FILE MANUALLY
# generated with 'dhi def merge image/php/alpine/8.3-dev.yaml'

name: PHP 8.3.x (dev)
image: dhi/php
variant: dev
tags:
    - 8.3-alpine3.22-dev
    - 8.3.29-alpine3.22-dev
platforms:
    - linux/amd64
    - linux/arm64
dates:
    release: "2023-11-23"
    end-of-life: "2027-12-31"
vars:
    CFLAGS: -fstack-protector-strong -fpic -fpie -O2 -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64
    CHECKSUM: f7950ca034b15a78f5de9f1b22f4d9bad1dd497114d175cb1672a4ca78077af5
    CPPFLAGS: -fstack-protector-strong -fpic -fpie -O2 -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64
    LDFLAGS: -Wl,-O1 -pie
    PHP_INI_DIR: /opt/php-8.3/etc/php
    PHP_PREFIX: /opt/php-8.3
    PHP_SRC_DIR: /opt/php-8.3/src
    SEMVER_MAJOR_MINOR_VERSION: "8.3"
    SEMVER_MAJOR_VERSION: "8"
    SEMVER_VERSION: 8.3.29
    VERSION: 8.3.29
contents:
    repositories:
        - https://dl-cdn.alpinelinux.org/alpine/v3.22/main
        - https://dl-cdn.alpinelinux.org/alpine/v3.22/community
    packages:
        - alpine-baselayout-data
        - apk-tools
        - argon2-libs
        - autoconf
        - bison
        - busybox
        - ca-certificates-bundle
        - curl
        - file
        - g++
        - gcc
        - gzip
        - icu-data-full
        - icu-libs
        - libc-dev
        - libcrypto3
        - libcurl
        - libsodium
        - libssl3
        - libtool
        - libxml2
        - make
        - oniguruma
        - pcre2
        - pkgconf
        - re2c
        - readline
        - sqlite-libs
        - tar
        - zlib
    builds:
        - name: php
          shell: bash
          environment:
            CFLAGS: -fstack-protector-strong -fpic -fpie -O2 -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64
            CPPFLAGS: -fstack-protector-strong -fpic -fpie -O2 -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64
            LDFLAGS: -Wl,-O1 -pie
            PHP_BUILD_PROVIDER: https://github.com/docker-hardened-images/definitions
            PHP_UNAME: Linux - Docker Hardened Images
          contents:
            repositories:
                - https://dl-cdn.alpinelinux.org/alpine/v3.22/main
                - https://dl-cdn.alpinelinux.org/alpine/v3.22/community
            packages:
                - bash
                - argon2-dev
                - autoconf
                - curl-dev
                - file
                - g++
                - gcc
                - gnu-libiconv-dev
                - gpg
                - gpg-agent
                - icu-dev
                - libc-dev
                - libsodium-dev
                - libxml2-dev
                - linux-headers
                - make
                - oniguruma-dev
                - openssl-dev
                - patch
                - pcre2-dev
                - pkgconf
                - re2c
                - readline-dev
                - sqlite-dev
                - xz
                - zlib-dev
            files:
                - url: https://www.php.net/distributions/php-8.3.29.tar.xz.asc
                  path: ${source.dir}/php-8.3.29.tar.xz.asc
                  uid: 0
                  gid: 0
                - url: https://www.php.net/distributions/php-8.3.29.tar.xz
                  checksum: sha256:f7950ca034b15a78f5de9f1b22f4d9bad1dd497114d175cb1672a4ca78077af5
                  path: ${source.dir}/php-8.3.29.tar.xz
                  spdx:
                    name: php
                    version: 8.3.29
                    packages:
                        - name: php
                          purl: pkg:dhi/php@8.3.29
                          license: PHP-3.01
                  uid: 0
                  gid: 0
          pipeline:
            - name: verify and extract
              runs: |
                set -eux -o pipefail

                GNUPGHOME="$(mktemp -d)"
                export GNUPGHOME

                case '8.3' in
                  8.5)
                    gpg --batch --import \
                      key/1198C0117593497A5EC5C199286AF1F9897469DC \
                      key/49D9AF6BC72A80D6691719C8AA23F5BE9C7097D4 \
                      key/D95C03BC702BE9515344AE3374E44BC9067701A5
                    ;;
                  8.4)
                    gpg --batch --import \
                      key/0616E93D95AF471243E26761770426E17EBBB3DD \
                      key/9D7F99A0CB8F05C8A6958D6256A97AF7600A39A6 \
                      key/AFD8691FDAEDF03BDF6E460563F15A9B715376CA
                    ;;
                  8.3)
                    gpg --batch --import \
                      key/1198C0117593497A5EC5C199286AF1F9897469DC \
                      key/AFD8691FDAEDF03BDF6E460563F15A9B715376CA \
                      key/C28D937575603EB4ABB725861C0779DC5C0A9DE4
                    ;;
                  8.2)
                    gpg --batch --import \
                      key/1198C0117593497A5EC5C199286AF1F9897469DC \
                      key/39B641343D8C104B2B146DC3F9C39DC0B9698544 \
                      key/E60913E4DF209907D8E30D96659A97C9CF2A795A
                    ;;
                  8.1)
                    gpg --batch --import \
                      key/528995BFEDFBA7191D46839EF9BA0ADA31CBD89E \
                      key/39B641343D8C104B2B146DC3F9C39DC0B9698544 \
                      key/F1F692238FBC1666E5A5CCD4199F9DFEF6FFBAFD
                    ;;
                  *)
                    exit 1
                    ;;
                esac

                gpg --batch --verify 'php-8.3.29.tar.xz.asc' 'php-8.3.29.tar.xz'
                tar xvf 'php-8.3.29.tar.xz'
            - name: copy source
              runs: |
                set -eux -o pipefail

                mkdir -p '${target.dir}//opt/php-8.3/src'
                cp -a '${source.dir}/php-8.3.29/.' '${target.dir}//opt/php-8.3/src'
            - name: build and install
              work-dir: ${source.dir}/php-8.3.29
              runs: |
                set -eux -o pipefail

                fpm_opts=()
                if [ '${target.flavor}' = fpm ]; then
                  fpm_opts=(--disable-cli --enable-fpm --with-fpm-user=nonroot --with-fpm-group=nonroot)
                fi

                phpdbg_opts=(--disable-phpdbg)
                pear_opts=()
                if [ '${target.dev}' = true ]; then
                  phpdbg_opts=(--enable-phpdbg --enable-phpdbg-readline)
                  pear_opts=(--with-pear)
                fi

                ./configure \
                  --enable-option-checking=fatal \
                  --prefix='/opt/php-8.3' \
                  --with-config-file-path='/opt/php-8.3/etc/php' \
                  --with-config-file-scan-dir='/opt/php-8.3/etc/php/conf.d' \
                  --disable-static \
                  --disable-cgi \
                  --enable-filter \
                  --enable-tokenizer \
                  --enable-ctype \
                  --enable-fileinfo \
                  --enable-mbstring --enable-mbregex \
                  --enable-intl \
                  --enable-mysqlnd \
                  --enable-session \
                  --enable-xml --enable-simplexml --enable-dom \
                  --enable-pdo \
                  --with-sqlite3 \
                  --with-pdo-sqlite \
                  --with-password-argon2 \
                  --with-sodium \
                  --with-openssl \
                  --with-external-pcre=/usr --with-pcre-jit \
                  --with-iconv \
                  --with-libxml \
                  --with-curl \
                  --with-readline \
                  --with-zlib \
                  "${fpm_opts[@]}" \
                  "${phpdbg_opts[@]}" \
                  "${pear_opts[@]}"

                make -j"$(nproc)"

                make install INSTALL_ROOT='${target.dir}'
            - name: install php.ini
              runs: |
                set -eux -o pipefail

                install -d '${target.dir}//opt/php-8.3/etc/php/conf.d'
                install '${source.dir}/php-8.3.29/php.ini-production' \
                  '${target.dir}//opt/php-8.3/etc/php/php.ini'

                # On dev images, include example php.ini files.
                if [ '${target.dev}' = 'true' ]; then
                  install -t '${target.dir}//opt/php-8.3/etc/php' \
                    '${source.dir}/php-8.3.29/'php.ini-*
                fi
            - uses: strip@v1
              with:
                dir: ${target.dir}//opt/php-8.3
          paths:
            - type: directory
              path: ${source.dir}/key
              uid: 0
              gid: 0
              source: image/php/key
          outputs:
            - source: ${target.dir}//opt/php-8.3/bin
              target: /opt/php-8.3/bin
              uid: 0
              gid: 0
            - source: ${target.dir}//opt/php-8.3/etc
              target: /opt/php-8.3/etc
              uid: 0
              gid: 0
            - source: ${target.dir}//opt/php-8.3/include
              target: /opt/php-8.3/include
              uid: 0
              gid: 0
            - source: ${target.dir}//opt/php-8.3/php
              target: /opt/php-8.3/php
              uid: 0
              gid: 0
            - source: ${target.dir}//opt/php-8.3/lib
              target: /opt/php-8.3/lib
              uid: 0
              gid: 0
            - source: ${target.dir}//opt/php-8.3/src
              target: /opt/php-8.3/src
              uid: 0
              gid: 0
            - source: /opt/docker/sbom/php
              target: /opt/docker/sbom/php
              uid: 0
              gid: 0
accounts:
    root: true
    run-as: root
    users:
        - name: nonroot
          uid: 65532
          gid: 65532
    groups:
        - name: nonroot
          gid: 65532
          members:
            - nonroot
os-release:
    name: Docker Hardened Images (Alpine)
    id: alpine
    version-id: "3.22"
    pretty-name: Docker Hardened Images/Alpine Linux v3.22
    home-url: https://docker.com/products/hardened-images/
    bug-report-url: https://docker.com/support/
environment:
    CFLAGS: -fstack-protector-strong -fpic -fpie -O2 -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64
    CPPFLAGS: -fstack-protector-strong -fpic -fpie -O2 -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64
    LDFLAGS: -Wl,-O1 -pie
    PATH: /opt/php-8.3/bin:/opt/php-8.3/sbin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    PHP_INI_DIR: /opt/php-8.3/etc/php
    PHP_PREFIX: /opt/php-8.3
    PHP_SRC_DIR: /opt/php-8.3/src
    PHP_VERSION: 8.3.29
paths:
    - type: directory
      path: /var/www/html
      uid: 65532
      gid: 65532
      mode: "0755"
    - type: file
      path: /opt/php-8.3/etc/php/conf.d/opcache.ini
      content: |
        # https://wiki.php.net/rfc/make_opcache_required
        zend_extension=opcache
      uid: 0
      gid: 0
      mode: "0644"
annotations:
    org.opencontainers.image.description: A minimal PHP image
    org.opencontainers.image.licenses: PHP-3.01
entrypoint:
    - /bin/sh
tests:
    - name: Run PHP tests
      directory: image/php/tests
      commands:
        - go test . -count=1 -v
      exit-code: 0
    - name: Run common tests
      directory: test/go-testing/base
      commands:
        - go test . -count=1 -v
      exit-code: 0
    - name: Run APK package manager tests
      directory: test/go-testing/package_manager
      commands:
        - go test . -count=1 -v
      exit-code: 0
