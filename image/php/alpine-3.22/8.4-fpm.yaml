# syntax=dhi.io/build:2-alpine3.22

name: PHP 8.4.x (fpm)
image: dhi.io/php
variant: runtime
flavor: fpm
tags:
  - 8.4-alpine3.22-fpm
  - 8.4.17-alpine3.22-fpm
platforms:
  - linux/amd64
  - linux/arm64
dates:
  release: "2024-11-21"
  end-of-life: "2028-12-31"
vars:
  CFLAGS: -fstack-protector-strong -fpic -fpie -O2 -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64
  CHECKSUM: 28b234e347286158cae921d61283eb1169d89bc9d2e5f5976567260ff38b0bfa
  CPPFLAGS: -fstack-protector-strong -fpic -fpie -O2 -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64
  LDFLAGS: -Wl,-O1 -pie
  PHP_PREFIX: /opt/php-8.4
  PHP_SYSCONFDIR: /opt/php-8.4/etc
  SEMVER_MAJOR_MINOR_VERSION: "8.4"
  SEMVER_MAJOR_VERSION: "8"
  SEMVER_VERSION: 8.4.17
  VERSION: 8.4.17
contents:
  repositories:
    - https://dl-cdn.alpinelinux.org/alpine/v3.22/main
    - https://dl-cdn.alpinelinux.org/alpine/v3.22/community
  packages:
    - alpine-baselayout-data
    - argon2-libs
    - busybox
    - ca-certificates-bundle
    - icu-data-full
    - icu-libs
    - libcrypto3
    - libcurl
    - libsodium
    - libssl3
    - libxml2
    - oniguruma
    - pcre2
    - readline
    - sqlite-libs
    - zlib
  builds:
    - name: php
      shell: bash
      environment:
        CFLAGS: -fstack-protector-strong -fpic -fpie -O2 -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64
        CPPFLAGS: -fstack-protector-strong -fpic -fpie -O2 -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64
        LDFLAGS: -Wl,-O1 -pie
        PHP_BUILD_PROVIDER: https://github.com/docker-hardened-images/definitions
        PHP_UNAME: Linux - Docker Hardened Images
      contents:
        repositories:
          - https://dl-cdn.alpinelinux.org/alpine/v3.22/main
          - https://dl-cdn.alpinelinux.org/alpine/v3.22/community
        packages:
          - argon2-dev
          - autoconf
          - bash
          - curl-dev
          - file
          - g++
          - gcc
          - gnu-libiconv-dev
          - icu-dev
          - libc-dev
          - libsodium-dev
          - libxml2-dev
          - linux-headers
          - make
          - musl-utils
          - oniguruma-dev
          - openssl-dev
          - patch
          - pcre2-dev
          - pkgconf
          - re2c
          - readline-dev
          - sqlite-dev
          - xz
          - zlib-dev
        files:
          - url: https://www.php.net/distributions/php-8.4.17.tar.xz.asc
            path: ${source.dir}/php-8.4.17.tar.xz.asc
            uid: 0
            gid: 0
          - url: https://www.php.net/distributions/php-8.4.17.tar.xz
            checksum: sha256:28b234e347286158cae921d61283eb1169d89bc9d2e5f5976567260ff38b0bfa
            path: ${source.dir}/php-8.4.17.tar.xz
            spdx:
              name: php
              version: 8.4.17
              packages:
                - name: php
                  purl: pkg:dhi/php@8.4.17
                  license: PHP-3.01
            uid: 0
            gid: 0
      pipeline:
        - name: verify php-8.4.17.tar.xz
          uses: gpg/verify@v1
          with:
            file: ${source.dir}/php-8.4.17.tar.xz
            keys: ${source.dir}/keyring.asc
            signature: ${source.dir}/php-8.4.17.tar.xz.asc
        - name: extract source
          runs: |
            set -eux -o pipefail

            tar xvf 'php-8.4.17.tar.xz'
        - name: build and install
          work-dir: ${source.dir}/php-8.4.17
          runs: |
            set -eux -o pipefail

            fpm_opts=()
            if [ '${target.flavor}' = fpm ]; then
              fpm_opts=(--disable-cli --enable-fpm --with-fpm-user=nonroot --with-fpm-group=nonroot)
            fi

            phpdbg_opts=(--disable-phpdbg)
            pear_opts=()
            if [ '${target.dev}' = true ]; then
              phpdbg_opts=(--enable-phpdbg --enable-phpdbg-readline)
              pear_opts=(--with-pear)
            fi

            ./configure \
              --enable-option-checking=fatal \
              --prefix='/opt/php-8.4' \
              --sysconfdir='/opt/php-8.4/etc' \
              --with-config-file-path='/opt/php-8.4/etc/php' \
              --with-config-file-scan-dir='/opt/php-8.4/etc/php/conf.d' \
              --disable-static \
              --disable-cgi \
              --enable-filter \
              --enable-tokenizer \
              --enable-ctype \
              --enable-fileinfo \
              --enable-mbstring --enable-mbregex \
              --enable-intl \
              --enable-mysqlnd \
              --enable-session \
              --enable-xml --enable-simplexml --enable-dom \
              --enable-pdo \
              --with-sqlite3 \
              --with-pdo-sqlite \
              --with-password-argon2 \
              --with-sodium \
              --with-openssl \
              --with-external-pcre=/usr --with-pcre-jit \
              --with-iconv \
              --with-libxml \
              --with-curl \
              --with-readline \
              --with-zlib \
              "${fpm_opts[@]}" \
              "${phpdbg_opts[@]}" \
              "${pear_opts[@]}"

            make -j"$(nproc)"

            make install INSTALL_ROOT='${target.dir}'
        - name: install php.ini
          runs: |
            set -eux -o pipefail

            install -d '${target.dir}/opt/php-8.4/etc/php/conf.d'
            install '${source.dir}/php-8.4.17/php.ini-production' \
              '${target.dir}/opt/php-8.4/etc/php/php.ini'

            # On dev images, include example php.ini files.
            if [ '${target.dev}' = true ]; then
              install -t '${target.dir}/opt/php-8.4/etc/php' \
                '${source.dir}/php-8.4.17/'php.ini-*
            fi
        - name: install php-fpm.conf
          runs: |
            set -eux -o pipefail

            install '${target.dir}/opt/php-8.4/etc/php-fpm.conf.default' \
              '${target.dir}/opt/php-8.4/etc/php-fpm.conf'
            install '${target.dir}/opt/php-8.4/etc/php-fpm.d/www.conf.default' \
              '${target.dir}/opt/php-8.4/etc/php-fpm.d/www.conf'

            # comment out localhost-only listen address
            sed -ri 's/^(listen = 127.0.0.1:9000)/;\1/' \
              '${target.dir}/opt/php-8.4/etc/php-fpm.d/www.conf'
        - name: remove unused scripts
          runs: |
            set -eux -o pipefail

            rm '${target.dir}/opt/php-8.4/bin/'{phpize,php-config}
            rm -rf '${target.dir}/opt/php-8.4/lib/php/build'
        - uses: strip@v1
          with:
            dir: ${target.dir}/opt/php-8.4
      paths:
        - type: file
          path: ${source.dir}/keyring.asc
          uid: 0
          gid: 0
          source: image/php/key/php8.4.keyring.asc
      outputs:
        - source: ${target.dir}/opt/php-8.4/bin
          target: /opt/php-8.4/bin
          uid: 0
          gid: 0
        - source: ${target.dir}/opt/php-8.4/sbin
          target: /opt/php-8.4/sbin
          uid: 0
          gid: 0
        - source: ${target.dir}/opt/php-8.4/lib
          target: /opt/php-8.4/lib
          uid: 0
          gid: 0
        - source: ${target.dir}/opt/php-8.4/etc
          target: /opt/php-8.4/etc
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/php
          target: /opt/docker/sbom/php
          uid: 0
          gid: 0
accounts:
  run-as: nonroot
  users:
    - name: nonroot
      uid: 65532
      gid: 65532
  groups:
    - name: nonroot
      gid: 65532
      members:
        - nonroot
os-release:
  name: Docker Hardened Images (Alpine)
  id: alpine
  version-id: "3.22"
  pretty-name: Docker Hardened Images/Alpine Linux v3.22
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
work-dir: /var/www/html
stop-signal: SIGQUIT
environment:
  PATH: /opt/php-8.4/bin:/opt/php-8.4/sbin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
  PHP_INI_DIR: /usr/local/etc/php
  PHP_PREFIX: /opt/php-8.4
  PHP_VERSION: 8.4.17
paths:
  - type: symlink
    path: /opt/php
    uid: 0
    gid: 0
    source: /opt/php-8.4
  - type: directory
    path: /usr/local/etc
    uid: 0
    gid: 0
  - type: symlink
    path: /usr/local/etc/php
    uid: 0
    gid: 0
    source: /opt/php-8.4/etc/php
  - type: directory
    path: /var/www/html
    uid: 65532
    gid: 65532
    mode: "0755"
  - type: file
    path: /opt/php-8.4/etc/php/conf.d/opcache.ini
    content: |
      # https://wiki.php.net/rfc/make_opcache_required
      zend_extension=opcache
    uid: 0
    gid: 0
    mode: "0644"
  - type: file
    path: /opt/php-8.4/etc/php/conf.d/fpm.ini
    content: |
      ; https://github.com/docker-library/php/issues/878#issuecomment-938595965
      fastcgi.logging = Off
    uid: 0
    gid: 0
    mode: "0644"
  - type: file
    path: /opt/php-8.4/etc/php-fpm.d/docker.conf
    content: |
      [global]
      error_log = /proc/self/fd/2

      ; https://github.com/docker-library/php/pull/725#issuecomment-443540114
      log_limit = 8192

      [www]
      ; php-fpm closes STDOUT on startup, so sending logs to /proc/self/fd/1 does not work.
      ; https://bugs.php.net/bug.php?id=73886
      access.log = /proc/self/fd/2

      clear_env = no

      ; Ensure worker stdout and stderr are sent to the main error log.
      catch_workers_output = yes
      decorate_workers_output = no

      ; default listen adddress for easy override in later php-fpm.d/*.conf files
      listen = 9000
    uid: 0
    gid: 0
    mode: "0644"
  - type: file
    path: /opt/php-8.4/etc/php-fpm.d/zz-docker.conf
    content: |
      [global]
      daemonize = no

      [www]
    uid: 0
    gid: 0
    mode: "0644"
annotations:
  org.opencontainers.image.description: A minimal PHP image
  org.opencontainers.image.licenses: PHP-3.01
entrypoint:
  - /opt/php-8.4/sbin/php-fpm
ports:
  - 9000/tcp
