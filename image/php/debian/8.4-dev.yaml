# syntax=dhi.io/build:1-debian13

name: PHP 8.4.x (dev)
image: dhi.io/php
variant: dev
tags:
  - 8.4-dev
  - 8.4.16-dev
  - 8.4-debian13-dev
  - 8.4.16-debian13-dev
platforms:
  - linux/amd64
  - linux/arm64
dates:
  release: "2024-11-21"
  end-of-life: "2028-12-31"
vars:
  BINUTILS_DIGEST: sha256:48107c1824276349ccbddce3853299de8b7c6a554b775957864d44c7b9a6b5b4
  BINUTILS_VERSION: "2.45"
  CFLAGS: -fstack-protector-strong -fpic -fpie -O2 -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64
  CHECKSUM: f66f8f48db34e9e29f7bfd6901178e9cf4a1b163e6e497716dfcb8f88bcfae30
  CPPFLAGS: -fstack-protector-strong -fpic -fpie -O2 -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64
  LDFLAGS: -Wl,-O1 -pie
  PHP_INI_DIR: /opt/php-8.4/etc/php
  PHP_PREFIX: /opt/php-8.4
  PHP_SRC_DIR: /opt/php-8.4/src
  SEMVER_MAJOR_MINOR_VERSION: "8.4"
  SEMVER_MAJOR_VERSION: "8"
  SEMVER_VERSION: 8.4.16
  VERSION: 8.4.16
contents:
  packages:
    - '!binutils'
    - '!binutils-aarch64-linux-gnu'
    - '!binutils-common'
    - '!binutils-x86-64-linux-gnu'
    - '!clang-17'
    - '!clang-18'
    - '!clang-19'
    - '!cpp-12'
    - '!cpp-13'
    - '!cpp-13-aarch64-linux-gnu'
    - '!cpp-13-x86-64-linux-gnu'
    - '!gawk'
    - '!gcc-12'
    - '!gcc-12-base'
    - '!gcc-13'
    - '!gcc-13-aarch64-linux-gnu'
    - '!gcc-13-base'
    - '!gcc-13-x86-64-linux-gnu'
    - '!libbinutils'
    - '!libclang-common-18-dev'
    - '!libclang-common-19-dev'
    - '!libclang-cpp17t64'
    - '!libclang-cpp18'
    - '!libclang-cpp19'
    - '!libclang1-17t64'
    - '!libclang1-18'
    - '!libclang1-19'
    - '!libctf-nobfd0'
    - '!libctf0'
    - '!libedit2'
    - '!libelogind0'
    - '!libgcc-12-dev'
    - '!libgcc-13-dev'
    - '!libgprofng0'
    - '!libllvm17t64'
    - '!libllvm18'
    - '!libllvm19'
    - '!libsframe1'
    - '!llvm-17-linker-tools'
    - '!llvm-18-linker-tools'
    - '!llvm-19-linker-tools'
    - '!make-guile'
    - '!mawk'
    - '!original-awk'
    - '!tcc'
    - apt
    - autoconf
    - base-files
    - bash
    - bison
    - ca-certificates
    - coreutils
    - curl
    - diffutils
    - dpkg
    - dpkg-dev
    - file
    - findutils
    - g++
    - gcc
    - grep
    - gzip
    - libargon2-1
    - libc-bin
    - libc6-dev
    - libcurl4t64
    - libicu76
    - libonig5
    - libpcre2-8-0
    - libreadline8t64
    - libsodium23
    - libsqlite3-0
    - libssl3t64
    - libtool
    - libxml2
    - make
    - mawk
    - perl-base
    - pkg-config
    - re2c
    - sed
    - tar
    - util-linux
    - zlib1g
  builds:
    - name: php
      environment:
        CFLAGS: -fstack-protector-strong -fpic -fpie -O2 -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64
        CPPFLAGS: -fstack-protector-strong -fpic -fpie -O2 -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64
        LDFLAGS: -Wl,-O1 -pie
        PHP_BUILD_PROVIDER: https://github.com/docker-hardened-images/definitions
        PHP_UNAME: Linux - Docker Hardened Images
      contents:
        packages:
          - bash
          - build-essential
          - coreutils
          - gpg
          - gpg-agent
          - grep
          - libargon2-dev
          - libc-bin
          - libcurl4-openssl-dev
          - libicu-dev
          - libonig-dev
          - libpcre2-dev
          - libreadline-dev
          - libsodium-dev
          - libsqlite3-dev
          - libssl-dev
          - libxml2-dev
          - sed
          - xz-utils
          - zlib1g-dev
        files:
          - url: https://www.php.net/distributions/php-8.4.16.tar.xz.asc
            path: ${source.dir}/php-8.4.16.tar.xz.asc
            uid: 0
            gid: 0
          - url: https://www.php.net/distributions/php-8.4.16.tar.xz
            checksum: sha256:f66f8f48db34e9e29f7bfd6901178e9cf4a1b163e6e497716dfcb8f88bcfae30
            path: ${source.dir}/php-8.4.16.tar.xz
            spdx:
              name: php
              version: 8.4.16
              packages:
                - name: php
                  purl: pkg:dhi/php@8.4.16
                  license: PHP-3.01
            uid: 0
            gid: 0
      pipeline:
        - name: verify and extract
          runs: |
            set -eux -o pipefail

            GNUPGHOME="$(mktemp -d)"
            export GNUPGHOME

            case '8.4' in
              8.5)
                gpg --batch --import \
                  key/1198C0117593497A5EC5C199286AF1F9897469DC \
                  key/49D9AF6BC72A80D6691719C8AA23F5BE9C7097D4 \
                  key/D95C03BC702BE9515344AE3374E44BC9067701A5
                ;;
              8.4)
                gpg --batch --import \
                  key/0616E93D95AF471243E26761770426E17EBBB3DD \
                  key/9D7F99A0CB8F05C8A6958D6256A97AF7600A39A6 \
                  key/AFD8691FDAEDF03BDF6E460563F15A9B715376CA
                ;;
              8.3)
                gpg --batch --import \
                  key/1198C0117593497A5EC5C199286AF1F9897469DC \
                  key/AFD8691FDAEDF03BDF6E460563F15A9B715376CA \
                  key/C28D937575603EB4ABB725861C0779DC5C0A9DE4
                ;;
              8.2)
                gpg --batch --import \
                  key/1198C0117593497A5EC5C199286AF1F9897469DC \
                  key/39B641343D8C104B2B146DC3F9C39DC0B9698544 \
                  key/E60913E4DF209907D8E30D96659A97C9CF2A795A
                ;;
              8.1)
                gpg --batch --import \
                  key/528995BFEDFBA7191D46839EF9BA0ADA31CBD89E \
                  key/39B641343D8C104B2B146DC3F9C39DC0B9698544 \
                  key/F1F692238FBC1666E5A5CCD4199F9DFEF6FFBAFD
                ;;
              *)
                exit 1
                ;;
            esac

            gpg --batch --verify 'php-8.4.16.tar.xz.asc' 'php-8.4.16.tar.xz'
            tar xvf 'php-8.4.16.tar.xz'
        - name: copy source
          runs: |
            set -eux -o pipefail

            mkdir -p '${target.dir}//opt/php-8.4/src'
            cp -a '${source.dir}/php-8.4.16/.' '${target.dir}//opt/php-8.4/src'
        - name: build and install
          work-dir: ${source.dir}/php-8.4.16
          runs: |
            set -eux -o pipefail

            fpm_opts=()
            if [ '${target.flavor}' = fpm ]; then
              fpm_opts=(--disable-cli --enable-fpm --with-fpm-user=nonroot --with-fpm-group=nonroot)
            fi

            phpdbg_opts=(--disable-phpdbg)
            pear_opts=()
            if [ '${target.dev}' = true ]; then
              phpdbg_opts=(--enable-phpdbg --enable-phpdbg-readline)
              pear_opts=(--with-pear)
            fi

            ./configure \
              --enable-option-checking=fatal \
              --prefix='/opt/php-8.4' \
              --with-config-file-path='/opt/php-8.4/etc/php' \
              --with-config-file-scan-dir='/opt/php-8.4/etc/php/conf.d' \
              --disable-static \
              --disable-cgi \
              --enable-filter \
              --enable-tokenizer \
              --enable-ctype \
              --enable-fileinfo \
              --enable-mbstring --enable-mbregex \
              --enable-intl \
              --enable-mysqlnd \
              --enable-session \
              --enable-xml --enable-simplexml --enable-dom \
              --enable-pdo \
              --with-sqlite3 \
              --with-pdo-sqlite \
              --with-password-argon2 \
              --with-sodium \
              --with-openssl \
              --with-external-pcre=/usr --with-pcre-jit \
              --with-iconv \
              --with-libxml \
              --with-curl \
              --with-readline \
              --with-zlib \
              "${fpm_opts[@]}" \
              "${phpdbg_opts[@]}" \
              "${pear_opts[@]}"

            make -j"$(nproc)"

            make install INSTALL_ROOT='${target.dir}'
        - name: install php.ini
          runs: |
            set -eux -o pipefail

            install -d '${target.dir}//opt/php-8.4/etc/php/conf.d'
            install '${source.dir}/php-8.4.16/php.ini-production' \
              '${target.dir}//opt/php-8.4/etc/php/php.ini'

            # On dev images, include example php.ini files.
            if [ '${target.dev}' = 'true' ]; then
              install -t '${target.dir}//opt/php-8.4/etc/php' \
                '${source.dir}/php-8.4.16/'php.ini-*
            fi
        - uses: strip@v1
          with:
            dir: ${target.dir}//opt/php-8.4
      paths:
        - type: directory
          path: ${source.dir}/key
          uid: 0
          gid: 0
          source: image/php/key
      outputs:
        - source: ${target.dir}//opt/php-8.4/bin
          target: /opt/php-8.4/bin
          uid: 0
          gid: 0
        - source: ${target.dir}//opt/php-8.4/etc
          target: /opt/php-8.4/etc
          uid: 0
          gid: 0
        - source: ${target.dir}//opt/php-8.4/include
          target: /opt/php-8.4/include
          uid: 0
          gid: 0
        - source: ${target.dir}//opt/php-8.4/php
          target: /opt/php-8.4/php
          uid: 0
          gid: 0
        - source: ${target.dir}//opt/php-8.4/lib
          target: /opt/php-8.4/lib
          uid: 0
          gid: 0
        - source: ${target.dir}//opt/php-8.4/src
          target: /opt/php-8.4/src
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/php
          target: /opt/docker/sbom/php
          uid: 0
          gid: 0
    - name: locale
      uses: dhi.io/debian-base:trixie-debian13@sha256:c7651f9ef631e9a9feada59aff228f9382bdb537e85dc8e9c201093597898c45
      contents:
        packages:
          - bash
          - locales
          - coreutils
          - gzip
      pipeline:
        - name: install locales
          runs: |
            set -eux -o pipefail

            echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen
            locale-gen en_US.UTF-8
      outputs:
        - source: /usr/share/locale
          target: /usr/share/locale
          uid: 0
          gid: 0
        - source: /usr/lib/locale
          target: /usr/lib/locale
          uid: 0
          gid: 0
  artifacts:
    - name: dhi.io/pkg-binutils:2.45-debian13@sha256:48107c1824276349ccbddce3853299de8b7c6a554b775957864d44c7b9a6b5b4
      excludes:
        - etc/group
        - etc/os-release
        - etc/passwd
        - var/lib/dpkg/status
      uid: 0
      gid: 0
accounts:
  root: true
  run-as: root
  users:
    - name: _apt
      uid: 42
      gid: 65532
  groups:
    - name: nonroot
      gid: 65532
      members:
        - nonroot
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
environment:
  CFLAGS: -fstack-protector-strong -fpic -fpie -O2 -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64
  CPPFLAGS: -fstack-protector-strong -fpic -fpie -O2 -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64
  DEBIAN_FRONTEND: noninteractive
  LANG: en_US.UTF-8
  LANGUAGE: en_US:en
  LC_ALL: en_US.UTF-8
  LDFLAGS: -Wl,-O1 -pie
  PATH: /opt/php-8.4/bin:/opt/php-8.4/sbin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
  PHP_INI_DIR: /opt/php-8.4/etc/php
  PHP_PREFIX: /opt/php-8.4
  PHP_SRC_DIR: /opt/php-8.4/src
  PHP_VERSION: 8.4.16
paths:
  - type: directory
    path: /var/www/html
    uid: 65532
    gid: 65532
    mode: "0755"
  - type: file
    path: /opt/php-8.4/etc/php/conf.d/opcache.ini
    content: |
      # https://wiki.php.net/rfc/make_opcache_required
      zend_extension=opcache
    uid: 0
    gid: 0
    mode: "0644"
annotations:
  org.opencontainers.image.description: A minimal PHP image
  org.opencontainers.image.licenses: PHP-3.01
entrypoint:
  - /bin/sh
tests:
  - name: Run PHP tests
    directory: image/php/tests
    commands:
      - go test . -count=1 -v
    exit-code: 0
  - name: Run common tests
    directory: test/go-testing/base
    commands:
      - go test . -count=1 -v
    exit-code: 0
  - name: Run APT package manager tests
    directory: test/go-testing/package_manager
    commands:
      - go test . -count=1 -v
    exit-code: 0
  - name: Run locales tests
    directory: test/go-testing/locales
    commands:
      - go test . -count=1 -v
    exit-code: 0
