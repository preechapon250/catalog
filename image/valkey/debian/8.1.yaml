# syntax=dhi/build:1-debian13

# DO NOT EDIT THIS FILE MANUALLY
# generated with 'dhi def merge image/valkey/debian/8.1.yaml'

name: Valkey 8.1.x
image: dhi/valkey
variant: runtime
tags:
    - "8"
    - "8.1"
    - 8.1.5
    - 8-debian13
    - 8.1-debian13
    - 8.1.5-debian13
platforms:
    - linux/amd64
    - linux/arm64
dates:
    release: "2025-03-31"
    end-of-life: "2030-03-31"
vars:
    COMMIT_SHA: 43561f89298820073ebfcff6ee7922d5670091a2
    DEBIAN_EPOCH_MAJOR_MINOR_VERSION: "8.1"
    DEBIAN_EPOCH_MAJOR_VERSION: "8"
    DEBIAN_EPOCH_VERSION: 8.1.5
    VERSION: 8.1.5
contents:
    packages:
        - '!adduser'
        - '!audit'
        - '!cdebconf'
        - '!debconf'
        - '!dpkg'
        - '!elogind'
        - '!gcc-14'
        - '!gcc-14-base'
        - '!gcc-base'
        - '!install-info'
        - '!libaudit-common'
        - '!libaudit1'
        - '!libdebian-installer'
        - '!libdebian-installer4'
        - '!libelogind0'
        - '!libnewt0.52'
        - '!libslang2'
        - '!libtextwrap'
        - '!libtextwrap1'
        - '!mawk'
        - '!openssl'
        - '!openssl-provider-legacy'
        - '!original-awk'
        - '!pam'
        - '!passwd'
        - '!pcre2'
        - '!readline-common'
        - '!shadow'
        - '!sysvinit'
        - '!sysvinit-utils'
        - '!tar'
        - base-files
        - bash
        - hostname
        - libc-bin
        - libpcre2-8-0
        - libssl3t64
        - tini
    builds:
        - name: valkey
          contents:
            packages:
                - bash
                - clang
                - coreutils
                - gnu-which
                - grep
                - hostname
                - libssl-dev
                - make
                - pkg-config
                - python3
                - sed
            files:
                - url: git+https://github.com/valkey-io/valkey.git#8.1.5
                  checksum: 43561f89298820073ebfcff6ee7922d5670091a2
                  path: ${source.dir}/valkey
                  spdx:
                    name: valkey
                    version: 8.1.5
                    packages:
                        - name: valkey
                          purl: pkg:dhi/valkey@8.1.5
                          license: BSD-3-Clause
                  uid: 0
                  gid: 0
          pipeline:
            - name: build
              work-dir: ${source.dir}/valkey
              runs: |
                set -eux -o pipefail

                make BUILD_TLS=yes CC=clang

                mkdir -p "${target.dir}/usr/local/bin"
                cp src/valkey-server "${target.dir}/usr/local/bin/valkey-server"
                cp src/valkey-cli "${target.dir}/usr/local/bin/valkey-cli"
                cp src/valkey-benchmark "${target.dir}/usr/local/bin/valkey-benchmark"
          outputs:
            - source: ${target.dir}/usr/local/bin/valkey-server
              target: /usr/local/bin/valkey-server
              uid: 0
              gid: 0
              mode: "0755"
            - source: ${target.dir}/usr/local/bin/valkey-cli
              target: /usr/local/bin/valkey-cli
              uid: 0
              gid: 0
              mode: "0755"
            - source: ${target.dir}/usr/local/bin/valkey-benchmark
              target: /usr/local/bin/valkey-benchmark
              uid: 0
              gid: 0
              mode: "0755"
accounts:
    run-as: nonroot
    users:
        - name: nonroot
          uid: 65532
          gid: 65532
    groups:
        - name: nonroot
          gid: 65532
          members:
            - nonroot
os-release:
    name: Docker Hardened Images (Debian)
    id: debian
    version-id: "13"
    version-codename: trixie
    pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
    home-url: https://docker.com/products/hardened-images/
    bug-report-url: https://docker.com/support/
paths:
    - type: symlink
      path: /usr/local/bin/redis-sentinel
      uid: 0
      gid: 0
      source: /usr/local/bin/valkey-server
    - type: symlink
      path: /usr/local/bin/redis-server
      uid: 0
      gid: 0
      source: /usr/local/bin/valkey-server
    - type: symlink
      path: /usr/local/bin/redis-cli
      uid: 0
      gid: 0
      source: /usr/local/bin/valkey-cli
    - type: symlink
      path: /usr/local/bin/redis-check-rdb
      uid: 0
      gid: 0
      source: /usr/local/bin/valkey-server
    - type: symlink
      path: /usr/local/bin/redis-check-aof
      uid: 0
      gid: 0
      source: /usr/local/bin/valkey-server
    - type: symlink
      path: /usr/local/bin/redis-benchmark
      uid: 0
      gid: 0
      source: /usr/local/bin/valkey-benchmark
    - type: symlink
      path: /usr/local/bin/valkey-sentinel
      uid: 0
      gid: 0
      source: /usr/local/bin/valkey-server
    - type: symlink
      path: /usr/local/bin/valkey-check-aof
      uid: 0
      gid: 0
      source: /usr/local/bin/valkey-server
    - type: symlink
      path: /usr/local/bin/valkey-check-rdb
      uid: 0
      gid: 0
      source: /usr/local/bin/valkey-server
    - type: directory
      path: /var/lib/valkey
      uid: 65532
      gid: 65532
      mode: "0755"
    - type: directory
      path: /var/log/valkey
      uid: 65532
      gid: 65532
      mode: "0755"
    - type: directory
      path: /run/valkey/
      uid: 65532
      gid: 65532
      mode: "0755"
    - type: file
      path: /etc/valkey/conf.d/docker.conf
      content: |
        daemonize no
        bind 0.0.0.0 -::1
        logfile ""
      uid: 0
      gid: 0
      mode: "0444"
    - type: file
      path: /usr/local/bin/docker-entrypoint.sh
      content: |
        #!/bin/sh
        set -e

        if [ "${1#-}" != "$1" ]; then
          # docker run dhi/valkey --flag
          set -- /etc/valkey/valkey.conf "$@"
        fi

        if [ "${1%.conf}" != "$1" ]; then
          # docker run dhi/valkey /path/to/custom/conf [optional flags]
          set -- valkey-server "$@"
        fi

        # set an appropriate umask (if one isn't set)
        um="$(umask)"
        if [ "$um" = '0022' ]; then
          umask 0077
        fi

        exec "$@"
      uid: 0
      gid: 0
      mode: "0755"
annotations:
    org.opencontainers.image.description: A minimal Valkey image
    org.opencontainers.image.licenses: BSD-3-Clause
entrypoint:
    - /usr/bin/tini
    - --
    - /usr/local/bin/docker-entrypoint.sh
tests:
    - name: Run testcontainers tests
      directory: image/valkey/tests
      commands:
        - go test . -count=1 -v
      exit-code: 0
