# syntax=dhi.io/build:2-debian13

name: KServe Storage Initializer 0.16.x (dev)
image: dhi.io/kserve-storage-initializer
variant: dev
tags:
  - 0-dev
  - 0.16-dev
  - 0.16.0-dev
  - 0-debian13-dev
  - 0-python3.11-dev
  - 0.16-debian13-dev
  - 0.16-python3.11-dev
  - 0.16.0-debian13-dev
  - 0.16.0-python3.11-dev
  - 0-python3.11-debian13-dev
  - 0.16-python3.11-debian13-dev
  - 0.16.0-python3.11-debian13-dev
platforms:
  - linux/amd64
  - linux/arm64
vars:
  COMMIT_SHA: 5b033a4024429302440b72180472ae2d26b44086
  DEBIAN_TRIPLE: '#{ (target.arch == "amd64" ? "x86-64" : "aarch64") + "-linux-gnu" }'
  POETRY_VERSION: 2.1.3
  PYTHON_BUILD_REFERENCE: dhi/python:3.11.14-debian13-dev@sha256:66ca57f344cabc4a79a09eb14ef83a661e0a794b1e616ef6dd101d46c8bff5ca
  PYTHON_MAJOR_MINOR_VERSION: "3.11"
  PYTHON_REFERENCE: dhi/python:3.11.14-debian13@sha256:748cd74a1485c1b990bf05b1bbf1769c146c398665e28ccd73ed61ac25852d40
  PYTHON_VERSION: 3.11.14
  SEMVER_MAJOR_MINOR_VERSION: "0.16"
  SEMVER_MAJOR_VERSION: "0"
  SEMVER_VERSION: 0.16.0
  VERSION: 0.16.0
contents:
  packages:
    - '!gawk'
    - '!libelogind0'
    - '!mawk'
    - '!original-awk'
    - apt
    - base-files
    - bash
    - ca-certificates
    - coreutils
    - diffutils
    - dpkg
    - findutils
    - grep
    - libc-bin
    - mawk
    - perl-base
    - sed
    - util-linux
  builds:
    - name: kserve-storage-initializer
      uses: dhi.io/python:3.11.14-debian13-dev@sha256:66ca57f344cabc4a79a09eb14ef83a661e0a794b1e616ef6dd101d46c8bff5ca
      contents:
        packages:
          - binutils-${DEBIAN_TRIPLE}
          - build-essential
          - ca-certificates
          - git
          - krb5-config
          - libkrb5-dev
        files:
          - url: git+https://github.com/kserve/kserve.git#v0.16.0
            checksum: 5b033a4024429302440b72180472ae2d26b44086
            path: ${source.dir}/kserve
            spdx:
              name: kserve
              version: 0.16.0
              packages:
                - name: kserve
                  purl: pkg:pypi/kserve@0.16.0
                  license: Apache-2.0
            uid: 0
            gid: 0
      pipeline:
        - name: install
          privileged: true
          runs: |
            set -eux -o pipefail

            export POETRY_HOME=/opt/poetry
            export VIRTUAL_ENV='${target.dir}/opt/kserve/storage-initializer-env'
            export PATH="$VIRTUAL_ENV/bin:$POETRY_HOME/bin:$PATH"

            python3 -m venv "$POETRY_HOME"
            "$POETRY_HOME/bin/pip" install 'poetry==2.1.3'

            python3 -m venv "$VIRTUAL_ENV"
            cp -r '${source.dir}/kserve/python/kserve' '${target.dir}/opt/kserve/kserve-python'

            poetry install --no-interaction --extras 'storage' --project '${target.dir}/opt/kserve/kserve-python'
            pip install 'krbcontext==0.10' 'hdfs~=2.6.0' 'requests-kerberos==0.14.0'

            # CVE remediation
            pip install --upgrade 'urllib3>=2.6.3' # CVE-2026-21441
        - name: pth and entrypoint
          runs: |
            set -eux -o pipefail

            sed -i 's#^${target.dir}##' '${target.dir}/opt/kserve/storage-initializer-env/lib/python3.11/site-packages/kserve.pth'

            sed '1c#!/opt/kserve/storage-initializer-env/bin/python3' \
              '${source.dir}/kserve/python/storage-initializer/scripts/initializer-entrypoint' \
              > '${target.dir}/opt/kserve/storage-initializer-entrypoint'

            chmod +x '${target.dir}/opt/kserve/storage-initializer-entrypoint'
      outputs:
        - source: ${target.dir}/opt/kserve
          target: /opt/kserve
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/kserve
          target: /opt/docker/sbom/kserve
          uid: 0
          gid: 0
  artifacts:
    - name: dhi.io/python:3.11.14-debian13@sha256:748cd74a1485c1b990bf05b1bbf1769c146c398665e28ccd73ed61ac25852d40
      includes:
        - opt/**
        - usr/**
      uid: 0
      gid: 0
accounts:
  root: true
  run-as: root
  users:
    - name: nonroot
      uid: 65532
      gid: 65532
    - name: _apt
      uid: 42
      gid: 65532
  groups:
    - name: nonroot
      gid: 65532
      members:
        - nonroot
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
work-dir: /work
environment:
  DEBIAN_FRONTEND: noninteractive
  PYTHONUNBUFFERED: "1"
paths:
  - type: directory
    path: /work
    uid: 65532
    gid: 65532
    mode: "0755"
  - type: directory
    path: /mnt
    uid: 65532
    gid: 65532
    mode: "0755"
annotations:
  org.opencontainers.image.licenses: Apache-2.0
entrypoint:
  - /opt/kserve/storage-initializer-entrypoint
