# syntax=dhi.io/build:2-debian13

name: Fluent Bit 4.2.x (dev)
image: dhi.io/fluent-bit
variant: dev
tags:
  - 4-dev
  - 4.2-dev
  - 4.2.2-dev
  - 4-debian13-dev
  - 4.2-debian13-dev
  - 4.2.2-debian13-dev
platforms:
  - linux/amd64
  - linux/arm64
dates:
  release: "2025-11-11"
vars:
  COMMIT_SHA: ddfef360d7f3ac5268942c47ccc9b01864424a05
  SEMVER_MAJOR_MINOR_VERSION: "4.2"
  SEMVER_MAJOR_VERSION: "4"
  SEMVER_VERSION: 4.2.2
  VERSION: 4.2.2
contents:
  packages:
    - '!gawk'
    - '!libelogind0'
    - '!mawk'
    - '!original-awk'
    - apt
    - base-files
    - bash
    - ca-certificates
    - coreutils
    - diffutils
    - dpkg
    - findutils
    - grep
    - libc-bin
    - libstdc++6
    - libyaml-0-2
    - mawk
    - perl-base
    - sed
    - util-linux
  builds:
    - name: fluent-bit
      contents:
        packages:
          - bash
          - coreutils
          - cmake
          - clang
          - build-essential
          - bison
          - flex
          - openssl
          - libssl-dev
          - libsystemd-dev
          - libyaml-dev
          - sed
          - grep
        files:
          - url: git+https://github.com/fluent/fluent-bit#v4.2.2
            checksum: ddfef360d7f3ac5268942c47ccc9b01864424a05
            path: ${source.dir}/fluent-bit
            spdx:
              name: fluent-bit
              version: 4.2.2
              packages:
                - name: fluent-bit
                  purl: pkg:dhi/fluent-bit@4.2.2
                  license: Apache-2.0
            uid: 0
            gid: 0
      pipeline:
        - name: build
          work-dir: ${source.dir}/fluent-bit/build
          runs: |
            set -eux -o pipefail

            cmake -DFLB_SIMD=On \
              -DFLB_RELEASE=On \
              -DFLB_JEMALLOC=On \
              -DFLB_TLS=On \
              -DFLB_SHARED_LIB=Off \
              -DFLB_EXAMPLES=Off \
              -DFLB_HTTP_SERVER=On \
              -DFLB_IN_EXEC=Off \
              -DFLB_IN_SYSTEMD=On \
              -DFLB_OUT_KAFKA=On \
              -DFLB_OUT_PGSQL=On \
              -DFLB_LOG_NO_CONTROL_CHARS=On \
              -DFLB_CHUNK_TRACE=On \
              ..

            make
            install -D bin/fluent-bit ${target.dir}/usr/local/bin/fluent-bit
            mkdir -p ${target.dir}/fluent-bit/bin
        - name: copy files
          work-dir: ${source.dir}/fluent-bit
          runs: |
            set -eux -o pipefail

            mkdir -p ${target.dir}/fluent-bit/etc/conf

            ${target.dir}/usr/local/bin/fluent-bit -J > ${target.dir}/fluent-bit/etc/schema.json

            cp conf/parsers.conf \
              conf/parsers_ambassador.conf \
              conf/parsers_java.conf \
              conf/parsers_extra.conf \
              conf/parsers_openstack.conf \
              conf/parsers_cinder.conf \
              conf/plugins.conf \
              ${target.dir}/fluent-bit/etc

            cp conf/fluent-bit.conf ${target.dir}/fluent-bit/etc/conf/
            mkdir -p ${target.dir}/fluent-bit/bin
      outputs:
        - source: ${target.dir}/usr/local/bin/fluent-bit
          target: /usr/local/bin/fluent-bit
          uid: 0
          gid: 0
        - source: ${target.dir}/fluent-bit/bin
          target: /fluent-bit/bin
          uid: 0
          gid: 0
        - source: ${target.dir}/fluent-bit/etc
          target: /fluent-bit/etc/
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/fluent-bit
          target: /opt/docker/sbom/fluent-bit
          uid: 0
          gid: 0
accounts:
  root: true
  run-as: root
  users:
    - name: nonroot
      uid: 65532
      gid: 65532
    - name: _apt
      uid: 42
      gid: 65532
  groups:
    - name: nonroot
      gid: 65532
      members:
        - nonroot
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
environment:
  DEBIAN_FRONTEND: noninteractive
  FLUENT_BIT_VERSION: 4.2.2
paths:
  - type: symlink
    path: /fluent-bit/bin/fluent-bit
    uid: 0
    gid: 0
    source: /usr/local/bin/fluent-bit
annotations:
  org.opencontainers.image.description: A minimal Fluent Bit image
  org.opencontainers.image.licenses: Apache-2.0
entrypoint:
  - /usr/local/bin/fluent-bit
ports:
  - 2020/tcp
  - 9880/tcp
  - 24224/tcp
