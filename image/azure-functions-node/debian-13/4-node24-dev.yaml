# syntax=dhi.io/build:2-debian13

name: Azure Functions 4.x for Node 24.x (node24.13, dev)
image: dhi.io/azure-functions-node
variant: dev
flavor: node24.13
tags:
  - 4-node24.13-dev
  - 4.1047-node24.13-dev
  - 4-debian13-node24.13-dev
  - 4.1047.100-node24.13-dev
  - 4.1047-debian13-node24.13-dev
  - 4.1047.100-debian13-node24.13-dev
platforms:
  - linux/amd64
vars:
  BUILD_NUMBER: "100"
  COMMIT_SHA: d2b723ade785c2630569ea74606a94486029c8a4
  DOTNET_REFERENCE: dhi/dotnet:8.0.417-sdk-debian13@sha256:e5142af1b51b230dcf7e27a7d7ee8c0599fe1de23a6400d651b9dc594bde6f5c
  DOTNET_VERSION: 8.0.417
  EXT_BUNDLE_COMMIT_SHA: 6f91ab8724392340705e925d94ef8b2479e47a57
  EXT_BUNDLE_VERSION: 4.32.0
  FUNCTIONS_WORKER: node
  NODE_MAJOR_MINOR_VERSION: "24.13"
  NODE_MAJOR_VERSION: "24"
  NODE_REFERENCE: dhi/node:24.13.0-debian13@sha256:c2368c70538c2459b90d588e5344013064da76aeba6fc4443457b2c376e60cd7
  NODE_VERSION: 24.13.0
  SEMVER_MAJOR_MINOR_VERSION: "4.1047"
  SEMVER_MAJOR_VERSION: "4"
  SEMVER_VERSION: 4.1047.100
  TEMPLATES_BUILDID: "259213"
  TEMPLATES_DOWNLOADURL: https://artprodwus21.artifacts.visualstudio.com/Ad1c51fbc-4477-4a0f-b99f-fc9013009a58/ae7e3bf3-d41a-4480-9ac0-b6cf9df9ac24/_apis/artifact/cGlwZWxpbmVhcnRpZmFjdDovL2F6ZnVuYy9wcm9qZWN0SWQvYWU3ZTNiZjMtZDQxYS00NDgwLTlhYzAtYjZjZjlkZjlhYzI0L2J1aWxkSWQvMjU5MjEzL2FydGlmYWN0TmFtZS9kcm9w0/content?format=zip
  VERSION: 4.1047.100
contents:
  repositories:
    - deb [signed-by=/usr/share/keyrings/microsoft-signing-key] https://packages.microsoft.com/debian/13/prod trixie main
  keyring:
    - https://packages.microsoft.com/keys/microsoft-2025.asc
  packages:
    - '!gawk'
    - '!libelogind0'
    - '!mawk'
    - '!original-awk'
    - apt
    - base-files
    - bash
    - ca-certificates
    - coreutils
    - diffutils
    - dpkg
    - findutils
    - grep
    - libc-bin
    - libglib2.0-0t64
    - libicu76
    - libsm6
    - libxext6
    - libxrender-dev
    - mawk
    - msodbcsql18
    - mssql-tools18
    - perl-base
    - sed
    - unixodbc
    - util-linux
  builds:
    - name: azure-functions-host
      uses: dhi.io/dotnet:8.0.417-sdk-debian13@sha256:e5142af1b51b230dcf7e27a7d7ee8c0599fe1de23a6400d651b9dc594bde6f5c
      contents:
        packages:
          - bash
          - findutils
        files:
          - url: git+https://github.com/Azure/azure-functions-host.git#v4.1047.100
            checksum: d2b723ade785c2630569ea74606a94486029c8a4
            path: ${source.dir}/azure-functions-host
            spdx:
              name: azure-functions-host
              version: 4.1047.100
              packages:
                - name: azure-functions-host
                  purl: pkg:github/Azure/azure-functions-host@4.1047.100
                  license: MIT
            uid: 0
            gid: 0
      pipeline:
        - name: build
          work-dir: ${source.dir}/azure-functions-host
          privileged: true
          runs: |
            set -eux -o pipefail

            dotnet publish -v q \
              /p:BuildNumber='100' /p:CommitHash='d2b723ade785c2630569ea74606a94486029c8a4' \
              src/WebJobs.Script.WebHost/WebJobs.Script.WebHost.csproj \
              -c Release \
              --output '${target.dir}/azure-functions-host' \
              --runtime linux-x64 --self-contained
        - name: install
          runs: |
            set -eux -o pipefail

            find '${target.dir}/azure-functions-host/workers' -type d -mindepth 1 -maxdepth 1 -not -name 'node' -exec rm -rf '{}' \;
      outputs:
        - source: ${target.dir}/azure-functions-host
          target: /azure-functions-host
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/azure-functions-host
          target: /opt/docker/sbom/azure-functions-host
          uid: 0
          gid: 0
    - name: azure-functions-extension-bundles
      uses: dhi.io/dotnet:8.0.417-sdk-debian13@sha256:e5142af1b51b230dcf7e27a7d7ee8c0599fe1de23a6400d651b9dc594bde6f5c
      contents:
        packages:
          - bash
          - ca-certificates
          - sed
          - unzip
        files:
          - url: git+https://github.com/Azure/azure-functions-extension-bundles.git#4.32.0
            checksum: 6f91ab8724392340705e925d94ef8b2479e47a57
            path: ${source.dir}/azure-functions-extension-bundles
            spdx:
              name: azure-functions-extension-bundles
              version: 4.32.0
              packages:
                - name: azure-functions-extension-bundles
                  purl: pkg:github/Azure/azure-functions-extension-bundles@4.32.0
                  license: MIT
            uid: 0
            gid: 0
          - url: https://artprodwus21.artifacts.visualstudio.com/Ad1c51fbc-4477-4a0f-b99f-fc9013009a58/ae7e3bf3-d41a-4480-9ac0-b6cf9df9ac24/_apis/artifact/cGlwZWxpbmVhcnRpZmFjdDovL2F6ZnVuYy9wcm9qZWN0SWQvYWU3ZTNiZjMtZDQxYS00NDgwLTlhYzAtYjZjZjlkZjlhYzI0L2J1aWxkSWQvMjU5MjEzL2FydGlmYWN0TmFtZS9kcm9w0/content?format=zip
            path: ${source.dir}/templatesArtifacts.zip
            uid: 0
            gid: 0
      pipeline:
        - name: extract templates
          work-dir: ${source.dir}/azure-functions-extension-bundles
          runs: |
            set -eux -o pipefail

            unzip ${source.dir}/templatesArtifacts.zip
            mv drop templatesArtifacts
        - name: patch source
          uses: patch@v1
          with:
            dir: ${source.dir}/azure-functions-extension-bundles
            options: -p1
            patches:
              - ${source.dir}/patch/linux_bundles.patch
        - name: build
          work-dir: ${source.dir}/azure-functions-extension-bundles/build
          privileged: true
          runs: |
            set -eux -o pipefail

            sed -E -i '${source.dir}/azure-functions-extension-bundles/src/Microsoft.Azure.Functions.ExtensionBundle/NuGet.Config' \
              -e 's|azure-functions-extension-bundles|nuget.org|' \
              -e 's|https://pkgs.dev.azure.com/[^"]+|https://api.nuget.org/v3/index.json|'

            TEMPLATES_ARTIFACTS_DIRECTORY=1 dotnet run \
              skip:GenerateVulnerabilityReport,PackageNetCoreV3BundlesWindows,CreateRUPackage,CreateCDNStoragePackage,CreateCDNStoragePackageWindows,BuildBundleBinariesForWindows
        - name: install
          work-dir: ${source.dir}/azure-functions-extension-bundles/artifacts
          runs: |
            set -eux -o pipefail

            mkdir -p ${target.dir}/FuncExtensionBundles/Microsoft.Azure.Functions.ExtensionBundle/4.32.0
            unzip Microsoft.Azure.Functions.ExtensionBundle.4.32.0_linux-x64.zip \
              -d ${target.dir}/FuncExtensionBundles/Microsoft.Azure.Functions.ExtensionBundle/4.32.0
      paths:
        - type: directory
          path: ${source.dir}/patch
          uid: 0
          gid: 0
          source: ecosystem/azure-functions/patch
      outputs:
        - source: ${target.dir}/FuncExtensionBundles
          target: /FuncExtensionBundles
          uid: 0
          gid: 0
        - source: /opt/docker/sbom/azure-functions-extension-bundles
          target: /opt/docker/sbom/azure-functions-extension-bundles
          uid: 0
          gid: 0
  artifacts:
    - name: dhi.io/node:24.13.0-debian13@sha256:c2368c70538c2459b90d588e5344013064da76aeba6fc4443457b2c376e60cd7
      includes:
        - opt/**
        - usr/**
        - var/**
      uid: 0
      gid: 0
accounts:
  root: true
  run-as: root
  users:
    - name: nonroot
      uid: 65532
      gid: 65532
    - name: _apt
      uid: 42
      gid: 65532
  groups:
    - name: nonroot
      gid: 65532
      members:
        - nonroot
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
environment:
  ASPNETCORE_CONTENTROOT: /azure-functions-host
  ASPNETCORE_URLS: http://+:80
  AzureFunctionsJobHost__Logging__Console__IsEnabled: "true"
  AzureWebJobsScriptRoot: /home/site/wwwroot
  DEBIAN_FRONTEND: noninteractive
  DOTNET_RUNNING_IN_CONTAINER: "true"
  DOTNET_USE_POLLING_FILE_WATCHER: "true"
  FUNCTIONS_WORKER_RUNTIME: node
  FUNCTIONS_WORKER_RUNTIME_VERSION: 24.13.0
annotations:
  org.opencontainers.image.description: A minimal Azure Functions Node image
  org.opencontainers.image.licenses: MIT
entrypoint:
  - /azure-functions-host/Microsoft.Azure.WebJobs.Script.WebHost
