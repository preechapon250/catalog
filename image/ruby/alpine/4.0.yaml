# syntax=dhi/build:1-alpine3.22

# DO NOT EDIT THIS FILE MANUALLY
# generated with 'dhi def merge image/ruby/alpine/4.0.yaml'

name: Ruby 4.0.x
image: dhi/ruby
variant: runtime
tags:
    - 4-alpine3.22
    - 4.0-alpine3.22
    - 4.0.0-alpine3.22
platforms:
    - linux/amd64
    - linux/arm64
vars:
    GEM_HOME: /usr/local/bundle
    SEMVER_MAJOR_MINOR_VERSION: "4.0"
    SEMVER_MAJOR_VERSION: "4"
    SEMVER_VERSION: 4.0.0
    SHA256: a72bacee9de07283ebc19baa4ac243b193129f21aa4e168c7186fb1fe7d07fe1
    VERSION: 4.0.0
contents:
    repositories:
        - https://dl-cdn.alpinelinux.org/alpine/v3.22/main
        - https://dl-cdn.alpinelinux.org/alpine/v3.22/community
    packages:
        - alpine-baselayout-data
        - ca-certificates-bundle
        - gmp
        - libcrypto3
        - openssl
        - yaml
        - zlib
    builds:
        - name: ruby
          contents:
            repositories:
                - https://dl-cdn.alpinelinux.org/alpine/v3.22/main
                - https://dl-cdn.alpinelinux.org/alpine/v3.22/community
            packages:
                - busybox
                - autoconf
                - bzip2
                - bzip2-dev
                - ca-certificates
                - coreutils
                - dpkg-dev
                - dpkg
                - g++
                - gcc
                - gdbm-dev
                - glib-dev
                - gmp-dev
                - libc-dev
                - libffi-dev
                - libxml2-dev
                - libxslt-dev
                - linux-headers
                - make
                - ncurses-dev
                - openssl
                - openssl-dev
                - patch
                - procps
                - yaml-dev
                - zlib-dev
                - ruby
                - tar
                - xz
                - yaml-dev
                - zlib-dev
                - musl-utils
            files:
                - url: https://cache.ruby-lang.org/pub/ruby/4.0/ruby-4.0.0.tar.xz
                  checksum: sha256:a72bacee9de07283ebc19baa4ac243b193129f21aa4e168c7186fb1fe7d07fe1
                  path: ${source.dir}/ruby.tar.xz
                  spdx:
                    name: ruby
                    version: 4.0.0
                    packages:
                        - name: ruby
                          purl: pkg:dhi/ruby@4.0.0
                          license: BSD-2-Clause
                  uid: 0
                  gid: 0
          pipeline:
            - name: install
              runs: |
                set -eux -o pipefail

                # skip installing gem documentation with `gem install`/`gem update`
                mkdir -p /usr/local/etc
                echo 'gem: --no-document' >> /usr/local/etc/gemrc

                mkdir -p /usr/src/ruby
                tar -xaf ruby.tar.xz -C /usr/src/ruby --strip-components=1
                cd /usr/src/ruby

                autoconf

                gnuArch="$(dpkg-architecture --query DEB_BUILD_GNU_TYPE)"
                ./configure \
                  --build="$gnuArch" \
                  --disable-install-doc \
                  --enable-shared

                ncpus=$(getconf _NPROCESSORS_ONLN)
                ncpus=$((ncpus > 6 ? 6 : ncpus))

                make -j${ncpus}
                # make -j${ncpus} check test-bundle
                make install

                # ensure ruby binary is installed in /usr/local/bin
                [ "$(command -v ruby)" = '/usr/local/bin/ruby' ]

                ruby --version
                ruby -e 'puts "hello world"'
            - name: cleanup
              runs: |
                set -eux -o pipefail

                rm -f /usr/local/bin/bundle
                rm -f /usr/local/bin/bundler
                rm -f /usr/local/bin/erb
                rm -f /usr/local/bin/gem
                rm -f /usr/local/bin/irb
                rm -f /usr/local/bin/racc
                rm -f /usr/local/bin/rake
                rm -f /usr/local/bin/rbs
                rm -f /usr/local/bin/rdbg
                rm -f /usr/local/bin/rdoc
                rm -f /usr/local/bin/ri
                rm -f /usr/local/bin/syntax_suggest
                rm -f /usr/local/bin/typeprof
          paths:
            - type: directory
              path: /tmp
              uid: 0
              gid: 0
          outputs:
            - source: /usr/local
              target: /usr/local
              uid: 0
              gid: 0
            - source: /opt/docker/sbom
              target: /opt/docker/sbom
              uid: 0
              gid: 0
accounts:
    run-as: nonroot
    users:
        - name: nonroot
          uid: 65532
          gid: 65532
    groups:
        - name: nonroot
          gid: 65532
          members:
            - nonroot
os-release:
    name: Docker Hardened Images (Alpine)
    id: alpine
    version-id: "3.22"
    pretty-name: Docker Hardened Images/Alpine Linux v3.22
    home-url: https://docker.com/products/hardened-images/
    bug-report-url: https://docker.com/support/
environment:
    BUNDLE_APP_CONFIG: /usr/local/bundle
    BUNDLE_SILENCE_ROOT_WARNING: "true"
    GEM_HOME: /usr/local/bundle
    LD_LIBRARY_PATH: /usr/local/lib:${LD_LIBRARY_PATH}
    PATH: /usr/local/bin:/usr/local/bundle/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    RUBY_VERSION: 4.0.0
    SSL_CERT_FILE: /etc/ssl/certs/ca-certificates.crt
annotations:
    org.opencontainers.image.description: A minimal Ruby image
    org.opencontainers.image.licenses: BSD-2-Clause
cmd:
    - ruby
tests:
    - name: Run testcontainers tests
      directory: image/ruby/tests
      commands:
        - go test . -count=1 -v
      exit-code: 0
    - name: Run testcontainers basic tests
      directory: test/go-testing/base
      commands:
        - go test . -count=1 -v
      exit-code: 0
