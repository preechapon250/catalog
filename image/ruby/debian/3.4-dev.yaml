# syntax=dhi/build:1-debian13

# DO NOT EDIT THIS FILE MANUALLY
# generated with 'dhi def merge image/ruby/debian/3.4-dev.yaml'

name: Ruby 3.4.x (dev)
image: dhi/ruby
variant: dev
tags:
    - 3-dev
    - 3.4-dev
    - 3.4.8-dev
    - 3-debian13-dev
    - 3.4-debian13-dev
    - 3.4.8-debian13-dev
platforms:
    - linux/amd64
    - linux/arm64
dates:
    release: "2024-12-24"
    end-of-life: "2028-03-31"
vars:
    BINUTILS_DIGEST: sha256:48107c1824276349ccbddce3853299de8b7c6a554b775957864d44c7b9a6b5b4
    BINUTILS_VERSION: "2.45"
    EXPAT_DIGEST: sha256:bf522255414eb53b8992e36dc64fde670d477c0b3be62c84209c4409de35e324
    EXPAT_VERSION: 2.7.3
    GEM_HOME: /usr/local/bundle
    SEMVER_MAJOR_MINOR_VERSION: "3.4"
    SEMVER_MAJOR_VERSION: "3"
    SEMVER_VERSION: 3.4.8
    SHA256: 53a8ec71111449cbbd42224d8d27c493fa6ded228636731051c48604d4255d68
    VERSION: 3.4.8
contents:
    packages:
        - '!binutils'
        - '!binutils-aarch64-linux-gnu'
        - '!binutils-common'
        - '!binutils-x86-64-linux-gnu'
        - '!gawk'
        - '!libbinutils'
        - '!libctf-nobfd0'
        - '!libctf0'
        - '!libelogind0'
        - '!libexpat1'
        - '!libgprofng0'
        - '!libsframe1'
        - '!make-guile'
        - '!mawk'
        - '!original-awk'
        - apt
        - base-files
        - bash
        - build-essential
        - ca-certificates
        - coreutils
        - diffutils
        - dpkg
        - findutils
        - git
        - grep
        - libc-bin
        - libcrypt1
        - libyaml-0-2
        - libyaml-dev
        - make
        - mawk
        - perl-base
        - sed
        - tzdata
        - util-linux
    builds:
        - name: ruby
          contents:
            packages:
                - autoconf
                - base-files
                - bash
                - binutils
                - bison
                - build-essential
                - coreutils
                - dpkg-dev
                - findutils
                - g++
                - gawk
                - gcc
                - grep
                - libc-bin
                - libc6-dev
                - libffi-dev
                - libgdbm-dev
                - libgmp-dev
                - libncurses-dev
                - libreadline-dev
                - libssl-dev
                - libyaml-dev
                - make
                - openssl
                - sed
                - zlib1g-dev
            files:
                - url: https://cache.ruby-lang.org/pub/ruby/3.4/ruby-3.4.8.tar.xz
                  checksum: sha256:53a8ec71111449cbbd42224d8d27c493fa6ded228636731051c48604d4255d68
                  path: ${source.dir}/ruby.tar.xz
                  spdx:
                    name: ruby
                    version: 3.4.8
                    packages:
                        - name: ruby
                          purl: pkg:dhi/ruby@3.4.8
                          license: BSD-2-Clause
                  uid: 0
                  gid: 0
          pipeline:
            - name: unpack
              runs: |
                set -eux -o pipefail

                mkdir -p /usr/src/ruby
                tar -xaf ruby.tar.xz -C /usr/src/ruby --strip-components=1
            - name: install
              runs: |
                set -eux -o pipefail

                # skip installing gem documentation with `gem install`/`gem update`
                mkdir -p /usr/local/etc
                echo 'gem: --no-document' >> /usr/local/etc/gemrc
                cd /usr/src/ruby

                autoconf

                gnuArch="$(dpkg-architecture --query DEB_BUILD_GNU_TYPE)"
                ./configure \
                  --build="$gnuArch" \
                  --disable-install-doc \
                  --enable-shared

                ncpus=$(getconf _NPROCESSORS_ONLN)
                ncpus=$((ncpus > 6 ? 6 : ncpus))

                make -j${ncpus}
                # make -j${ncpus} check test-bundle
                make install

                # ensure ruby binary is installed in /usr/local/bin
                [ "$(command -v ruby)" = '/usr/local/bin/ruby' ]

                ruby --version
                ruby -e 'puts "hello world"'
            - name: test-dev
              runs: |
                set -eux -o pipefail

                bundle --version
                bundler --version
                erb --version
                gem --version
                irb --version
                racc --version
                rake --version
                rbs --version
                rdbg --version
                rdoc --version
                ri --version
                typeprof --version

                # syntax_suggest is broken in ruby 3.2+
                # shellcheck disable=SC1083
                if [[ "$(ruby -v | awk '{print $2}')" != "3.2"* ]]; then
                  syntax_suggest --version
                fi
          paths:
            - type: directory
              path: /tmp
              uid: 0
              gid: 0
          outputs:
            - source: /usr/local
              target: /usr/local
              uid: 0
              gid: 0
            - source: /opt/docker/sbom
              target: /opt/docker/sbom
              uid: 0
              gid: 0
    artifacts:
        - name: dhi/pkg-binutils:2.45-debian13@sha256:48107c1824276349ccbddce3853299de8b7c6a554b775957864d44c7b9a6b5b4
          excludes:
            - etc/group
            - etc/os-release
            - etc/passwd
            - var/lib/dpkg/status
          uid: 0
          gid: 0
        - name: dhi/pkg-expat:2.7.3-debian13@sha256:bf522255414eb53b8992e36dc64fde670d477c0b3be62c84209c4409de35e324
          includes:
            - usr/**
            - var/lib/dpkg/status.d
          uid: 0
          gid: 0
accounts:
    root: true
    run-as: root
    users:
        - name: nonroot
          uid: 65532
          gid: 65532
        - name: _apt
          uid: 42
          gid: 65532
    groups:
        - name: nonroot
          gid: 65532
          members:
            - nonroot
os-release:
    name: Docker Hardened Images (Debian)
    id: debian
    version-id: "13"
    version-codename: trixie
    pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
    home-url: https://docker.com/products/hardened-images/
    bug-report-url: https://docker.com/support/
environment:
    BUNDLE_APP_CONFIG: /usr/local/bundle
    BUNDLE_SILENCE_ROOT_WARNING: "true"
    DEBIAN_FRONTEND: noninteractive
    GEM_HOME: /usr/local/bundle
    LD_LIBRARY_PATH: /usr/local/lib:${LD_LIBRARY_PATH}
    PATH: /usr/local/bin:/usr/local/bundle/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    RUBY_VERSION: 3.4.8
    SSL_CERT_FILE: /etc/ssl/certs/ca-certificates.crt
paths:
    - type: directory
      path: /usr/local/bundle
      uid: 65532
      gid: 65532
      mode: "0755"
annotations:
    org.opencontainers.image.description: A minimal Ruby image
    org.opencontainers.image.licenses: BSD-2-Clause
cmd:
    - /bin/bash
tests:
    - name: Run testcontainers tests
      directory: image/ruby/tests
      commands:
        - go test . -count=1 -v
      exit-code: 0
    - name: Run testcontainers basic tests
      directory: test/go-testing/base
      commands:
        - go test . -count=1 -v
      exit-code: 0
    - name: Run APT package manager tests
      directory: test/go-testing/package_manager
      commands:
        - go test . -count=1 -v
      exit-code: 0
