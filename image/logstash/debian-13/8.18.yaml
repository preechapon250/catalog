# syntax=dhi.io/build:2-debian13

name: Logstash 8.18.x
image: dhi.io/logstash
variant: runtime
tags:
  - "8.18"
  - 8.18.8
  - 8.18-debian13
  - 8.18.8-debian13
platforms:
  - linux/amd64
  - linux/arm64
dates:
  release: "2025-04-09"
vars:
  ARCH: '#{ target.arch == "amd64" ? "x86_64" : "aarch64" }'
  COMMIT_SHA: e1b101139286fed67fb694aa7dded21d140b564b
  GO_REFERENCE: dhi/golang:1.24.13-debian13-dev@sha256:ab5aa6c5769f20dd35a2fd530954d59efc7940e6e37870d02b935f413b7229a0
  GO_VERSION: 1.24.13
  GRADLE_REFERENCE: dhi/gradle:8.14.4-jdk21-debian13-dev@sha256:63883727e15c4d3f73fad0240d2323c1234201f3b1fd8864835c9589bfd2207f
  GRADLE_VERSION: 8.14.4
  JAVA_MAJOR_VERSION: "21"
  JDK_REFERENCE: dhi/eclipse-temurin:21.0.10.7-jdk-debian13-dev@sha256:06b052ecff54363ba616669096269e82f8a19838e31983da5366d338515819ad
  JDK_VERSION: 21.0.10.7
  LOGSTASH_PATH: /usr/share/logstash
  LOGSTASH_SOURCE: "1"
  OSS: "true"
  SEMVER_MAJOR_MINOR_VERSION: "8.18"
  SEMVER_MAJOR_VERSION: "8"
  SEMVER_VERSION: 8.18.8
  VERSION: 8.18.8
contents:
  packages:
    - '!libelogind0'
    - '!mawk'
    - '!original-awk'
    - base-files
    - bash
    - coreutils
    - sed
  builds:
    - name: env2yaml go for 8.18
      uses: dhi.io/golang:1.24.13-debian13-dev@sha256:ab5aa6c5769f20dd35a2fd530954d59efc7940e6e37870d02b935f413b7229a0
      contents:
        packages:
          - bash
          - coreutils
        files:
          - url: git+https://github.com/elastic/logstash.git#e1b101139286fed67fb694aa7dded21d140b564b
            checksum: e1b101139286fed67fb694aa7dded21d140b564b
            path: ${source.dir}/logstash
            uid: 0
            gid: 0
      pipeline:
        - name: build env2yaml go
          privileged: true
          runs: |
            set -eux -o pipefail

            mkdir -p /tmp/go/src
            cp -r "${source.dir}/logstash/docker/data/logstash/env2yaml" /tmp/go/src/env2yaml
            cd /tmp/go/src/env2yaml
            go build -trimpath
      outputs:
        - source: /tmp/go/src/env2yaml/env2yaml
          target: /usr/local/bin/env2yaml
          uid: 0
          gid: 0
          mode: "0755"
    - name: build logstash
      uses: dhi.io/gradle:8.14.4-jdk21-debian13-dev@sha256:63883727e15c4d3f73fad0240d2323c1234201f3b1fd8864835c9589bfd2207f
      contents:
        packages:
          - coreutils
          - curl
          - findutils
          - grep
          - gzip
          - libc6-dev
          - make
          - sed
          - tar
        files:
          - url: git+https://github.com/elastic/logstash.git#v8.18.8
            checksum: e1b101139286fed67fb694aa7dded21d140b564b
            path: ${source.dir}/logstash
            spdx:
              name: logstash
              version: 8.18.8
              packages:
                - name: logstash
                  purl: pkg:dhi/logstash@8.18.8
                  license: Apache-2.0
            uid: 0
            gid: 0
          - url: https://repo1.maven.org/maven2/at/yawk/lz4/lz4-java/1.10.1/lz4-java-1.10.1.jar
            path: ${source.dir}/patch/deps/lz4-java-1.10.1.jar
            uid: 0
            gid: 0
      pipeline:
        - name: patch deps
          uses: git/patch@v1
          work-dir: ${source.dir}/logstash
          with:
            patch: ${source.dir}/patch/deps-8.18.patch
        - name: install default gems
          work-dir: ${source.dir}/logstash
          privileged: true
          runs: |
            set -eux -o pipefail

            gradle installDefaultGems
        - name: install assemble tar distro
          work-dir: ${source.dir}/logstash
          privileged: true
          runs: |
            set -eux -o pipefail

            gradle assembleOssTarDistribution
        - name: unpack
          work-dir: ${source.dir}/logstash
          runs: |
            set -eux -o pipefail

            tar -zxf "build/logstash-oss-8.18.8-SNAPSHOT-no-jdk.tar.gz" -C /usr/share

            mkdir -p "${target.dir}/usr/share/logstash"

            cp -r "/usr/share/logstash-8.18.8"-SNAPSHOT/* "${target.dir}/usr/share/logstash"
        - name: replace vulnerable jars
          work-dir: ${source.dir}/logstash
          runs: |
            set -eux -o pipefail

            lz4_base_path="${target.dir}/usr/share/logstash/vendor/bundle/jruby/3.1.0/gems/logstash-integration-kafka-11.6.4-java/vendor/jar-dependencies/org/lz4/lz4-java/"

            # Remove old version
            # This will fail if the file is not there (meaning something has changed since this patch was needed)
            rm "$lz4_base_path/1.8.0/lz4-java-1.8.0.jar"
            rmdir "$lz4_base_path/1.8.0"

            # Insert fixed version
            mkdir "$lz4_base_path/1.10.1"
            cp "${source.dir}/patch/deps/lz4-java-1.10.1.jar" "$lz4_base_path/1.10.1"
      paths:
        - type: directory
          path: ${source.dir}/patch
          uid: 0
          gid: 0
          source: image/logstash/patch
      outputs:
        - source: ${target.dir}/usr/share/logstash
          target: /usr/share/logstash
          uid: 0
          gid: 0
          mode: "0755"
        - source: /opt/docker/sbom/logstash
          target: /opt/docker/sbom/logstash
          uid: 0
          gid: 0
        - source: ${source.dir}/logstash/docker/data/logstash/bin/docker-entrypoint
          target: /usr/local/bin/docker-entrypoint
          uid: 0
          gid: 0
          mode: "0755"
        - source: ${source.dir}/logstash/docker/data/logstash/config/pipelines.yml
          target: /usr/share/logstash/config/pipelines.yml
          uid: 1000
          gid: 0
          mode: "0644"
        - source: ${source.dir}/logstash/docker/data/logstash/config/log4j2.properties
          target: /usr/share/logstash/config/log4j2.properties
          uid: 1000
          gid: 0
          mode: "0644"
        - source: ${source.dir}/logstash/docker/data/logstash/config/log4j2.file.properties
          target: /usr/share/logstash/config/log4j2.file.properties
          uid: 1000
          gid: 0
          mode: "0644"
        - source: ${source.dir}/logstash/docker/data/logstash/config/logstash-oss.yml
          target: /usr/share/logstash/config/logstash.yml
          uid: 1000
          gid: 0
          mode: "0644"
        - source: ${source.dir}/logstash/docker/data/logstash/pipeline/default.conf
          target: /usr/share/logstash/pipeline/logstash.conf
          uid: 1000
          gid: 0
          mode: "0644"
  artifacts:
    - name: dhi.io/eclipse-temurin:21.0.10.7-jdk-debian13-dev@sha256:06b052ecff54363ba616669096269e82f8a19838e31983da5366d338515819ad
      includes:
        - opt/**
        - usr/local/bin/**
      uid: 0
      gid: 0
accounts:
  run-as: logstash
  users:
    - name: logstash
      uid: 1000
      gid: 1000
  groups:
    - name: logstash
      gid: 1000
      members:
        - logstash
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
work-dir: /usr/share/logstash
environment:
  ELASTIC_CONTAINER: "true"
  PATH: /usr/share/logstash/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
paths:
  - type: directory
    path: /usr/share/logstash
    uid: 0
    gid: 0
    mode: "0755"
  - type: directory
    path: /usr/share/logstash/data
    uid: 1000
    gid: 0
    mode: "2755"
  - type: directory
    path: /usr/share/logstash/logs
    uid: 1000
    gid: 0
    mode: "2755"
  - type: symlink
    path: /opt/logstash
    uid: 0
    gid: 0
    source: /usr/share/logstash
  - type: symlink
    path: /usr/share/logstash/jdk
    uid: 0
    gid: 0
    source: /opt/java/openjdk/21
annotations:
  org.opencontainers.image.description: A minimal logstash image
  org.opencontainers.image.licenses: Elastic-License-2.0
entrypoint:
  - /usr/local/bin/docker-entrypoint
ports:
  - 9600/tcp
  - 5044/tcp
