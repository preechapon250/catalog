# syntax=dhi.io/build:1-debian13

name: Logstash 8.19.x
image: dhi.io/logstash
variant: runtime
tags:
  - "8"
  - "8.19"
  - 8.19.9
  - 8-debian13
  - 8.19-debian13
  - 8.19.9-debian13
platforms:
  - linux/amd64
  - linux/arm64
dates:
  release: "2025-07-14"
  end-of-life: "2027-07-15"
vars:
  ARCH: '#{ target.arch == "amd64" ? "x86_64" : "aarch64" }'
  COMMIT_SHA: 19f7f492af390443f29a825dd737fc7599a9576f
  ENV2YAML_BUILDER: dhi/gradle:8.14.3-jdk21-debian13-dev@sha256:3e3429fa344bdb01a7df7c240038442a263060e1925d61e954e471edcab3ce47
  GO_REFERENCE: dhi/golang:1.24.11-debian13-dev@sha256:3e717c75bdd2e547755fc90963578c5424b77243f4c35f97ac025ca783a41b6a
  GO_VERSION: 1.24.11
  GRADLE_REFERENCE: dhi/gradle:8.14.3-jdk21-debian13-dev@sha256:3e3429fa344bdb01a7df7c240038442a263060e1925d61e954e471edcab3ce47
  GRADLE_VERSION: 8.14.3
  JAVA_MAJOR_VERSION: "21"
  JDK_REFERENCE: dhi/eclipse-temurin:21.0.9.10-jdk-debian13-dev@sha256:99421ea725e0905500a94ed9b10b688071e6681002d06bd6869193f55111c366
  JDK_VERSION: 21.0.9.10
  LOGSTASH_PATH: /usr/share/logstash
  LOGSTASH_SOURCE: "1"
  OSS: "true"
  SEMVER_MAJOR_MINOR_VERSION: "8.19"
  SEMVER_MAJOR_VERSION: "8"
  SEMVER_VERSION: 8.19.9
  VERSION: 8.19.9
contents:
  packages:
    - '!libelogind0'
    - '!mawk'
    - '!original-awk'
    - base-files
    - bash
    - coreutils
    - sed
  builds:
    - name: env2yaml
      uses: dhi.io/gradle:8.14.3-jdk21-debian13-dev@sha256:3e3429fa344bdb01a7df7c240038442a263060e1925d61e954e471edcab3ce47
      contents:
        packages:
          - bash
          - coreutils
        files:
          - url: git+https://github.com/elastic/logstash.git#19f7f492af390443f29a825dd737fc7599a9576f
            path: ${source.dir}/logstash-19f7f492af390443f29a825dd737fc7599a9576f
            uid: 0
            gid: 0
      pipeline:
        - name: build env2yaml java
          work-dir: ${source.dir}/logstash-19f7f492af390443f29a825dd737fc7599a9576f/docker/data/logstash/env2yaml
          privileged: true
          runs: |
            set -eux -o pipefail

            gradle build
      outputs:
        - source: ${source.dir}/logstash-19f7f492af390443f29a825dd737fc7599a9576f/docker/data/logstash/env2yaml
          target: /usr/share/logstash/env2yaml
          uid: 0
          gid: 0
          mode: "0755"
        - source: ${source.dir}/logstash-19f7f492af390443f29a825dd737fc7599a9576f/docker/data/logstash/env2yaml/env2yaml
          target: /usr/local/bin/env2yaml
          uid: 0
          gid: 0
          mode: "0755"
    - name: build logstash
      uses: dhi.io/gradle:8.14.3-jdk21-debian13-dev@sha256:3e3429fa344bdb01a7df7c240038442a263060e1925d61e954e471edcab3ce47
      contents:
        packages:
          - coreutils
          - curl
          - findutils
          - grep
          - gzip
          - libc6-dev
          - make
          - sed
          - tar
        files:
          - url: git+https://github.com/elastic/logstash.git#v8.19.9
            checksum: 19f7f492af390443f29a825dd737fc7599a9576f
            path: ${source.dir}/logstash
            spdx:
              name: logstash
              version: 8.19.9
              packages:
                - name: logstash
                  purl: pkg:dhi/logstash@8.19.9
                  license: Apache-2.0
            uid: 0
            gid: 0
          - url: https://repo1.maven.org/maven2/at/yawk/lz4/lz4-java/1.10.1/lz4-java-1.10.1.jar
            path: ${source.dir}/patch/deps/lz4-java-1.10.1.jar
            uid: 0
            gid: 0
      pipeline:
        - name: apply rack patch
          uses: patch@v1
          work-dir: ${source.dir}/logstash
          with:
            patches:
              - ${source.dir}/patch/rack-8.19.patch
        - name: install default gems
          work-dir: ${source.dir}/logstash
          privileged: true
          runs: |
            set -eux -o pipefail

            gradle installDefaultGems
        - name: install assemble tar distro
          work-dir: ${source.dir}/logstash
          privileged: true
          runs: |
            set -eux -o pipefail

            gradle assembleOssTarDistribution
        - name: unpack
          work-dir: ${source.dir}/logstash
          runs: |
            set -eux -o pipefail

            tar -zxf "build/logstash-oss-8.19.9-SNAPSHOT-no-jdk.tar.gz" -C /usr/share

            mkdir -p "${target.dir}/usr/share/logstash"

            cp -r "/usr/share/logstash-8.19.9"-SNAPSHOT/* "${target.dir}/usr/share/logstash"
        - name: replace vulnerable jars
          work-dir: ${source.dir}/logstash
          runs: |
            set -eux -o pipefail

            lz4_base_path="${target.dir}/usr/share/logstash/vendor/bundle/jruby/3.1.0/gems/logstash-integration-kafka-11.6.4-java/vendor/jar-dependencies/org/lz4/lz4-java/"

            # Remove old version
            # This will fail if the file is not there (meaning something has changed since this patch was needed)
            rm "$lz4_base_path/1.8.0/lz4-java-1.8.0.jar"
            rmdir "$lz4_base_path/1.8.0"

            # Insert fixed version
            mkdir "$lz4_base_path/1.10.1"
            cp "${source.dir}/patch/deps/lz4-java-1.10.1.jar" "$lz4_base_path/1.10.1"
      paths:
        - type: directory
          path: ${source.dir}/patch
          uid: 0
          gid: 0
          source: image/logstash/patch
      outputs:
        - source: ${target.dir}/usr/share/logstash
          target: /usr/share/logstash
          uid: 0
          gid: 0
          mode: "0755"
        - source: /opt/docker/sbom/logstash
          target: /opt/docker/sbom/logstash
          uid: 0
          gid: 0
        - source: ${source.dir}/logstash/docker/data/logstash/bin/docker-entrypoint
          target: /usr/local/bin/docker-entrypoint
          uid: 0
          gid: 0
          mode: "0755"
        - source: ${source.dir}/logstash/docker/data/logstash/config/pipelines.yml
          target: /usr/share/logstash/config/pipelines.yml
          uid: 1000
          gid: 0
          mode: "0644"
        - source: ${source.dir}/logstash/docker/data/logstash/config/log4j2.properties
          target: /usr/share/logstash/config/log4j2.properties
          uid: 1000
          gid: 0
          mode: "0644"
        - source: ${source.dir}/logstash/docker/data/logstash/config/log4j2.file.properties
          target: /usr/share/logstash/config/log4j2.file.properties
          uid: 1000
          gid: 0
          mode: "0644"
        - source: ${source.dir}/logstash/docker/data/logstash/config/logstash-oss.yml
          target: /usr/share/logstash/config/logstash.yml
          uid: 1000
          gid: 0
          mode: "0644"
        - source: ${source.dir}/logstash/docker/data/logstash/pipeline/default.conf
          target: /usr/share/logstash/pipeline/logstash.conf
          uid: 1000
          gid: 0
          mode: "0644"
  artifacts:
    - name: dhi.io/eclipse-temurin:21.0.9.10-jdk-debian13-dev@sha256:99421ea725e0905500a94ed9b10b688071e6681002d06bd6869193f55111c366
      includes:
        - opt/**
        - usr/local/bin/**
      uid: 0
      gid: 0
accounts:
  run-as: logstash
  users:
    - name: logstash
      uid: 1000
      gid: 1000
  groups:
    - name: logstash
      gid: 1000
      members:
        - logstash
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
work-dir: /usr/share/logstash
environment:
  ELASTIC_CONTAINER: "true"
  PATH: /usr/share/logstash/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
paths:
  - type: directory
    path: /usr/share/logstash
    uid: 0
    gid: 0
    mode: "0755"
  - type: directory
    path: /usr/share/logstash/data
    uid: 1000
    gid: 0
    mode: "2755"
  - type: directory
    path: /usr/share/logstash/logs
    uid: 1000
    gid: 0
    mode: "2755"
  - type: symlink
    path: /opt/logstash
    uid: 0
    gid: 0
    source: /usr/share/logstash
  - type: symlink
    path: /usr/share/logstash/jdk
    uid: 0
    gid: 0
    source: /opt/java/openjdk/21
annotations:
  org.opencontainers.image.description: A minimal logstash image
  org.opencontainers.image.licenses: Elastic-License-2.0
entrypoint:
  - /usr/local/bin/docker-entrypoint
ports:
  - 9600/tcp
  - 5044/tcp
tests:
  - name: Run testcontainers basic tests
    directory: test/go-testing/base
    commands:
      - go test . -count=1 -v
    exit-code: 0
  - name: Run testcontainers tests
    directory: image/logstash/tests
    commands:
      - go test . -count=1 -v
    exit-code: 0
