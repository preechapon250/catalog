# syntax=dhi.io/build:2-debian13

name: OpenSCAP 1.x
image: dhi.io/openscap
variant: runtime
tags:
  - "1"
  - "1.4"
  - 1.4.3
  - 1-debian13
  - 1.4-debian13
  - 1.4.3-debian13
platforms:
  - linux/amd64
  - linux/arm64
vars:
  COMMIT_SHA: 24986066961363e24fcff83294995b3cfe4058ba
  DOCKER_PY_COMMIT_SHA: a3652028b1ead708bd9191efb286f909ba6c2a49
  DOCKER_PY_VERSION: 7.1.0
  OPENSCAP_COMMIT_SHA: 24986066961363e24fcff83294995b3cfe4058ba
  OPENSCAP_VERSION: 1.4.3
  PYTHON_REFERENCE: dhi/python:3.13.11-debian13-dev@sha256:a699c9ddca400955c37ad71c068026ba5c2e5e67f47d96d241b0b798eca3db42
  SEMVER_MAJOR_MINOR_VERSION: "1.4"
  SEMVER_MAJOR_VERSION: "1"
  SEMVER_VERSION: 1.4.3
  VERSION: 1.4.3
contents:
  packages:
    - '!libelogind0'
    - '!libpython3-stdlib'
    - '!libpython3.13'
    - '!libpython3.13-minimal'
    - '!libpython3.13-stdlib'
    - '!mawk'
    - '!original-awk'
    - '!python'
    - '!python3'
    - '!python3-minimal'
    - '!python3.13'
    - base-files
    - ca-certificates
    - libacl1
    - libblkid1
    - libbz2-1.0
    - libcap2
    - libcurl4t64
    - libdbus-1-3
    - libpcre2-8-0
    - librpm10
    - librpmio10
    - libselinux1
    - libxml2
    - libxmlsec1t64-openssl
    - libxslt1.1
    - libyaml-0-2
    - ssg-debian
  builds:
    - name: build openscap
      uses: dhi.io/python:3.13.11-debian13-dev@sha256:a699c9ddca400955c37ad71c068026ba5c2e5e67f47d96d241b0b798eca3db42
      contents:
        packages:
          - bash
          - coreutils
          - findutils
          - net-tools
          - sed
          - vim
          - git
          - apt
          - grep
          - tree
          - gcc
          - g++
          - cmake
          - dh-python
          - dpkg-dev
          - libacl1-dev
          - libattr1-dev
          - libblkid-dev
          - libbz2-dev
          - libcap-dev
          - libcrypt1
          - libcurl4-openssl-dev
          - libdbus-1-dev
          - libgcrypt20-dev
          - libglib2.0-dev
          - libldap2-dev
          - libpcre2-dev
          - libpopt-dev
          - libpython3-all-dev
          - librpm-dev
          - libselinux1-dev
          - libxml-parser-perl
          - libxml-xpath-perl
          - libxml2-dev
          - libxmlsec1-dev
          - libxslt1-dev
          - libyaml-dev
          - libperl-dev
          - pkgconf
          - swig
          - asciidoc
          - doxygen
          - graphviz
        files:
          - url: git+https://github.com/OpenSCAP/openscap#1.4.3
            checksum: 24986066961363e24fcff83294995b3cfe4058ba
            path: ${source.dir}/openscap
            spdx:
              name: openscap
              version: 1.4.3
              packages:
                - purl: pkg:dhi/openscap@1.4.3
                  license: LGPL-2.1-only
            uid: 0
            gid: 0
          - url: git+https://github.com/docker/docker-py#7.1.0
            checksum: a3652028b1ead708bd9191efb286f909ba6c2a49
            path: ${source.dir}/docker-py
            spdx:
              name: docker-py
              version: 7.1.0
              packages:
                - purl: pkg:pypi/docker@7.1.0
                  license: Apache-2.0
            uid: 0
            gid: 0
      pipeline:
        - name: install openscap
          work-dir: ${source.dir}/openscap
          privileged: true
          runs: |
            set -eux -o pipefail

            mkdir -p "${target.dir}/usr"
            ls -la
            PYTHON_DESTDIR=/usr/lib/python3/dist-packages
            cmake -B build -DPYTHON_SITE_PACKAGES_INSTALL_DIR=${PYTHON_DESTDIR} -DENABLE_PYTHON3=ON -DCMAKE_INSTALL_PREFIX=/usr -DCMAKE_INSTALL_LIBDIR=lib -DCMAKE_BUILD_TYPE=Release -DENABLE_PERL=OFF -DENABLE_TESTS=OFF
            VERBOSE=1 cmake --build build
            DESTDIR=${target.dir} cmake --install build
      outputs:
        - source: ${target.dir}/usr
          target: /usr
          uid: 0
          gid: 0
  artifacts:
    - name: dhi.io/python:3.13.11-debian13-dev@sha256:a699c9ddca400955c37ad71c068026ba5c2e5e67f47d96d241b0b798eca3db42
      includes:
        - opt/**
        - var/**
      uid: 0
      gid: 0
accounts:
  run-as: nonroot
  users:
    - name: nonroot
      uid: 65532
      gid: 65532
  groups:
    - name: nonroot
      gid: 65532
      members:
        - nonroot
os-release:
  name: Docker Hardened Images (Debian)
  id: debian
  version-id: "13"
  version-codename: trixie
  pretty-name: Docker Hardened Images/Debian GNU/Linux 13 (trixie)
  home-url: https://docker.com/products/hardened-images/
  bug-report-url: https://docker.com/support/
environment:
  DOCKER_PY_VERSION: 7.1.0
  OPENSCAP_VERBOSE: ERROR
  OPENSCAP_VERSION: ${DEBIAN_EPOCH_VERSION}
  PYTHONPATH: /usr/lib/python3/dist-packages
paths:
  - type: symlink
    path: /usr/bin/python3
    uid: 0
    gid: 0
    source: /opt/python/bin/python3
  - type: directory
    path: /opt/docker/gpos/xml/scap/ssg/content/
    uid: 0
    gid: 0
  - type: file
    path: /opt/docker/gpos/xml/scap/ssg/content/ssg-dhi-gpos-ds.xml
    uid: 0
    gid: 0
    mode: "0644"
    source: image/openscap/config/ssg-dhi-gpos-ds.xml
annotations:
  org.opencontainers.image.description: An OpenSCAP image to scan DHI
  org.opencontainers.image.licenses: LGPL-2.1
entrypoint:
  - /usr/bin/oscap
